"use strict";(()=>{var it=Object.defineProperty,nt=Object.defineProperties;var st=Object.getOwnPropertyDescriptors;var Y=Object.getOwnPropertySymbols;var ot=Object.prototype.hasOwnProperty,rt=Object.prototype.propertyIsEnumerable;var U=(a,e,t)=>e in a?it(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t,y=(a,e)=>{for(var t in e||(e={}))ot.call(e,t)&&U(a,t,e[t]);if(Y)for(var t of Y(e))rt.call(e,t)&&U(a,t,e[t]);return a},f=(a,e)=>nt(a,st(e));var V=(a,e,t)=>new Promise((i,n)=>{var s=l=>{try{c(t.next(l))}catch(r){n(r)}},h=l=>{try{c(t.throw(l))}catch(r){n(r)}},c=l=>l.done?i(l.value):Promise.resolve(l.value).then(s,h);c((t=t.apply(a,e)).next())});var at="#F3CE32";function j(){var v,w;let a=document.createElement("div");a.style.position="absolute",a.style.top="-40px",a.style.left="0",a.style.zIndex="2",(v=this.canvas.parentNode)==null||v.insertBefore(a,this.canvas);let e=document.createElement("div");e.style.position="relative",e.style.top="0",e.style.left="0",e.style.zIndex="2",(w=this.canvas.parentNode)==null||w.insertBefore(e,this.canvas.nextSibling),this.playerControlsContainer=e;let t=this.videoElement.tagName==="VIDEO"?this.videoElement:null;this.uiContainer=a;let i=(u,o,d=a)=>{let m=document.createElement("button");if(m.type="button",m.innerHTML=u,m.style.margin="5px",d.appendChild(m),this.buttons.push(m),typeof o=="function")this.addEvent(m,"click",o);else{m.dataset.tool=o;let p=()=>{this.currentTool===o?this.currentTool=null:this.currentTool=o};this.addEvent(m,"click",p)}return m},n=()=>{let u=document.createElement("div");return u.style.display="inline-flex",u.style.alignItems="center",u.style.margin="5px",a.appendChild(u),u};if(i('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></svg>',"rectangle"),i('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle></svg>',"circle"),i('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.3 8.7 8.7 21.3c-1 1-2.5 1-3.4 0l-2.6-2.6c-1-1-1-2.5 0-3.4L15.3 2.7c1-1 2.5-1 3.4 0l2.6 2.6c1 1 1 2.5 0 3.4Z"></path><path d="m7.5 10.5 2 2"></path><path d="m10.5 7.5 2 2"></path><path d="m13.5 4.5 2 2"></path><path d="m4.5 13.5 2 2"></path></svg>',"line"),i('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9.06 11.9 8.07-8.06a2.85 2.85 0 1 1 4.03 4.03l-8.06 8.08"></path><path d="M7.07 14.94c-1.66 0-3 1.35-3 3.02 0 1.33-2.5 1.52-2 2.02 1.08 1.1 2.49 2.02 4 2.02 2.2 0 4-1.8 4-4.04a3.01 3.01 0 0 0-3-3.02z"></path></svg>',"curve"),i('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>',"arrow"),i('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="4 7 4 4 20 4 20 7"></polyline><line x1="9" y1="20" x2="15" y2="20"></line><line x1="12" y1="4" x2="12" y2="20"></line></svg>',"text"),i('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m7 21-4.3-4.3c-1-1-1-2.5 0-3.4l9.6-9.6c1-1 2.5-1 3.4 0l5.6 5.6c1 1 1 2.5 0 3.4L13 21"></path><path d="M22 21H7"></path><path d="m5 11 9 9"></path></svg>',"eraser"),i('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="5 9 2 12 5 15"></polyline><polyline points="9 5 12 2 15 5"></polyline><polyline points="15 19 12 22 9 19"></polyline><polyline points="19 9 22 12 19 15"></polyline><line x1="2" y1="12" x2="22" y2="12"></line><line x1="12" y1="2" x2="12" y2="22"></line></svg>',"move"),i('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7v6h6"></path><path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"></path></svg>',()=>{this.handleUndo()}),t){i('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="19 20 9 12 19 4 19 20"></polygon><line x1="5" y1="19" x2="5" y2="5"></line></svg>',()=>{this.prevFrame()},this.playerControlsContainer),i('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 4 15 12 5 20 5 4"></polygon><line x1="19" y1="5" x2="19" y2="19"></line></svg>',()=>{this.nextFrame()},this.playerControlsContainer);let u=i('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>',o=>{t.paused&&t.play()},this.playerControlsContainer);i('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pause"><rect width="4" height="16" x="6" y="4"></rect><rect width="4" height="16" x="14" y="4"></rect></svg>',()=>{t.pause()},this.playerControlsContainer)}let s=document.createElement("input");s.type="color",s.value=at,s.style.margin="5px",this.colorPicker=s,a.appendChild(s);let h=n(),c=document.createElement("input");c.type="number",c.step="1",c.min="1",c.max="10",c.value="5",c.style.margin="5px",h.appendChild(c);let l=u=>{this.ctx.lineWidth=u.target.valueAsNumber,this.focusOnMediaNode()};this.addEvent(c,"input",l);let r=u=>{this.ctx.strokeStyle=u.target.value,this.ctx.fillStyle=u.target.value,this.focusOnMediaNode()};if(this.addEvent(s,"input",r),this.colorPicker=s,this.strokeSizePicker=c,t){this.hide(),this.addEvent(t,"pause",()=>{this.show()}),this.addEvent(t,"seek",()=>{t.paused&&this.show()}),this.addEvent(t,"error",()=>{this.hide()}),this.addEvent(t,"stalled",()=>{this.hide()}),this.addEvent(t,"waiting",()=>{this.hide()}),this.addEvent(t,"ended",()=>{this.hide()}),this.addEvent(t,"play",()=>{this.hideControls(),this.playAnnotationsAsVideo()});let u=o=>{let d=o.target===document.body,m=this.uiContainer.contains(o.target),p=this.playerControlsContainer.contains(o.target),T=this.videoElement.contains(o.target),S=this.canvas.contains(o.target);return m||p||T||S||d};this.addEvent(document,"copy",o=>{var d;u(o)&&(o.preventDefault(),o.stopPropagation(),o.stopImmediatePropagation(),(d=o.clipboardData)==null||d.setData("application/json",JSON.stringify(this.saveCurrentFrame())))}),this.addEvent(document,"cut",o=>{var m;if(!u(o))return;o.preventDefault(),o.stopPropagation(),o.stopImmediatePropagation();let d=this.saveCurrentFrame();this.replaceFrame(this.playbackFrame,[]),this.redrawFullCanvas(),(m=o.clipboardData)==null||m.setData("application/json",JSON.stringify(d))}),this.addEvent(document,"paste",o=>{var T,S,H,W,O;if(!u(o))return;let d=(S=(T=o.clipboardData)==null?void 0:T.types)!=null?S:[];if(console.log("dataTypes",JSON.stringify(d)),d.includes("application/json"))o.preventDefault(),o.stopPropagation(),o.stopImmediatePropagation();else if(d.includes("Files")){let b=(H=o.clipboardData)==null?void 0:H.files;if(b&&b.length>0){let z=b[0];if(z.type.startsWith("image/")){o.preventDefault(),o.stopPropagation(),o.stopImmediatePropagation();let P=new Image;P.addEventListener("load",()=>{let tt=P.naturalWidth/P.naturalHeight,X=.25,et=X/tt*this.aspectRatio;this.addShapesToFrame(this.playbackFrame,[{type:"image",image:P,x:0,y:0,width:X,height:et,strokeStyle:"red",fillStyle:"red",lineWidth:2}]),this.redrawFullCanvas(),requestAnimationFrame(()=>{this.show()}),this.currentTool="move"},{once:!0}),P.src=URL.createObjectURL(z),this.redrawFullCanvas()}}}else if(d.includes("text/plain")){let b=(W=o.clipboardData)==null?void 0:W.getData("text/plain");b&&(console.log("text",b),o.preventDefault(),o.stopPropagation(),o.stopImmediatePropagation(),this.addShapesToFrame(this.playbackFrame,[{type:"text",text:b,x:.4,y:.4,strokeStyle:this.ctx.strokeStyle,fillStyle:this.ctx.fillStyle,lineWidth:this.ctx.lineWidth}]),this.show(),this.currentTool="move",this.redrawFullCanvas())}else return;let m=(O=o.clipboardData)==null?void 0:O.getData("application/json");if(!m)return;let p=JSON.parse(m);p&&p.shapes&&p.version===1&&(this.addShapesToFrame(this.playbackFrame,p.shapes),this.redrawFullCanvas())}),this.addEvent(document,"click",o=>{if(!u(o))return;let d=this.uiContainer.contains(o.target),m=this.playerControlsContainer.contains(o.target);d||m||t.paused||(this.currentTool=null,t.pause())}),this.addEvent(document,"keydown",o=>{u(o)&&(o.key==="ArrowLeft"||o.key==="ArrowRight"?(o.preventDefault(),o.stopPropagation(),o.stopImmediatePropagation(),o.key==="ArrowLeft"?this.prevFrame():o.key==="ArrowRight"&&this.nextFrame()):o.code==="Space"&&(o.preventDefault(),o.stopPropagation(),o.stopImmediatePropagation(),t.paused?t.play():t.pause()))})}}function K(){var a;this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"),(a=this.videoElement.parentNode)==null||a.insertBefore(this.canvas,this.videoElement.nextSibling),this.canvas.style.position="absolute",this.canvas.style.top="0",this.canvas.style.left="0",this.canvas.style.zIndex="1",this.addEvent(this.canvas,"pointerdown",this.handleMouseDown),this.addEvent(this.canvas,"pointermove",this.handleMouseMove),this.addEvent(this.canvas,"pointerup",this.handleMouseUp),this.addEvent(this.canvas,"pointercancel",this.handleMouseUp),this.addEvent(window,"resize",this.setCanvasSize),this.addEvent(document,"keydown",this.onKeyDown)}var g=class{constructor(e){this.startX=0;this.startY=0;this.isDrawing=!1;this.annotationTool=e}get ctx(){return this.annotationTool.ctx}onDeactivate(){}onActivate(){}reset(){this.startX=0,this.startY=0,this.isDrawing=!1}save(e){this.annotationTool.addShape(e)}};var C=class extends g{constructor(){super(...arguments);this.name="rectangle"}normalize(t,i,n){return f(y({},t),{x:t.x/i,y:t.y/n,width:t.width/i,height:t.height/n})}onPointerDown(t){let{x:i,y:n}=this.annotationTool.getRelativeCoords(t);this.startX=i,this.startY=n,this.isDrawing=!0}onPointerMove(t){if(!this.isDrawing)return;let{x:i,y:n}=this.annotationTool.getRelativeCoords(t);this.drawRectangle(this.startX,this.startY,i-this.startX,n-this.startY)}onPointerUp(t){if(!this.isDrawing)return;let{x:i,y:n}=this.annotationTool.getRelativeCoords(t);this.save({type:"rectangle",x:this.startX,y:this.startY,width:i-this.startX,height:n-this.startY,strokeStyle:this.ctx.strokeStyle,fillStyle:this.ctx.fillStyle,lineWidth:this.ctx.lineWidth}),this.drawRectangle(this.startX,this.startY,i-this.startX,n-this.startY),this.isDrawing=!1}drawRectangle(t,i,n,s){this.ctx.beginPath(),this.ctx.rect(t,i,n,s),this.ctx.stroke()}draw(t){this.drawRectangle(t.x,t.y,t.width,t.height)}};var k=class extends g{constructor(){super(...arguments);this.name="circle"}normalize(t,i,n){return f(y({},t),{x:t.x/i,y:t.y/n,radius:t.radius/i})}onPointerDown(t){let{x:i,y:n}=this.annotationTool.getRelativeCoords(t);this.startX=i,this.startY=n,this.isDrawing=!0}onPointerMove(t){if(!this.isDrawing)return;let{x:i,y:n}=this.annotationTool.getRelativeCoords(t),s=Math.sqrt(Math.pow(i-this.startX,2)+Math.pow(n-this.startY,2));this.drawCircle(this.startX,this.startY,s)}onPointerUp(t){if(!this.isDrawing)return;let{x:i,y:n}=this.annotationTool.getRelativeCoords(t),s=Math.sqrt(Math.pow(i-this.startX,2)+Math.pow(n-this.startY,2));this.save({type:"circle",x:this.startX,y:this.startY,radius:s,strokeStyle:this.ctx.strokeStyle,fillStyle:this.ctx.fillStyle,lineWidth:this.ctx.lineWidth}),this.drawCircle(this.startX,this.startY,s),this.isDrawing=!1}drawCircle(t,i,n){this.ctx.beginPath(),this.ctx.arc(t,i,n,0,2*Math.PI),this.ctx.stroke()}draw(t){this.drawCircle(t.x,t.y,t.radius)}};var I=class{constructor(e,t){this.x=e;this.y=t}distanceToLine(e,t){let i=t.x-e.x,n=t.y-e.y,s=Math.abs(n*this.x-i*this.y+t.x*e.y-t.y*e.x),h=Math.sqrt(n*n+i*i);return s/h}};function F(a,e){if(a.length<=2)return a;let t=a[0],i=a[a.length-1],n=-1,s=0;for(let h=1;h<a.length-1;h++){let c=a[h].distanceToLine(t,i);c>s&&(n=h,s=c)}if(s>e){let h=F(a.slice(0,n+1),e),c=F(a.slice(n),e);return h.slice(0,h.length-1).concat(c)}else return[t,i]}var M=class extends g{constructor(){super(...arguments);this.name="curve";this.curvePoints=[]}normalize(t,i,n){return f(y({},t),{points:t.points.map(s=>({x:s.x/i,y:s.y/n}))})}draw(t){this.drawCurve(t)}reset(){super.reset(),this.curvePoints=[]}onPointerDown(t){if(this.isDrawing)return;let{x:i,y:n}=this.annotationTool.getRelativeCoords(t);this.curvePoints=[],this.startX=i,this.startY=n,this.isDrawing=!0,this.curvePoints.push({x:i,y:n})}onPointerMove(t){if(!this.isDrawing)return;let{x:i,y:n}=this.annotationTool.getRelativeCoords(t);this.curvePoints.push({x:i,y:n}),this.drawCurve({points:this.curvePoints,lineWidth:this.ctx.lineWidth})}onPointerUp(t){if(!this.isDrawing)return;let{x:i,y:n}=this.annotationTool.getRelativeCoords(t);this.curvePoints.push({x:i,y:n});let s=this.curvePoints.map(v=>new I(v.x,v.y)),r={type:"curve",points:F(s,2).map(v=>({x:v.x,y:v.y})),strokeStyle:this.ctx.strokeStyle,fillStyle:this.ctx.fillStyle,lineWidth:this.ctx.lineWidth};this.save(r),this.curvePoints=[],this.isDrawing=!1}drawCurve(t){if(t.points.length===2&&t.points[0].x===t.points[1].x&&t.points[0].y===t.points[1].y){let i=t.lineWidth/4,n=0,s=2*Math.PI;this.ctx.beginPath(),this.ctx.arc(t.points[0].x,t.points[0].y,i,n,s),this.ctx.stroke()}else{this.ctx.beginPath(),this.ctx.moveTo(t.points[0].x,t.points[0].y);for(let i=1;i<t.points.length-1;i++){let n=t.points[i],s=t.points[i+1];this.ctx.quadraticCurveTo(n.x,n.y,s.x,s.y)}this.ctx.stroke()}}};var D=class extends g{constructor(){super(...arguments);this.name="line"}normalize(t,i,n){return f(y({},t),{x1:t.x1/i,y1:t.y1/n,x2:t.x2/i,y2:t.y2/n})}onPointerDown(t){let{x:i,y:n}=this.annotationTool.getRelativeCoords(t);this.startX=i,this.startY=n,this.isDrawing=!0}onPointerMove(t){if(!this.isDrawing)return;let{x:i,y:n}=this.annotationTool.getRelativeCoords(t);this.drawLine(this.startX,this.startY,i,n)}onPointerUp(t){if(!this.isDrawing)return;let{x:i,y:n}=this.annotationTool.getRelativeCoords(t);this.save({type:"line",x1:this.startX,y1:this.startY,x2:i,y2:n,fillStyle:this.ctx.fillStyle,strokeStyle:this.ctx.strokeStyle,lineWidth:this.ctx.lineWidth}),this.drawLine(this.startX,this.startY,i,n),this.isDrawing=!1}drawLine(t,i,n,s){this.ctx.beginPath(),this.ctx.moveTo(t,i),this.ctx.lineTo(n,s),this.ctx.stroke()}draw(t){this.drawLine(t.x1,t.y1,t.x2,t.y2)}};var L=class extends g{constructor(){super(...arguments);this.name="arrow"}normalize(t,i,n){return f(y({},t),{x1:t.x1/i,y1:t.y1/n,x2:t.x2/i,y2:t.y2/n})}draw(t){this.drawArrow(t.x1,t.y1,t.x2,t.y2)}onPointerDown(t){let{x:i,y:n}=this.annotationTool.getRelativeCoords(t);this.startX=i,this.startY=n,this.isDrawing=!0}onPointerMove(t){if(!this.isDrawing)return;let{x:i,y:n}=this.annotationTool.getRelativeCoords(t);this.drawArrow(this.startX,this.startY,i,n)}onPointerUp(t){if(!this.isDrawing)return;this.isDrawing=!1;let{x:i,y:n}=this.annotationTool.getRelativeCoords(t);this.save({type:"arrow",x1:this.startX,y1:this.startY,x2:i,y2:n,strokeStyle:this.ctx.strokeStyle,fillStyle:this.ctx.fillStyle,lineWidth:this.ctx.lineWidth})}drawArrow(t,i,n,s){let h=10+2.5*this.ctx.lineWidth,c=Math.PI/6,l=Math.atan2(s-i,n-t);this.ctx.beginPath(),this.ctx.moveTo(t,i),this.ctx.lineTo(n,s),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(n,s),this.ctx.lineTo(n-h*Math.cos(l+c),s-h*Math.sin(l+c)),this.ctx.moveTo(n,s),this.ctx.lineTo(n-h*Math.cos(l-c),s-h*Math.sin(l-c)),this.ctx.stroke()}};var B=class extends g{constructor(){super(...arguments);this.name="text"}onActivate(){this.annotationTool.canvas.style.cursor="text",this.isDrawing=!0}onDeactivate(){this.annotationTool.canvas.style.cursor="default",this.isDrawing=!1}draw(t){let i=t.text.split(`
`);for(let n=0;n<i.length;n++)this.drawText(t.x,t.y+n*20,i[n])}drawText(t,i,n){let s=16+this.ctx.lineWidth*.5;this.ctx.font=`${s}px Helvetica Neue, Arial`,this.ctx.fillText(n,t,i)}onPointerDown(t){let{x:i,y:n}=this.annotationTool.getRelativeCoords(t);this.startX=i,this.startY=n}onPointerMove(t){let{x:i,y:n}=this.annotationTool.getRelativeCoords(t);this.ctx.beginPath(),this.ctx.arc(i,n,5,0,2*Math.PI),this.ctx.fill()}normalize(t,i,n){return f(y({},t),{x:t.x/i,y:t.y/n})}onPointerUp(t){let{x:i,y:n}=this.annotationTool.getRelativeCoords(t),s=prompt("Enter the text to be drawn:");s!==null&&this.save({type:"text",x:i,y:n,text:s,strokeStyle:this.ctx.strokeStyle,fillStyle:this.ctx.fillStyle,lineWidth:this.ctx.lineWidth})}};var R=class extends g{constructor(){super(...arguments);this.name="eraser"}normalize(t,i,n){return f(y({},t),{x:t.x/i,y:t.y/n,width:t.width/i,height:t.height/n})}draw(t){this.drawEraser(t.x,t.y,t.width,t.height)}onPointerDown(t){let{x:i,y:n}=this.annotationTool.getRelativeCoords(t);this.startX=i,this.startY=n,this.isDrawing=!0}onPointerMove(t){if(!this.isDrawing)return;let{x:i,y:n}=this.annotationTool.getRelativeCoords(t);this.ctx.save(),this.ctx.strokeStyle="rgba(255, 255, 255, 0.5)",this.ctx.lineWidth=1,this.ctx.fillStyle="rgba(255, 255, 255, 0.3)",this.ctx.fillRect(this.startX,this.startY,i-this.startX,n-this.startY),this.ctx.strokeRect(this.startX,this.startY,i-this.startX,n-this.startY),this.ctx.restore()}onPointerUp(t){if(!this.isDrawing)return;this.isDrawing=!1;let{x:i,y:n}=this.annotationTool.getRelativeCoords(t);this.save({type:"eraser",x:this.startX,y:this.startY,width:i-this.startX,height:n-this.startY,strokeStyle:this.ctx.strokeStyle,fillStyle:this.ctx.fillStyle,lineWidth:this.ctx.lineWidth})}drawEraser(t,i,n,s){this.ctx.clearRect(t,i,n,s)}};var A=class extends g{constructor(){super(...arguments);this.name="move";this.shape=null;this.lastDrawnShape=null;this.shapeRemoved=!1}normalize(t){return y({},t)}onPointerDown(t){let{x:i,y:n}=this.annotationTool.getRelativeCoords(t),s=this.annotationTool.shapes.slice(0).pop();s&&(this.shape=s,this.shapeRemoved=!1,this.lastDrawnShape=null,this.startX=i,this.startY=n,this.isDrawing=!0)}onPointerMove(t){if(!this.isDrawing||!this.shape)return;this.shapeRemoved||(this.annotationTool.removeLastShape(),this.shapeRemoved=!0);let{x:i,y:n}=this.annotationTool.getRelativeCoords(t),s=i-this.startX,h=n-this.startY;this.startX=i-s,this.startY=n-h;let c=["line","image","circle","rectangle","text","arrow","curve","eraser"],l=this.annotationTool.deserialize([this.shape])[0],r=l.type==="image"?l:JSON.parse(JSON.stringify(l));r.type==="line"?(r.x1+=s,r.y1+=h,r.x2+=s,r.y2+=h):r.type==="circle"||r.type==="rectangle"||r.type==="text"?(r.x+=s,r.y+=h):r.type==="arrow"?(r.x1+=s,r.y1+=h,r.x2+=s,r.y2+=h):r.type==="curve"?r.points.forEach(v=>{v.x+=s,v.y+=h}):(r.type==="eraser"||r.type==="image")&&(r.x+=s,r.y+=h),this.lastDrawnShape=r,c.includes(r.type)&&this.annotationTool.pluginForTool(r.type).draw(r)}onPointerUp(t){!this.isDrawing||!this.lastDrawnShape||(this.lastDrawnShape&&(this.lastDrawnShape.fillStyle=this.annotationTool.ctx.fillStyle,this.lastDrawnShape.strokeStyle=this.annotationTool.ctx.strokeStyle,this.lastDrawnShape.lineWidth=this.annotationTool.ctx.lineWidth,this.save(this.lastDrawnShape)),this.isDrawing=!1,this.shape=null,this.shapeRemoved=!1,this.lastDrawnShape=null)}draw(){throw new Error("Method not implemented.")}reset(){this.isDrawing=!1,this.shape=null,this.lastDrawnShape=null,this.shapeRemoved=!1}};var N=class extends g{constructor(){super(...arguments);this.name="image"}onPointerDown(t){}onPointerMove(t){}onPointerUp(t){}normalize(t,i,n){return f(y({},t),{x:t.x/i,y:t.y/n,width:t.width/i,height:t.height/n})}draw(t){if(!(t.image instanceof HTMLImageElement)){console.error("Image is not an instance of HTMLImageElement");return}this.ctx.drawImage(t.image,t.x,t.y,t.width,t.height)}};var q=[C,k,D,L,B,R,M,A,N];function J(a,e){let t,i,n,s=[],h=!0;function c(v,w){let u=Math.abs(w.mediaTime-t),o=Math.abs(w.presentedFrames-i),d=u/o;d&&d<1&&h&&s.length<50&&a.playbackRate===1&&document.hasFocus()&&(s.push(d),n=Math.round(1/r()),e(n,s.length*2)),h=!0,t=w.mediaTime,i=w.presentedFrames,a.requestVideoFrameCallback(c)}a.requestVideoFrameCallback(c);let l=()=>{s.pop(),h=!1};a.addEventListener("seeked",l);function r(){return s.reduce((v,w)=>v+w)/s.length}return()=>{a.removeEventListener("seeked",l)}}var _=25,E=class{constructor(e){this.isMouseDown=!1;this.activeTimeFrame=1;this.buttons=[];this.destructors=[];this.plugins=[];this.isDestroyed=!1;this.timeStack=new Map;this.undoTimeStack=new Map;this.annotatedFrameCoordinates=[];this.fps=_;this.lastNavigatedFrame=0;this.isProgressBarNavigation=!1;this.plugins=q.map(t=>new t(this)),this.init(e)}prevFrame(){let e=this.activeTimeFrame,t=Math.max(1,e-1);this.playbackFrame=t}nextFrame(){let e=this.activeTimeFrame,t=Math.min(this.videoElement.duration*this.fps,e+1);this.playbackFrame=t}get selectedColor(){return this.colorPicker.value}get selectedStrokeSize(){return this.strokeSizePicker.valueAsNumber}get currentTool(){return this._currentTool}set currentTool(e){let t=this._currentTool;t&&(this.getButtonForTool(t).classList.remove("active"),this.pluginForTool(t).onDeactivate()),this._currentTool=e,this.canvas.style.cursor=e?"pointer":"default",e&&(this.getButtonForTool(e).classList.add("active"),this.pluginForTool(e).onActivate())}enableFrameRateDetection(){if(this.destructors.find(i=>i.name==="frameRateDetector"))return;let e=this.videoElement;if(e.tagName==="IMG")return;let t=J(e,i=>{this.fps=i});Object.defineProperty(t,"name",{value:"frameRateDetector"}),this.destructors.push(t)}get playbackFrame(){if(this.videoElement instanceof HTMLImageElement)return 1;let e=Math.round(this.videoElement.currentTime*this.fps);return Math.max(1,e)}set playbackFrame(e){if(this.videoElement instanceof HTMLImageElement)return;let t=e/this.fps;this.videoElement.currentTime=t,this.show()}get canvasWidth(){return this.canvas.width/this.pixelRatio}get canvasHeight(){return this.canvas.height/this.pixelRatio}get aspectRatio(){return this.canvasWidth/this.canvasHeight}get isMobile(){return window.innerWidth<960}get progressBarCoordinates(){let e=this.isMobile?30:10,t=5,i=55,n=this.canvasWidth-t-i,s=t,h=this.canvasHeight-e;return{x:s,y:h,width:n,height:e}}get videoClientRect(){return this.videoElement.getBoundingClientRect()}get shapes(){return this.timeStack.has(this.activeTimeFrame)||this.timeStack.set(this.activeTimeFrame,[]),this.timeStack.get(this.activeTimeFrame)}set shapes(e){this.timeStack.set(this.activeTimeFrame,e)}get undoStack(){return this.undoTimeStack.has(this.activeTimeFrame)||this.undoTimeStack.set(this.activeTimeFrame,[]),this.undoTimeStack.get(this.activeTimeFrame)}set undoStack(e){this.undoTimeStack.set(this.activeTimeFrame,e)}get pixelRatio(){return window.devicePixelRatio||1}hide(){this.stopAnnotationsAsVideo(),this.hideControls(),this.hideCanvas()}showControls(){this.uiContainer.style.display="block"}hideControls(){this.uiContainer.style.display="none"}showCanvas(){this.canvas.style.display="block"}hideCanvas(){this.canvas.style.display="none"}show(){this.stopAnnotationsAsVideo(),this.activeTimeFrame=this.playbackFrame,this.showCanvas(),this.showControls(),this.redrawFullCanvas()}setCanvasSettings(){this.ctx.strokeStyle=this.selectedColor,this.ctx.fillStyle=this.selectedColor,this.ctx.lineWidth=this.selectedStrokeSize}pluginForTool(e){if(this.isDestroyed)throw new Error("AnnotationTool is destroyed");let t=this.plugins.find(i=>i.name===e);if(!t)throw new Error(`No plugin found for tool ${e}`);return t}getButtonForTool(e){return this.buttons.find(t=>t.dataset.tool===e)}bindContext(){this.handleMouseDown=this.handleMouseDown.bind(this),this.handleMouseMove=this.handleMouseMove.bind(this),this.handleMouseUp=this.handleMouseUp.bind(this),this.setCanvasSize=this.setCanvasSize.bind(this),this.onKeyDown=this.onKeyDown.bind(this)}initProperties(){this.isDestroyed=!1,this.isProgressBarNavigation=!1,this.currentTool=null,this.shapes=[]}init(e){this.videoElement=e,this.bindContext(),this.initCanvas(),this.initUI(),this.initProperties(),this.setCanvasSize(),this.fillCanvas(),this.setCanvasSettings(),this.currentTool=this.isMobile?null:"curve"}addEvent(e,t,i){let n=s=>{this.isDestroyed||i(s)};e.addEventListener(t,n),this.destructors.push(()=>{e.removeEventListener(t,n)})}initCanvas(){throw new Error("Method not implemented.")}onKeyDown(e){(e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==="z"&&this.handleUndo()}removeLastShape(){this.shapes.pop(),this.redrawFullCanvas()}handleUndo(){this.undoStack.length>0&&(this.shapes=this.undoStack.pop(),this.redrawFullCanvas())}destroy(){var n,s,h,c,l;if(this.isDestroyed)return;this.destructors.forEach(r=>r()),this.stopAnnotationsAsVideo(),this.destructors=[],this._currentTool=null,this.plugins.forEach(r=>r.reset()),this.annotatedFrameCoordinates=[],this.setFrameRate(_),this.cleanFrameStacks();let e=this.strokeSizePicker.parentElement;(n=e==null?void 0:e.parentNode)==null||n.removeChild(e);let t=this.colorPicker.parentElement;(s=t==null?void 0:t.parentNode)==null||s.removeChild(t),this.buttons.forEach(r=>{var v;(v=r.parentNode)==null||v.removeChild(r)}),this.buttons=[],(h=this.uiContainer.parentNode)==null||h.removeChild(this.uiContainer),(c=this.canvas.parentNode)==null||c.removeChild(this.canvas),(l=this.playerControlsContainer.parentElement)==null||l.removeChild(this.playerControlsContainer),["strokeSizePicker","colorPicker","uiContainer","playerControlsContainer","canvas","ctx","videoElement"].forEach(r=>{delete this[r]}),this.activeTimeFrame=0}setCanvasSize(){let e=this.videoClientRect;this.canvas.width=e.width*this.pixelRatio,this.canvas.height=e.height*this.pixelRatio,this.canvas.style.width=`${e.width}px`,this.canvas.style.height=`${e.height}px`,this.ctx.scale(this.pixelRatio,this.pixelRatio),this.redrawFullCanvas(),this.setCanvasSettings()}isMultiTouch(e){return e.pointerType==="touch"&&e.isPrimary===!1}addShape(e){let t=this.serialize([e])[0];this.undoStack.push([...this.shapes]),this.shapes.push(t)}serialize(e=this.shapes){let t=this.canvasWidth,i=this.canvasHeight;return e.map(n=>this.pluginForTool(n.type).normalize(n,t,i))}deserialize(e){let t=1/this.canvasWidth,i=1/this.canvasHeight;return e.map(n=>this.pluginForTool(n.type).normalize(n,t,i))}getRelativeCoords(e){let t=this.canvas.getBoundingClientRect();return{x:this.getEventX(e)-t.left,y:this.getEventY(e)-t.top}}handleMouseDown(e){if(e.preventDefault(),this.isMouseDown=!0,this.isMultiTouch(e))return;let t=this.frameFromProgressBar(e,!0);if(t){this.isProgressBarNavigation=!0;let i=this.getAnnotationFrame(e);this.isVideoPaused&&(i!==null?this.playbackFrame=i:this.playbackFrame=t);return}this.currentTool&&this.pluginForTool(this.currentTool).onPointerDown(e)}get isDrawing(){return this.currentTool?this.pluginForTool(this.currentTool).isDrawing:!1}get isVideoPaused(){return this.videoElement.tagName==="VIDEO"?this.videoElement.paused:!0}handleMouseMove(e){if(e.preventDefault(),!this.isMultiTouch(e)){if(this.isMouseDown){let t=this.isProgressBarNavigation?this.frameFromProgressBar(e,!1):null;if(t!==null&&!this.isDrawing){if(t===this.lastNavigatedFrame)return;this.lastNavigatedFrame=t,this.isVideoPaused&&(this.playbackFrame=t);return}else this.hideControls(),this.clearCanvas(),this.addVideoOverlay(),this.drawShapesOverlay()}else this.redrawFullCanvas();this.currentTool&&this.pluginForTool(this.currentTool).onPointerMove(e)}}getEventX(e){return e.clientX}getEventY(e){return e.clientY}handleMouseUp(e){this.isMouseDown=!1,this.isProgressBarNavigation=!1,this.showControls(),!this.isMultiTouch(e)&&(this.currentTool&&this.pluginForTool(this.currentTool).onPointerUp(e),this.redrawFullCanvas())}focusOnMediaNode(){this.videoElement.focus()}drawShapesOverlay(){let e={strokeStyle:this.ctx.strokeStyle,fillStyle:this.ctx.fillStyle,lineWidth:this.ctx.lineWidth};this.deserialize(this.shapes).forEach(t=>{this.ctx.strokeStyle=t.strokeStyle,this.ctx.fillStyle=t.fillStyle,this.ctx.lineWidth=t.lineWidth;try{this.pluginForTool(t.type).draw(t)}catch(i){console.error(i)}}),this.ctx.strokeStyle=e.strokeStyle,this.ctx.fillStyle=e.fillStyle,this.ctx.lineWidth=e.lineWidth}clearCanvas(){this.ctx.clearRect(0,0,this.canvasWidth,this.canvasHeight)}frameToDataUrl(){try{this.clearCanvas(),this.addVideoOverlay(),this.addFrameSquareOverlay(),this.drawShapesOverlay();let e=this.canvas.toDataURL("image/png");return this.redrawFullCanvas(),e}catch(e){return console.error(e),null}}redrawFullCanvas(){this.clearCanvas(),this.addVideoOverlay(),this.drawShapesOverlay(),this.addFrameSquareOverlay(),this.addProgressBarOverlay()}replaceFrame(e,t){this.timeStack.set(e,this.parseShapes(this.stringifyShapes(t)))}addShapesToFrame(e,t){let i=this.timeStack.get(e)||[];this.timeStack.set(e,[...i,...this.parseShapes(this.stringifyShapes(t))])}setFrameRate(e){var t;(t=this.destructors.find(i=>i.name==="frameRateDetector"))==null||t(),this.fps=e}stringifyShapes(e){return JSON.stringify(e,(t,i)=>t==="image"?i.src:i)}parseShapes(e){return JSON.parse(e,(t,i)=>{if(t==="image"){let n=new Image;return n.src=i,n}return i})}filterNonSerializableShapes(e){return e.filter(t=>t.type!=="image")}saveCurrentFrame(){return{frame:this.playbackFrame,version:1,fps:this.fps,shapes:this.parseShapes(this.stringifyShapes(this.filterNonSerializableShapes(this.shapes)))}}addFrameSquareOverlay(e=this.activeTimeFrame){throw new Error("Method not implemented.")}addVideoOverlay(){throw new Error("Method not implemented.")}cleanFrameStacks(){this.timeStack.clear(),this.undoTimeStack.clear()}loadAllFrames(e){this.cleanFrameStacks(),e.forEach(t=>{this.timeStack.set(t.frame,t.shapes)})}appendFrames(e){e.forEach(t=>{this.addShapesToFrame(t.frame,t.shapes)})}saveAllFrames(){return Array.from(this.timeStack.keys()).filter(n=>{var s;return(s=this.timeStack.get(n))==null?void 0:s.length}).map(n=>{var s;return{frame:n,fps:this.fps,version:1,shapes:this.filterNonSerializableShapes((s=this.timeStack.get(n))!=null?s:[])}})}getAnnotationFrame(e){var h,c;let t=e.offsetX,i=e.offsetY,n=this.isMobile?10:5;return(c=(h=this.annotatedFrameCoordinates.find(l=>t>=l.x-n&&t<=l.x+n&&i>=l.y-n&&i<=l.y+n))==null?void 0:h.frame)!=null?c:null}frameFromProgressBar(e,t=!0){let i=this.videoElement;if(i.tagName!=="VIDEO")return null;let{x:n,width:s,height:h,y:c}=this.progressBarCoordinates,l=e.offsetX,r=e.offsetY;return t?l>=n&&l<=n+s&&r>=c&&r<=c+h?Math.ceil((l-n)/s*(i.duration*this.fps)):null:l>=n&&l<=n+s?Math.ceil((l-n)/s*(i.duration*this.fps)):null}addProgressBarOverlay(){throw new Error("Method not implemented.")}initUI(){throw new Error("Method not implemented.")}stopAnnotationsAsVideo(){clearTimeout(this.playTimeout)}hasAnnotationsForFrame(e){if(this.timeStack.has(e)){let t=this.timeStack.get(e);return t&&t.length>0}return!1}playAnnotationsAsVideo(){this.stopAnnotationsAsVideo();let e=this.playbackFrame;this.hasAnnotationsForFrame(e)?(this.showCanvas(),this.activeTimeFrame=e,this.clearCanvas(),this.drawShapesOverlay()):this.hideCanvas();let t=1e3/this.fps;this.playTimeout=window.setTimeout(()=>{this.playAnnotationsAsVideo()},t)}fillCanvas(){this.ctx.save(),this.ctx.fillStyle="rgba(0, 0, 0, 0.5)",this.ctx.fillRect(0,0,this.canvasWidth,this.canvasHeight),this.ctx.restore()}};function $(a=this.activeTimeFrame){this.ctx.save(),this.ctx.fillStyle="rgba(0, 0, 0, 0.5)";let e=50,t=30,i=20;this.ctx.fillRect(this.canvasWidth-e,this.canvasHeight-t,e,t),this.ctx.fillStyle="white",this.ctx.font=`${i}px sans-serif`,this.ctx.fillText(`${a}`.padStart(3,"0"),this.canvasWidth-40,this.canvasHeight-7),this.ctx.restore()}function G(){this.ctx.drawImage(this.videoElement,0,0,this.canvas.width/this.pixelRatio,this.canvas.height/this.pixelRatio)}function Z(){let a=this.videoElement;if(a.tagName!=="VIDEO")return;this.annotatedFrameCoordinates=[];let t=Array.from(this.timeStack.keys()).filter(d=>{var m;return(m=this.timeStack.get(d))==null?void 0:m.length}),i=a.duration*this.fps,{x:n,width:s,height:h,y:c}=this.progressBarCoordinates,l=t.map(d=>Math.ceil(d/i*s));this.ctx.save(),this.ctx.fillStyle="rgba(0, 0, 0, 0.5)",this.ctx.fillRect(n,c,s,h),this.ctx.fillStyle="#F3CE32";let r=this.isMobile?16:8;l.forEach((d,m)=>{this.ctx.beginPath();let p=n+d,T=this.canvasHeight-h/2;this.ctx.fillRect(p-r/2,T-r/2,r,r),this.annotatedFrameCoordinates.push({x:p,y:T,frame:t[m]})});let v=this.playbackFrame,w=Math.ceil(v/i*s)+n;this.ctx.fillStyle="white",this.ctx.beginPath();let u=w,o=this.canvasHeight-h/2;this.ctx.beginPath(),this.ctx.fillRect(u-r/2,o-r/2,r,r),this.ctx.fill(),this.ctx.restore()}E.prototype.initUI=j;E.prototype.initCanvas=K;E.prototype.addFrameSquareOverlay=$;E.prototype.addVideoOverlay=G;E.prototype.addProgressBarOverlay=Z;new EventSource("/esbuild").addEventListener("change",()=>location.reload());var x=document.querySelector("video");function Q(){return V(this,null,function*(){let a=window.getComputedStyle(x),e=parseFloat(a.width),t=parseFloat(a.height),i=window.innerHeight-80;if(t>i){let o=e/t,d=i,m=d*o;x.style.width=`${m}px`,x.style.height=`${d}px`}let n=yield fetch(x.currentSrc).then(o=>o.blob()),s=new Promise(o=>{setTimeout(()=>{o(!0)},250),x.addEventListener("loadeddata",()=>{o(!0)},{once:!0})}),h=yield fetch("./frame_29.png").then(o=>V(this,null,function*(){let d=yield o.blob(),m=new Blob([d],{type:"image/png"}),p=new Image,T=new Promise(S=>{p.addEventListener("load",()=>{S(!0)},{once:!0})});return p.src=window.URL.createObjectURL(m),yield T,p}));x.paused||x.pause();let c=new Blob([n],{type:"video/mp4"});x.src=window.URL.createObjectURL(c),yield s;let l=new E(x);console.log({tool:l}),l.addShapesToFrame(29,[{type:"image",image:h,x:0,y:0,width:1,height:1,strokeStyle:"red",lineWidth:2,fillStyle:"red"}]),x.paused||x.pause(),setInterval(()=>{l.destroy(),l.init(x)},1e8),setInterval(()=>{console.log(l.saveAllFrames())},1e5);let r=document.getElementById("file"),v=document.getElementById("download"),w=document.getElementById("sample");document.getElementById("save-image").addEventListener("click",o=>{o.stopPropagation(),o.preventDefault();let d=l.frameToDataUrl();if(!d)return;let m=l.activeTimeFrame,p=document.createElement("a");p.href=d,p.download=`frame_${String(m).padStart(3,"0")}.png`,p.click()}),w.addEventListener("click",o=>{o.stopPropagation(),o.preventDefault(),fetch("./annotations-sample.json").then(d=>d.json()).then(d=>{l.loadAllFrames(d),l.redrawFullCanvas()})}),r.addEventListener("change",o=>{if(!r.files||r.files.length===0)return;let d=r.files[0],m=new FileReader;m.onload=p=>{if(!p.target)return;let T=p.target.result,S=JSON.parse(T);confirm("Append to existing annotations?")?l.appendFrames(S):l.loadAllFrames(S),l.redrawFullCanvas()},m.readAsText(d)}),v.addEventListener("click",o=>{o.stopPropagation(),o.preventDefault();let d=l.saveAllFrames(),m=document.createElement("a");m.href=URL.createObjectURL(new Blob([JSON.stringify(d)],{type:"application/json"}));let p=new Date().toISOString().replace(/:/g,"-");m.download=`annotations-${p}.json`,m.click()})})}x.readyState===0?x.addEventListener("loadedmetadata",()=>{requestAnimationFrame(()=>{Q()})},{once:!0}):Q();})();
