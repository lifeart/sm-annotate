"use strict";(()=>{var dt=Object.defineProperty,mt=Object.defineProperties;var ut=Object.getOwnPropertyDescriptors;var z=Object.getOwnPropertySymbols;var pt=Object.prototype.hasOwnProperty,vt=Object.prototype.propertyIsEnumerable;var U=(s,n,t)=>n in s?dt(s,n,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[n]=t,f=(s,n)=>{for(var t in n||(n={}))pt.call(n,t)&&U(s,t,n[t]);if(z)for(var t of z(n))vt.call(n,t)&&U(s,t,n[t]);return s},w=(s,n)=>mt(s,ut(n));var g=(s,n,t)=>new Promise((e,i)=>{var o=r=>{try{l(t.next(r))}catch(h){i(h)}},a=r=>{try{l(t.throw(r))}catch(h){i(h)}},l=r=>r.done?e(r.value):Promise.resolve(r.value).then(o,a);l((t=t.apply(s,n)).next())});var b=(s,n)=>{let t=s.target===document.body,e=n.uiContainer.contains(s.target),i=n.playerControlsContainer.contains(s.target),o=n.videoElement.contains(s.target),a=n.canvas.contains(s.target);return e||i||o||a||t};function P(s){return s.pointerType==="touch"&&s.isPrimary===!1}function j(s,n){if(!b(s,n))return;let t=n.uiContainer.contains(s.target),e=n.playerControlsContainer.contains(s.target);if(t||e)return;let i=n.videoElement;i.tagName==="VIDEO"&&(i.paused||(n.currentTool=null,i.pause(),n.withRefVideo(o=>{o.pause()}),n.raf(()=>g(this,null,function*(){n.syncTime(),n.redrawFullCanvas()}))))}function X(s,n){var t;b(s,n)&&(s.preventDefault(),s.stopPropagation(),s.stopImmediatePropagation(),(t=s.clipboardData)==null||t.setData("application/json",JSON.stringify(n.saveCurrentFrame())))}function Y(s,n){var e;if(!b(s,n))return;s.preventDefault(),s.stopPropagation(),s.stopImmediatePropagation();let t=n.saveCurrentFrame();n.replaceFrame(n.playbackFrame,[]),n.redrawFullCanvas(),(e=s.clipboardData)==null||e.setData("application/json",JSON.stringify(t))}function q(s,n){if(!b(s,n))return;let t=n.videoElement;t.tagName==="VIDEO"&&(s.key==="ArrowLeft"||s.key==="ArrowRight"?(s.preventDefault(),s.stopPropagation(),s.stopImmediatePropagation(),s.key==="ArrowLeft"?n.prevFrame():s.key==="ArrowRight"&&n.nextFrame()):s.code==="Space"&&(s.preventDefault(),s.stopPropagation(),s.stopImmediatePropagation(),t.paused?(n.withRefVideo(e=>{e.play().then(()=>{n.syncTime(),n.redrawFullCanvas()})}),t.play().then(()=>{n.syncTime(),n.redrawFullCanvas()})):(n.withRefVideo(e=>{e.pause()}),t.pause(),n.raf(()=>{n.syncTime(),n.redrawFullCanvas()}))))}function K(s,n){var o,a,l,r,h;if(!b(s,n))return;let t=(a=(o=s.clipboardData)==null?void 0:o.types)!=null?a:[];if(t.includes("application/json"))s.preventDefault(),s.stopPropagation(),s.stopImmediatePropagation();else if(t.includes("Files")){let m=(l=s.clipboardData)==null?void 0:l.files;if(m&&m.length>0){let d=m[0];if(d.type.startsWith("image/")){s.preventDefault(),s.stopPropagation(),s.stopImmediatePropagation();let c=new Image;c.addEventListener("load",()=>{let u=c.naturalWidth/c.naturalHeight,p=.25,v=p/u*n.aspectRatio;n.addShapesToFrame(n.playbackFrame,[{type:"image",image:c,x:0,y:0,width:p,height:v,strokeStyle:"red",fillStyle:"red",lineWidth:2}]),n.redrawFullCanvas(),n.raf(()=>{n.show()}),n.currentTool="move"},{once:!0}),c.src=URL.createObjectURL(d),n.redrawFullCanvas()}}}else if(t.includes("text/plain")){let m=(r=s.clipboardData)==null?void 0:r.getData("text/plain");m&&(s.preventDefault(),s.stopPropagation(),s.stopImmediatePropagation(),n.addShapesToFrame(n.playbackFrame,[{type:"text",text:m,x:.4,y:.4,strokeStyle:n.ctx.strokeStyle,fillStyle:n.ctx.fillStyle,lineWidth:n.ctx.lineWidth}]),n.show(),n.currentTool="move",n.redrawFullCanvas())}else return;let e=(h=s.clipboardData)==null?void 0:h.getData("application/json");if(!e)return;let i=JSON.parse(e);i&&i.shapes&&i.version===1&&(n.addShapesToFrame(n.playbackFrame,i.shapes),n.redrawFullCanvas())}function $(s,n){let t=document.createElement("button");t.type="button",t.style.margin="5px",t.style.float="right",t.title="Download current frame",t.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-image"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"></rect><circle cx="9" cy="9" r="2"></circle><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"></path></svg>',n.addEvent(t,"click",()=>{let e=n.frameToDataUrl();if(!e)return;let i=document.createElement("a");i.download=`frame_${String(n.activeTimeFrame).padStart(3,"0")}.png`,i.href=e,i.click()}),n.buttons.push(t),n.playerControlsContainer.appendChild(t)}var _='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-volume-x"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><line x1="22" x2="16" y1="9" y2="15"></line><line x1="16" x2="22" y1="9" y2="15"></line></svg>',J='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-volume-2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path><path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path></svg>';function G(s,n){let t=document.createElement("button");t.type="button",t.style.margin="5px",s.muted||s.volume===0?t.innerHTML=J:t.innerHTML=_,n.addEvent(s,"volumechange",()=>{s.muted||s.volume===0?t.innerHTML=_:t.innerHTML=J}),n.addEvent(t,"click",()=>{s.muted&&(s.muted=!1),s.volume===0?s.volume=1:s.volume=0}),n.buttons.push(t),n.playerControlsContainer.appendChild(t)}var Z='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>',gt='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pause"><rect width="4" height="16" x="6" y="4"></rect><rect width="4" height="16" x="14" y="4"></rect></svg>';function Q(s,n){let t=document.createElement("button");t.type="button",t.innerHTML=Z,t.style.margin="5px",n.addEvent(s,"play",()=>{t.innerHTML=gt}),n.addEvent(s,"pause",()=>{t.innerHTML=Z,n.syncTime()}),n.addEvent(t,"click",()=>{s.paused?(n.withRefVideo(e=>{e.paused&&e.play().then(()=>{n.syncTime()})}),s.play().then(()=>{n.syncTime()})):(n.withRefVideo(e=>{e.paused||e.pause()}),s.pause(),n.raf(()=>{n.syncTime(),n.redrawFullCanvas()}))}),n.buttons.push(t),n.playerControlsContainer.appendChild(t)}function tt(s){return`<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-superscript">
        <style>
            .small {
                font-family: auto;
                font-size: ${s===1?"16":"24"}px;
            }
        </style>
        <text x="${s===1?3:2}" y="${s===1?17:20}" font-weight="normal" class="small">${{"0.25":"\xBC","0.5":"\xBD","0.75":"\xBE",1:"1\xD7"}[String(s)]}</text>
        
    </svg>`}function et(s,n){let t=[.25,.5,.75,1],e=document.createElement("button"),i=t[t.length-1];e.type="button",s.playbackRate=i,n.withRefVideo(o=>{o.playbackRate=i}),e.innerHTML=tt(i),e.style.margin="5px",n.addEvent(e,"click",()=>{let o=t.indexOf(s.playbackRate),a=o+1>=t.length?0:o+1;s.playbackRate=t[a],n.withRefVideo(l=>{l.playbackRate=t[a]}),e.innerHTML=tt(t[a])}),n.buttons.push(e),n.playerControlsContainer.appendChild(e)}var yt="#F3CE32";function it(){var m,d;let s=document.createElement("div");s.style.position="absolute",s.style.top="-40px",s.style.left="0",s.style.zIndex="2",(m=this.canvas.parentNode)==null||m.insertBefore(s,this.canvas);let n=document.createElement("div");n.style.position="relative",n.style.top="0",n.style.left="0",n.style.zIndex="2",(d=this.canvas.parentNode)==null||d.insertBefore(n,this.canvas.nextSibling),this.playerControlsContainer=n;let t=this.videoElement.tagName==="VIDEO"?this.videoElement:null;this.uiContainer=s;let e=(c,u,p=s)=>{let v=document.createElement("button");if(v.type="button",v.innerHTML=c,v.style.margin="5px",p.appendChild(v),this.buttons.push(v),typeof u=="function")this.addEvent(v,"click",u);else{v.dataset.tool=u;let x=()=>{this.currentTool===u?this.currentTool=null:this.currentTool=u};this.addEvent(v,"click",x)}return v},i=()=>{let c=document.createElement("div");return c.style.display="inline-flex",c.style.alignItems="center",c.style.margin="5px",s.appendChild(c),c};e('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></svg>',"rectangle"),e('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle></svg>',"circle"),e('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.3 8.7 8.7 21.3c-1 1-2.5 1-3.4 0l-2.6-2.6c-1-1-1-2.5 0-3.4L15.3 2.7c1-1 2.5-1 3.4 0l2.6 2.6c1 1 1 2.5 0 3.4Z"></path><path d="m7.5 10.5 2 2"></path><path d="m10.5 7.5 2 2"></path><path d="m13.5 4.5 2 2"></path><path d="m4.5 13.5 2 2"></path></svg>',"line"),e('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9.06 11.9 8.07-8.06a2.85 2.85 0 1 1 4.03 4.03l-8.06 8.08"></path><path d="M7.07 14.94c-1.66 0-3 1.35-3 3.02 0 1.33-2.5 1.52-2 2.02 1.08 1.1 2.49 2.02 4 2.02 2.2 0 4-1.8 4-4.04a3.01 3.01 0 0 0-3-3.02z"></path></svg>',"curve"),e('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>',"arrow"),e('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="4 7 4 4 20 4 20 7"></polyline><line x1="9" y1="20" x2="15" y2="20"></line><line x1="12" y1="4" x2="12" y2="20"></line></svg>',"text"),e('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m7 21-4.3-4.3c-1-1-1-2.5 0-3.4l9.6-9.6c1-1 2.5-1 3.4 0l5.6 5.6c1 1 1 2.5 0 3.4L13 21"></path><path d="M22 21H7"></path><path d="m5 11 9 9"></path></svg>',"eraser"),e('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="5 9 2 12 5 15"></polyline><polyline points="9 5 12 2 15 5"></polyline><polyline points="15 19 12 22 9 19"></polyline><polyline points="19 9 22 12 19 15"></polyline><line x1="2" y1="12" x2="22" y2="12"></line><line x1="12" y1="2" x2="12" y2="22"></line></svg>',"move"),e('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-flip-horizontal"><path d="M8 3H5a2 2 0 0 0-2 2v14c0 1.1.9 2 2 2h3"></path><path d="M16 3h3a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-3"></path><path d="M12 20v2"></path><path d="M12 14v2"></path><path d="M12 8v2"></path><path d="M12 2v2"></path></svg>',"compare"),e('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7v6h6"></path><path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"></path></svg>',()=>{this.handleUndo()}),t&&(e('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="19 20 9 12 19 4 19 20"></polygon><line x1="5" y1="19" x2="5" y2="5"></line></svg>',()=>{this.prevFrame()},this.playerControlsContainer),Q(t,this),e('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 4 15 12 5 20 5 4"></polygon><line x1="19" y1="5" x2="19" y2="19"></line></svg>',()=>{this.nextFrame()},this.playerControlsContainer),G(t,this),et(t,this),$(t,this));let o=document.createElement("input");o.type="color",o.value=yt,o.style.margin="5px",this.colorPicker=o,s.appendChild(o);let a=i(),l=document.createElement("input");l.type="number",l.step="1",l.min="1",l.max="10",l.value="5",l.style.margin="5px",a.appendChild(l);let r=c=>{this.ctx.lineWidth=c.target.valueAsNumber,this.focusOnMediaNode()};this.addEvent(l,"input",r);let h=c=>{this.ctx.strokeStyle=c.target.value,this.ctx.fillStyle=c.target.value,this.focusOnMediaNode()};this.addEvent(o,"input",h),this.colorPicker=o,this.strokeSizePicker=l,this.hideButton("compare"),t&&(this.hide(),this.addEvent(t,"pause",()=>{this.show()}),this.addEvent(t,"seek",()=>{t.paused&&this.show(),this.syncTime()}),this.addEvent(t,"timeupdate",()=>{t.currentTime<2e-4&&!t.paused&&this.startAnnotationsAsVideo(),this.syncTime()}),this.addEvent(t,"seeking",()=>{this.syncTime()}),this.addEvent(t,"error",()=>{this.hide()}),this.addEvent(t,"stalled",()=>{this.hide()}),this.addEvent(t,"play",()=>{this.hideControls(),this.startAnnotationsAsVideo()}),this.addEvent(document,"copy",c=>{X(c,this)}),this.addEvent(document,"cut",c=>{Y(c,this)}),this.addEvent(document,"paste",c=>{K(c,this)}),this.addEvent(document,"click",c=>{j(c,this)}),this.addEvent(document,"keydown",c=>{q(c,this)}))}function nt(){var s;this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"),(s=this.videoElement.parentNode)==null||s.insertBefore(this.canvas,this.videoElement.nextSibling),this.canvas.style.position="absolute",this.canvas.style.top="0",this.canvas.style.left="0",this.canvas.style.zIndex="1",this.addEvent(this.canvas,"pointerdown",this.handleMouseDown),this.addEvent(this.canvas,"pointermove",this.handleMouseMove),this.addEvent(this.canvas,"pointerup",this.handleMouseUp),this.addEvent(this.canvas,"pointercancel",this.handleMouseUp),this.addEvent(window,"resize",this.setCanvasSize),this.addEvent(document,"keydown",this.onKeyDown)}var k=class{constructor(){this.destructors=[];this.isDestroyed=!1;this.activeTimeFrame=1;this.globalShapes=[];this.timeStack=new Map;this.undoTimeStack=new Map}cleanFrameStacks(){this.timeStack.clear(),this.undoTimeStack.clear()}destroy(){this.destructors.forEach(n=>n()),this.destructors=[],this.globalShapes=[],this.cleanFrameStacks()}raf(n){return requestAnimationFrame(n)}addEvent(n,t,e){let i=o=>{this.isDestroyed||e(o)};n.addEventListener(t,i),this.destructors.push(()=>{n.removeEventListener(t,i)})}addProgressBarOverlay(){throw new Error("Method not implemented.")}initUI(){throw new Error("Method not implemented.")}initCanvas(){throw new Error("Method not implemented.")}addFrameSquareOverlay(n=this.activeTimeFrame){throw new Error("Method not implemented.")}addVideoOverlay(){throw new Error("Method not implemented.")}withRefVideo(n){this.isDestroyed||this.referenceVideoElement&&n(this.referenceVideoElement)}withVideo(n){if(this.isDestroyed)return;let t=this.videoElement;!t||t.tagName!=="VIDEO"||n(t)}};var y=class{constructor(n){this.startX=0;this.startY=0;this.isDrawing=!1;this.annotationTool=n}get ctx(){return this.annotationTool.ctx}onDeactivate(){}onActivate(){}reset(){this.startX=0,this.startY=0,this.isDrawing=!1}save(n){this.annotationTool.addShape(n)}};var I=class extends y{constructor(){super(...arguments);this.name="rectangle"}move(t,e,i){return t.x+=e,t.y+=i,t}normalize(t,e,i){return w(f({},t),{x:t.x/e,y:t.y/i,width:t.width/e,height:t.height/i})}onPointerDown(t){let{x:e,y:i}=this.annotationTool.getRelativeCoords(t);this.startX=e,this.startY=i,this.isDrawing=!0}onPointerMove(t){if(!this.isDrawing)return;let{x:e,y:i}=this.annotationTool.getRelativeCoords(t);this.drawRectangle(this.startX,this.startY,e-this.startX,i-this.startY)}onPointerUp(t){if(!this.isDrawing)return;let{x:e,y:i}=this.annotationTool.getRelativeCoords(t);this.save({type:"rectangle",x:this.startX,y:this.startY,width:e-this.startX,height:i-this.startY,strokeStyle:this.ctx.strokeStyle,fillStyle:this.ctx.fillStyle,lineWidth:this.ctx.lineWidth}),this.drawRectangle(this.startX,this.startY,e-this.startX,i-this.startY),this.isDrawing=!1}drawRectangle(t,e,i,o){this.ctx.beginPath(),this.ctx.rect(t,e,i,o),this.ctx.stroke()}draw(t){this.drawRectangle(t.x,t.y,t.width,t.height)}};var F=class extends y{constructor(){super(...arguments);this.name="circle"}move(t,e,i){return t.x+=e,t.y+=i,t}normalize(t,e,i){return w(f({},t),{x:t.x/e,y:t.y/i,radius:t.radius/e})}onPointerDown(t){let{x:e,y:i}=this.annotationTool.getRelativeCoords(t);this.startX=e,this.startY=i,this.isDrawing=!0}onPointerMove(t){if(!this.isDrawing)return;let{x:e,y:i}=this.annotationTool.getRelativeCoords(t),o=Math.sqrt(Math.pow(e-this.startX,2)+Math.pow(i-this.startY,2));this.drawCircle(this.startX,this.startY,o)}onPointerUp(t){if(!this.isDrawing)return;let{x:e,y:i}=this.annotationTool.getRelativeCoords(t),o=Math.sqrt(Math.pow(e-this.startX,2)+Math.pow(i-this.startY,2));this.save({type:"circle",x:this.startX,y:this.startY,radius:o,strokeStyle:this.ctx.strokeStyle,fillStyle:this.ctx.fillStyle,lineWidth:this.ctx.lineWidth}),this.drawCircle(this.startX,this.startY,o),this.isDrawing=!1}drawCircle(t,e,i){this.ctx.beginPath(),this.ctx.arc(t,e,i,0,2*Math.PI),this.ctx.stroke()}draw(t){this.drawCircle(t.x,t.y,t.radius)}};var M=class{constructor(n,t){this.x=n;this.y=t}distanceToLine(n,t){let e=t.x-n.x,i=t.y-n.y,o=Math.abs(i*this.x-e*this.y+t.x*n.y-t.y*n.x),a=Math.sqrt(i*i+e*e);return o/a}};function D(s,n){if(s.length<=2)return s;let t=s[0],e=s[s.length-1],i=-1,o=0;for(let a=1;a<s.length-1;a++){let l=s[a].distanceToLine(t,e);l>o&&(i=a,o=l)}if(o>n){let a=D(s.slice(0,i+1),n),l=D(s.slice(i),n);return a.slice(0,a.length-1).concat(l)}else return[t,e]}var L=class extends y{constructor(){super(...arguments);this.name="curve";this.curvePoints=[]}move(t,e,i){return t.points=t.points.map(o=>({x:o.x+e,y:o.y+i})),t}normalize(t,e,i){return w(f({},t),{points:t.points.map(o=>({x:o.x/e,y:o.y/i}))})}draw(t){this.drawCurve(t)}reset(){super.reset(),this.curvePoints=[]}onPointerDown(t){if(this.isDrawing)return;let{x:e,y:i}=this.annotationTool.getRelativeCoords(t);this.curvePoints=[],this.startX=e,this.startY=i,this.isDrawing=!0,this.curvePoints.push({x:e,y:i})}onPointerMove(t){if(!this.isDrawing)return;let{x:e,y:i}=this.annotationTool.getRelativeCoords(t);this.curvePoints.push({x:e,y:i}),this.drawCurve({points:this.curvePoints,lineWidth:this.ctx.lineWidth})}onPointerUp(t){if(!this.isDrawing)return;let{x:e,y:i}=this.annotationTool.getRelativeCoords(t);this.curvePoints.push({x:e,y:i});let o=this.curvePoints.map(m=>new M(m.x,m.y)),h={type:"curve",points:D(o,2).map(m=>({x:m.x,y:m.y})),strokeStyle:this.ctx.strokeStyle,fillStyle:this.ctx.fillStyle,lineWidth:this.ctx.lineWidth};this.save(h),this.curvePoints=[],this.isDrawing=!1}drawCurve(t){if(t.points.length===2&&t.points[0].x===t.points[1].x&&t.points[0].y===t.points[1].y){let e=t.lineWidth/4,i=0,o=2*Math.PI;this.ctx.beginPath(),this.ctx.arc(t.points[0].x,t.points[0].y,e,i,o),this.ctx.stroke()}else{this.ctx.beginPath(),this.ctx.moveTo(t.points[0].x,t.points[0].y);for(let e=1;e<t.points.length-1;e++){let i=t.points[e],o=t.points[e+1];this.ctx.quadraticCurveTo(i.x,i.y,o.x,o.y)}this.ctx.stroke()}}};var A=class extends y{constructor(){super(...arguments);this.name="line"}move(t,e,i){return t.x1+=e,t.y1+=i,t.x2+=e,t.y2+=i,t}normalize(t,e,i){return w(f({},t),{x1:t.x1/e,y1:t.y1/i,x2:t.x2/e,y2:t.y2/i})}onPointerDown(t){let{x:e,y:i}=this.annotationTool.getRelativeCoords(t);this.startX=e,this.startY=i,this.isDrawing=!0}onPointerMove(t){if(!this.isDrawing)return;let{x:e,y:i}=this.annotationTool.getRelativeCoords(t);this.drawLine(this.startX,this.startY,e,i)}onPointerUp(t){if(!this.isDrawing)return;let{x:e,y:i}=this.annotationTool.getRelativeCoords(t);this.save({type:"line",x1:this.startX,y1:this.startY,x2:e,y2:i,fillStyle:this.ctx.fillStyle,strokeStyle:this.ctx.strokeStyle,lineWidth:this.ctx.lineWidth}),this.drawLine(this.startX,this.startY,e,i),this.isDrawing=!1}drawLine(t,e,i,o){this.ctx.beginPath(),this.ctx.moveTo(t,e),this.ctx.lineTo(i,o),this.ctx.stroke()}draw(t){this.drawLine(t.x1,t.y1,t.x2,t.y2)}};var B=class extends y{constructor(){super(...arguments);this.name="arrow"}normalize(t,e,i){return w(f({},t),{x1:t.x1/e,y1:t.y1/i,x2:t.x2/e,y2:t.y2/i})}move(t,e,i){return t.x1+=e,t.y1+=i,t.x2+=e,t.y2+=i,t}draw(t){this.drawArrow(t.x1,t.y1,t.x2,t.y2)}onPointerDown(t){let{x:e,y:i}=this.annotationTool.getRelativeCoords(t);this.startX=e,this.startY=i,this.isDrawing=!0}onPointerMove(t){if(!this.isDrawing)return;let{x:e,y:i}=this.annotationTool.getRelativeCoords(t);this.drawArrow(this.startX,this.startY,e,i)}onPointerUp(t){if(!this.isDrawing)return;this.isDrawing=!1;let{x:e,y:i}=this.annotationTool.getRelativeCoords(t);this.save({type:"arrow",x1:this.startX,y1:this.startY,x2:e,y2:i,strokeStyle:this.ctx.strokeStyle,fillStyle:this.ctx.fillStyle,lineWidth:this.ctx.lineWidth})}drawArrow(t,e,i,o){let a=10+2.5*this.ctx.lineWidth,l=Math.PI/6,r=Math.atan2(o-e,i-t);this.ctx.beginPath(),this.ctx.moveTo(t,e),this.ctx.lineTo(i,o),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(i,o),this.ctx.lineTo(i-a*Math.cos(r+l),o-a*Math.sin(r+l)),this.ctx.moveTo(i,o),this.ctx.lineTo(i-a*Math.cos(r-l),o-a*Math.sin(r-l)),this.ctx.stroke()}};var R=class extends y{constructor(){super(...arguments);this.name="text"}move(t,e,i){return t.x+=e,t.y+=i,t}onActivate(){this.annotationTool.canvas.style.cursor="text",this.isDrawing=!0}onDeactivate(){this.annotationTool.canvas.style.cursor="default",this.isDrawing=!1}draw(t){let e=t.text.split(`
`);for(let i=0;i<e.length;i++)this.drawText(t.x,t.y+i*20,e[i])}drawText(t,e,i){let o=16+this.ctx.lineWidth*.5;this.ctx.font=`${o}px Helvetica Neue, Arial`,this.ctx.fillText(i,t,e)}onPointerDown(t){let{x:e,y:i}=this.annotationTool.getRelativeCoords(t);this.startX=e,this.startY=i}onPointerMove(t){let{x:e,y:i}=this.annotationTool.getRelativeCoords(t);this.ctx.beginPath(),this.ctx.arc(e,i,5,0,2*Math.PI),this.ctx.fill()}normalize(t,e,i){return w(f({},t),{x:t.x/e,y:t.y/i})}onPointerUp(t){let{x:e,y:i}=this.annotationTool.getRelativeCoords(t),o=prompt("Enter the text to be drawn:");o!==null&&this.save({type:"text",x:e,y:i,text:o,strokeStyle:this.ctx.strokeStyle,fillStyle:this.ctx.fillStyle,lineWidth:this.ctx.lineWidth})}};var V=class extends y{constructor(){super(...arguments);this.name="eraser"}move(t,e,i){return t.x+=e,t.y+=i,t}normalize(t,e,i){return w(f({},t),{x:t.x/e,y:t.y/i,width:t.width/e,height:t.height/i})}draw(t){this.drawEraser(t.x,t.y,t.width,t.height)}onPointerDown(t){let{x:e,y:i}=this.annotationTool.getRelativeCoords(t);this.startX=e,this.startY=i,this.isDrawing=!0}onPointerMove(t){if(!this.isDrawing)return;let{x:e,y:i}=this.annotationTool.getRelativeCoords(t);this.ctx.save(),this.ctx.strokeStyle="rgba(255, 255, 255, 0.5)",this.ctx.lineWidth=1,this.ctx.fillStyle="rgba(255, 255, 255, 0.3)",this.ctx.fillRect(this.startX,this.startY,e-this.startX,i-this.startY),this.ctx.strokeRect(this.startX,this.startY,e-this.startX,i-this.startY),this.ctx.restore()}onPointerUp(t){if(!this.isDrawing)return;this.isDrawing=!1;let{x:e,y:i}=this.annotationTool.getRelativeCoords(t);this.save({type:"eraser",x:this.startX,y:this.startY,width:e-this.startX,height:i-this.startY,strokeStyle:this.ctx.strokeStyle,fillStyle:this.ctx.fillStyle,lineWidth:this.ctx.lineWidth})}drawEraser(t,e,i,o){this.ctx.clearRect(t,e,i,o)}};var H=class extends y{constructor(){super(...arguments);this.name="move";this.shape=null;this.lastDrawnShape=null;this.shapeRemoved=!1;this.isScale=!1}move(t){return t}normalize(t){return f({},t)}onPointerDown(t){let{x:e,y:i}=this.annotationTool.getRelativeCoords(t),o=this.annotationTool.shapes.slice(0).pop();o&&(this.shape=o,this.shapeRemoved=!1,this.lastDrawnShape=null,this.startX=e,this.startY=i,this.isDrawing=!0,this.isScale=o.type==="image"?this.isPointerAtCorner(o,e,i):!1)}isPointerAtCorner(t,e,i){let o=this.annotationTool.deserialize([t])[0],a=15,l=Math.abs(o.y-i)<a,r=Math.abs(o.x-e)<a,h=Math.abs(o.x+o.width-e)<a,m=Math.abs(o.y+o.height-i)<a;return l&&r||l&&h||m&&r||m&&h}onPointerMove(t){if(!this.isDrawing||!this.shape)return;this.shapeRemoved||(this.annotationTool.removeLastShape(),this.shapeRemoved=!0);let{x:e,y:i}=this.annotationTool.getRelativeCoords(t),o=e-this.startX,a=i-this.startY;this.startX=e-o,this.startY=i-a;let l=this.annotationTool.deserialize([this.shape])[0],r=l.type==="image"?l:JSON.parse(JSON.stringify(l));if(r.type==="image")if(this.isScale){let{width:h,height:m}=r,d=h/m,c=h+o,u=c/d;r.width=c,r.height=u,this.lastDrawnShape=r,this.annotationTool.pluginForTool(r.type).draw(r)}else{let h=this.annotationTool.pluginForTool(r.type).move(r,o,a);this.lastDrawnShape=h,this.annotationTool.pluginForTool(r.type).draw(h)}else{let h=this.annotationTool.pluginForTool(r.type).move(r,o,a);this.lastDrawnShape=h,this.annotationTool.pluginForTool(r.type).draw(h)}}onPointerUp(t){!this.isDrawing||!this.lastDrawnShape||(this.lastDrawnShape&&(this.lastDrawnShape.fillStyle=this.annotationTool.ctx.fillStyle,this.lastDrawnShape.strokeStyle=this.annotationTool.ctx.strokeStyle,this.lastDrawnShape.lineWidth=this.annotationTool.ctx.lineWidth,this.save(this.lastDrawnShape)),this.isDrawing=!1,this.isScale=!1,this.shape=null,this.shapeRemoved=!1,this.lastDrawnShape=null)}draw(){throw new Error("Method not implemented.")}reset(){this.isDrawing=!1,this.shape=null,this.isScale=!1,this.lastDrawnShape=null,this.shapeRemoved=!1}};var N=class extends y{constructor(){super(...arguments);this.name="image"}move(t,e,i){return t.x+=e,t.y+=i,t}onPointerDown(t){}onPointerMove(t){}onPointerUp(t){}normalize(t,e,i){return w(f({},t),{x:t.x/e,y:t.y/i,width:t.width/e,height:t.height/i})}draw(t){if(!(t.image instanceof HTMLImageElement)){console.error("Image is not an instance of HTMLImageElement");return}this.ctx.drawImage(t.image,t.x,t.y,t.width,t.height)}};var ft=.7,O=class extends y{constructor(){super(...arguments);this.name="compare";this.comparisonLine=0;this.leftOpacity=1;this.rightOpacity=1;this.isDrawing=!1}move(t,e,i){return t.x+=e,t}onActivate(){this.comparisonLine=this.annotationTool.canvasWidth/2,this.leftOpacity=1,this.rightOpacity=ft,this.annotationTool.canvas.style.cursor="col-resize",this.annotationTool.syncTime(!0)}onDeactivate(){this.annotationTool.canvas.style.cursor="default",this.comparisonLine=0,this.leftOpacity=1,this.rightOpacity=1,this.isDrawing=!1}normalize(t,e){return w(f({},t),{x:t.x/e})}onPointerDown(t){let{x:e,y:i}=this.annotationTool.getRelativeCoords(t);this.startX=e,this.startY=i,this.isDrawing=!0,this.annotationTool.syncTime(!0),this.onPointerMove(t)}onPointerMove(t){if(!this.isDrawing){if(this.annotationTool.globalShapes.length>0){let o=this.annotationTool.globalShapes[0];if(o.type==="compare"){let a=this.annotationTool.deserialize([o])[0];this.draw(a),this.annotationTool.addFrameSquareOverlay()}}return}let{x:e}=this.annotationTool.getRelativeCoords(t);this.comparisonLine=e;let i={type:"compare",strokeStyle:this.ctx.strokeStyle,fillStyle:this.ctx.fillStyle,lineWidth:this.ctx.lineWidth,x:e};this.draw(i).then(()=>{this.drawDelimiter(i)}),this.drawDelimiter(i)}onPointerUp(){this.isDrawing&&(this.save({type:"compare",strokeStyle:this.ctx.strokeStyle,fillStyle:this.ctx.fillStyle,lineWidth:this.ctx.lineWidth,x:this.comparisonLine}),this.isDrawing=!1)}save(t){this.annotationTool.globalShapes=this.annotationTool.globalShapes.filter(i=>i.type!=="compare");let e=this.annotationTool.serialize([t])[0];e.x<.05||e.x>.95||this.annotationTool.addGlobalShape(e)}drawDelimiter(t){this.ctx.beginPath(),this.ctx.moveTo(t.x,0),this.ctx.lineTo(t.x,this.annotationTool.canvasWidth),this.ctx.stroke()}drawShape(t){let e=this.annotationTool.videoElement,i=this.annotationTool.referenceVideoElement;if(!e||!i)return;let o=this.ctx.globalAlpha,a=this.annotationTool.canvasWidth,l=this.annotationTool.canvasHeight,r=t.x;this.ctx.globalAlpha=this.leftOpacity,this.ctx.drawImage(e,0,0,e.videoWidth,e.videoHeight,0,0,a,l);let h=r,m=a-h,d=m/a*e.videoWidth;this.ctx.globalAlpha=this.rightOpacity,this.ctx.drawImage(i,h/a*e.videoWidth,0,d,e.videoHeight,h,0,m,l),this.ctx.globalAlpha=o}draw(t){return g(this,null,function*(){let e=this.annotationTool.videoElement,i=this.annotationTool.referenceVideoElement;if(!e||!i)return;this.annotationTool.syncTime(),this.drawShape(t),e.paused&&i.paused||(yield this.annotationTool.waitForFrameSync(),this.drawShape(t))})}};var ot=[I,F,A,B,R,V,L,H,N,O];function st(s,n){let t,e,i,o=[],a=!0;function l(m,d){let c=Math.abs(d.mediaTime-t),u=Math.abs(d.presentedFrames-e),p=c/u;p&&p<1&&a&&o.length<50&&s.playbackRate===1&&document.hasFocus()&&(o.push(p),i=Math.round(1/h()),n(i,o.length*2)),a=!0,t=d.mediaTime,e=d.presentedFrames,s.requestVideoFrameCallback(l)}s.requestVideoFrameCallback(l);let r=()=>{o.pop(),a=!1};s.addEventListener("seeked",r);function h(){return o.reduce((m,d)=>m+d)/o.length}return()=>{s.removeEventListener("seeked",r)}}var W=class{constructor(){this.init()}release(n=void 0){if(clearTimeout(this.timeout),n!==void 0){let t=performance.now(),e=n-t;e>0?this.timeout=setTimeout(()=>{this.resolve(!0)},e):this.resolve(!0)}else this.resolve(!0)}init(){clearTimeout(this.timeout),this.reject&&this.reject(!0);let n,t,e=!1,i,o=new Promise((a,l)=>{n=r=>{clearTimeout(i),!e&&(e=!0,a(r),this.init())},t=()=>{clearTimeout(this.timeout),clearTimeout(i),!e&&(e=!0,l(!0),this.init())}});this.promise=o,this.resolve=n,this.reject=t,i=setTimeout(()=>{this.resolve(!0)},32)}},at=25,S=class extends k{constructor(t){super();this.isMouseDown=!1;this.buttons=[];this.plugins=[];this.frameSyncBucket=new W;this.annotatedFrameCoordinates=[];this.fps=at;this.ct=0;this.isPlaybackRestarting=!1;this.lastNavigatedFrame=0;this.isProgressBarNavigation=!1;this.isAnnotationsAsVideoActive=!1;this.plugins=ot.map(e=>new e(this)),this.init(t)}prevFrame(){let t=this.activeTimeFrame,e=Math.max(1,t-1);e===this.playbackFrame?this.playbackFrame=this.totalFrames:this.playbackFrame=e}nextFrame(){let t=this.activeTimeFrame,e=Math.min(this.totalFrames,t+1);e===this.totalFrames?this.playbackFrame=1:this.playbackFrame=e}addGlobalShape(t){this.globalShapes.push(t)}get selectedColor(){return this.colorPicker.value}get selectedStrokeSize(){return this.strokeSizePicker.valueAsNumber}get currentTool(){return this._currentTool}set currentTool(t){let e=this._currentTool;e&&(this.getButtonForTool(e).classList.remove("active"),this.pluginForTool(e).onDeactivate()),this._currentTool=t,this.canvas.style.cursor=t?"pointer":"default",t&&(this.getButtonForTool(t).classList.add("active"),this.pluginForTool(t).onActivate())}enableFrameRateDetection(){if(this.destructors.find(i=>i.name==="frameRateDetector"))return;let t=this.videoElement;if(t.tagName==="IMG")return;let e=st(t,i=>{this.fps=i});Object.defineProperty(e,"name",{value:"frameRateDetector"}),this.destructors.push(e)}get playbackFrame(){if(this.videoElement instanceof HTMLImageElement)return 1;let t=Math.round(this.videoElement.currentTime*this.fps);return Math.max(1,t)}set playbackFrame(t){if(this.videoElement instanceof HTMLImageElement)return;let e=t/this.fps;this.videoElement.currentTime=e,this.withRefVideo(i=>{i.currentTime=e}),this.syncTime(),this.show()}get canvasWidth(){return this.canvas.width/this.pixelRatio}get canvasHeight(){return this.canvas.height/this.pixelRatio}get aspectRatio(){return this.canvasWidth/this.canvasHeight}get isMobile(){return window.innerWidth<960}get progressBarCoordinates(){let t=this.isMobile?30:10,e=5,i=55,o=this.canvasWidth-e-i,a=e,l=this.canvasHeight-t;return{x:a,y:l,width:o,height:t}}get shapes(){return this.timeStack.has(this.activeTimeFrame)||this.timeStack.set(this.activeTimeFrame,[]),this.timeStack.get(this.activeTimeFrame)}set shapes(t){this.timeStack.set(this.activeTimeFrame,t)}get undoStack(){return this.undoTimeStack.has(this.activeTimeFrame)||this.undoTimeStack.set(this.activeTimeFrame,[]),this.undoTimeStack.get(this.activeTimeFrame)}set undoStack(t){this.undoTimeStack.set(this.activeTimeFrame,t)}get pixelRatio(){return window.devicePixelRatio||1}hide(){this.stopAnnotationsAsVideo(),this.hideControls(),this.hideCanvas()}showControls(){this.uiContainer.style.display="block"}hideControls(){this.uiContainer.style.display="none"}showCanvas(){this.canvas.style.display="block"}hideCanvas(){this.canvas.style.display="none"}updateActiveTimeFrame(){this.activeTimeFrame=this.playbackFrame}show(){return g(this,null,function*(){this.stopAnnotationsAsVideo(),this.updateActiveTimeFrame(),this.showCanvas(),this.showControls(),yield this.redrawFullCanvas()})}setCanvasSettings(){this.ctx.strokeStyle=this.selectedColor,this.ctx.fillStyle=this.selectedColor,this.ctx.lineWidth=this.selectedStrokeSize}pluginForTool(t){if(this.isDestroyed)throw new Error("AnnotationTool is destroyed");let e=this.plugins.find(i=>i.name===t);if(!e)throw new Error(`No plugin found for tool ${t}`);return e}getButtonForTool(t){return this.buttons.find(e=>e.dataset.tool===t)}bindContext(){this.handleMouseDown=this.handleMouseDown.bind(this),this.handleMouseMove=this.handleMouseMove.bind(this),this.handleMouseUp=this.handleMouseUp.bind(this),this.setCanvasSize=this.setCanvasSize.bind(this),this.onKeyDown=this.onKeyDown.bind(this)}initProperties(){this.isDestroyed=!1,this.isProgressBarNavigation=!1,this.shapes=[],this.globalShapes=[],this.currentTool=this.isMobile?null:"curve"}setVideoStyles(){this.videoElement.style.objectFit="cover",this.videoElement.style.objectPosition="left top"}get frameCallbackSupported(){return"requestVideoFrameCallback"in HTMLVideoElement.prototype}initFrameCounter(){if(!this.frameCallbackSupported){setTimeout(()=>{this.updateActiveTimeFrame(),this.frameSyncBucket.release(),this.initFrameCounter()},1e3/this.fps);return}return new Promise(e=>g(this,null,function*(){let[i,o]=yield Promise.all([new Promise(d=>{this.withVideo(c=>{c.requestVideoFrameCallback((u,p)=>{d(p)})})}),new Promise(d=>{this.withRefVideo(c=>{c.requestVideoFrameCallback((u,p)=>{d(p)})}),this.referenceVideoElement||d({mediaTime:0})})]);if(!this.referenceVideoElement)return this.updateActiveTimeFrame(),this.frameSyncBucket.release(i.expectedDisplayTime),this.initFrameCounter(),e(!0);let a=this.videoElement,l=parseFloat((o.mediaTime-i.mediaTime).toFixed(5)),r=parseFloat((1/this.fps).toFixed(5)),h=Math.ceil(l/r),m=parseFloat((h*r).toFixed(5));if(i.mediaTime!==o.mediaTime){if(h%2===0){let d=a.currentTime-m+r;a.currentTime=d}this.ct++,this.ct>this.fps&&this.restartPlayback(),this.updateActiveTimeFrame()}else this.ct=0,this.updateActiveTimeFrame(),this.frameSyncBucket.release(Math.max(i.expectedDisplayTime,o.expectedDisplayTime));e(!0),this.initFrameCounter()}))}waitForFrameSync(){return this.frameSyncBucket.promise}init(t){this.videoElement=t,this.setVideoStyles(),this.initFrameCounter(),this.bindContext(),this.initCanvas(),this.initUI(),this.initProperties(),this.setCanvasSize()}onKeyDown(t){(t.ctrlKey||t.metaKey)&&t.key.toLowerCase()==="z"&&this.handleUndo()}removeLastShape(){return g(this,null,function*(){this.shapes.pop(),yield this.redrawFullCanvas()})}handleUndo(){return g(this,null,function*(){this.undoStack.length>0&&(this.shapes=this.undoStack.pop(),yield this.redrawFullCanvas())})}destroy(){var o,a,l,r,h,m;if(this.isDestroyed)return;super.destroy(),this.stopAnnotationsAsVideo(),this._currentTool=null,this.plugins.forEach(d=>d.reset()),this.annotatedFrameCoordinates=[],this.setFrameRate(at);let t=this.strokeSizePicker.parentElement;if((o=t==null?void 0:t.parentNode)==null||o.removeChild(t),this.referenceVideoElement){let d=this.referenceVideoElement.parentElement;(a=d==null?void 0:d.parentNode)==null||a.removeChild(d),this.referenceVideoElement=null}let e=this.colorPicker.parentElement;(l=e==null?void 0:e.parentNode)==null||l.removeChild(e),this.buttons.forEach(d=>{var c;(c=d.parentNode)==null||c.removeChild(d)}),this.buttons=[],(r=this.uiContainer.parentNode)==null||r.removeChild(this.uiContainer),(h=this.canvas.parentNode)==null||h.removeChild(this.canvas),(m=this.playerControlsContainer.parentElement)==null||m.removeChild(this.playerControlsContainer),["strokeSizePicker","colorPicker","uiContainer","playerControlsContainer","canvas","ctx","videoElement"].forEach(d=>{delete this[d]}),this.activeTimeFrame=0,this.isDestroyed=!0}setCanvasSize(){return g(this,null,function*(){let t=this.videoElement.getBoundingClientRect();this.canvas.width=t.width*this.pixelRatio,this.canvas.height=t.height*this.pixelRatio,this.canvas.style.width=`${t.width}px`,this.canvas.style.height=`${t.height}px`,this.ctx.scale(this.pixelRatio,this.pixelRatio),this.setCanvasSettings(),this.syncVideoSizes(),yield this.redrawFullCanvas()})}addShape(t){let e=this.serialize([t])[0];this.undoStack.push([...this.shapes]),this.shapes.push(e)}syncTime(t=!1,e=null){let i=this.videoElement;if(!i||i.tagName!=="VIDEO"||this.frameCallbackSupported&&!i.paused)return;let o=e===null?i.currentTime:e;this.withRefVideo(a=>{if(a.readyState<4||!t&&!this.globalShapes.length)return;Math.abs(a.currentTime-o)>=this.msPerFrame/3&&(a.currentTime=o)})}get msPerFrame(){return this.fps/1e3}syncVideoSizes(){this.withRefVideo(t=>{let i=this.videoElement.getBoundingClientRect();t.style.position="fixed",t.style.top=`${i.top}px`,t.style.left=`${i.left}px`})}addReferenceVideoByURL(t){return g(this,null,function*(){let e=yield fetch(t).then(a=>a.blob()),i=new Blob([e],{type:"video/mp4"}),o=window.URL.createObjectURL(i);this.referenceVideoElement||(this.referenceVideoElement=document.createElement("video"),this.withRefVideo(a=>{a.style.zIndex="-1",a.style.display="none",a.style.objectFit="cover",a.style.objectPosition="left top",a.muted=!0,a.playsInline=!0,a.autoplay=!1,a.controls=!1,a.loop=!0,this.videoElement.after(a)}),this.syncVideoSizes()),this.referenceVideoElement.src=o,this.showButton("compare")})}restartPlayback(){return g(this,null,function*(){if(this.isPlaybackRestarting)return;this.isPlaybackRestarting=!0;let t=!1,e=!1;this.withRefVideo(o=>{e=!o.paused}),this.withVideo(o=>{t=!o.paused});let i=[];t&&this.withVideo(o=>{o.pause()}),e&&this.withRefVideo(o=>{o.pause()}),e&&t&&this.withVideo(o=>{this.withRefVideo(a=>{i.push(o.play(),a.play())})}),yield Promise.all(i).finally(()=>{this.isPlaybackRestarting=!1})})}hideButton(t){let e=this.getButtonForTool(t);e.style.display="none"}showButton(t){let e=this.getButtonForTool(t);e.style.display=""}addSingletonShape(t){let e=this.serialize([t])[0],i=this.shapes.filter(o=>o.type!==t.type);this.replaceFrame(this.playbackFrame,[...i,e])}serialize(t=this.shapes){let e=this.canvasWidth,i=this.canvasHeight;return t.map(o=>this.pluginForTool(o.type).normalize(o,e,i))}deserialize(t){let e=1/this.canvasWidth,i=1/this.canvasHeight;return t.map(o=>this.pluginForTool(o.type).normalize(o,e,i))}getRelativeCoords(t){let e=this.canvas.getBoundingClientRect();return{x:this.getEventX(t)-e.left,y:this.getEventY(t)-e.top}}handleMouseDown(t){if(t.preventDefault(),this.isMouseDown=!0,P(t))return;let e=this.frameFromProgressBar(t,!0);if(e){this.isProgressBarNavigation=!0;let i=this.getAnnotationFrame(t);this.isVideoPaused&&(i!==null?this.playbackFrame=i:this.playbackFrame=e);return}this.currentTool&&this.pluginForTool(this.currentTool).onPointerDown(t)}get isDrawing(){return this.currentTool?this.pluginForTool(this.currentTool).isDrawing:!1}get isVideoPaused(){return this.videoElement.tagName==="VIDEO"?this.videoElement.paused:!0}get hasGlobalOverlays(){return this.globalShapes.length>0}handleMouseMove(t){return g(this,null,function*(){if(t.preventDefault(),!P(t)){if(this.isMouseDown){let e=this.isProgressBarNavigation?this.frameFromProgressBar(t,!1):null;if(e!==null&&!this.isDrawing){if(e===this.lastNavigatedFrame)return;this.lastNavigatedFrame=e,this.isVideoPaused&&(this.playbackFrame=e);return}else this.hideControls(),this.clearCanvas(),this.hasGlobalOverlays||this.addVideoOverlay(),yield this.drawShapesOverlay()}else yield this.redrawFullCanvas();this.currentTool&&this.pluginForTool(this.currentTool).onPointerMove(t)}})}getEventX(t){return t.clientX}getEventY(t){return t.clientY}handleMouseUp(t){return g(this,null,function*(){this.isMouseDown=!1,this.isProgressBarNavigation=!1,this.showControls(),!P(t)&&(this.currentTool&&this.pluginForTool(this.currentTool).onPointerUp(t),yield this.redrawFullCanvas())})}focusOnMediaNode(){this.videoElement.focus()}drawShapesOverlay(){return g(this,null,function*(){let t={strokeStyle:this.ctx.strokeStyle,fillStyle:this.ctx.fillStyle,lineWidth:this.ctx.lineWidth};for(let e of this.deserialize(this.globalShapes)){this.ctx.strokeStyle=e.strokeStyle,this.ctx.fillStyle=e.fillStyle,this.ctx.lineWidth=e.lineWidth;try{yield this.pluginForTool(e.type).draw(e)}catch(i){console.error(i)}}for(let e of this.deserialize(this.shapes)){this.ctx.strokeStyle=e.strokeStyle,this.ctx.fillStyle=e.fillStyle,this.ctx.lineWidth=e.lineWidth;try{yield this.pluginForTool(e.type).draw(e)}catch(i){console.error(i)}}this.ctx.strokeStyle=t.strokeStyle,this.ctx.fillStyle=t.fillStyle,this.ctx.lineWidth=t.lineWidth})}clearCanvas(){this.ctx.clearRect(0,0,this.canvasWidth,this.canvasHeight)}frameToDataUrl(){return g(this,null,function*(){try{this.clearCanvas(),this.addVideoOverlay(),this.addFrameSquareOverlay(),yield this.drawShapesOverlay();let t=this.canvas.toDataURL("image/png");return yield this.redrawFullCanvas(),t}catch(t){return console.error(t),null}})}redrawFullCanvas(){return g(this,null,function*(){this.clearCanvas(),this.hasGlobalOverlays||this.addVideoOverlay(),yield this.drawShapesOverlay(),this.addFrameSquareOverlay(),this.addProgressBarOverlay()})}replaceFrame(t,e){this.timeStack.set(t,this.parseShapes(this.stringifyShapes(e)))}addShapesToFrame(t,e){let i=this.timeStack.get(t)||[];this.timeStack.set(t,[...i,...this.parseShapes(this.stringifyShapes(e))])}setFrameRate(t){var e;(e=this.destructors.find(i=>i.name==="frameRateDetector"))==null||e(),this.fps=t}stringifyShapes(t){return JSON.stringify(t,(e,i)=>e==="image"?i.src:i)}parseShapes(t){return JSON.parse(t,(e,i)=>{if(e==="image"){let o=new Image;return o.src=i,o}return i})}filterNonSerializableShapes(t){return t.filter(e=>e.type!=="image")}saveCurrentFrame(){return{frame:this.playbackFrame,version:1,fps:this.fps,shapes:this.parseShapes(this.stringifyShapes(this.filterNonSerializableShapes(this.shapes)))}}loadAllFrames(t){this.cleanFrameStacks(),t.forEach(e=>{this.timeStack.set(e.frame,e.shapes)})}appendFrames(t){t.forEach(e=>{this.addShapesToFrame(e.frame,e.shapes)})}saveAllFrames(){return Array.from(this.timeStack.keys()).filter(o=>{var a;return(a=this.timeStack.get(o))==null?void 0:a.length}).map(o=>{var a;return{frame:o,fps:this.fps,version:1,shapes:this.filterNonSerializableShapes((a=this.timeStack.get(o))!=null?a:[])}})}getAnnotationFrame(t){var l,r;let e=t.offsetX,i=t.offsetY,o=this.isMobile?10:5;return(r=(l=this.annotatedFrameCoordinates.find(h=>e>=h.x-o&&e<=h.x+o&&i>=h.y-o&&i<=h.y+o))==null?void 0:l.frame)!=null?r:null}get totalFrames(){let t=this.videoElement;return t.tagName!=="VIDEO"?1:Math.ceil(t.duration*this.fps)}frameFromProgressBar(t,e=!0){let i=this.videoElement;if(i.tagName!=="VIDEO")return null;let{x:o,width:a,height:l,y:r}=this.progressBarCoordinates,h=t.offsetX,m=t.offsetY;return e?h>=o&&h<=o+a&&m>=r&&m<=r+l?Math.ceil((h-o)/a*(i.duration*this.fps)):null:h>=o&&h<=o+a?Math.ceil((h-o)/a*(i.duration*this.fps)):null}hasAnnotationsForFrame(t){if(this.globalShapes.length>0)return!0;if(this.timeStack.has(t)){let e=this.timeStack.get(t);return e&&e.length>0}return!1}stopAnnotationsAsVideo(){this.isAnnotationsAsVideoActive=!1}startAnnotationsAsVideo(){this.isAnnotationsAsVideoActive=!0,this.playAnnotationsAsVideo()}playAnnotationsAsVideo(){return g(this,null,function*(){this.isAnnotationsAsVideoActive&&(this.updateActiveTimeFrame(),this.syncTime(),this.clearCanvas(),yield this.drawShapesOverlay(),this.raf(()=>{this.syncTime()}),this.waitForFrameSync().finally(()=>{this.playAnnotationsAsVideo()}))})}};function rt(s=this.activeTimeFrame){this.ctx.save(),this.ctx.fillStyle="rgba(0, 0, 0, 0.5)";let n=50,t=30,e=20;this.ctx.fillRect(this.canvasWidth-n,this.canvasHeight-t,n,t),this.ctx.fillStyle="white",this.ctx.font=`${e}px sans-serif`,this.ctx.fillText(`${s}`.padStart(3,"0"),this.canvasWidth-40,this.canvasHeight-7),this.ctx.restore()}function lt(){let s=this.videoElement;s.tagName==="VIDEO"&&this.ctx.drawImage(s,0,0,s.videoWidth,s.videoHeight,0,0,this.canvasWidth,this.canvasHeight)}function ht(){let s=this.videoElement;if(s.tagName!=="VIDEO")return;this.annotatedFrameCoordinates=[];let t=Array.from(this.timeStack.keys()).filter(p=>{var v;return(v=this.timeStack.get(p))==null?void 0:v.length}),e=s.duration*this.fps,{x:i,width:o,height:a,y:l}=this.progressBarCoordinates,r=t.map(p=>Math.ceil(p/e*o));this.ctx.save(),this.ctx.fillStyle="rgba(0, 0, 0, 0.5)",this.ctx.fillRect(i,l,o,a),this.ctx.fillStyle="#F3CE32";let h=this.isMobile?16:8;r.forEach((p,v)=>{this.ctx.beginPath();let x=i+p,E=this.canvasHeight-a/2;this.ctx.fillRect(x-h/2,E-h/2,h,h),this.annotatedFrameCoordinates.push({x,y:E,frame:t[v]})});let m=this.playbackFrame,d=Math.ceil(m/e*o)+i;this.ctx.fillStyle="white",this.ctx.beginPath();let c=d,u=this.canvasHeight-a/2;this.ctx.beginPath(),this.ctx.fillRect(c-h/2,u-h/2,h,h),this.ctx.fill(),this.ctx.restore()}S.prototype.initUI=it;S.prototype.initCanvas=nt;S.prototype.addFrameSquareOverlay=rt;S.prototype.addVideoOverlay=lt;S.prototype.addProgressBarOverlay=ht;new EventSource("/esbuild").addEventListener("change",()=>location.reload());var T=document.querySelector("video");function ct(){return g(this,null,function*(){let s=window.getComputedStyle(T),n=parseFloat(s.width),t=parseFloat(s.height),e=window.innerHeight-80;if(t>e){let u=n/t,p=e,v=p*u;T.style.width=`${v}px`,T.style.height=`${p}px`}let i=yield fetch(T.currentSrc).then(u=>u.blob()),o=new Promise(u=>{setTimeout(()=>{u(!0)},250),T.addEventListener("loadeddata",()=>{u(!0)},{once:!0})}),a=yield fetch("./frame_29.png").then(u=>g(this,null,function*(){let p=yield u.blob(),v=new Blob([p],{type:"image/png"}),x=new Image,E=new Promise(C=>{x.addEventListener("load",()=>{C(!0)},{once:!0})});return x.src=window.URL.createObjectURL(v),yield E,x}));T.paused||T.pause();let l=new Blob([i],{type:"video/mp4"});T.src=window.URL.createObjectURL(l),yield o;let r=new S(T);yield r.addReferenceVideoByURL("./mov_bbb_g.mp4"),r.setFrameRate(30),requestAnimationFrame(()=>{r.setCanvasSize()}),console.log({tool:r}),r.addShapesToFrame(29,[{type:"image",image:a,x:0,y:0,width:1,height:1,strokeStyle:"red",lineWidth:2,fillStyle:"red"}]),T.paused||T.pause(),setInterval(()=>{r.destroy(),r.init(T)},1e8),setInterval(()=>{console.log(r.saveAllFrames())},1e5);let h=document.getElementById("file"),m=document.getElementById("download"),d=document.getElementById("sample");document.getElementById("save-image").addEventListener("click",u=>g(this,null,function*(){u.stopPropagation(),u.preventDefault();let p=yield r.frameToDataUrl();if(!p)return;let v=r.activeTimeFrame,x=document.createElement("a");x.href=p,x.download=`frame_${String(v).padStart(3,"0")}.png`,x.click()})),d.addEventListener("click",u=>{u.stopPropagation(),u.preventDefault(),fetch("./annotations-sample.json").then(p=>p.json()).then(p=>{r.loadAllFrames(p),r.redrawFullCanvas()})}),h.addEventListener("change",u=>{if(!h.files||h.files.length===0)return;let p=h.files[0],v=new FileReader;v.onload=x=>{if(!x.target)return;let E=x.target.result,C=JSON.parse(E);confirm("Append to existing annotations?")?r.appendFrames(C):r.loadAllFrames(C),r.redrawFullCanvas()},v.readAsText(p)}),m.addEventListener("click",u=>{u.stopPropagation(),u.preventDefault();let p=r.saveAllFrames(),v=document.createElement("a");v.href=URL.createObjectURL(new Blob([JSON.stringify(p)],{type:"application/json"}));let x=new Date().toISOString().replace(/:/g,"-");v.download=`annotations-${x}.json`,v.click()})})}T.readyState===0?T.addEventListener("loadedmetadata",()=>{requestAnimationFrame(()=>{ct()})},{once:!0}):ct();})();
