"use strict";(()=>{var Rn=Object.create;var he=Object.defineProperty,Ln=Object.defineProperties,An=Object.getOwnPropertyDescriptor,Dn=Object.getOwnPropertyDescriptors,$n=Object.getOwnPropertyNames,$t=Object.getOwnPropertySymbols,Bn=Object.getPrototypeOf,de=Object.prototype.hasOwnProperty,Ce=Object.prototype.propertyIsEnumerable;var Ee=i=>{throw TypeError(i)},nt=Math.pow,ce=(i,o,t)=>o in i?he(i,o,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[o]=t,k=(i,o)=>{for(var t in o||(o={}))de.call(o,t)&&ce(i,t,o[t]);if($t)for(var t of $t(o))Ce.call(o,t)&&ce(i,t,o[t]);return i},H=(i,o)=>Ln(i,Dn(o));var Fe=(i,o)=>{var t={};for(var e in i)de.call(i,e)&&o.indexOf(e)<0&&(t[e]=i[e]);if(i!=null&&$t)for(var e of $t(i))o.indexOf(e)<0&&Ce.call(i,e)&&(t[e]=i[e]);return t};var Hn=(i,o)=>()=>(o||i((o={exports:{}}).exports,o),o.exports);var On=(i,o,t,e)=>{if(o&&typeof o=="object"||typeof o=="function")for(let n of $n(o))!de.call(i,n)&&n!==t&&he(i,n,{get:()=>o[n],enumerable:!(e=An(o,n))||e.enumerable});return i};var zn=(i,o,t)=>(t=i!=null?Rn(Bn(i)):{},On(o||!i||!i.__esModule?he(t,"default",{value:i,enumerable:!0}):t,i));var Y=(i,o,t)=>ce(i,typeof o!="symbol"?o+"":o,t),Ie=(i,o,t)=>o.has(i)||Ee("Cannot "+t);var I=(i,o,t)=>(Ie(i,o,"read from private field"),t?t.call(i):o.get(i)),ot=(i,o,t)=>o.has(i)?Ee("Cannot add the same private member more than once"):o instanceof WeakSet?o.add(i):o.set(i,t),Et=(i,o,t,e)=>(Ie(i,o,"write to private field"),e?e.call(i,t):o.set(i,t),t);var M=(i,o,t)=>new Promise((e,n)=>{var a=l=>{try{c(t.next(l))}catch(s){n(s)}},r=l=>{try{c(t.throw(l))}catch(s){n(s)}},c=l=>l.done?e(l.value):Promise.resolve(l.value).then(a,r);c((t=t.apply(i,o)).next())});var sn=Hn((ba,rn)=>{"use strict";function eo(i){for(var o=1/0,t=-1/0,e=0,n=i.length,a;e<n;e++)a=i[e],o>a&&(o=a),t<a&&(t=a);return{min:o,max:t}}function nn(i,o){var t=Math.pow(2,o-1),e=i<0?i*t:i*(t-1);return Math.max(-t,Math.min(t-1,e))}function on(i,o,t){var e,n=i.length,a=Math.ceil(n/o),r,c,l,s,h,m,u=an(t,a*2);for(e=0;e<a;e++)r=e*o,c=(e+1)*o>n?n:(e+1)*o,l=i.subarray(r,c),m=eo(l),h=nn(m.min,t),s=nn(m.max,t),u[e*2]=h,u[e*2+1]=s;return u}function an(i,o){return new(new Function(`return Int${i}Array`)())(o)}function no(i,o){var t=i.length,e=1/t,n=i[0].length/2,a=0,r=0,c,l,s=an(o,n*2);for(r=0;r<n;r++){for(c=0,l=0,a=0;a<t;a++)c+=e*i[a][r*2],l+=e*i[a][r*2+1];s[r*2]=c,s[r*2+1]=l}return[s]}function Jt(i,o){return typeof i=="number"?i:o}rn.exports=function(i,o,t,e,n,a){if(o=Jt(o,1e3),a=Jt(a,16),t==null&&(t=!0),[8,16,32].indexOf(a)<0)throw new Error("Invalid number of bits specified for peaks.");var r=i.numberOfChannels,c=[],l,s,h,m;if(e=Jt(e,0),n=Jt(n,i.length),typeof i.subarray=="undefined")for(l=0;l<r;l++)h=i.getChannelData(l),m=h.subarray(e,n),c.push(on(m,o,a));else c.push(on(i.subarray(e,n),o,a));return t&&c.length>1&&(c=no(c,a)),s=c[0].length/2,{length:s,data:c,bits:a}}});var Vn={bgPrimary:"rgba(28, 28, 32, 0.95)",bgSecondary:"rgba(42, 42, 48, 0.98)",bgTertiary:"#35353d",bgHover:"rgba(255, 255, 255, 0.08)",bgActive:"rgba(255, 255, 255, 0.12)",textPrimary:"#f0f0f2",textSecondary:"#a8a8b0",textMuted:"#68687a",border:"rgba(255, 255, 255, 0.1)",borderHover:"rgba(255, 255, 255, 0.2)",accent:"#5b9fff",accentHover:"#7db3ff",shadow:"rgba(0, 0, 0, 0.4)"},Wn={bgPrimary:"rgba(250, 250, 252, 0.95)",bgSecondary:"rgba(255, 255, 255, 0.98)",bgTertiary:"#f0f0f5",bgHover:"rgba(0, 0, 0, 0.04)",bgActive:"rgba(0, 0, 0, 0.08)",textPrimary:"#1a1a24",textSecondary:"#5a5a6e",textMuted:"#9090a0",border:"rgba(0, 0, 0, 0.1)",borderHover:"rgba(0, 0, 0, 0.2)",accent:"#2563eb",accentHover:"#3b82f6",shadow:"rgba(0, 0, 0, 0.15)"},Nn={dark:Vn,light:Wn},d="sm-annotate";function Xn(i){return`
    --${d}-bg-primary: ${i.bgPrimary};
    --${d}-bg-secondary: ${i.bgSecondary};
    --${d}-bg-tertiary: ${i.bgTertiary};
    --${d}-bg-hover: ${i.bgHover};
    --${d}-bg-active: ${i.bgActive};
    --${d}-text-primary: ${i.textPrimary};
    --${d}-text-secondary: ${i.textSecondary};
    --${d}-text-muted: ${i.textMuted};
    --${d}-border: ${i.border};
    --${d}-border-hover: ${i.borderHover};
    --${d}-accent: ${i.accent};
    --${d}-accent-hover: ${i.accentHover};
    --${d}-shadow: ${i.shadow};

    /* Customizable sizing and layout variables */
    --${d}-toolbar-radius: 8px;
    --${d}-toolbar-padding: 4px;
    --${d}-toolbar-gap: 2px;
    --${d}-btn-size: 32px;
    --${d}-btn-size-mobile: 44px;
    --${d}-btn-radius: 6px;
    --${d}-font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
    --${d}-transition-duration: 0.15s;
    --${d}-z-index-toolbar: 10;
    --${d}-z-index-tooltip: 1000;
  `}function Yn(){return`
    /* Root container for CSS isolation */
    .${d}-root {
      font-family: var(--${d}-font-family);
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .${d}-root *,
    .${d}-root *::before,
    .${d}-root *::after {
      box-sizing: border-box;
    }

    .${d}-container {
      position: absolute;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      display: inline-flex;
      flex-direction: row;
      align-items: center;
      flex-wrap: nowrap;
      gap: var(--${d}-toolbar-gap);
      padding: var(--${d}-toolbar-padding);
      background: var(--${d}-bg-primary);
      border: 1px solid var(--${d}-border);
      border-radius: var(--${d}-toolbar-radius);
      backdrop-filter: blur(12px);
      box-shadow: 0 4px 16px var(--${d}-shadow);
      z-index: var(--${d}-z-index-toolbar);
      margin-top: 8px;
      font-family: var(--${d}-font-family);
    }

    .${d}-player-controls {
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      display: inline-flex;
      flex-direction: row;
      align-items: center;
      flex-wrap: nowrap;
      gap: var(--${d}-toolbar-gap);
      padding: var(--${d}-toolbar-padding);
      background: var(--${d}-bg-primary);
      border: 1px solid var(--${d}-border);
      border-radius: var(--${d}-toolbar-radius);
      backdrop-filter: blur(12px);
      box-shadow: 0 4px 16px var(--${d}-shadow);
      z-index: var(--${d}-z-index-toolbar);
      margin-bottom: 8px;
      font-family: var(--${d}-font-family);
    }

    /* ==================== LAYOUT MODES ==================== */

    /* Horizontal layout (default) - already styled above */
    .${d}-layout-horizontal .${d}-container {
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      flex-direction: row;
    }

    /* Vertical sidebar layout */
    .${d}-layout-vertical .${d}-container {
      top: 50%;
      left: 0;
      transform: translateY(-50%);
      flex-direction: column;
      margin-top: 0;
      margin-left: 8px;
    }

    .${d}-layout-vertical.${d}-sidebar-right .${d}-container {
      left: auto;
      right: 0;
      margin-left: 0;
      margin-right: 8px;
    }

    .${d}-layout-vertical .${d}-divider {
      width: 20px;
      height: 1px;
      margin: 4px 0;
    }

    .${d}-layout-vertical .${d}-player-controls {
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      flex-direction: row;
    }

    /* Minimal/Floating layout */
    .${d}-layout-minimal .${d}-container {
      top: 8px;
      left: 8px;
      transform: none;
      flex-wrap: wrap;
      max-width: 200px;
      cursor: move;
      user-select: none;
    }

    .${d}-layout-minimal .${d}-container.${d}-dragging {
      opacity: 0.8;
    }

    .${d}-layout-minimal .${d}-player-controls {
      bottom: 8px;
      left: 50%;
      transform: translateX(-50%);
    }

    /* Bottom dock layout */
    .${d}-layout-bottom-dock .${d}-container {
      top: auto;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      margin-top: 0;
      margin-bottom: 8px;
      flex-direction: row;
    }

    .${d}-layout-bottom-dock .${d}-player-controls {
      display: none;
    }

    /* ==================== COLLAPSIBLE TOOLBARS ==================== */

    .${d}-collapsible {
      transition: transform var(--${d}-transition-duration) ease,
                  opacity var(--${d}-transition-duration) ease;
    }

    .${d}-collapsed {
      opacity: 0.3;
      pointer-events: none;
    }

    .${d}-collapsed:hover,
    .${d}-collapsed:focus-within {
      opacity: 1;
      pointer-events: auto;
    }

    /* Collapse direction based on layout */
    .${d}-layout-horizontal .${d}-container.${d}-collapsed {
      transform: translateX(-50%) translateY(-100%);
    }

    .${d}-layout-vertical .${d}-container.${d}-collapsed {
      transform: translateY(-50%) translateX(-100%);
    }

    .${d}-layout-vertical.${d}-sidebar-right .${d}-container.${d}-collapsed {
      transform: translateY(-50%) translateX(100%);
    }

    .${d}-layout-minimal .${d}-container.${d}-collapsed {
      transform: scale(0.8);
      opacity: 0.3;
    }

    .${d}-layout-bottom-dock .${d}-container.${d}-collapsed {
      transform: translateX(-50%) translateY(100%);
    }

    .${d}-collapse-btn {
      position: absolute;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--${d}-bg-secondary);
      border: 1px solid var(--${d}-border);
      border-radius: 50%;
      cursor: pointer;
      z-index: calc(var(--${d}-z-index-toolbar) + 1);
      transition: background var(--${d}-transition-duration) ease;
    }

    .${d}-collapse-btn:hover {
      background: var(--${d}-bg-hover);
    }

    .${d}-collapse-btn svg {
      width: 14px;
      height: 14px;
      color: var(--${d}-text-secondary);
      transition: transform var(--${d}-transition-duration) ease;
    }

    .${d}-collapsed + .${d}-collapse-btn svg {
      transform: rotate(180deg);
    }

    /* Collapse button position based on layout */
    .${d}-layout-horizontal .${d}-collapse-btn {
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      margin-top: 4px;
    }

    .${d}-layout-vertical .${d}-collapse-btn {
      top: 50%;
      left: 100%;
      transform: translateY(-50%);
      margin-left: 4px;
    }

    .${d}-layout-vertical.${d}-sidebar-right .${d}-collapse-btn {
      left: auto;
      right: 100%;
      margin-left: 0;
      margin-right: 4px;
    }

    .${d}-layout-minimal .${d}-collapse-btn {
      top: -8px;
      right: -8px;
      left: auto;
      transform: none;
    }

    .${d}-layout-bottom-dock .${d}-collapse-btn {
      bottom: 100%;
      left: 50%;
      top: auto;
      transform: translateX(-50%);
      margin-bottom: 4px;
    }

    /* Fullscreen mode - toolbars inside the fullscreen container */
    :fullscreen .${d}-container,
    :-webkit-full-screen .${d}-container {
      position: fixed;
      top: 0;
      margin-top: 8px;
    }

    :fullscreen .${d}-player-controls,
    :-webkit-full-screen .${d}-player-controls {
      position: fixed;
      bottom: 0;
      margin-bottom: 8px;
    }

    .${d}-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      padding: 0;
      border: none;
      border-radius: 6px;
      background: transparent;
      color: var(--${d}-text-secondary);
      cursor: pointer;
      transition: background 0.15s ease, color 0.15s ease;
      outline: none;
    }

    .${d}-btn:hover {
      background: var(--${d}-bg-hover);
      color: var(--${d}-text-primary);
    }

    .${d}-btn:active {
      background: var(--${d}-bg-active);
    }

    .${d}-btn.active {
      background: var(--${d}-accent);
      color: #ffffff;
    }

    .${d}-btn.active:hover {
      background: var(--${d}-accent-hover);
    }

    .${d}-btn:disabled {
      opacity: 0.35;
      cursor: not-allowed;
    }

    .${d}-btn svg {
      width: 18px;
      height: 18px;
    }

    .${d}-divider {
      flex: 0 0 1px;
      width: 1px;
      height: 20px;
      margin: 0 4px;
      background: var(--${d}-border);
    }

    .${d}-color-picker {
      width: 32px;
      height: 32px;
      padding: 4px;
      border: none;
      border-radius: 6px;
      background: transparent;
      cursor: pointer;
      transition: background 0.15s ease;
    }

    .${d}-color-picker:hover {
      background: var(--${d}-bg-hover);
    }

    .${d}-color-picker::-webkit-color-swatch-wrapper {
      padding: 0;
    }

    .${d}-color-picker::-webkit-color-swatch {
      border: 2px solid var(--${d}-border);
      border-radius: 4px;
    }

    .${d}-color-picker:hover::-webkit-color-swatch {
      border-color: var(--${d}-border-hover);
    }

    .${d}-slider {
      width: 48px;
      height: 28px;
      padding: 0 8px;
      border: 1px solid var(--${d}-border);
      border-radius: 6px;
      background: var(--${d}-bg-secondary);
      color: var(--${d}-text-primary);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 12px;
      font-weight: 500;
      text-align: center;
      transition: border-color 0.15s ease;
    }

    .${d}-slider:hover {
      border-color: var(--${d}-border-hover);
    }

    .${d}-slider:focus {
      outline: none;
      border-color: var(--${d}-accent);
    }

    .${d}-group {
      display: inline-flex;
      align-items: center;
      gap: 2px;
    }

    .${d}-fullscreen-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      padding: 0;
      border: none;
      border-radius: 6px;
      background: transparent;
      color: var(--${d}-text-secondary);
      cursor: pointer;
      transition: background 0.15s ease, color 0.15s ease;
      outline: none;
    }

    .${d}-fullscreen-btn:hover {
      background: var(--${d}-bg-hover);
      color: var(--${d}-text-primary);
    }

    .${d}-fullscreen-btn svg {
      width: 18px;
      height: 18px;
    }

    /* Tooltip styles using modern CSS */
    [data-tooltip] {
      position: relative;
    }

    [data-tooltip]::before,
    [data-tooltip]::after {
      position: absolute;
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
      transition: opacity 0.2s ease, visibility 0.2s ease, translate 0.2s ease;
      z-index: 1000;
    }

    /* Tooltip text bubble */
    [data-tooltip]::after {
      content: attr(data-tooltip);
      inset-block-end: calc(100% + 8px);
      inset-inline-start: 50%;
      translate: -50% 4px;
      padding: 6px 10px;
      background: var(--${d}-bg-secondary);
      color: var(--${d}-text-primary);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 12px;
      font-weight: 500;
      line-height: 1.3;
      white-space: nowrap;
      border-radius: 6px;
      border: 1px solid var(--${d}-border);
      box-shadow: 0 4px 12px var(--${d}-shadow);
    }

    /* Tooltip arrow */
    [data-tooltip]::before {
      content: '';
      inset-block-end: calc(100% + 2px);
      inset-inline-start: 50%;
      translate: -50% 4px;
      border: 6px solid transparent;
      border-block-start-color: var(--${d}-bg-secondary);
    }

    /* Show tooltip on hover/focus */
    [data-tooltip]:hover::before,
    [data-tooltip]:hover::after,
    [data-tooltip]:focus-visible::before,
    [data-tooltip]:focus-visible::after {
      opacity: 1;
      visibility: visible;
      translate: -50% 0;
    }

    /* Bottom tooltip variant */
    [data-tooltip-position="bottom"]::after {
      inset-block-end: auto;
      inset-block-start: calc(100% + 8px);
      translate: -50% -4px;
    }

    [data-tooltip-position="bottom"]::before {
      inset-block-end: auto;
      inset-block-start: calc(100% + 2px);
      translate: -50% -4px;
      border-block-start-color: transparent;
      border-block-end-color: var(--${d}-bg-secondary);
    }

    [data-tooltip-position="bottom"]:hover::before,
    [data-tooltip-position="bottom"]:hover::after,
    [data-tooltip-position="bottom"]:focus-visible::before,
    [data-tooltip-position="bottom"]:focus-visible::after {
      translate: -50% 0;
    }

    /* Hide tooltip on disabled buttons */
    [data-tooltip]:disabled::before,
    [data-tooltip]:disabled::after {
      display: none;
    }

    /* Mobile styles - larger touch targets */
    @media (max-width: 960px) {
      .${d}-container {
        gap: 4px;
        padding: 6px;
        margin-top: 4px;
        border-radius: 10px;
        max-width: calc(100vw - 16px);
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
        -ms-overflow-style: none;
      }

      .${d}-container::-webkit-scrollbar {
        display: none;
      }

      .${d}-player-controls {
        gap: 4px;
        padding: 6px;
        margin-bottom: 4px;
        border-radius: 10px;
        max-width: calc(100vw - 16px);
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
        -ms-overflow-style: none;
      }

      .${d}-player-controls::-webkit-scrollbar {
        display: none;
      }

      .${d}-btn {
        width: 44px;
        height: 44px;
        border-radius: 8px;
      }

      .${d}-btn svg {
        width: 22px;
        height: 22px;
      }

      .${d}-divider {
        height: 28px;
        margin: 0 6px;
      }

      .${d}-color-picker {
        width: 44px;
        height: 44px;
        padding: 6px;
        border-radius: 8px;
      }

      .${d}-slider {
        width: 56px;
        height: 36px;
        font-size: 14px;
        border-radius: 8px;
      }

      .${d}-fullscreen-btn {
        width: 44px;
        height: 44px;
        border-radius: 8px;
      }

      .${d}-fullscreen-btn svg {
        width: 22px;
        height: 22px;
      }
    }

    /* Touch devices - hide tooltips */
    @media (pointer: coarse) {
      [data-tooltip]::before,
      [data-tooltip]::after {
        display: none;
      }
    }

    /* Fullscreen mode with safe area support */
    :fullscreen .${d}-container,
    :-webkit-full-screen .${d}-container {
      margin-top: max(8px, env(safe-area-inset-top, 8px));
    }

    :fullscreen .${d}-player-controls,
    :-webkit-full-screen .${d}-player-controls {
      margin-bottom: max(8px, env(safe-area-inset-bottom, 8px));
    }

    /* Mobile fullscreen - extra adjustments */
    @media (max-width: 960px) {
      :fullscreen .${d}-container,
      :-webkit-full-screen .${d}-container {
        margin-top: max(4px, env(safe-area-inset-top, 4px));
        padding-left: max(6px, env(safe-area-inset-left, 6px));
        padding-right: max(6px, env(safe-area-inset-right, 6px));
      }

      :fullscreen .${d}-player-controls,
      :-webkit-full-screen .${d}-player-controls {
        margin-bottom: max(4px, env(safe-area-inset-bottom, 4px));
        padding-left: max(6px, env(safe-area-inset-left, 6px));
        padding-right: max(6px, env(safe-area-inset-right, 6px));
      }
    }

    /* Landscape orientation on mobile - compact mode */
    @media (max-width: 960px) and (orientation: landscape) and (max-height: 500px) {
      .${d}-container {
        padding: 4px;
        gap: 2px;
      }

      .${d}-btn {
        width: 36px;
        height: 36px;
      }

      .${d}-btn svg {
        width: 18px;
        height: 18px;
      }

      .${d}-divider {
        height: 24px;
        margin: 0 4px;
      }

      .${d}-color-picker {
        width: 36px;
        height: 36px;
        padding: 4px;
      }

      .${d}-slider {
        width: 48px;
        height: 32px;
        font-size: 12px;
      }

      .${d}-fullscreen-btn {
        width: 36px;
        height: 36px;
      }

      .${d}-fullscreen-btn svg {
        width: 18px;
        height: 18px;
      }

      .${d}-player-controls {
        padding: 4px;
        gap: 2px;
      }
    }
  `}var Ft=null;function ue(i="dark"){Ft||(Ft=document.createElement("style"),Ft.id=`${d}-theme-styles`,document.head.appendChild(Ft));let o=Nn[i];Ft.textContent=`
    :root {
      ${Xn(o)}
    }
    ${Yn()}
  `}function j(i){i.classList.add(`${d}-btn`)}function Me(i){i.classList.add(`${d}-container`)}function ke(i){i.classList.add(`${d}-player-controls`)}function Pe(i){i.classList.add(`${d}-color-picker`)}function Re(i){i.classList.add(`${d}-slider`)}function Le(i){i.classList.add(`${d}-fullscreen-btn`)}function It(){let i=document.createElement("div");return i.classList.add(`${d}-divider`),i}function xt(){return d}function Ae(i){let o=document.createElement("button");o.type="button",o.dataset.tooltip="Toggle theme",j(o);let t=()=>{let e=i.theme==="dark";o.innerHTML=e?`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="5"/>
          <line x1="12" y1="1" x2="12" y2="3"/>
          <line x1="12" y1="21" x2="12" y2="23"/>
          <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
          <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
          <line x1="1" y1="12" x2="3" y2="12"/>
          <line x1="21" y1="12" x2="23" y2="12"/>
          <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
          <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
        </svg>`:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
        </svg>`};return t(),i.addEvent(o,"click",()=>{i.setTheme(i.theme==="dark"?"light":"dark"),t()}),o}function De(i,o){let t=document.createElement("button");t.type="button",j(t),t.style.float="right",t.dataset.tooltip="Download frame",t.dataset.tooltipPosition="bottom",t.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-image"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"></rect><circle cx="9" cy="9" r="2"></circle><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"></path></svg>',o.addEvent(t,"click",()=>{let e=o.frameToDataUrl();if(!e)return;let n=document.createElement("a");n.download=`frame_${String(o.activeTimeFrame).padStart(3,"0")}.png`,n.href=e,n.click()}),o.buttons.push(t),o.playerControlsContainer.appendChild(t)}var $e='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-volume-x"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><line x1="22" x2="16" y1="9" y2="15"></line><line x1="16" x2="22" y1="9" y2="15"></line></svg>',Be='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-volume-2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path><path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path></svg>';function He(i,o){let t=document.createElement("button");t.type="button",j(t),t.dataset.tooltip="Mute/Unmute",t.dataset.tooltipPosition="bottom",i.muted||i.volume===0?t.innerHTML=$e:t.innerHTML=Be,o.addEvent(i,"volumechange",()=>{i.muted||i.volume===0?t.innerHTML=$e:t.innerHTML=Be}),o.addEvent(t,"click",()=>{if(i.muted){i.muted=!1;return}i.volume===0?i.volume=1:i.volume=0}),o.buttons.push(t),o.playerControlsContainer.appendChild(t)}var lt=[{value:0,label:"off"},{value:.25,label:"25%"},{value:.5,label:"50%"},{value:.7,label:"70%"},{value:1,label:"100%"}];function Oe(i,o=!1){let t=o?'<circle cx="18" cy="6" r="4" fill="currentColor" opacity="0.7"/>':"";return`<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <style>
      .label {
        font-family: sans-serif;
        font-size: 9px;
      }
    </style>
    <rect x="3" y="3" width="18" height="18" rx="2" opacity="${i.value===0?.3:i.value}"/>
    <text x="12" y="14" text-anchor="middle" class="label" fill="currentColor">${i.label}</text>
    ${t}
  </svg>`}function me(i){let o=lt.findIndex(t=>t.value===i);return o===-1?4:o}function ze(i){let o=document.createElement("button");o.type="button",o.dataset.tooltip="Opacity";let t=me(i.overlayOpacity),e=()=>{var c;let a=i.currentTool==="move"?i.pluginForTool("move"):null,r=a==null?void 0:a.getSelectedShape();if(r){let l=(c=r.opacity)!=null?c:1,s=me(l);o.innerHTML=Oe(lt[s],!0),o.dataset.tooltip="Shape opacity"}else o.innerHTML=Oe(lt[t],!1),o.dataset.tooltip="Overlay opacity"};e(),j(o),i.addEvent(o,"click",()=>{var c;let a=i.currentTool==="move"?i.pluginForTool("move"):null,r=a==null?void 0:a.getSelectedShape();if(r&&a){let l=(c=r.opacity)!=null?c:1,s=me(l);s=(s+1)%lt.length;let h=lt[s].value;a.setSelectedShapeOpacity(h)}else t=(t+1)%lt.length,i.overlayOpacity=lt[t].value,i.redrawFullCanvas();e()});let n=i.redrawFullCanvas.bind(i);return i.redrawFullCanvas=()=>{n(),e()},i.buttons.push(o),i.uiContainer.appendChild(o),o}var Ve='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>',Un='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pause"><rect width="4" height="16" x="6" y="4"></rect><rect width="4" height="16" x="14" y="4"></rect></svg>';function We(i,o){let t=document.createElement("button");t.type="button",t.innerHTML=Ve,j(t),t.dataset.tooltip="Play/Pause",t.dataset.tooltipPosition="bottom",o.addEvent(i,"play",()=>{t.innerHTML=Un}),o.addEvent(i,"pause",()=>{t.innerHTML=Ve}),o.addEvent(t,"click",()=>{o.withRefVideo(e=>{e.paused&&e.play().then(()=>{o.showButton("compare")})}),i.paused?i.play().then(()=>{o.redrawFullCanvas()}):(i.pause(),o.raf(()=>{o.redrawFullCanvas()}))}),o.buttons.push(t),o.playerControlsContainer.appendChild(t)}function Ne(i){return`<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-superscript">
        <style>
            .small {
                font-family: auto;
                font-size: ${i===1?"16":"24"}px;
            }
        </style>
        <text x="${i===1?3:2}" y="${i===1?17:20}" font-weight="normal" class="small">${{"0.25":"\xBC","0.5":"\xBD","0.75":"\xBE",1:"1\xD7"}[String(i)]}</text>
        
    </svg>`}function Xe(i,o){let t=[.25,.5,.75,1],e=document.createElement("button"),n=t[t.length-1];e.type="button",i.playbackRate=n,e.innerHTML=Ne(n),j(e),e.dataset.tooltip="Playback speed",e.dataset.tooltipPosition="bottom",o.addEvent(e,"click",()=>{let a=t.indexOf(i.playbackRate),r=a+1>=t.length?0:a+1;i.playbackRate=t[r],e.innerHTML=Ne(t[r])}),o.buttons.push(e),o.playerControlsContainer.appendChild(e)}var jn=500;function Ye(i,o,t){let e=null,n=!1,a=()=>{n=!1,e=setTimeout(()=>{n=!0,t(),o.redrawFullCanvas()},jn)},r=()=>{e&&(clearTimeout(e),e=null)},c=()=>{e&&(clearTimeout(e),e=null)},l=s=>{n&&(s.preventDefault(),s.stopImmediatePropagation(),n=!1)};o.addEvent(i,"click",l),i.addEventListener("pointerdown",a),i.addEventListener("pointerup",r),i.addEventListener("pointerleave",c),o.destructors.push(()=>{i.removeEventListener("pointerdown",a),i.removeEventListener("pointerup",r),i.removeEventListener("pointerleave",c),e&&clearTimeout(e)})}var Bt=class{constructor(o,t){this.create=(o,t,e=this.uiContainer,n,a="top")=>{let r=document.createElement("button");if(r.type="button",r.innerHTML=o,j(r),n&&(r.dataset.tooltip=n,a==="bottom"&&(r.dataset.tooltipPosition="bottom")),e.appendChild(r),this.buttons.push(r),typeof t=="function")this.addEvent(r,"click",t);else{r.dataset.tool=t;let c=()=>{this.currentTool===t?this.currentTool=null:this.currentTool=t};try{this.tool.pluginForTool(t),this.addEvent(r,"click",c)}catch(l){console.error(l),r.disabled=!0}}return r};this.tool=o,this.uiContainer=t}get buttons(){return this.tool.buttons}get addEvent(){return this.tool.addEvent.bind(this.tool)}get currentTool(){return this.tool.currentTool}set currentTool(o){this.tool.currentTool=o}};function Ue(i,o){let t=i.videoElement.tagName==="VIDEO"?i.videoElement:null;if(o.create('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></svg>',"rectangle",o.uiContainer,"Rectangle"),o.create('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle></svg>',"circle",o.uiContainer,"Circle"),o.create('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.3 8.7 8.7 21.3c-1 1-2.5 1-3.4 0l-2.6-2.6c-1-1-1-2.5 0-3.4L15.3 2.7c1-1 2.5-1 3.4 0l2.6 2.6c1 1 1 2.5 0 3.4Z"></path><path d="m7.5 10.5 2 2"></path><path d="m10.5 7.5 2 2"></path><path d="m13.5 4.5 2 2"></path><path d="m4.5 13.5 2 2"></path></svg>',"line",o.uiContainer,"Line"),o.create('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9.06 11.9 8.07-8.06a2.85 2.85 0 1 1 4.03 4.03l-8.06 8.08"></path><path d="M7.07 14.94c-1.66 0-3 1.35-3 3.02 0 1.33-2.5 1.52-2 2.02 1.08 1.1 2.49 2.02 4 2.02 2.2 0 4-1.8 4-4.04a3.01 3.01 0 0 0-3-3.02z"></path></svg>',"curve",o.uiContainer,"Freehand"),o.create('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>',"arrow",o.uiContainer,"Arrow"),o.create('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="4 7 4 4 20 4 20 7"></polyline><line x1="9" y1="20" x2="15" y2="20"></line><line x1="12" y1="4" x2="12" y2="20"></line></svg>',"text",o.uiContainer,"Text"),o.create('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m7 21-4.3-4.3c-1-1-1-2.5 0-3.4l9.6-9.6c1-1 2.5-1 3.4 0l5.6 5.6c1 1 1 2.5 0 3.4L13 21"></path><path d="M22 21H7"></path><path d="m5 11 9 9"></path></svg>',"eraser",o.uiContainer,"Eraser"),o.uiContainer.appendChild(It()),o.create('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="5 9 2 12 5 15"></polyline><polyline points="9 5 12 2 15 5"></polyline><polyline points="15 19 12 22 9 19"></polyline><polyline points="19 9 22 12 19 15"></polyline><line x1="2" y1="12" x2="22" y2="12"></line><line x1="12" y1="2" x2="12" y2="22"></line></svg>',"move",o.uiContainer,"Move shape"),o.create('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-flip-horizontal"><path d="M8 3H5a2 2 0 0 0-2 2v14c0 1.1.9 2 2 2h3"></path><path d="M16 3h3a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-3"></path><path d="M12 20v2"></path><path d="M12 14v2"></path><path d="M12 8v2"></path><path d="M12 2v2"></path></svg>',"compare",o.uiContainer,"Compare videos"),ze(i),o.create('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7v6h6"></path><path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"></path></svg>',()=>{i.handleUndo()},o.uiContainer,"Undo (Ctrl+Z)"),t){let e=o.create('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="19 20 9 12 19 4 19 20"></polygon><line x1="5" y1="19" x2="5" y2="5"></line></svg>',()=>{i.prevFrame()},i.playerControlsContainer,"Previous frame (hold for annotation)","bottom");Ye(e,i,()=>i.prevAnnotatedFrame()),We(t,i);let n=o.create('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 4 15 12 5 20 5 4"></polygon><line x1="19" y1="5" x2="19" y2="19"></line></svg>',()=>{i.nextFrame()},i.playerControlsContainer,"Next frame (hold for annotation)","bottom");Ye(n,i,()=>i.nextAnnotatedFrame()),He(t,i),Xe(t,i),De(t,i)}o.create(`<svg viewBox="0 0 24 24" width="24" height="24">
      <path fill="currentColor" d="M3 3h18v18H3V3m2 2v14h14V5H5z"/>
      <path fill="currentColor" d="M7 7h10v10H7V7m2 2v6h6V9H9z"/>
    </svg>`,"selection",o.uiContainer,"Select region")}var Z=(i,o)=>{let t=i.target===document.body,e=o.uiContainer.contains(i.target),n=o.playerControlsContainer.contains(i.target),a=o.videoElement.contains(i.target),r=o.canvas.contains(i.target);return e||n||a||r||t};function Ht(i){return i.pointerType==="pen"?!1:i.pointerType==="touch"&&i.isPrimary===!1}function je(i,o){if(!Z(i,o))return;let t=o.uiContainer.contains(i.target),e=o.playerControlsContainer.contains(i.target);if(t||e)return;let n=o.videoElement;n.tagName==="VIDEO"&&(n.paused||(o.currentTool=null,n.pause(),o.raf(()=>M(this,null,function*(){o.redrawFullCanvas()}))))}function _e(i,o){var t;Z(i,o)&&(i.preventDefault(),i.stopPropagation(),i.stopImmediatePropagation(),(t=i.clipboardData)==null||t.setData("application/json",JSON.stringify(o.saveCurrentFrame())))}function Ge(i,o){var e;if(!Z(i,o))return;i.preventDefault(),i.stopPropagation(),i.stopImmediatePropagation();let t=o.saveCurrentFrame();o.replaceFrame(o.playbackFrame,[]),o.redrawFullCanvas(),(e=i.clipboardData)==null||e.setData("application/json",JSON.stringify(t))}function qe(i,o){if(!Z(i,o))return;let t=o.videoElement;t.tagName==="VIDEO"&&(i.key==="ArrowLeft"||i.key==="ArrowRight"?(i.preventDefault(),i.stopPropagation(),i.stopImmediatePropagation(),i.key==="ArrowLeft"?o.prevFrame():i.key==="ArrowRight"&&o.nextFrame()):i.code==="Space"&&(i.preventDefault(),i.stopPropagation(),i.stopImmediatePropagation(),t.paused?t.play().then(()=>{o.redrawFullCanvas()}):(t.pause(),o.raf(()=>{o.redrawFullCanvas()}))))}function Ke(i,o){var a,r,c,l,s;if(!Z(i,o))return;let t=(r=(a=i.clipboardData)==null?void 0:a.types)!=null?r:[];if(t.includes("application/json"))i.preventDefault(),i.stopPropagation(),i.stopImmediatePropagation();else if(t.includes("Files")){let h=(c=i.clipboardData)==null?void 0:c.files;if(h&&h.length>0){let m=h[0];if(m.type.startsWith("image/")){i.preventDefault(),i.stopPropagation(),i.stopImmediatePropagation();let u=new Image,p=URL.createObjectURL(m);u.addEventListener("load",()=>{URL.revokeObjectURL(p);let f=u.naturalWidth/u.naturalHeight,v=.25,y=v/f*o.aspectRatio;o.addShapesToFrame(o.playbackFrame,[{type:"image",image:u,x:0,y:0,width:v,height:y,strokeStyle:"red",fillStyle:"red",lineWidth:2}]),o.redrawFullCanvas(),o.raf(()=>{o.show()}),o.currentTool="move"},{once:!0}),u.addEventListener("error",()=>{URL.revokeObjectURL(p)},{once:!0}),u.src=p,o.redrawFullCanvas()}}}else if(t.includes("text/plain")){let h=(l=i.clipboardData)==null?void 0:l.getData("text/plain");h&&(i.preventDefault(),i.stopPropagation(),i.stopImmediatePropagation(),o.addShapesToFrame(o.playbackFrame,[{type:"text",text:h,x:.4,y:.4,strokeStyle:o.ctx.strokeStyle,fillStyle:o.ctx.fillStyle,lineWidth:o.ctx.lineWidth}]),o.show(),o.currentTool="move",o.redrawFullCanvas())}else return;let e=(s=i.clipboardData)==null?void 0:s.getData("application/json");if(!e)return;let n=JSON.parse(e);n&&n.shapes&&n.version===1&&(o.addShapesToFrame(o.playbackFrame,n.shapes),o.redrawFullCanvas())}var ct={r:"#d31a3b",g:"#15d33b",b:"#0085CA",y:"#F3CE32",a:"#7fffd4",c:"#00ffff",d:"#696969",e:"#50c878",f:"#ff00ff",h:"#f0fff0",i:"#4b0082",j:"#00a86b",k:"#f0e68c",l:"#e6e6fa",m:"#98ff98",n:"#000080",o:"#ffa500",p:"#800080",q:"#e5acc8",s:"#0f52ba",t:"#008080",u:"#3f00ff",v:"#ee82ee",w:"#ffffff",x:"#738678",z:"#0014a8"};function Je(i,o){let t=document.createElement("input");t.type="color",t.value=i,t.dataset.tooltip="Stroke color";let e=n=>{o.ctx.strokeStyle=n.target.value,o.ctx.fillStyle=n.target.value,o.focusOnMediaNode()};return o.addEvent(t,"input",e),t}function Ze(i){let o=document.createElement("input");o.type="number",o.step="1",o.min="1",o.max="10",o.value="5",o.style.margin="5px",o.dataset.tooltip="Stroke width";let t=e=>{i.ctx.lineWidth=e.target.valueAsNumber,i.focusOnMediaNode()};return i.addEvent(o,"input",t),o}var _n=`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
  <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/>
</svg>`;function Gn(){var i,o;return(o=(i=document.fullscreenElement)!=null?i:document.webkitFullscreenElement)!=null?o:null}function qn(i){if(i.requestFullscreen)return i.requestFullscreen();let o=i;if(o.webkitRequestFullscreen)return o.webkitRequestFullscreen()}function Kn(){if(document.exitFullscreen)return document.exitFullscreen();let i=document;if(i.webkitExitFullscreen)return i.webkitExitFullscreen()}function Jn(){var i;return!!((i=document.fullscreenEnabled)!=null?i:document.webkitFullscreenEnabled)}function Qe(i){let o=document.createElement("button");if(o.innerHTML=_n,o.type="button",o.dataset.tooltip="Fullscreen",o.dataset.tooltipPosition="bottom",Le(o),!Jn())return o.style.display="none",o;let t=()=>{if(Gn())Kn();else{let n=i.videoElement.parentElement;n&&qn(n)}};o.addEventListener("click",t);let e=()=>{i.setCanvasSize(),i.playbackFrame=i.playbackFrame,i.canvas.focus(),i.redrawFullCanvas(),o.blur()};return document.addEventListener("fullscreenchange",e),document.addEventListener("webkitfullscreenchange",e),i.destructors.push(()=>{o.removeEventListener("click",t),document.removeEventListener("fullscreenchange",e),document.removeEventListener("webkitfullscreenchange",e)}),o}var Zn=ct.r,Qn="",to="";function tn(){var c,l;let i=document.createElement("div");i.style.cssText=to,Me(i),(c=this.canvas.parentNode)==null||c.insertBefore(i,this.canvas);let o=document.createElement("div");o.style.cssText=Qn,ke(o),(l=this.canvas.parentNode)==null||l.insertBefore(o,this.canvas.nextSibling),this.playerControlsContainer=o;let t=this.videoElement.tagName==="VIDEO"?this.videoElement:null;this.uiContainer=i;let e=()=>{let s=document.createElement("div");return s.style.display="inline-flex",s.style.alignItems="center",s},n=new Bt(this,i);Ue(this,n),this.isMobile&&(this.hideButton("line"),this.hideButton("circle"),this.hideButton("rectangle"),this.hideButton("eraser")),this.hideButton("compare"),i.appendChild(It()),this.colorPicker=Je(Zn,this),Pe(this.colorPicker),i.appendChild(this.colorPicker);let a=e();this.strokeSizePicker=Ze(this),Re(this.strokeSizePicker),a.appendChild(this.strokeSizePicker),i.appendChild(a),i.appendChild(It());let r=Ae(this);if(i.appendChild(r),t){this.hide(),this.addEvent(t,"pause",()=>{this.show()}),this.addEvent(t,"seek",()=>{t.paused&&this.show()}),this.addEvent(t,"timeupdate",()=>{t.currentTime<2e-4&&!t.paused&&this.startAnnotationsAsVideo()}),this.addEvent(t,"error",()=>{this.hide()}),this.addEvent(t,"stalled",()=>{this.hide()}),this.addEvent(t,"play",()=>{this.hideControls(),this.startAnnotationsAsVideo()}),this.addEvent(document,"copy",h=>{_e(h,this)}),this.addEvent(document,"cut",h=>{Ge(h,this)}),this.addEvent(document,"paste",h=>{Ke(h,this)}),this.addEvent(document,"click",h=>{je(h,this)}),this.addEvent(document,"keydown",h=>{qe(h,this)}),this.addEvent(document.body.querySelector("div"),"drop",h=>{var m;(m=h.dataTransfer)!=null&&m.types});let s=Qe(this);o.appendChild(s)}}function en(){var i;this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"),(i=this.videoElement.parentNode)==null||i.insertBefore(this.canvas,this.videoElement.nextSibling),this.canvas.style.position="absolute",this.canvas.style.backgroundColor="transparent",this.canvas.style.top="0",this.canvas.style.left="0",this.canvas.style.zIndex="1",this.addEvent(this.canvas,"pointerdown",this.handleMouseDown),this.addEvent(this.canvas,"pointermove",this.handleMouseMove),this.addEvent(this.canvas,"pointerup",this.handleMouseUp),this.addEvent(this.canvas,"pointercancel",this.handleMouseUp),this.addEvent(this.canvas,"pointerenter",()=>{this.isCursorOverCanvas=!0}),this.addEvent(this.canvas,"pointerleave",()=>{this.isCursorOverCanvas=!1}),this.addEvent(this.canvas,"touchmove",o=>{o.stopImmediatePropagation(),o.stopPropagation(),o.preventDefault()}),this.addEvent(window,"resize",this.setCanvasSize),this.addEvent(document,"keydown",this.onKeyDown)}var Ot=class{constructor(){this.destructors=[];this.isDestroyed=!1;this.activeTimeFrame=1;this.globalShapes=[];this.timeStack=new Map;this.undoTimeStack=new Map}cleanFrameStacks(){this.timeStack.clear(),this.undoTimeStack.clear()}destroy(){this.destructors.forEach(o=>o()),this.destructors=[],this.globalShapes=[],this.cleanFrameStacks()}raf(o){return requestAnimationFrame(o)}addEvent(o,t,e){let n=a=>{this.isDestroyed||e(a)};o.addEventListener(t,n),this.destructors.push(()=>{o.removeEventListener(t,n)})}addProgressBarOverlay(){throw new Error("Method not implemented.")}initUI(){throw new Error("Method not implemented.")}initCanvas(){throw new Error("Method not implemented.")}addFrameSquareOverlay(o=this.activeTimeFrame){throw new Error("Method not implemented.")}addVideoOverlay(){throw new Error("Method not implemented.")}withRefVideo(o){this.isDestroyed||this.referenceVideoElement&&o(this.referenceVideoElement)}withVideo(o){if(this.isDestroyed)return;let t=this.videoElement;!t||t.tagName!=="VIDEO"||o(t)}};var B=class{constructor(o){this.startX=0;this.startY=0;this.isDrawing=!1;this.annotationTool=o}isPointerAtShape(o,t,e){return!1}on(o,t){}get ctx(){return this.annotationTool.ctx}onDeactivate(){}onActivate(){}reset(){this.startX=0,this.startY=0,this.isDrawing=!1}save(o){this.annotationTool.addShape(o)}applyRotation(o,t,e){return o.rotation?(this.ctx.save(),this.ctx.translate(t,e),this.ctx.rotate(o.rotation),this.ctx.translate(-t,-e),!0):!1}restoreRotation(){this.ctx.restore()}getRotationCenter(o,t,e){return o.rotationCenterX!==void 0&&o.rotationCenterY!==void 0?{x:o.rotationCenterX*this.annotationTool.canvasWidth,y:o.rotationCenterY*this.annotationTool.canvasHeight}:{x:t,y:e}}};var zt=class extends B{constructor(){super(...arguments);this.name="rectangle"}move(t,e,n){return t.x+=e,t.y+=n,t}normalize(t,e,n){return H(k({},t),{x:t.x/e,y:t.y/n,width:t.width/e,height:t.height/n})}onPointerDown(t){let{x:e,y:n}=this.annotationTool.getRelativeCoords(t);this.startX=e,this.startY=n,this.isDrawing=!0}onPointerMove(t){if(!this.isDrawing)return;let{x:e,y:n}=this.annotationTool.getRelativeCoords(t);this.drawRectangle(this.startX,this.startY,e-this.startX,n-this.startY)}onPointerUp(t){if(!this.isDrawing)return;let{x:e,y:n}=this.annotationTool.getRelativeCoords(t);this.save({type:"rectangle",x:this.startX,y:this.startY,width:e-this.startX,height:n-this.startY,strokeStyle:this.ctx.strokeStyle,fillStyle:this.ctx.fillStyle,lineWidth:this.ctx.lineWidth}),this.drawRectangle(this.startX,this.startY,e-this.startX,n-this.startY),this.isDrawing=!1}drawRectangle(t,e,n,a){this.ctx.beginPath(),this.ctx.rect(t,e,n,a),this.ctx.stroke()}draw(t){let e=t.x+t.width/2,n=t.y+t.height/2,a=this.getRotationCenter(t,e,n),r=this.applyRotation(t,a.x,a.y);this.drawRectangle(t.x,t.y,t.width,t.height),r&&this.restoreRotation()}isPointerAtShape(t,e,n){let r=Math.min(t.x,t.x+t.width),c=Math.max(t.x,t.x+t.width),l=Math.min(t.y,t.y+t.height),s=Math.max(t.y,t.y+t.height),h=Math.abs(e-r)<=5,m=Math.abs(e-c)<=5,u=Math.abs(n-l)<=5,p=Math.abs(n-s)<=5,f=n>=l-5&&n<=s+5,v=e>=r-5&&e<=c+5;return(h||m)&&f||(u||p)&&v}};var Vt=class extends B{constructor(){super(...arguments);this.name="circle"}move(t,e,n){return t.x+=e,t.y+=n,t}normalize(t,e,n){return H(k({},t),{x:t.x/e,y:t.y/n,radius:t.radius/e})}onPointerDown(t){let{x:e,y:n}=this.annotationTool.getRelativeCoords(t);this.startX=e,this.startY=n,this.isDrawing=!0}onPointerMove(t){if(!this.isDrawing)return;let{x:e,y:n}=this.annotationTool.getRelativeCoords(t),a=Math.sqrt(Math.pow(e-this.startX,2)+Math.pow(n-this.startY,2));this.drawCircle(this.startX,this.startY,a)}onPointerUp(t){if(!this.isDrawing)return;let{x:e,y:n}=this.annotationTool.getRelativeCoords(t),a=Math.sqrt(Math.pow(e-this.startX,2)+Math.pow(n-this.startY,2));this.save({type:"circle",x:this.startX,y:this.startY,radius:a,strokeStyle:this.ctx.strokeStyle,fillStyle:this.ctx.fillStyle,lineWidth:this.ctx.lineWidth}),this.drawCircle(this.startX,this.startY,a),this.isDrawing=!1}drawCircle(t,e,n){this.ctx.beginPath(),this.ctx.arc(t,e,n,0,2*Math.PI),this.ctx.stroke()}draw(t){if(t.radius===void 0||t.radius<0)return;let e=this.getRotationCenter(t,t.x,t.y),n=this.applyRotation(t,e.x,e.y);this.drawCircle(t.x,t.y,t.radius),n&&this.restoreRotation()}isPointerAtShape(t,e,n){var s;if(t.radius===void 0||t.radius<0)return!1;let a=e-t.x,r=n-t.y,c=Math.sqrt(a*a+r*r),l=Math.max(((s=t.lineWidth)!=null?s:1)/2,5);return c<=t.radius+l}};var Wt=class{constructor(o,t){this.x=o;this.y=t}distanceToLine(o,t){let e=t.x-o.x,n=t.y-o.y,a=Math.abs(n*this.x-e*this.y+t.x*o.y-t.y*o.x),r=Math.sqrt(n*n+e*e);return a/r}};function Nt(i,o){if(i.length<=2)return i;let t=i[0],e=i[i.length-1],n=-1,a=0;for(let r=1;r<i.length-1;r++){let c=i[r].distanceToLine(t,e);c>a&&(n=r,a=c)}if(a>o){let r=Nt(i.slice(0,n+1),o),c=Nt(i.slice(n),o);return r.slice(0,r.length-1).concat(c)}else return[t,e]}var Xt=class extends B{constructor(){super(...arguments);this.name="curve";this.curvePoints=[];this.zoomScale=2;this.zoomRadius=100;this.zoomCtx=null;this.zoomCanvas=null;this.onKeyPress=t=>{let e=t.key;if(e===null||e===" "||t.isComposing)return;let n=Number(e);if(isNaN(n)||!n){e in ct&&(this.annotationTool.colorPicker.value=ct[e],this.annotationTool.setCanvasSettings());return}this.annotationTool.strokeSizePicker.value=e,this.annotationTool.setCanvasSettings()}}move(t,e,n){return t.points=t.points.map(a=>({x:a.x+e,y:a.y+n})),t}onActivate(){this.initZoomCanvas(),document.addEventListener("keypress",this.onKeyPress)}onDeactivate(){this.zoomCtx=null,this.zoomCanvas=null,document.removeEventListener("keypress",this.onKeyPress)}normalize(t,e,n){return H(k({},t),{points:t.points.map(a=>({x:a.x/e,y:a.y/n}))})}draw(t){if(!t.points||t.points.length===0)return;let e=0,n=0;for(let s of t.points)e+=s.x,n+=s.y;let a=e/t.points.length,r=n/t.points.length,c=this.getRotationCenter(t,a,r),l=this.applyRotation(t,c.x,c.y);this.drawCurve(t),l&&this.restoreRotation()}reset(){super.reset(),this.curvePoints=[]}onPointerDown(t){if(this.isDrawing)return;let{x:e,y:n}=this.annotationTool.getRelativeCoords(t);this.curvePoints=[],this.startX=e,this.startY=n,this.isDrawing=!0,this.curvePoints.push({x:e,y:n})}onPointerMove(t){let{x:e,y:n}=this.annotationTool.getRelativeCoords(t);if(!this.isDrawing){this.drawZoomCircle(e,n,t.shiftKey);return}this.curvePoints.push({x:e,y:n}),this.drawCurve({points:this.curvePoints,lineWidth:this.ctx.lineWidth}),this.drawZoomCircle(e,n,t.shiftKey)}onPointerUp(t){let{x:e,y:n}=this.annotationTool.getRelativeCoords(t);if(this.drawZoomCircle(e,n,t.shiftKey),!this.isDrawing)return;this.curvePoints.push({x:e,y:n});let a=this.curvePoints.map(h=>new Wt(h.x,h.y)),s={type:"curve",points:Nt(a,.5).map(h=>({x:h.x,y:h.y})),strokeStyle:this.ctx.strokeStyle,fillStyle:this.ctx.fillStyle,lineWidth:this.ctx.lineWidth};this.save(s),this.curvePoints=[],this.isDrawing=!1}drawCurve(t){if(t.points.length===2&&t.points[0].x===t.points[1].x&&t.points[0].y===t.points[1].y){let e=t.lineWidth/4,n=0,a=2*Math.PI;this.ctx.beginPath(),this.ctx.arc(t.points[0].x,t.points[0].y,e,n,a),this.ctx.stroke()}else{this.ctx.beginPath(),this.ctx.moveTo(t.points[0].x,t.points[0].y);for(let e=0;e<t.points.length-1;e++){let n=t.points[e],a=t.points[e+1];this.ctx.quadraticCurveTo(n.x,n.y,a.x,a.y)}this.ctx.stroke()}}initZoomCanvas(){let t=document.createElement("canvas"),e=2;t.width=this.zoomRadius*2*e,t.height=this.zoomRadius*2*e;let n=t.getContext("2d");n&&(n.imageSmoothingQuality="high",n.imageSmoothingEnabled=!0,this.zoomCtx=n,this.zoomCanvas=t)}isPointerAtShape(t,e,n){var r;if(!t.points||t.points.length===0)return!1;let a=Math.max(((r=t.lineWidth)!=null?r:this.ctx.lineWidth)/2,5);for(let c=0;c<t.points.length-1;c++){let l=t.points[c],s=t.points[c+1],h=e-l.x,m=n-l.y,u=s.x-l.x,p=s.y-l.y,f=h*u+m*p,v=u*u+p*p,y=-1;v!==0&&(y=f/v);let g,x;y<0?(g=l.x,x=l.y):y>1?(g=s.x,x=s.y):(g=l.x+y*u,x=l.y+y*p);let C=e-g,P=n-x;if(Math.sqrt(C*C+P*P)<a)return!0}return!1}drawZoomCircle(t,e,n=!1){if(!n)return;this.isDrawing||(this.annotationTool.clearCanvas(),this.annotationTool.addVideoOverlay(),this.annotationTool.drawShapesOverlay());let a=this.zoomCtx;if(!a)return;let r=this.annotationTool.pixelRatio,c=this.zoomRadius*2/this.zoomScale,l=t-c/2,s=e-c/2;a.clearRect(0,0,this.zoomCanvas.width,this.zoomCanvas.height),a.drawImage(this.ctx.canvas,l*r,s*r,c*r,c*r,0,0,this.zoomRadius*2,this.zoomRadius*2),this.ctx.save(),this.ctx.beginPath(),this.ctx.arc(t,e,this.zoomRadius,0,2*Math.PI),this.ctx.closePath(),this.ctx.clip(),this.ctx.drawImage(this.zoomCanvas,t-this.zoomRadius,e-this.zoomRadius),this.ctx.restore()}};var Yt=class extends B{constructor(){super(...arguments);this.name="line"}move(t,e,n){return t.x1+=e,t.y1+=n,t.x2+=e,t.y2+=n,t}normalize(t,e,n){return H(k({},t),{x1:t.x1/e,y1:t.y1/n,x2:t.x2/e,y2:t.y2/n})}onPointerDown(t){let{x:e,y:n}=this.annotationTool.getRelativeCoords(t);this.startX=e,this.startY=n,this.isDrawing=!0}onPointerMove(t){if(!this.isDrawing)return;let{x:e,y:n}=this.annotationTool.getRelativeCoords(t);this.drawLine(this.startX,this.startY,e,n)}onPointerUp(t){if(!this.isDrawing)return;let{x:e,y:n}=this.annotationTool.getRelativeCoords(t);this.save({type:"line",x1:this.startX,y1:this.startY,x2:e,y2:n,fillStyle:this.ctx.fillStyle,strokeStyle:this.ctx.strokeStyle,lineWidth:this.ctx.lineWidth}),this.drawLine(this.startX,this.startY,e,n),this.isDrawing=!1}drawLine(t,e,n,a){this.ctx.beginPath(),this.ctx.moveTo(t,e),this.ctx.lineTo(n,a),this.ctx.stroke()}draw(t){let e=(t.x1+t.x2)/2,n=(t.y1+t.y2)/2,a=this.getRotationCenter(t,e,n),r=this.applyRotation(t,a.x,a.y);this.drawLine(t.x1,t.y1,t.x2,t.y2),r&&this.restoreRotation()}isPointerAtShape(t,e,n){var u;let{x1:a,y1:r,x2:c,y2:l}=t,s=Math.max(((u=t.lineWidth)!=null?u:1)/2,5),h=(c-a)*(r-n)-(a-e)*(l-r),m=nt(c-a,2)+nt(l-r,2);if(m===0){let p=e-a,f=n-r;return Math.sqrt(p*p+f*f)<=s}return Math.abs(h)/Math.sqrt(m)<=s&&e>=Math.min(a,c)-s&&e<=Math.max(a,c)+s&&n>=Math.min(r,l)-s&&n<=Math.max(r,l)+s}};var Ut=class extends B{constructor(){super(...arguments);this.name="arrow"}normalize(t,e,n){return H(k({},t),{x1:t.x1/e,y1:t.y1/n,x2:t.x2/e,y2:t.y2/n})}move(t,e,n){return t.x1+=e,t.y1+=n,t.x2+=e,t.y2+=n,t}draw(t){let e=(t.x1+t.x2)/2,n=(t.y1+t.y2)/2,a=this.getRotationCenter(t,e,n),r=this.applyRotation(t,a.x,a.y);this.drawArrow(t.x1,t.y1,t.x2,t.y2,t.lineWidth),r&&this.restoreRotation()}onPointerDown(t){let{x:e,y:n}=this.annotationTool.getRelativeCoords(t);this.startX=e,this.startY=n,this.isDrawing=!0}onPointerMove(t){if(!this.isDrawing)return;let{x:e,y:n}=this.annotationTool.getRelativeCoords(t);this.drawArrow(this.startX,this.startY,e,n)}onPointerUp(t){if(!this.isDrawing)return;let{x:e,y:n}=this.annotationTool.getRelativeCoords(t);this.save({type:"arrow",x1:this.startX,y1:this.startY,x2:e,y2:n,strokeStyle:this.ctx.strokeStyle,fillStyle:this.ctx.fillStyle,lineWidth:this.ctx.lineWidth}),this.drawArrow(this.startX,this.startY,e,n),this.isDrawing=!1}drawArrow(t,e,n,a,r){let c=10+2.5*(r!=null?r:this.ctx.lineWidth),l=Math.PI/6,s=Math.atan2(a-e,n-t);this.ctx.beginPath(),this.ctx.moveTo(t,e),this.ctx.lineTo(n,a),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(n,a),this.ctx.lineTo(n-c*Math.cos(s+l),a-c*Math.sin(s+l)),this.ctx.moveTo(n,a),this.ctx.lineTo(n-c*Math.cos(s-l),a-c*Math.sin(s-l)),this.ctx.stroke()}isPointerAtShape(t,e,n){var u;let{x1:a,y1:r,x2:c,y2:l}=t,s=Math.max(((u=t.lineWidth)!=null?u:1)/2,5),h=(c-a)*(r-n)-(a-e)*(l-r),m=nt(c-a,2)+nt(l-r,2);if(m===0){let p=e-a,f=n-r;return Math.sqrt(p*p+f*f)<=s}return Math.abs(h)/Math.sqrt(m)<=s&&e>=Math.min(a,c)-s&&e<=Math.max(a,c)+s&&n>=Math.min(r,l)-s&&n<=Math.max(r,l)+s}};var jt=class extends B{constructor(){super(...arguments);this.name="text";this.activePopup=null;this.handleKeyDown=t=>{}}move(t,e,n){return t.x+=e,t.y+=n,t}onActivate(){this.annotationTool.canvas.style.cursor="text",this.isDrawing=!0}onDeactivate(){this.destroyPopup(),this.annotationTool.canvas.style.cursor="default",this.isDrawing=!1}draw(t){var p;if(!t.text)return;let e=t.text.split(`
`),n=16+((p=t.lineWidth)!=null?p:this.ctx.lineWidth)*.5,a=n*1.25;this.ctx.font=`${n}px Helvetica Neue, Arial`;let r=e.map(f=>this.ctx.measureText(f).width),c=r.length>0?Math.max(...r):0,l=e.length*a,s=t.x+c/2,h=t.y-n/2+l/2,m=this.getRotationCenter(t,s,h),u=this.applyRotation(t,m.x,m.y);for(let f=0;f<e.length;f++)this.drawTextLine(t.x,t.y+f*a,e[f],n);u&&this.restoreRotation()}drawText(t,e,n){let a=16+this.ctx.lineWidth*.5;this.ctx.font=`${a}px Helvetica Neue, Arial`,this.ctx.fillText(n,t,e)}drawTextLine(t,e,n,a){this.ctx.font=`${a}px Helvetica Neue, Arial`,this.ctx.fillText(n,t,e)}onPointerDown(t){let{x:e,y:n}=this.annotationTool.getRelativeCoords(t);this.startX=e,this.startY=n}onPointerMove(t){let{x:e,y:n}=this.annotationTool.getRelativeCoords(t);this.ctx.beginPath(),this.ctx.arc(e,n,5,0,2*Math.PI),this.ctx.fill()}normalize(t,e,n){return H(k({},t),{x:t.x/e,y:t.y/n})}destroyPopup(){var t;this.activePopup&&((t=this.annotationTool.canvas.parentElement)==null||t.removeChild(this.activePopup),this.activePopup=null,document.removeEventListener("keydown",this.handleKeyDown))}createTextInputPopup(t,e){var p;this.destroyPopup();let n=document.createElement("div");this.activePopup=n,n.style.cssText=`
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      z-index: 1000;
      min-width: 280px;
    `;let a=document.createElement("input");a.type="text",a.placeholder="Enter text to draw",a.style.cssText=`
      display: block;
      width: 100%;
      padding: 8px 12px;
      margin-bottom: 16px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      line-height: 20px;
      box-sizing: border-box;
      outline: none;
      transition: border-color 0.2s;
    `,a.addEventListener("focus",()=>{a.style.borderColor="#007bff"}),a.addEventListener("blur",()=>{a.style.borderColor="#ddd"});let r=document.createElement("div");r.style.cssText=`
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    `;let c=`
      height: 36px;
      min-width: 80px;
      padding: 0 16px;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: opacity 0.2s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    `,l=document.createElement("button");l.textContent="Cancel",l.style.cssText=`
      ${c}
      background: #f0f0f0;
      color: #333;
    `,l.addEventListener("mouseover",()=>{l.style.opacity="0.8"}),l.addEventListener("mouseout",()=>{l.style.opacity="1"});let s=document.createElement("button");s.textContent="OK",s.style.cssText=`
      ${c}
      background: #007bff;
      color: white;
    `,s.addEventListener("mouseover",()=>{s.style.opacity="0.8"}),s.addEventListener("mouseout",()=>{s.style.opacity="1"});let h=()=>{this.destroyPopup()},m=()=>{let f=a.value.trim();f&&(this.save({type:"text",x:t,y:e,text:f,strokeStyle:this.ctx.strokeStyle,fillStyle:this.ctx.fillStyle,lineWidth:this.ctx.lineWidth}),this.annotationTool.currentTool=null),h()},u=f=>{f.key==="Escape"?h():f.key==="Enter"&&m()};this.handleKeyDown=u,s.onclick=m,l.onclick=h,a.onkeyup=u,document.addEventListener("keydown",u),r.appendChild(l),r.appendChild(s),n.appendChild(a),n.appendChild(r),(p=this.annotationTool.canvas.parentElement)==null||p.appendChild(n),requestAnimationFrame(()=>{a.focus()})}onPointerUp(t){let{x:e,y:n}=this.annotationTool.getRelativeCoords(t);this.createTextInputPopup(e,n)}isPointerAtShape(t,e,n){var m;if(!t.text)return!1;let a=t.text.split(`
`);if(a.length===0)return!1;let r=16+((m=t.lineWidth)!=null?m:1)*.5,c=r*1.25,l=a.length*c;this.ctx.font=`${r}px Helvetica Neue, Arial`;let s=a.map(u=>this.ctx.measureText(u).width),h=s.length>0?Math.max(...s):0;return h===0?!1:e>=t.x&&e<=t.x+h&&n>=t.y-r&&n<=t.y+l-r}};var _t=class extends B{constructor(){super(...arguments);this.name="eraser"}move(t,e,n){return t.x+=e,t.y+=n,t}normalize(t,e,n){return H(k({},t),{x:t.x/e,y:t.y/n,width:t.width/e,height:t.height/n})}draw(t){this.drawEraser(t.x,t.y,t.width,t.height)}onPointerDown(t){let{x:e,y:n}=this.annotationTool.getRelativeCoords(t);this.startX=e,this.startY=n,this.isDrawing=!0}onPointerMove(t){if(!this.isDrawing)return;let{x:e,y:n}=this.annotationTool.getRelativeCoords(t);this.ctx.save(),this.ctx.strokeStyle="rgba(255, 255, 255, 0.5)",this.ctx.lineWidth=1,this.ctx.fillStyle="rgba(255, 255, 255, 0.3)",this.ctx.fillRect(this.startX,this.startY,e-this.startX,n-this.startY),this.ctx.strokeRect(this.startX,this.startY,e-this.startX,n-this.startY),this.ctx.restore()}onPointerUp(t){if(!this.isDrawing)return;this.isDrawing=!1;let{x:e,y:n}=this.annotationTool.getRelativeCoords(t);this.save({type:"eraser",x:this.startX,y:this.startY,width:e-this.startX,height:n-this.startY,strokeStyle:this.ctx.strokeStyle,fillStyle:this.ctx.fillStyle,lineWidth:this.ctx.lineWidth})}drawEraser(t,e,n,a){this.ctx.clearRect(t,e,n,a)}isPointerAtShape(t,e,n){let a=Math.min(t.x,t.x+t.width),r=Math.max(t.x,t.x+t.width),c=Math.min(t.y,t.y+t.height),l=Math.max(t.y,t.y+t.height);return e>=a&&e<=r&&n>=c&&n<=l}};var Gt=class extends B{constructor(){super(...arguments);this.name="move";this.shape=null;this.shapeIndex=-1;this.lastDrawnShape=null;this.isScale=!1;this.selectedShapeIndex=-1;this.boundHandleKeyDown=null;this.activeHandle=null;this.handleSize=8;this.resizeStartBounds=null;this.resizeOriginalShape=null;this.rotationActive=!1;this.rotationStartAngle=0;this.rotationShapeStartAngle=0;this.centerDragActive=!1;this.rotationHandleDistance=40}cloneShape(t){if(t.type==="image"){let e=t;return H(k({},JSON.parse(JSON.stringify(t))),{image:e.image})}return JSON.parse(JSON.stringify(t))}getSelectedShape(){return this.selectedShapeIndex<0||this.selectedShapeIndex>=this.annotationTool.shapes.length?null:this.annotationTool.shapes[this.selectedShapeIndex]}setSelectedShapeOpacity(t){return this.selectedShapeIndex<0||this.selectedShapeIndex>=this.annotationTool.shapes.length?!1:(this.annotationTool.undoStack.push([...this.annotationTool.shapes]),this.annotationTool.shapes[this.selectedShapeIndex].opacity=t,this.annotationTool.redrawFullCanvas(),!0)}move(t){return t}normalize(t){return k({},t)}onActivate(){this.boundHandleKeyDown=this.handleKeyDown.bind(this),document.addEventListener("keydown",this.boundHandleKeyDown)}onDeactivate(){this.boundHandleKeyDown&&(document.removeEventListener("keydown",this.boundHandleKeyDown),this.boundHandleKeyDown=null),this.selectedShapeIndex=-1}handleKeyDown(t){if((t.key==="Backspace"||t.key==="Delete")&&this.selectedShapeIndex>=0){t.preventDefault(),this.deleteSelectedShape();return}if((t.ctrlKey||t.metaKey)&&t.key.toLowerCase()==="d"&&this.selectedShapeIndex>=0){t.preventDefault(),this.duplicateSelectedShape();return}if((t.ctrlKey||t.metaKey)&&t.shiftKey&&t.key==="ArrowRight"){t.preventDefault(),this.copyAnnotationsToNextFrame();return}if((t.ctrlKey||t.metaKey)&&t.shiftKey&&t.key==="ArrowLeft"){t.preventDefault(),this.copyAnnotationsToPrevFrame();return}}duplicateSelectedShape(){let t=this.getSelectedShape();if(!t)return;let e=this.cloneShape(t),n=20;this.getShapeBounds(e)&&this.offsetShape(e,n,n),this.annotationTool.undoStack.push([...this.annotationTool.shapes]);let r=this.annotationTool.serialize([e])[0];this.annotationTool.shapes.push(r),this.selectedShapeIndex=this.annotationTool.shapes.length-1,this.annotationTool.redrawFullCanvas()}copyAnnotationsToNextFrame(){let e=this.annotationTool.activeTimeFrame+1;if(e>this.annotationTool.totalFrames||this.annotationTool.shapes.length===0)return;let n=this.annotationTool.timeStack.get(e)||[],a=this.annotationTool.shapes.map(c=>this.cloneShape(c)),r=[...n,...a];this.annotationTool.timeStack.set(e,r),this.annotationTool.playbackFrame=e,this.annotationTool.redrawFullCanvas()}copyAnnotationsToPrevFrame(){let e=this.annotationTool.activeTimeFrame-1;if(e<1||this.annotationTool.shapes.length===0)return;let n=this.annotationTool.timeStack.get(e)||[],a=this.annotationTool.shapes.map(c=>this.cloneShape(c)),r=[...n,...a];this.annotationTool.timeStack.set(e,r),this.annotationTool.playbackFrame=e,this.annotationTool.redrawFullCanvas()}offsetShape(t,e,n){let a=this.annotationTool.deserialize([t])[0],c=this.annotationTool.pluginForTool(a.type).move(a,e,n);Object.assign(t,this.annotationTool.serialize([c])[0])}getShapeBounds(t){var n;let e=this.annotationTool.deserialize([t])[0];switch(e.type){case"rectangle":{let a=e;return{x:Math.min(a.x,a.x+a.width),y:Math.min(a.y,a.y+a.height),width:Math.abs(a.width),height:Math.abs(a.height)}}case"image":{let a=e;return{x:Math.min(a.x,a.x+a.width),y:Math.min(a.y,a.y+a.height),width:Math.abs(a.width),height:Math.abs(a.height)}}case"selection":{let a=e;return{x:Math.min(a.x,a.x+a.width),y:Math.min(a.y,a.y+a.height),width:Math.abs(a.width),height:Math.abs(a.height)}}case"circle":{let a=e;return{x:a.x-a.radius,y:a.y-a.radius,width:a.radius*2,height:a.radius*2}}case"line":{let a=e,r=Math.min(a.x1,a.x2),c=Math.min(a.y1,a.y2),l=Math.max(a.x1,a.x2),s=Math.max(a.y1,a.y2);return{x:r,y:c,width:l-r||10,height:s-c||10}}case"arrow":{let a=e,r=Math.min(a.x1,a.x2),c=Math.min(a.y1,a.y2),l=Math.max(a.x1,a.x2),s=Math.max(a.y1,a.y2);return{x:r,y:c,width:l-r||10,height:s-c||10}}case"curve":{let a=e;if(!a.points||a.points.length===0)return null;let r=1/0,c=1/0,l=-1/0,s=-1/0;for(let h of a.points)r=Math.min(r,h.x),c=Math.min(c,h.y),l=Math.max(l,h.x),s=Math.max(s,h.y);return{x:r,y:c,width:l-r||10,height:s-c||10}}case"text":{let a=e;if(!a.text)return null;let c=16+((n=t.lineWidth)!=null?n:1)*.5,l=a.text.length*c*.6;return{x:a.x,y:a.y-c,width:l||50,height:c*1.2}}default:return null}}drawResizeHandles(){let t=this.getSelectedShape();if(!t)return;let e=this.getShapeBounds(t);if(!e)return;let n=this.annotationTool.ctx,a=this.handleSize,r=a/2,c=[{pos:"nw",x:e.x,y:e.y},{pos:"n",x:e.x+e.width/2,y:e.y},{pos:"ne",x:e.x+e.width,y:e.y},{pos:"e",x:e.x+e.width,y:e.y+e.height/2},{pos:"se",x:e.x+e.width,y:e.y+e.height},{pos:"s",x:e.x+e.width/2,y:e.y+e.height},{pos:"sw",x:e.x,y:e.y+e.height},{pos:"w",x:e.x,y:e.y+e.height/2}];n.save(),n.strokeStyle="#5b9fff",n.lineWidth=1,n.setLineDash([4,4]),n.strokeRect(e.x,e.y,e.width,e.height),n.setLineDash([]),n.fillStyle="#ffffff",n.strokeStyle="#5b9fff",n.lineWidth=1;for(let l of c)n.fillRect(l.x-r,l.y-r,a,a),n.strokeRect(l.x-r,l.y-r,a,a);n.restore(),this.drawRotationHandles(e)}getShapeRotationCenter(t,e){return t.rotationCenterX!==void 0&&t.rotationCenterY!==void 0?{x:t.rotationCenterX*this.annotationTool.canvasWidth,y:t.rotationCenterY*this.annotationTool.canvasHeight}:{x:e.x+e.width/2,y:e.y+e.height/2}}drawRotationHandles(t){var h;let e=this.getSelectedShape();if(!e)return;let n=this.annotationTool.ctx,a=this.getShapeRotationCenter(e,t),r=(h=e.rotation)!=null?h:0,c=a.x+Math.sin(r)*this.rotationHandleDistance,l=a.y-Math.cos(r)*this.rotationHandleDistance;n.save(),n.beginPath(),n.strokeStyle="#5b9fff",n.lineWidth=1,n.setLineDash([]),n.moveTo(a.x,a.y),n.lineTo(c,l),n.stroke();let s=6;n.beginPath(),n.strokeStyle="#5b9fff",n.lineWidth=1.5,n.moveTo(a.x-s,a.y),n.lineTo(a.x+s,a.y),n.moveTo(a.x,a.y-s),n.lineTo(a.x,a.y+s),n.stroke(),n.beginPath(),n.fillStyle="#ffffff",n.strokeStyle="#5b9fff",n.lineWidth=1.5,n.arc(a.x,a.y,4,0,Math.PI*2),n.fill(),n.stroke(),n.beginPath(),n.fillStyle="#ffffff",n.strokeStyle="#5b9fff",n.lineWidth=1.5,n.arc(c,l,6,0,Math.PI*2),n.fill(),n.stroke(),n.beginPath(),n.strokeStyle="#5b9fff",n.lineWidth=1,n.arc(c,l,3,-Math.PI*.7,Math.PI*.5),n.stroke(),n.restore()}isPointerAtRotationHandle(t,e){var p;let n=this.getSelectedShape();if(!n)return!1;let a=this.getShapeBounds(n);if(!a)return!1;let r=this.getShapeRotationCenter(n,a),c=(p=n.rotation)!=null?p:0,l=r.x+Math.sin(c)*this.rotationHandleDistance,s=r.y-Math.cos(c)*this.rotationHandleDistance,h=t-l,m=e-s;return Math.sqrt(h*h+m*m)<=12}isPointerAtRotationCenter(t,e){let n=this.getSelectedShape();if(!n)return!1;let a=this.getShapeBounds(n);if(!a)return!1;let r=this.getShapeRotationCenter(n,a),c=t-r.x,l=e-r.y;return Math.sqrt(c*c+l*l)<=10}calculateAngle(t,e,n,a){return Math.atan2(n-t,-(a-e))}getHandleAtPosition(t,e){let n=this.getSelectedShape();if(!n)return null;let a=this.getShapeBounds(n);if(!a)return null;let c=(this.handleSize+4)/2,l=[{pos:"nw",x:a.x,y:a.y},{pos:"n",x:a.x+a.width/2,y:a.y},{pos:"ne",x:a.x+a.width,y:a.y},{pos:"e",x:a.x+a.width,y:a.y+a.height/2},{pos:"se",x:a.x+a.width,y:a.y+a.height},{pos:"s",x:a.x+a.width/2,y:a.y+a.height},{pos:"sw",x:a.x,y:a.y+a.height},{pos:"w",x:a.x,y:a.y+a.height/2}];for(let s of l)if(t>=s.x-c&&t<=s.x+c&&e>=s.y-c&&e<=s.y+c)return s.pos;return null}getCursorForHandle(t){return{nw:"nw-resize",n:"n-resize",ne:"ne-resize",e:"e-resize",se:"se-resize",s:"s-resize",sw:"sw-resize",w:"w-resize"}[t]}resizeShape(t,e,n,a,r,c=!1){var y;if(!this.resizeOriginalShape)return;let l=this.annotationTool.deserialize([this.resizeOriginalShape])[0],s=r.x,h=r.y,m=r.width,u=r.height;switch(e){case"nw":s+=n,h+=a,m-=n,u-=a;break;case"n":h+=a,u-=a;break;case"ne":h+=a,m+=n,u-=a;break;case"e":m+=n;break;case"se":m+=n,u+=a;break;case"s":u+=a;break;case"sw":s+=n,m-=n,u+=a;break;case"w":s+=n,m-=n;break}if(c&&r.width>0&&r.height>0){let g=r.width/r.height;if(e==="n"||e==="s"){let x=u*g,C=x-m;m=x,s-=C/2}else if(e==="e"||e==="w"){let x=m/g,C=x-u;u=x,h-=C/2}else{let x=m/r.width,C=u/r.height,P=Math.max(Math.abs(x),Math.abs(C)),O=x>=0?1:-1,R=C>=0?1:-1,D=r.width*P*O,w=r.height*P*R;e==="nw"?(s=r.x+r.width-D,h=r.y+r.height-w):e==="ne"?h=r.y+r.height-w:e==="sw"&&(s=r.x+r.width-D),m=D,u=w}}let p=10;m<p&&(e.includes("w")&&(s=r.x+r.width-p),m=p),u<p&&(e.includes("n")&&(h=r.y+r.height-p),u=p);let f=r.width>0?m/r.width:1,v=r.height>0?u/r.height:1;switch(l.type){case"rectangle":{let g=t;g.x=s/this.annotationTool.canvasWidth,g.y=h/this.annotationTool.canvasHeight,g.width=m/this.annotationTool.canvasWidth,g.height=u/this.annotationTool.canvasHeight;break}case"selection":{let g=t;g.x=s/this.annotationTool.canvasWidth,g.y=h/this.annotationTool.canvasHeight,g.width=m/this.annotationTool.canvasWidth,g.height=u/this.annotationTool.canvasHeight;break}case"circle":{let g=t,x=Math.min(m,u)/2,C=s+m/2,P=h+u/2;g.x=C/this.annotationTool.canvasWidth,g.y=P/this.annotationTool.canvasHeight,g.radius=x/this.annotationTool.canvasWidth;break}case"line":{let g=t,x=l,C=(x.x1-r.x)*f+s,P=(x.y1-r.y)*v+h,O=(x.x2-r.x)*f+s,R=(x.y2-r.y)*v+h;g.x1=C/this.annotationTool.canvasWidth,g.y1=P/this.annotationTool.canvasHeight,g.x2=O/this.annotationTool.canvasWidth,g.y2=R/this.annotationTool.canvasHeight;break}case"arrow":{let g=t,x=l,C=(x.x1-r.x)*f+s,P=(x.y1-r.y)*v+h,O=(x.x2-r.x)*f+s,R=(x.y2-r.y)*v+h;g.x1=C/this.annotationTool.canvasWidth,g.y1=P/this.annotationTool.canvasHeight,g.x2=O/this.annotationTool.canvasWidth,g.y2=R/this.annotationTool.canvasHeight;break}case"curve":{let g=t,x=l;if(!x.points||x.points.length===0)break;g.points=x.points.map(C=>({x:((C.x-r.x)*f+s)/this.annotationTool.canvasWidth,y:((C.y-r.y)*v+h)/this.annotationTool.canvasHeight}));break}case"text":{let g=t,x=l,P=16+((y=this.resizeOriginalShape.lineWidth)!=null?y:1)*.5,O=(x.x-r.x)*f+s,R=(x.y-r.y)*v+h;g.x=O/this.annotationTool.canvasWidth,g.y=R/this.annotationTool.canvasHeight;let D=(f+v)/2,w=P*D;g.lineWidth=Math.max(1,(w-16)*2);break}case"image":{let g=t;g.x=s/this.annotationTool.canvasWidth,g.y=h/this.annotationTool.canvasHeight,g.width=m/this.annotationTool.canvasWidth,g.height=u/this.annotationTool.canvasHeight;break}}}deleteSelectedShape(){this.selectedShapeIndex<0||this.selectedShapeIndex>=this.annotationTool.shapes.length||(this.annotationTool.undoStack.push([...this.annotationTool.shapes]),this.annotationTool.shapes.splice(this.selectedShapeIndex,1),this.selectedShapeIndex=-1,this.shapeIndex=-1,this.annotationTool.redrawFullCanvas())}onPointerDown(t){var s;let{x:e,y:n}=this.annotationTool.getRelativeCoords(t);if(this.selectedShapeIndex>=0&&this.isPointerAtRotationHandle(e,n)){let h=this.getSelectedShape();if(h){let m=this.getShapeBounds(h);if(m){let u=this.getShapeRotationCenter(h,m);this.rotationActive=!0,this.rotationStartAngle=this.calculateAngle(u.x,u.y,e,n),this.rotationShapeStartAngle=(s=h.rotation)!=null?s:0,this.isDrawing=!0,this.annotationTool.undoStack.push([...this.annotationTool.shapes]),this.annotationTool.canvas.style.cursor="grabbing";return}}}if(this.selectedShapeIndex>=0&&this.isPointerAtRotationCenter(e,n)){this.centerDragActive=!0,this.startX=e,this.startY=n,this.isDrawing=!0,this.annotationTool.undoStack.push([...this.annotationTool.shapes]),this.annotationTool.canvas.style.cursor="move";return}let a=this.getHandleAtPosition(e,n);if(a&&this.selectedShapeIndex>=0){this.activeHandle=a,this.startX=e,this.startY=n,this.isDrawing=!0;let h=this.getSelectedShape();h&&(this.resizeStartBounds=this.getShapeBounds(h),this.resizeOriginalShape=this.cloneShape(h),this.annotationTool.undoStack.push([...this.annotationTool.shapes])),this.annotationTool.canvas.style.cursor=this.getCursorForHandle(a);return}let r=this.annotationTool.shapes,c=r.slice().reverse(),l=!1;for(let h of c)if(this.isPointerAtShape(h,e,n)){this.shape=this.cloneShape(h),this.shapeIndex=r.indexOf(h),this.selectedShapeIndex=this.shapeIndex,l=!0;break}l||(this.selectedShapeIndex=-1,this.annotationTool.redrawFullCanvas()),this.shape&&(this.lastDrawnShape=null,this.startX=e,this.startY=n,this.isDrawing=!0,this.isScale=this.shape.type==="image"?this.isPointerAtCorner(this.shape,e,n):!1,this.isScale?this.annotationTool.canvas.style.cursor="nw-resize":this.annotationTool.canvas.style.cursor="move")}isPointerAtShape(t,e,n){let a=this.annotationTool.deserialize([t])[0];if(a.rotation){let c=this.getShapeBounds(t);if(c){let l=this.getShapeRotationCenter(t,c),s=Math.cos(-a.rotation),h=Math.sin(-a.rotation),m=e-l.x,u=n-l.y;e=l.x+m*s-u*h,n=l.y+m*h+u*s}}return this.annotationTool.pluginForTool(a.type).isPointerAtShape(a,e,n)}isPointerAtCorner(t,e,n){if(!("type"in t))return!1;let a=this.annotationTool.deserialize([t])[0],r=15,c=Math.abs(a.y-n)<r,l=Math.abs(a.x-e)<r,s=Math.abs(a.x+a.width-e)<r,h=Math.abs(a.y+a.height-n)<r;return c&&l||c&&s||h&&l||h&&s}onPointerMove(t){let{x:e,y:n}=this.annotationTool.getRelativeCoords(t);if(this.isDrawing&&this.rotationActive){let s=this.annotationTool.shapes[this.selectedShapeIndex];if(s){let h=this.getShapeBounds(s);if(h){let m=this.getShapeRotationCenter(s,h),u=this.calculateAngle(m.x,m.y,e,n),p=this.rotationShapeStartAngle+(u-this.rotationStartAngle);if(t.shiftKey){let f=Math.PI/12;p=Math.round(p/f)*f}s.rotation=p,this.annotationTool.redrawFullCanvas()}}return}if(this.isDrawing&&this.centerDragActive){let s=this.annotationTool.shapes[this.selectedShapeIndex];s&&(s.rotationCenterX=e/this.annotationTool.canvasWidth,s.rotationCenterY=n/this.annotationTool.canvasHeight,this.annotationTool.redrawFullCanvas());return}if(this.isDrawing&&this.activeHandle&&this.resizeStartBounds){let s=e-this.startX,h=n-this.startY,m=this.annotationTool.shapes[this.selectedShapeIndex];m&&(this.resizeShape(m,this.activeHandle,s,h,this.resizeStartBounds,t.shiftKey),this.annotationTool.redrawFullCanvas());return}if(!this.isDrawing&&this.selectedShapeIndex>=0){if(this.isPointerAtRotationHandle(e,n)){this.annotationTool.canvas.style.cursor="grab";return}if(this.isPointerAtRotationCenter(e,n)){this.annotationTool.canvas.style.cursor="move";return}let s=this.getHandleAtPosition(e,n);if(s){this.annotationTool.canvas.style.cursor=this.getCursorForHandle(s);return}}if(!this.isDrawing||!this.shape){this.isDrawing||(this.annotationTool.canvas.style.cursor="default");return}let a=e-this.startX,r=n-this.startY;this.startX=e-a,this.startY=n-r;let c=this.annotationTool.deserialize([this.shape])[0],l=c.type==="image"?c:JSON.parse(JSON.stringify(c));if(l.type!=="audio-peaks")if(l.type==="image")if(this.isScale){let{width:s,height:h}=l,m=s/h,u=s+a,p=u/m;l.width=u,l.height=p,this.lastDrawnShape=l,this.annotationTool.pluginForTool(l.type).draw(l)}else{let s=this.annotationTool.pluginForTool(l.type).move(l,a,r);this.lastDrawnShape=s,this.annotationTool.pluginForTool(l.type).draw(s)}else{let s=this.annotationTool.pluginForTool(l.type).move(l,a,r);this.lastDrawnShape=s,this.annotationTool.pluginForTool(l.type).draw(s)}}onPointerUp(t){if(this.rotationActive){this.rotationActive=!1,this.isDrawing=!1,this.annotationTool.canvas.style.cursor="default",this.annotationTool.redrawFullCanvas();return}if(this.centerDragActive){this.centerDragActive=!1,this.isDrawing=!1,this.annotationTool.canvas.style.cursor="default",this.annotationTool.redrawFullCanvas();return}if(this.activeHandle){this.activeHandle=null,this.resizeStartBounds=null,this.resizeOriginalShape=null,this.isDrawing=!1,this.annotationTool.canvas.style.cursor="default",this.annotationTool.redrawFullCanvas();return}if(!this.isDrawing||!this.lastDrawnShape){this.isDrawing=!1,this.annotationTool.redrawFullCanvas();return}this.lastDrawnShape&&this.shape&&(this.lastDrawnShape.fillStyle=this.shape.fillStyle,this.lastDrawnShape.strokeStyle=this.shape.strokeStyle,this.lastDrawnShape.lineWidth=this.shape.lineWidth,this.shape.opacity!==void 0&&(this.lastDrawnShape.opacity=this.shape.opacity),this.save(this.lastDrawnShape)),this.isDrawing=!1,this.isScale=!1,this.shape=null,this.lastDrawnShape=null,this.annotationTool.canvas.style.cursor="default",this.annotationTool.redrawFullCanvas()}draw(){throw new Error("Method not implemented.")}reset(){this.isDrawing=!1,this.shape=null,this.isScale=!1,this.lastDrawnShape=null,this.shapeIndex=-1,this.selectedShapeIndex=-1,this.activeHandle=null,this.resizeStartBounds=null,this.resizeOriginalShape=null,this.rotationActive=!1,this.centerDragActive=!1,this.annotationTool.canvas.style.cursor="default"}save(t){this.annotationTool.replaceShape(t,this.shapeIndex)}};var qt=class extends B{constructor(){super(...arguments);this.name="image"}move(t,e,n){return t.x+=e,t.y+=n,t}onPointerDown(t){}onPointerMove(t){}onPointerUp(t){}normalize(t,e,n){return H(k({},t),{x:t.x/e,y:t.y/n,width:t.width/e,height:t.height/n})}draw(t){if(!(t.image instanceof HTMLImageElement)){console.error("Image is not an instance of HTMLImageElement");return}if(t.width===0||t.height===0)return;let e=t.x+t.width/2,n=t.y+t.height/2,a=this.getRotationCenter(t,e,n),r=this.applyRotation(t,a.x,a.y);this.ctx.drawImage(t.image,t.x,t.y,t.width,t.height),r&&this.restoreRotation()}isPointerAtShape(t,e,n){let a=Math.min(t.x,t.x+t.width),r=Math.max(t.x,t.x+t.width),c=Math.min(t.y,t.y+t.height),l=Math.max(t.y,t.y+t.height);return e>=a&&e<=r&&n>=c&&n<=l}};var Kt=class extends B{constructor(){super(...arguments);this.name="compare";this.comparisonLine=0;this.leftOpacity=1;this.isDrawing=!1}get rightOpacity(){return this.annotationTool.overlayOpacity}move(t,e,n){return t.x+=e,t}onActivate(){this.comparisonLine=this.annotationTool.canvasWidth/2,this.leftOpacity=1,this.annotationTool.canvas.style.cursor="col-resize"}onDeactivate(){this.annotationTool.canvas.style.cursor="default",this.comparisonLine=0,this.leftOpacity=1,this.isDrawing=!1}normalize(t,e,n){return H(k({},t),{x:t.x/e})}onPointerDown(t){let{x:e,y:n}=this.annotationTool.getRelativeCoords(t);this.startX=e,this.startY=n,this.isDrawing=!0,this.disablePreviousCompare(),this.onPointerMove(t)}onPointerMove(t){if(!this.isDrawing){if(this.annotationTool.globalShapes.length>0){let a=this.annotationTool.globalShapes[0];if(a.type==="compare"){let r=this.annotationTool.deserialize([a])[0];this.draw(r),this.annotationTool.addFrameSquareOverlay()}}return}let{x:e}=this.annotationTool.getRelativeCoords(t);this.comparisonLine=e;let n={type:"compare",strokeStyle:this.ctx.strokeStyle,fillStyle:this.ctx.fillStyle,lineWidth:this.ctx.lineWidth,x:e};this.draw(n),this.drawDelimiter(n)}onPointerUp(){this.isDrawing&&(this.save({type:"compare",strokeStyle:this.ctx.strokeStyle,fillStyle:this.ctx.fillStyle,lineWidth:this.ctx.lineWidth,disabled:!1,x:this.comparisonLine}),this.isDrawing=!1)}removePreviousCompare(){this.annotationTool.globalShapes=this.annotationTool.globalShapes.filter(t=>t.type!=="compare")}disablePreviousCompare(){this.annotationTool.globalShapes=this.annotationTool.globalShapes.map(t=>t.type==="compare"?H(k({},t),{disabled:!0}):t)}save(t){this.removePreviousCompare();let e=this.annotationTool.serialize([t])[0];e.x<.05||e.x>.95||this.annotationTool.addGlobalShape(e)}drawDelimiter(t){this.ctx.beginPath(),this.ctx.moveTo(t.x,0),this.ctx.lineTo(t.x,this.annotationTool.canvasWidth),this.ctx.stroke()}drawShape(t){var at,Tt,K,rt,st,St,Ct,yt;let e=this.annotationTool.videoElement,n=this.annotationTool.referenceVideoElement;if(!e||!n)return;let a=this.ctx.globalAlpha,r=this.annotationTool.canvasWidth,c=this.annotationTool.canvasHeight,l=t.x,s=n.videoHeight-e.videoHeight,h=n.videoWidth-e.videoWidth,m=this.annotationTool.isMobile;this.ctx.globalAlpha=this.leftOpacity;let u=(Tt=(at=this.annotationTool.referenceVideoFrameBuffer)==null?void 0:at.frameNumberFromTime(e.currentTime))!=null?Tt:1,p=u;if(h>e.videoWidth&&s>e.videoHeight&&!this.annotationTool.isMobile){let b=(St=(st=this.annotationTool.referenceVideoFrameBuffer)==null?void 0:st.getFrameNumberBySignature((rt=(K=this.annotationTool.videoFrameBuffer)==null?void 0:K.getAudioFingerprint(u))!=null?rt:null,u))!=null?St:u,F=Math.abs(u-b);F>=1&&F<=3&&(p=b)}let v=(Ct=this.annotationTool.referenceVideoFrameBuffer)==null?void 0:Ct.getFrame(p),y=(yt=this.annotationTool.videoFrameBuffer)==null?void 0:yt.getFrame(u);if(m){this.ctx.imageSmoothingQuality="low";let b=l/r,F=l;this.ctx.drawImage(y!=null?y:e,0,0,b*e.videoWidth,e.videoHeight,0,0,F,c)}else{let b=y?y.width:e.videoWidth,F=y?y.height:e.videoHeight;this.ctx.drawImage(y!=null?y:e,0,0,b,F,0,0,r,c)}this.ctx.globalAlpha=this.rightOpacity;let g=0,x=0,C=e.videoWidth/e.videoHeight,P=n.videoWidth/n.videoHeight,R=Math.abs(C-P)>.1,D=10,w=Math.abs(s)>D,T=e.videoWidth,E=e.videoHeight,S=0;if(h<-D)if(R){let b=e.videoWidth/r;S=Math.abs(h/2),S=S/b,S<=D&&(S=0)}else T=n.videoWidth;else h>D&&(T=n.videoWidth);if(s===0)g=0;else if(s>0)R?(g=s/2,g<=D&&(g=0)):E=w?n.videoHeight:e.videoHeight;else if(!R)E=w?n.videoHeight:e.videoHeight;else{x=Math.abs(s/2);let b=e.videoHeight/c;x=x/b,x<=D&&(x=0)}let $=l-S,W=r-$,q=W/r*T;v&&this.rightOpacity>0&&(m&&(this.ctx.imageSmoothingQuality="low"),this.ctx.drawImage(v,$/r*T,g,q,E,$+S,x,W,c)),this.ctx.globalAlpha=a}draw(t){if(t.disabled)return;let e=this.annotationTool.videoElement,n=this.annotationTool.referenceVideoElement;!e||!n||this.drawShape(t)}};function oo(i){let o=i[0],t=i[0];for(let e=1;e<i.length;e++)i[e]<o&&(o=i[e]),i[e]>t&&(t=i[e]);return[o,t]}var Zt=class extends B{constructor(t){super(t);this.name="audio-peaks";this.canvas=document.createElement("canvas");this.props={peaks:new Int8Array,theme:{waveOutlineColor:"rgba(255,192,203,0.7)",waveFillColor:"grey",waveProgressColor:"orange"},waveHeight:40,bits:16};this.drawCtx=this.canvas.getContext("2d")}onVideoBlobSet(t){return M(this,null,function*(){let e=yield t.arrayBuffer();this.init(e)})}on(t,e){t==="videoBlobSet"&&this.onVideoBlobSet(e)}extractPeaks(t){return M(this,null,function*(){let{default:e}=yield Promise.resolve().then(()=>zn(sn(),1)),n=this.progressBarCoordinates.width,a=Math.ceil(t.length/n);return e(t,a,!0)})}setProps(t){let[e,n]=oo(t.data[0]),a=Math.pow(2,t.bits-1)-1,r=-Math.pow(2,t.bits-1);this.props.peaks=t.data[0].map(c=>c<0?Math.round(c/e*r):Math.round(c/n*a)),this.props.bits=t.bits}init(t){return M(this,null,function*(){try{let n=yield new AudioContext().decodeAudioData(t),a=yield this.extractPeaks(n);this.initCanvas(),this.setProps(a),this.annotationTool.removeGlobalShape("audio-peaks"),this.annotationTool.addGlobalShape({x:0,y:0,strokeStyle:"red",fillStyle:"red",lineWidth:1,type:"audio-peaks"}),this.clearLocalCanvas(),this.drawOnCanvas()}catch(e){this.initCanvas(),this.props.peaks=new Int8Array,this.annotationTool.removeGlobalShape("audio-peaks"),this.clearLocalCanvas(),console.error(e)}})}initCanvas(){this.canvas.width=this.progressBarCoordinates.width*this.pixelRatio,this.canvas.height=this.props.waveHeight*this.pixelRatio,this.drawCtx.scale(this.pixelRatio,this.pixelRatio)}move(t,e,n){return t.x+=e,t.y+=n,t}normalize(t,e,n){return H(k({},t),{x:t.x/e,y:t.y/n})}onPointerDown(t){}onPointerMove(t){}onPointerUp(t){}reset(){this.clearLocalCanvas(),this.props.peaks=new Int8Array,this.annotationTool.removeGlobalShape("audio-peaks")}draw(t){let e=this.annotationTool.videoElement;if(!e||e.tagName!=="VIDEO"||e.muted||e.volume===0)return;this.ctx.clearRect(0,0,this.annotationTool.canvasWidth,this.annotationTool.canvasHeight);let{waveHeight:a,theme:r}=this.props,c=this.ctx,l=a/2,s=this.progressBarCoordinates.y-20,{x:h,width:m}=this.progressBarCoordinates,u=this.annotationTool.playbackFrame,p=this.annotationTool.totalFrames,f=Math.ceil(u/p*m)+h;this.ctx.drawImage(this.canvas,h,s,m,a),c.fillStyle=r.waveProgressColor,c.fillRect(f,s+0,1,l*2)}get pixelRatio(){return this.annotationTool.pixelRatio}get progressBarCoordinates(){return this.annotationTool.progressBarCoordinates}clearLocalCanvas(){this.drawCtx.clearRect(0,0,this.canvas.width,this.canvas.height)}drawOnCanvas(){let{peaks:t,bits:e,waveHeight:n,theme:a}=this.props,r=this.drawCtx,c=0,l=0,s=n/2,h=nt(2,e-1),m=0,u=t.length;r.fillStyle=a.waveOutlineColor;for(let p=0;p<u;p+=1){let f=t[(p+c)*2+1]/h,v=Math.abs(f*s);r.fillRect(p+l,m+0+s-v,1,v)}}};var Qt=class extends B{constructor(){super(...arguments);this.name="selection";this.selectedArea=null}move(t,e,n){return t.x+=e,t.y+=n,t}normalize(t,e,n){return H(k({},t),{x:t.x/e,y:t.y/n,width:t.width/e,height:t.height/n})}onPointerDown(t){let{x:e,y:n}=this.annotationTool.getRelativeCoords(t);this.startX=e,this.startY=n,this.isDrawing=!0,this.selectedArea=null}onPointerMove(t){if(!this.isDrawing)return;let{x:e,y:n}=this.annotationTool.getRelativeCoords(t);this.annotationTool.clearCanvas(),this.annotationTool.globalShapes.length>0?this.annotationTool.drawShapesOverlay():this.annotationTool.addVideoOverlay(),this.drawSelectionRect(this.startX,this.startY,e-this.startX,n-this.startY)}onPointerUp(t){if(!this.isDrawing)return;let{x:e,y:n}=this.annotationTool.getRelativeCoords(t),a=Math.min(e,this.startX),r=Math.min(n,this.startY),c=Math.abs(e-this.startX),l=Math.abs(n-this.startY);if(c<1||l<1){this.isDrawing=!1,this.annotationTool.redrawFullCanvas();return}let s=document.createElement("canvas"),h=s.getContext("2d"),m=this.annotationTool.videoElement;if(!(m instanceof HTMLVideoElement))return;let u=m.videoWidth/m.videoHeight,p=this.annotationTool.canvasWidth/this.annotationTool.canvasHeight,f=this.annotationTool.canvasWidth,v=this.annotationTool.canvasHeight,y=0,g=0;u>p?(v=this.annotationTool.canvasWidth/u,g=(this.annotationTool.canvasHeight-v)/2):(f=this.annotationTool.canvasHeight*u,y=(this.annotationTool.canvasWidth-f)/2);let x=m.videoWidth/f,C=m.videoHeight/v,P=(a-y)*x,O=(r-g)*C,R=c*x,D=l*C;s.width=Math.max(1,R),s.height=Math.max(1,D);try{h.drawImage(this.annotationTool.videoElement,P,O,R,D,0,0,R,D);let w=h.getImageData(0,0,s.width,s.height);this.selectedArea=w;let T=document.createElement("canvas");T.width=R+4,T.height=D+4,T.style.width=`${c+4}px`,T.style.height=`${l+4}px`;let E=T.getContext("2d");E.strokeStyle="black",E.lineWidth=2,E.strokeRect(1,1,R+2,D+2),E.strokeStyle="black",E.lineWidth=2,E.strokeRect(2,2,R,D),E.putImageData(w,2,2);let S=new Image;S.onload=()=>{this.annotationTool.pluginForTool("image").save({type:"image",x:a-2,y:r-2,width:c+4,height:l+4,image:S,strokeStyle:"transparent",fillStyle:"transparent",lineWidth:0}),this.isDrawing=!1,this.selectedArea=null,this.annotationTool.redrawFullCanvas()},S.src=T.toDataURL(),this.annotationTool.currentTool="move"}catch(w){console.error("Error capturing selection:",w),this.isDrawing=!1,this.annotationTool.redrawFullCanvas();return}}drawSelectionRect(t,e,n,a){var p,f,v;let r=Math.min(t,t+n),c=Math.min(e,e+a),l=Math.abs(n),s=Math.abs(a),h=this.annotationTool.pixelRatio,m=null;if(l>0&&s>0)try{m=this.ctx.getImageData(r*h,c*h,l*h,s*h)}catch(y){m=null}if(this.ctx.fillStyle="rgba(0, 0, 0, 0.5)",this.ctx.fillRect(0,0,this.annotationTool.canvasWidth,this.annotationTool.canvasHeight),m&&l>0&&s>0)this.ctx.putImageData(m,r*h,c*h);else if(l>0&&s>0){let y=this.annotationTool.videoElement;if(y instanceof HTMLVideoElement){let g=(p=this.annotationTool.videoFrameBuffer)==null?void 0:p.frameNumberFromTime(y.currentTime),x=(v=(f=this.annotationTool.videoFrameBuffer)==null?void 0:f.getFrame(g||0))!=null?v:y,C=x?x.width:y.videoWidth,P=x?x.height:y.videoHeight,O=C/this.annotationTool.canvasWidth,R=P/this.annotationTool.canvasHeight;this.ctx.drawImage(x,r*O,c*R,l*O,s*R,r,c,l,s)}}this.ctx.beginPath();let u=this.ctx.strokeStyle;this.ctx.strokeStyle="#ffffff",this.ctx.lineWidth=2,this.ctx.setLineDash([5,5]),this.ctx.strokeRect(r,c,l,s),this.ctx.setLineDash([]),this.ctx.strokeStyle=u}draw(t){this.drawSelectionRect(t.x,t.y,t.width,t.height)}reset(){super.reset(),this.selectedArea=null}isPointerAtShape(t,e,n){let a=Math.min(t.x,t.x+t.width),r=Math.max(t.x,t.x+t.width),c=Math.min(t.y,t.y+t.height),l=Math.max(t.y,t.y+t.height);return e>=a&&e<=r&&n>=c&&n<=l}};var ln=[zt,Vt,Yt,Ut,jt,_t,Xt,Gt,qt,Kt,Zt,Qt];function cn(i,o){let t,e,n,a=[],r=!0,c=!1;function l(m,u){if(c)return;let p=Math.abs(u.mediaTime-t),f=Math.abs(u.presentedFrames-e),v=p/f;v&&v<1&&r&&a.length<50&&i.playbackRate===1&&document.hasFocus()&&(a.push(v),n=Math.round(1/h()),o(n,a.length*2)),r=!0,t=u.mediaTime,e=u.presentedFrames,c||i.requestVideoFrameCallback(l)}i.requestVideoFrameCallback(l);let s=()=>{a.pop(),r=!1};i.addEventListener("seeked",s);function h(){return a.reduce((m,u)=>m+u)/a.length}return()=>{c=!0,i.removeEventListener("seeked",s)}}var ee=class ee extends Array{constructor(...o){super(...o),this.id=ee.nextId++}};ee.nextId=0;var pe=ee,hn=new Map;function io(i,o){return`${Math.min(i.id,o.id)}-${Math.max(i.id,o.id)}`}function fe(i,o){let t=io(i,o),e=hn.get(t);if(e!==void 0)return e;if(i.length===0||o.length===0)return 0;let n=Math.min(i.length,o.length),a=0,r=0;for(let u=0;u<n;u++)a+=i[u],r+=o[u];a/=n,r/=n;let c=0,l=0,s=0;for(let u=0;u<n;u++){let p=i[u]-a,f=o[u]-r;c+=p*f,l+=p*p,s+=f*f}let h=Math.sqrt(l*s),m=h===0?0:(c/h+1)/2;return hn.set(t,m),m}var dn=128,te=class{constructor(o,t){this.video=o;this.fps=t;this.audioContext=null;this.audioBuffer=null;this.fingerprints=new Map;this.isInitialized=!1;this.initPromise=null}init(){return M(this,null,function*(){if(!this.isInitialized)return this.initPromise?this.initPromise:(this.initPromise=this.doInit(),this.initPromise)})}doInit(){return M(this,null,function*(){try{let e=yield(yield(yield fetch(this.video.currentSrc||this.video.src)).blob()).arrayBuffer();this.audioContext=new AudioContext,this.audioBuffer=yield this.audioContext.decodeAudioData(e),this.isInitialized=!0}catch(o){console.warn("Could not extract audio for fingerprinting:",o),this.isInitialized=!0,this.audioBuffer=null}})}hasAudio(){return this.audioBuffer!==null}get totalFrames(){return Math.round(this.video.duration*this.fps)}extractFingerprint(o){if(!this.audioBuffer)return null;let t=(o-1)/this.fps,e=1/this.fps,n=this.audioBuffer.sampleRate,a=Math.floor(t*n),c=Math.floor((t+e)*n)-a;if(c<=0||a>=this.audioBuffer.length)return null;let l=this.audioBuffer.getChannelData(0),s=new pe,h=Math.max(1,Math.floor(c/dn));for(let m=0;m<dn;m++){let u=a+m*h,p=Math.min(u+h,this.audioBuffer.length),f=0,v=0;for(let g=u;g<p;g++)g<l.length&&(f+=l[g]*l[g],v++);let y=v>0?Math.sqrt(f/v):0;s.push(y)}return s}getFingerprint(o){if(this.fingerprints.has(o))return this.fingerprints.get(o);let t=this.extractFingerprint(o);return t&&this.fingerprints.set(o,t),t}extractRange(o,t){for(let e=o;e<=t;e++)this.getFingerprint(e)}setFingerprint(o,t){this.fingerprints.set(o,t)}findBestMatch(o,t,e=3){if(!o||!(this.fingerprints.size>0)&&!this.hasAudio())return t;let a=0,r=t,c=Math.max(1,t-e),l=Math.min(this.totalFrames,t+e);for(let s=c;s<=l;s++){let h=this.getFingerprint(s);if(h){let m=fe(o,h);m>a&&(a=m,r=s)}}return r}destroy(){this.fingerprints.clear(),this.audioContext&&(this.audioContext.close().catch(()=>{}),this.audioContext=null),this.audioBuffer=null,this.isInitialized=!1,this.initPromise=null}};var un=64,ht=class{constructor(o,t,e=!0){this.isDestroyed=!1;this.autoHide=!0;this.isMobile=!1;this.audioExtractor=null;this.audioInitPromise=null;this.seenFrames=0;this.isCanvasSizeSet=!1;this.frames=new Map;this.audioFingerprints=new Map;this.video=o,this.fps=t,this.autoHide=e,this.createCanvas(),this.createTransformCanvas()}createTransformCanvas(){this.transformCanvas=document.createElement("canvas"),this.transformCanvasCtx=this.canvas.getContext("2d",{willReadFrequently:!0,alpha:!1}),this.transformCanvas.width=un,this.transformCanvas.height=un}initAudioSync(){return M(this,null,function*(){var o;return this.audioExtractor?(o=this.audioInitPromise)!=null?o:Promise.resolve():(this.audioExtractor=new te(this.video,this.fps),this.audioInitPromise=this.audioExtractor.init(),this.audioInitPromise)})}hasAudioSync(){var o,t;return(t=(o=this.audioExtractor)==null?void 0:o.hasAudio())!=null?t:!1}start(){this.addRequestFrameCallback(),this.isMobile||this.initAudioSync().catch(()=>{})}destroy(){this.isDestroyed=!0,this.frames.forEach(o=>o.close()),this.frames.clear(),this.audioFingerprints.clear(),this.audioExtractor&&(this.audioExtractor.destroy(),this.audioExtractor=null),this.audioInitPromise=null}tick(o,t){if(this.setCanvasSize(),t.expectedDisplayTime-performance.now()>10,this.isDestroyed)return!1;if(this.seenFrames>=this.totalFrames){if(this.autoHide)try{this.video.paused||this.video.pause(),this.video.style.display="none"}catch(c){}return!1}if(this.video.videoWidth===0||this.video.videoHeight===0)return!0;let n=this.video,a=this.frameNumberFromTime(t.mediaTime);if(!Math.max(1,t.presentedFrames>this.totalFrames?t.presentedFrames%this.totalFrames:t.presentedFrames))throw new Error("expectedFrame is 0");if(this.hasFrame(a))this.seenFrames++;else{this.ctx.drawImage(n,0,0,this.width,this.height,0,0,this.width,this.height);let c=this.ctx.getImageData(0,0,this.canvas.width,this.canvas.height);createImageBitmap(c,0,0,this.width,this.height).then(l=>M(this,null,function*(){var s;if(this.setFrame(a,l),!this.isMobile&&((s=this.audioExtractor)!=null&&s.hasAudio())){let h=this.audioExtractor.getFingerprint(a);h&&this.setAudioFingerprint(a,h)}}))}return!0}addRequestFrameCallback(){this.isDestroyed||this.video.requestVideoFrameCallback((o,t)=>{this.tick(o,t)&&this.addRequestFrameCallback()})}createCanvas(){this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d",{willReadFrequently:!0,alpha:!1})}setCanvasSize(){this.isCanvasSizeSet||(this.canvas.width=this.video.videoWidth,this.canvas.height=this.video.videoHeight,this.isCanvasSizeSet=!0)}get width(){return this.video.videoWidth}get height(){return this.video.videoHeight}hasFrame(o){return this.frames.has(o)}getFrame(o){return this.frames.has(o)?this.frames.get(o):null}getFrameNumberBySignature(o,t){if(!o)return t;let e=0,n=t;return[t-3,t-2,t-1,t,t+1,t+2,t+3].filter(r=>r>0&&r<=this.totalFrames).forEach(r=>{let c=this.getAudioFingerprint(r);if(c){let l=fe(o,c);l>e&&(e=l,n=r)}}),n}setFrame(o,t){this.frames.set(o,t)}setAudioFingerprint(o,t){this.audioFingerprints.set(o,t)}getAudioFingerprint(o){var t;if(this.audioFingerprints.has(o))return this.audioFingerprints.get(o);if((t=this.audioExtractor)!=null&&t.hasAudio()){let e=this.audioExtractor.getFingerprint(o);if(e)return this.audioFingerprints.set(o,e),e}return null}get totalFrames(){return Math.round(this.video.duration*this.fps)}frameNumberFromTime(o){return Math.max(1,Math.round(o*this.fps))}};var dt={layout:"horizontal",mobile:{collapsibleToolbars:!0,gesturesEnabled:!0,autoCollapse:!0,breakpoint:960},theme:"dark",toolbar:{draggable:!1,sidebarPosition:"left",defaultTool:"curve"},features:{showThemeToggle:!0,showFullscreen:!0,showProgressBar:!0,showFrameCounter:!0}};function mn(i){var o,t;return i?{layout:(o=i.layout)!=null?o:dt.layout,theme:(t=i.theme)!=null?t:dt.theme,mobile:k(k({},dt.mobile),i.mobile),toolbar:k(k({},dt.toolbar),i.toolbar),features:k(k({},dt.features),i.features)}:k({},dt)}var Mt=class{constructor(o){this.tool=o;this.currentRenderer=null;this.rootElement=null;this.prefix=xt()}getRootElement(){if(!this.rootElement){let o=this.tool.canvas;o!=null&&o.parentElement&&(this.rootElement=o.parentElement,this.rootElement.classList.add(`${this.prefix}-root`))}return this.rootElement}clearLayoutClasses(){let o=this.getRootElement();o&&o.classList.remove(`${this.prefix}-layout-horizontal`,`${this.prefix}-layout-vertical`,`${this.prefix}-layout-minimal`,`${this.prefix}-layout-bottom-dock`,`${this.prefix}-sidebar-right`)}setLayout(o,t){this.currentRenderer&&this.currentRenderer.cleanup(),this.clearLayoutClasses();let e=this.getRootElement();e&&(e.classList.add(`${this.prefix}-layout-${o}`),o==="vertical"&&(t==null?void 0:t.sidebarPosition)==="right"&&e.classList.add(`${this.prefix}-sidebar-right`)),this.currentRenderer=this.createRenderer(o),this.currentRenderer.apply(this.tool)}getCurrentLayout(){var o,t;return(t=(o=this.currentRenderer)==null?void 0:o.name)!=null?t:null}createRenderer(o){switch(o){case"horizontal":return new ge;case"vertical":return new ve;case"minimal":return new ye;case"bottom-dock":return new xe}}destroy(){this.currentRenderer&&(this.currentRenderer.cleanup(),this.currentRenderer=null),this.clearLayoutClasses(),this.rootElement=null}},ge=class{constructor(){this.name="horizontal"}apply(o){}cleanup(){}},ve=class{constructor(){this.name="vertical"}apply(o){}cleanup(){}},ye=class{constructor(){this.name="minimal";this.dragState={isDragging:!1,startX:0,startY:0,offsetX:0,offsetY:0};this.container=null;this.boundHandlers={};this.prefix=xt()}apply(o){var e;if(this.container=o.uiContainer,!this.container)return;this.boundHandlers.mousedown=this.handleMouseDown.bind(this),this.boundHandlers.mousemove=this.handleMouseMove.bind(this),this.boundHandlers.mouseup=this.handleMouseUp.bind(this),this.container.addEventListener("mousedown",this.boundHandlers.mousedown),document.addEventListener("mousemove",this.boundHandlers.mousemove),document.addEventListener("mouseup",this.boundHandlers.mouseup);let t=o.config;(e=t==null?void 0:t.toolbar)!=null&&e.position&&(this.container.style.left=`${t.toolbar.position.x}px`,this.container.style.top=`${t.toolbar.position.y}px`)}cleanup(){this.container&&this.boundHandlers.mousedown&&this.container.removeEventListener("mousedown",this.boundHandlers.mousedown),this.boundHandlers.mousemove&&document.removeEventListener("mousemove",this.boundHandlers.mousemove),this.boundHandlers.mouseup&&document.removeEventListener("mouseup",this.boundHandlers.mouseup),this.container&&(this.container.style.left="",this.container.style.top=""),this.container=null,this.boundHandlers={}}handleMouseDown(o){if(!this.container||o.target.closest("button, input"))return;this.dragState.isDragging=!0,this.dragState.startX=o.clientX,this.dragState.startY=o.clientY;let t=this.container.getBoundingClientRect();this.dragState.offsetX=t.left,this.dragState.offsetY=t.top,this.container.classList.add(`${this.prefix}-dragging`),o.preventDefault()}handleMouseMove(o){if(!this.dragState.isDragging||!this.container)return;let t=o.clientX-this.dragState.startX,e=o.clientY-this.dragState.startY;this.container.style.left=`${this.dragState.offsetX+t}px`,this.container.style.top=`${this.dragState.offsetY+e}px`}handleMouseUp(){this.container&&(this.dragState.isDragging=!1,this.container.classList.remove(`${this.prefix}-dragging`))}},xe=class{constructor(){this.name="bottom-dock";this.movedElements=[];this.playerControls=null;this.divider=null;this.prefix=xt()}apply(o){let t=o.uiContainer,e=o.playerControlsContainer;if(t&&e)for(this.playerControls=e,this.divider=document.createElement("div"),this.divider.classList.add(`${this.prefix}-divider`),t.appendChild(this.divider);e.firstChild;){let n=e.firstChild;this.movedElements.push(n),t.appendChild(n)}}cleanup(){if(this.playerControls)for(let o of this.movedElements)this.playerControls.appendChild(o);this.divider&&this.divider.parentNode&&this.divider.parentNode.removeChild(this.divider),this.movedElements=[],this.playerControls=null,this.divider=null}};var ne=class{constructor(o,t=!0){this.container=o;this.autoCollapse=t;this.isCollapsed=!1;this.collapseButton=null;this.prefix=xt()}init(){this.container.classList.add(`${this.prefix}-collapsible`),this.createCollapseButton()}createCollapseButton(){var o;this.collapseButton=document.createElement("button"),this.collapseButton.type="button",this.collapseButton.classList.add(`${this.prefix}-collapse-btn`),this.collapseButton.setAttribute("aria-label","Toggle toolbar"),this.collapseButton.setAttribute("data-tooltip","Toggle toolbar"),this.updateButtonIcon(),this.collapseButton.addEventListener("click",t=>{t.stopPropagation(),this.toggle()}),(o=this.container.parentElement)==null||o.insertBefore(this.collapseButton,this.container.nextSibling)}updateButtonIcon(){this.collapseButton&&(this.collapseButton.innerHTML=`
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="18 15 12 9 6 15"/>
      </svg>
    `)}collapse(){this.isCollapsed||(this.isCollapsed=!0,this.container.classList.add(`${this.prefix}-collapsed`))}expand(){this.isCollapsed&&(this.isCollapsed=!1,this.container.classList.remove(`${this.prefix}-collapsed`))}toggle(){this.isCollapsed?this.expand():this.collapse()}get collapsed(){return this.isCollapsed}get autoCollapseEnabled(){return this.autoCollapse}setAutoCollapse(o){this.autoCollapse=o}destroy(){this.collapseButton&&(this.collapseButton.remove(),this.collapseButton=null),this.container.classList.remove(`${this.prefix}-collapsible`,`${this.prefix}-collapsed`)}};var kt=class{constructor(o,t){this.canvas=o;this.onGestureChange=t;this.initialDistance=0;this.initialScale=1;this.currentScale=1;this.panStart={x:0,y:0};this.panOffset={x:0,y:0};this.isGesturing=!1;this.activeTouches=0;this.minScale=.5;this.maxScale=3;this.handleTouchStart=o=>{this.activeTouches=o.touches.length,o.touches.length===2&&(o.preventDefault(),this.isGesturing=!0,this.initialDistance=this.getDistance(o.touches[0],o.touches[1]),this.initialScale=this.currentScale,this.panStart=this.getMidpoint(o.touches[0],o.touches[1]))};this.handleTouchMove=o=>{if(o.touches.length===2&&this.isGesturing){o.preventDefault();let e=this.getDistance(o.touches[0],o.touches[1])/this.initialDistance;this.currentScale=Math.max(this.minScale,Math.min(this.maxScale,this.initialScale*e));let n=this.getMidpoint(o.touches[0],o.touches[1]);this.panOffset={x:this.panOffset.x+(n.x-this.panStart.x),y:this.panOffset.y+(n.y-this.panStart.y)},this.panStart=n,this.onGestureChange(this.getState())}};this.handleTouchEnd=o=>{this.activeTouches=o.touches.length,o.touches.length<2&&(this.isGesturing=!1,o.touches.length===1&&(this.panStart={x:o.touches[0].clientX,y:o.touches[0].clientY}))}}init(){this.canvas.addEventListener("touchstart",this.handleTouchStart,{passive:!1}),this.canvas.addEventListener("touchmove",this.handleTouchMove,{passive:!1}),this.canvas.addEventListener("touchend",this.handleTouchEnd,{passive:!1}),this.canvas.addEventListener("touchcancel",this.handleTouchEnd,{passive:!1})}getDistance(o,t){let e=t.clientX-o.clientX,n=t.clientY-o.clientY;return Math.sqrt(e*e+n*n)}getMidpoint(o,t){return{x:(o.clientX+t.clientX)/2,y:(o.clientY+t.clientY)/2}}getState(){return{scale:this.currentScale,panX:this.panOffset.x,panY:this.panOffset.y}}isActive(){return this.isGesturing}hasTwoFingers(){return this.activeTouches>=2}reset(){this.currentScale=1,this.panOffset={x:0,y:0},this.initialScale=1,this.initialDistance=0,this.isGesturing=!1,this.onGestureChange(this.getState())}setScale(o){this.currentScale=Math.max(this.minScale,Math.min(this.maxScale,o)),this.onGestureChange(this.getState())}setPan(o,t){this.panOffset={x:o,y:t},this.onGestureChange(this.getState())}destroy(){this.canvas.removeEventListener("touchstart",this.handleTouchStart),this.canvas.removeEventListener("touchmove",this.handleTouchMove),this.canvas.removeEventListener("touchend",this.handleTouchEnd),this.canvas.removeEventListener("touchcancel",this.handleTouchEnd)}};var ao=window.devicePixelRatio||1,pn=25,Q=class extends Ot{constructor(t,e){super();this.referenceVideoFrameBuffer=null;this.videoFrameBuffer=null;this.ffmpegFrameExtractor=null;this.isMouseDown=!1;this.buttons=[];this.plugins=[];this.annotatedFrameCoordinates=[];this.videoBlobUrl=null;this.referenceVideoBlobUrl=null;this.frameCounterTimeoutId=null;this._enforcedTotalFrames=null;this.isCursorOverCanvas=!1;this.overlayOpacity=.7;this._theme="dark";this.themeChangeListeners=[];this.layoutManager=null;this.collapseController=null;this.gestureHandler=null;this.gestureState={scale:1,panX:0,panY:0};this.fps=pn;this.plannedFn=null;this.ct=0;this.isCanvasInitialized=!1;this.enforcedCanvasSize=null;this.lastNavigatedFrame=0;this.isProgressBarNavigation=!1;this.isAnnotationsAsVideoActive=!1;this.config=mn(e),this._theme=this.config.theme,this.plugins=ln.map(n=>new n(this)),this.init(t)}prevFrame(){let e=this.playbackFrame-1;e<1?this.playbackFrame=this.totalFrames:this.playbackFrame=e}nextFrame(){let e=this.playbackFrame+1;e>this.totalFrames?this.playbackFrame=1:this.playbackFrame=e}getAnnotatedFrames(){let t=[];return this.timeStack.forEach((e,n)=>{e&&e.length>0&&t.push(n)}),t.sort((e,n)=>e-n)}prevAnnotatedFrame(){let t=this.getAnnotatedFrames();if(t.length===0)return;let e=this.playbackFrame;for(let n=t.length-1;n>=0;n--)if(t[n]<e){this.playbackFrame=t[n];return}this.playbackFrame=t[t.length-1]}nextAnnotatedFrame(){let t=this.getAnnotatedFrames();if(t.length===0)return;let e=this.playbackFrame;for(let n of t)if(n>e){this.playbackFrame=n;return}this.playbackFrame=t[0]}get theme(){return this._theme}setTheme(t){this._theme=t,ue(t),this.themeChangeListeners.forEach(e=>e(t))}onThemeChange(t){return this.themeChangeListeners.push(t),()=>{let e=this.themeChangeListeners.indexOf(t);e!==-1&&this.themeChangeListeners.splice(e,1)}}setLayout(t){this.layoutManager||(this.layoutManager=new Mt(this)),this.layoutManager.setLayout(t,{sidebarPosition:this.config.toolbar.sidebarPosition})}getLayout(){var t,e;return(e=(t=this.layoutManager)==null?void 0:t.getCurrentLayout())!=null?e:this.config.layout}collapseToolbar(){var t;(t=this.collapseController)==null||t.collapse()}expandToolbar(){var t;(t=this.collapseController)==null||t.expand()}toggleToolbar(){var t;(t=this.collapseController)==null||t.toggle()}isToolbarCollapsed(){var t,e;return(e=(t=this.collapseController)==null?void 0:t.collapsed)!=null?e:!1}setGesturesEnabled(t){t&&!this.gestureHandler?(this.gestureHandler=new kt(this.canvas,e=>{this.applyGestureTransform(e)}),this.gestureHandler.init()):!t&&this.gestureHandler&&(this.gestureHandler.destroy(),this.gestureHandler=null,this.resetZoom())}isGesturesEnabled(){return this.gestureHandler!==null}resetZoom(){var t;this.gestureState={scale:1,panX:0,panY:0},(t=this.gestureHandler)==null||t.reset(),this.redrawFullCanvas()}getZoomScale(){return this.gestureState.scale}applyGestureTransform(t){this.gestureState=t,this.redrawFullCanvas()}removeGlobalShape(t){this.globalShapes=this.globalShapes.filter(e=>e.type!==t)}addGlobalShape(t){this.globalShapes.push(t)}get selectedColor(){return this.colorPicker.value}get selectedStrokeSize(){return this.strokeSizePicker.valueAsNumber}get currentTool(){return this._currentTool}set currentTool(t){let e=this._currentTool;e&&(this.getButtonForTool(e).classList.remove("active"),this.pluginForTool(e).onDeactivate()),this._currentTool=t,this.canvas.style.cursor=t?"pointer":"default",t&&(this.getButtonForTool(t).classList.add("active"),this.pluginForTool(t).onActivate())}enableFrameRateDetection(){if(this.destructors.find(n=>n.name==="frameRateDetector"))return;let t=this.videoElement;if(t.tagName==="IMG")return;let e=cn(t,n=>{this.fps=n});Object.defineProperty(e,"name",{value:"frameRateDetector"}),this.destructors.push(e)}timeToFrame(t){return Math.max(1,Math.round(t*this.fps))}get playbackFrame(){return this.videoElement instanceof HTMLImageElement?1:this.timeToFrame(this.videoElement.currentTime)}set playbackFrame(t){if(this.videoElement instanceof HTMLImageElement)return;let e=t/this.fps;this.videoElement.currentTime=e,this.rvf(()=>{this.show()})}rvf(t){this.plannedFn=t}get canvasWidth(){var t,e;return(e=(t=this.enforcedCanvasSize)==null?void 0:t.width)!=null?e:0}get canvasHeight(){var t,e;return(e=(t=this.enforcedCanvasSize)==null?void 0:t.height)!=null?e:0}get aspectRatio(){return this.canvasHeight===0?0:this.canvasWidth/this.canvasHeight}get isMobile(){var e,n,a;let t=(a=(n=(e=this.config)==null?void 0:e.mobile)==null?void 0:n.breakpoint)!=null?a:960;return window.innerWidth<t}get progressBarCoordinates(){let t=this.isMobile?30:10,e=5,a=this.canvasWidth-e-55,r=e,c=this.canvasHeight-t;return{x:r,y:c,width:a,height:t}}get shapes(){return this.timeStack.has(this.activeTimeFrame)||this.timeStack.set(this.activeTimeFrame,[]),this.timeStack.get(this.activeTimeFrame)}set shapes(t){this.timeStack.set(this.activeTimeFrame,t)}get undoStack(){return this.undoTimeStack.has(this.activeTimeFrame)||this.undoTimeStack.set(this.activeTimeFrame,[]),this.undoTimeStack.get(this.activeTimeFrame)}set undoStack(t){this.undoTimeStack.set(this.activeTimeFrame,t)}get pixelRatio(){return ao}setVideoBlob(n){return M(this,arguments,function*(t,e=this.fps){this.videoBlobUrl&&URL.revokeObjectURL(this.videoBlobUrl);let a=URL.createObjectURL(t);this.videoBlobUrl=a,yield this.setVideoUrl(a,e),this.plugins.forEach(r=>{r.on("videoBlobSet",t)})})}setVideoUrl(n){return M(this,arguments,function*(t,e=this.fps){if(this.videoElement instanceof HTMLImageElement)return;let a=this.videoElement;a.src=t.toString(),yield this.videoElement.load(),this.setFrameRate(e),this.videoFrameBuffer&&(this.videoFrameBuffer.destroy(),this.videoFrameBuffer=new ht(a,e,!1),this.videoFrameBuffer.isMobile=this.isMobile),this.setCanvasSize()})}enableVideoFrameBuffer(){this.videoElement instanceof HTMLImageElement||(this.videoFrameBuffer=new ht(this.videoElement,this.fps,!1),this.videoFrameBuffer.isMobile=this.isMobile)}setFFmpegFrameExtractor(t){this.ffmpegFrameExtractor=t,this.redrawFullCanvas()}hasFFmpegFrame(t){var e,n;return(n=(e=this.ffmpegFrameExtractor)==null?void 0:e.hasFrame(t))!=null?n:!1}hide(){this.stopAnnotationsAsVideo(),this.hideControls(),this.hideCanvas()}showControls(){this.uiContainer.style.display=""}hideControls(){this.uiContainer.style.display="none"}showCanvas(){this.canvas.style.display="block"}hideCanvas(){this.canvas.style.display="none"}updateActiveTimeFrame(t=void 0){this.activeTimeFrame=t?this.timeToFrame(t):this.playbackFrame}show(){this.stopAnnotationsAsVideo(),this.updateActiveTimeFrame(),this.showCanvas(),this.showControls(),this.redrawFullCanvas()}setCanvasSettings(){this.ctx.strokeStyle=this.selectedColor,this.ctx.fillStyle=this.selectedColor,this.ctx.lineWidth=this.selectedStrokeSize}pluginForTool(t){if(this.isDestroyed)throw new Error("AnnotationTool is destroyed");let e=this.plugins.find(n=>n.name===t);if(!e)throw new Error(`No plugin found for tool ${t}`);return e}getButtonForTool(t){return this.buttons.find(e=>e.dataset.tool===t)}bindContext(){this.handleMouseDown=this.handleMouseDown.bind(this),this.handleMouseMove=this.handleMouseMove.bind(this),this.handleMouseUp=this.handleMouseUp.bind(this),this.setCanvasSize=this.setCanvasSize.bind(this),this.onKeyDown=this.onKeyDown.bind(this)}initProperties(){var t;this.isDestroyed=!1,this.isProgressBarNavigation=!1,this.shapes=[],this.globalShapes=[],this.currentTool=this.isMobile?null:(t=this.config.toolbar.defaultTool)!=null?t:null,ue(this._theme),this.layoutManager=new Mt(this),this.layoutManager.setLayout(this.config.layout,{sidebarPosition:this.config.toolbar.sidebarPosition}),this.isMobile&&this.config.mobile.collapsibleToolbars&&(this.collapseController=new ne(this.uiContainer,this.config.mobile.autoCollapse),this.collapseController.init()),this.isMobile&&this.config.mobile.gesturesEnabled&&(this.gestureHandler=new kt(this.canvas,e=>{this.applyGestureTransform(e)}),this.gestureHandler.init())}setVideoStyles(){this.videoElement.style.objectFit="cover",this.videoElement.style.objectPosition="left top"}get frameCallbackSupported(){return"requestVideoFrameCallback"in HTMLVideoElement.prototype}initFrameCounter(){if(!this.frameCallbackSupported){this.frameCounterTimeoutId=setTimeout(()=>{var t;this.isDestroyed||((t=this.plannedFn)==null||t.call(this),this.plannedFn=null,this.initFrameCounter(),this.updateActiveTimeFrame(),this.playAnnotationsAsVideo())},1e3/this.fps);return}this.withVideo(t=>{t.requestVideoFrameCallback((e,n)=>{var a,r;this.isCanvasInitialized||this._setCanvasSize(),(a=this.videoFrameBuffer)==null||a.tick(e,n),(r=this.plannedFn)==null||r.call(this),this.plannedFn=null,this.raf(()=>{this.initFrameCounter(),this.updateActiveTimeFrame(n.mediaTime),this.playAnnotationsAsVideo()})})})}init(t){this.videoElement=t,this.setVideoStyles(),this.initFrameCounter(),this.bindContext(),this.initCanvas(),this.initUI(),this.initProperties(),this.setCanvasSize()}onKeyDown(t){(t.ctrlKey||t.metaKey)&&t.key.toLowerCase()==="z"&&this.handleUndo()}handleUndo(){this.undoStack.length>0&&(this.shapes=this.undoStack.pop(),this.redrawFullCanvas())}destroy(){var a,r,c,l,s,h,m,u,p,f,v;if(this.isDestroyed)return;super.destroy(),this.stopAnnotationsAsVideo(),this.frameCounterTimeoutId&&(clearTimeout(this.frameCounterTimeoutId),this.frameCounterTimeoutId=null),this.videoBlobUrl&&(URL.revokeObjectURL(this.videoBlobUrl),this.videoBlobUrl=null),this.referenceVideoBlobUrl&&(URL.revokeObjectURL(this.referenceVideoBlobUrl),this.referenceVideoBlobUrl=null),this.currentTool=null,this.plugins.forEach(y=>y.reset()),this.annotatedFrameCoordinates=[],this.setFrameRate(pn);let t=this.strokeSizePicker.parentElement;if((a=t==null?void 0:t.parentNode)==null||a.removeChild(t),this.referenceVideoElement){let y=this.referenceVideoElement.parentElement;(r=y==null?void 0:y.parentNode)==null||r.removeChild(y),this.referenceVideoElement=null}let e=this.colorPicker.parentElement;(c=e==null?void 0:e.parentNode)==null||c.removeChild(e),this.buttons.forEach(y=>{var g;(g=y.parentNode)==null||g.removeChild(y)}),this.buttons=[],(l=this.uiContainer.parentNode)==null||l.removeChild(this.uiContainer),(s=this.canvas.parentNode)==null||s.removeChild(this.canvas),(h=this.playerControlsContainer.parentElement)==null||h.removeChild(this.playerControlsContainer),["strokeSizePicker","colorPicker","uiContainer","playerControlsContainer","canvas","ctx","videoElement"].forEach(y=>{delete this[y]}),this.activeTimeFrame=0,this.isDestroyed=!0,(m=this.referenceVideoFrameBuffer)==null||m.destroy(),this.referenceVideoFrameBuffer=null,(u=this.videoFrameBuffer)==null||u.destroy(),this.videoFrameBuffer=null,(p=this.layoutManager)==null||p.destroy(),this.layoutManager=null,(f=this.collapseController)==null||f.destroy(),this.collapseController=null,(v=this.gestureHandler)==null||v.destroy(),this.gestureHandler=null,this.gestureState={scale:1,panX:0,panY:0}}_setCanvasSize(){var u;let t=getComputedStyle(this.videoElement),e=parseInt(t.width,10),n=this.videoElement,a=n.videoWidth/n.videoHeight;if(isNaN(e)||!n.videoWidth||!n.videoHeight)return this.isCanvasInitialized=!1,this.setCanvasSettings(),!1;let r=n.parentElement,c=!!((u=document.fullscreenElement)!=null?u:document.webkitFullscreenElement),l=Math.min(e,n.videoWidth),s=Math.floor(l/a);if(c&&r){let v=window.innerWidth,y=window.innerHeight-90;v/y>a?(s=y,l=s*a):(l=v,s=l/a),n.style.width=`${l}px`,n.style.height=`${s}px`,n.style.marginTop="40px",n.style.marginBottom="50px"}else n.style.width=`${l}px`,n.style.height=`${s}px`,n.style.marginTop="",n.style.marginBottom="";this.isCanvasInitialized=n.videoWidth>0&&n.videoHeight>0,this.canvas.width=l*this.pixelRatio,this.canvas.height=s*this.pixelRatio,this.canvas.style.width=`${l}px`,this.canvas.style.height=`${s}px`,this.canvas.style.position="absolute";let h=n.offsetTop,m=n.offsetLeft;return this.canvas.style.top=`${h}px`,this.canvas.style.left=`${m}px`,this.enforcedCanvasSize={width:l,height:s},this.ctx.scale(this.pixelRatio,this.pixelRatio),this.setCanvasSettings(),!0}setCanvasSize(){this._setCanvasSize()&&(this.syncVideoSizes(),this.redrawFullCanvas())}replaceShape(t,e){let n=this.serialize([t])[0];this.undoStack.push([...this.shapes]),this.shapes[e]=n}addShape(t){let e=this.serialize([t])[0];this.undoStack.push([...this.shapes]),this.shapes.push(e)}get msPerFrame(){return 1e3/this.fps}syncVideoSizes(){this.withRefVideo(t=>{let n=this.videoElement.getBoundingClientRect();t.style.position="fixed",t.style.top=`${n.top}px`,t.style.left=`${n.left}px`})}addReferenceVideoByURL(a){return M(this,arguments,function*(t,e=this.fps,n="video/mp4"){var s;let r=yield fetch(t).then(h=>h.blob()),c=new Blob([r],{type:n});this.referenceVideoBlobUrl&&URL.revokeObjectURL(this.referenceVideoBlobUrl);let l=window.URL.createObjectURL(c);this.referenceVideoBlobUrl=l,this.referenceVideoElement?((s=this.referenceVideoFrameBuffer)==null||s.destroy(),this.referenceVideoFrameBuffer=new ht(this.referenceVideoElement,e),this.referenceVideoFrameBuffer.isMobile=this.isMobile,this.referenceVideoFrameBuffer.start()):(this.referenceVideoElement=document.createElement("video"),this.withRefVideo(h=>{this.isMobile?(h.style.zIndex="2",h.style.display="block",h.style.top="0",h.style.left="0",h.style.opacity="0.25",h.style.width="20px",h.style.height="15px"):(h.style.zIndex="-1",h.style.display="none",h.style.width="100px",h.style.height="70px"),h.style.objectFit="cover",h.style.objectPosition="left top",h.muted=!0,h.volume=0,h.playsInline=!0,h.autoplay=!1,h.controls=!1,h.loop=!0,this.videoElement.after(h),this.referenceVideoFrameBuffer=new ht(h,e),this.referenceVideoFrameBuffer.isMobile=this.isMobile,this.referenceVideoFrameBuffer.start()}),this.syncVideoSizes()),this.referenceVideoElement.src=l,this.referenceVideoElement.play().then(()=>{this.showButton("compare")}).catch(()=>{this.hideButton("compare")})})}hideButton(t){let e=this.getButtonForTool(t);e.style.display="none"}showButton(t){let e=this.getButtonForTool(t);e.style.display=""}addSingletonShape(t){let e=this.serialize([t])[0],n=this.shapes.filter(a=>a.type!==t.type);this.replaceFrame(this.playbackFrame,[...n,e])}serialize(t=this.shapes){let e=this.canvasWidth,n=this.canvasHeight;return t.map(a=>this.pluginForTool(a.type).normalize(a,e,n))}deserialize(t){let e=1/this.canvasWidth,n=1/this.canvasHeight;return t.map(a=>this.pluginForTool(a.type).normalize(a,e,n))}getRelativeCoords(t){let e=this.canvas.getBoundingClientRect();return{x:this.getEventX(t)-e.left,y:this.getEventY(t)-e.top}}handleMouseDown(t){var n,a;if(t.preventDefault(),this.isMouseDown=!0,Ht(t)||(n=this.gestureHandler)!=null&&n.hasTwoFingers())return;let e=this.frameFromProgressBar(t,!0);if(e){this.isProgressBarNavigation=!0;let r=this.getAnnotationFrame(t);this.isVideoPaused&&(r!==null?this.playbackFrame=r:this.playbackFrame=e);return}this.currentTool&&((a=this.collapseController)!=null&&a.autoCollapseEnabled)&&this.collapseController.collapse(),this.currentTool&&this.pluginForTool(this.currentTool).onPointerDown(t)}get isDrawing(){return this.currentTool?this.pluginForTool(this.currentTool).isDrawing:!1}get isVideoPaused(){return this.videoElement.tagName==="VIDEO"?this.videoElement.paused:!0}get hasGlobalOverlays(){return this.globalShapes.length>0}handleMouseMove(t){if(t.preventDefault(),!Ht(t)){if(this.isMouseDown){let e=this.isProgressBarNavigation?this.frameFromProgressBar(t,!1):null;if(e!==null&&!this.isDrawing){if(e===this.lastNavigatedFrame)return;this.lastNavigatedFrame=e,this.activeTimeFrame=e,this.isVideoPaused&&(this.playbackFrame=e),this.clearCanvas(),this.hasGlobalOverlays||this.addVideoOverlay(),this.drawShapesOverlay(),this.addProgressBarOverlay();return}else this.hideControls(),this.clearCanvas(),this.hasGlobalOverlays||this.addVideoOverlay(),this.drawShapesOverlay()}else this.redrawFullCanvas();this.currentTool&&this.pluginForTool(this.currentTool).onPointerMove(t)}}getEventX(t){return t.clientX}getEventY(t){return t.clientY}handleMouseUp(t){var e;this.isMouseDown=!1,this.isProgressBarNavigation=!1,this.showControls(),!Ht(t)&&(this.currentTool&&this.pluginForTool(this.currentTool).onPointerUp(t),(e=this.collapseController)!=null&&e.autoCollapseEnabled&&this.collapseController.expand(),this.redrawFullCanvas())}focusOnMediaNode(){this.videoElement.focus()}drawShapesOverlay(){var n,a;let t={strokeStyle:this.ctx.strokeStyle,fillStyle:this.ctx.fillStyle,lineWidth:this.ctx.lineWidth,globalAlpha:this.ctx.globalAlpha},e=this.gestureState.scale!==1||this.gestureState.panX!==0||this.gestureState.panY!==0;if(e){this.ctx.save(),this.ctx.translate(this.gestureState.panX,this.gestureState.panY);let r=this.canvasWidth/2,c=this.canvasHeight/2;this.ctx.translate(r,c),this.ctx.scale(this.gestureState.scale,this.gestureState.scale),this.ctx.translate(-r,-c)}for(let r of this.deserialize(this.globalShapes)){this.ctx.strokeStyle=r.strokeStyle,this.ctx.fillStyle=r.fillStyle,this.ctx.lineWidth=r.lineWidth,this.ctx.globalAlpha=(n=r.opacity)!=null?n:1;try{this.pluginForTool(r.type).draw(r)}catch(c){console.error(c)}}for(let r of this.deserialize(this.shapes)){this.ctx.strokeStyle=r.strokeStyle,this.ctx.fillStyle=r.fillStyle,this.ctx.lineWidth=r.lineWidth,this.ctx.globalAlpha=(a=r.opacity)!=null?a:1;try{this.pluginForTool(r.type).draw(r)}catch(c){console.error(c)}}e&&this.ctx.restore(),this.ctx.strokeStyle=t.strokeStyle,this.ctx.fillStyle=t.fillStyle,this.ctx.lineWidth=t.lineWidth,this.ctx.globalAlpha=t.globalAlpha}clearCanvas(){this.ctx.clearRect(0,0,this.canvasWidth,this.canvasHeight)}frameToDataUrl(){try{this.clearCanvas(),this.addVideoOverlay(),this.addFrameSquareOverlay(),this.drawShapesOverlay();let t=this.canvas.toDataURL("image/png");return this.redrawFullCanvas(),t}catch(t){return console.error(t),null}}redrawFullCanvas(){this.clearCanvas(),this.addVideoOverlay(),this.drawShapesOverlay(),this.drawSelectionHandles(),this.addFrameSquareOverlay(),this.addProgressBarOverlay()}drawSelectionHandles(){if(this.currentTool==="move")try{this.pluginForTool("move").drawResizeHandles()}catch(t){}}replaceFrame(t,e){this.timeStack.set(t,this.parseShapes(this.stringifyShapes(e)))}addShapesToFrame(t,e){let n=this.timeStack.get(t)||[];this.timeStack.set(t,[...n,...this.parseShapes(this.stringifyShapes(e))])}setFrameRate(t){var e;(e=this.destructors.find(n=>n.name==="frameRateDetector"))==null||e(),this.fps=t}stringifyShapes(t){return JSON.stringify(t,(e,n)=>e==="image"?n.src:n)}parseShapes(t){return JSON.parse(t,(e,n)=>{if(e==="image"){let a=new Image;return a.src=n,a}return n})}filterNonSerializableShapes(t){return t.filter(e=>e.type!=="image")}saveCurrentFrame(){return{frame:this.playbackFrame,version:1,fps:this.fps,shapes:this.parseShapes(this.stringifyShapes(this.filterNonSerializableShapes(this.shapes)))}}loadAllFrames(t){this.cleanFrameStacks(),t.forEach(e=>{let n=e.shapes||[];this.timeStack.set(e.frame,this.parseShapes(this.stringifyShapes(n)))})}appendFrames(t){t.forEach(e=>{this.addShapesToFrame(e.frame,e.shapes)})}saveAllFrames(){return Array.from(this.timeStack.keys()).filter(a=>{var r;return(r=this.timeStack.get(a))==null?void 0:r.length}).map(a=>{var r;return{frame:a,fps:this.fps,version:1,shapes:this.filterNonSerializableShapes((r=this.timeStack.get(a))!=null?r:[])}})}getAnnotationFrame(t){var c,l;let e=t.offsetX,n=t.offsetY,a=this.isMobile?20:12;return(l=(c=this.annotatedFrameCoordinates.find(s=>e>=s.x-a&&e<=s.x+a&&n>=s.y-a&&n<=s.y+a))==null?void 0:c.frame)!=null?l:null}get totalFrames(){if(this._enforcedTotalFrames!==null)return this._enforcedTotalFrames;let t=this.videoElement;return t.tagName!=="VIDEO"?1:Math.round(t.duration*this.fps)}setTotalFrames(t){this._enforcedTotalFrames=t!==null?Math.max(1,Math.round(t)):null}getEnforcedTotalFrames(){return this._enforcedTotalFrames}frameFromProgressBar(t,e=!0){if(this.videoElement.tagName!=="VIDEO")return null;let{x:a,width:r,height:c,y:l}=this.progressBarCoordinates,s=t.offsetX,h=t.offsetY,m=()=>{let u=Math.round((s-a)/r*this.totalFrames);return Math.max(1,Math.min(u,this.totalFrames))};return e?s>=a&&s<=a+r&&h>=l&&h<=l+c?m():null:s>=a&&s<=a+r?m():null}hasAnnotationsForFrame(t){if(this.globalShapes.length>0)return!0;if(this.timeStack.has(t)){let e=this.timeStack.get(t);return e&&e.length>0}return!1}stopAnnotationsAsVideo(){this.isAnnotationsAsVideoActive=!1}startAnnotationsAsVideo(){this.isAnnotationsAsVideoActive=!0,this.playAnnotationsAsVideo()}playAnnotationsAsVideo(){this.isAnnotationsAsVideoActive&&(this.clearCanvas(),this.addVideoOverlay(),this.drawShapesOverlay(),(this.isCursorOverCanvas||this.isMobile)&&(this.addFrameSquareOverlay(),this.addProgressBarOverlay()))}};function fn(i=this.activeTimeFrame){this.ctx.save(),this.ctx.fillStyle="rgba(0, 0, 0, 0.5)";let o=50,t=30,e=20;this.ctx.fillRect(this.canvasWidth-o,this.canvasHeight-t,o,t),this.ctx.fillStyle="white",this.ctx.font=`${e}px sans-serif`,this.ctx.fillText(`${i}`.padStart(3,"0"),this.canvasWidth-40,this.canvasHeight-7),this.ctx.restore()}function gn(){var h,m;let i=this.videoElement;if(i.tagName!=="VIDEO")return;let o=i.getBoundingClientRect(),t=this.canvas.getBoundingClientRect(),e=o.left-t.left,n=o.top-t.top,a=this.activeTimeFrame,r=null,c,l,s=(h=this.ffmpegFrameExtractor)==null?void 0:h.getFrame(a||1);if(s)r=s,c=s.width,l=s.height;else{let u=(m=this.videoFrameBuffer)==null?void 0:m.getFrame(a||0);u?(r=u,c=u.width,l=u.height):(r=i,c=i.videoWidth,l=i.videoHeight)}this.ctx.drawImage(r,0,0,c,l,e,n,this.canvasWidth,this.canvasHeight)}function vn(){if(this.videoElement.tagName!=="VIDEO")return;this.annotatedFrameCoordinates=[];let t=Array.from(this.timeStack.keys()).filter(f=>{var v;return(v=this.timeStack.get(f))==null?void 0:v.length}),e=this.totalFrames,{x:n,width:a,height:r,y:c}=this.progressBarCoordinates,l=t.map(f=>Math.round(f/e*a));this.ctx.save(),this.ctx.fillStyle="rgba(0, 0, 0, 0.5)",this.ctx.fillRect(n,c,a,r),this.ctx.fillStyle=ct.y;let s=this.isMobile?16:8;l.forEach((f,v)=>{this.ctx.beginPath();let y=n+f,g=this.canvasHeight-r/2;this.ctx.fillRect(y-s/2,g-s/2,s,s),this.annotatedFrameCoordinates.push({x:y,y:g,frame:t[v]})});let h=this.isProgressBarNavigation&&this.lastNavigatedFrame>0?this.lastNavigatedFrame:this.playbackFrame,m=Math.round(h/e*a)+n;this.ctx.fillStyle="white",this.ctx.beginPath();let u=m,p=this.canvasHeight-r/2;this.ctx.beginPath(),this.ctx.fillRect(u-s/2,p-s/2,s,s),this.ctx.fill(),this.ctx.restore()}function be(i,o=1){let t=i.replace(/^#/,""),e=0,n=0,a=0;return t.length===3?(e=parseInt(t[0]+t[0],16)/255,n=parseInt(t[1]+t[1],16)/255,a=parseInt(t[2]+t[2],16)/255):t.length===6?(e=parseInt(t.substring(0,2),16)/255,n=parseInt(t.substring(2,4),16)/255,a=parseInt(t.substring(4,6),16)/255):t.length===8&&(e=parseInt(t.substring(0,2),16)/255,n=parseInt(t.substring(2,4),16)/255,a=parseInt(t.substring(4,6),16)/255,o=parseInt(t.substring(6,8),16)/255),[e,n,a,o]}function bt(i,o=1){if(typeof i=="string"){if(i.startsWith("rgb")){let t=i.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*([\d.]+))?\)/);if(t)return[parseInt(t[1])/255,parseInt(t[2])/255,parseInt(t[3])/255,t[4]?parseFloat(t[4]):o]}return be(i,o)}return[1,0,0,o]}function yn(i,o,t,e){let n=Math.cos(e),a=Math.sin(e),r=i.x-o,c=i.y-t;return{x:o+r*n-c*a,y:t+r*a+c*n}}function ut(i,o,t,e){if(!o.rotation)return i;let n=o.rotationCenterX!==void 0?o.rotationCenterX:t,a=o.rotationCenterY!==void 0?o.rotationCenterY:e;return i.map(r=>yn(r,n,a,o.rotation))}function xn(i,o,t){return{x:i*2-1,y:(1-o*2)/t}}function ft(i){return`[ [ ${i.map(o=>oe(o)).join(" ")} ] ]`}function mt(i){return`[ ${i.map(o=>oe(o)).join(" ")} ]`}function oe(i){return Number.isInteger(i)?String(i):i.toFixed(9).replace(/\.?0+$/,"")||"0"}function pt(i,o){return`[ ${i.map(e=>{let n=xn(e.x,e.y,o);return`[ ${oe(n.x)} ${oe(n.y)} ]`}).join(" ")} ]`}function ro(i,o,t,e,n){var u;let a=bt(i.strokeStyle,(u=i.opacity)!=null?u:1),r=e/n,c=0,l=0;for(let p of i.points)c+=p.x,l+=p.y;c/=i.points.length,l/=i.points.length;let s=ut(i.points,i,c,l),h=i.lineWidth/n,m=new Array(s.length).fill(h);return{name:`"pen:${o}:${t}:User"`,properties:[{type:"float",dimensions:4,name:"color",value:ft(a)},{type:"float",name:"width",value:mt(m)},{type:"string",name:"brush",value:'"circle"'},{type:"float",dimensions:2,name:"points",value:pt(s,r)},{type:"int",name:"debug",value:0},{type:"int",name:"join",value:3},{type:"int",name:"cap",value:1},{type:"int",name:"splat",value:0}]}}function so(i,o,t,e,n){var u;let a=bt(i.strokeStyle,(u=i.opacity)!=null?u:1),r=e/n,c=(i.x1+i.x2)/2,l=(i.y1+i.y2)/2,s=[{x:i.x1,y:i.y1},{x:i.x2,y:i.y2}];s=ut(s,i,c,l);let h=i.lineWidth/n,m=new Array(s.length).fill(h);return{name:`"pen:${o}:${t}:User"`,properties:[{type:"float",dimensions:4,name:"color",value:ft(a)},{type:"float",name:"width",value:mt(m)},{type:"string",name:"brush",value:'"circle"'},{type:"float",dimensions:2,name:"points",value:pt(s,r)},{type:"int",name:"debug",value:0},{type:"int",name:"join",value:3},{type:"int",name:"cap",value:1},{type:"int",name:"splat",value:0}]}}function lo(i,o,t,e,n){var C;let a=bt(i.strokeStyle,(C=i.opacity)!=null?C:1),r=ft(a),c=e/n,l=(i.x1+i.x2)/2,s=(i.y1+i.y2)/2,h=[{x:i.x1,y:i.y1},{x:i.x2,y:i.y2}],u=(10+2.5*i.lineWidth)/((e+n)/2),p=Math.PI/6,f=Math.atan2(i.y2-i.y1,i.x2-i.x1),v=[{x:i.x2,y:i.y2},{x:i.x2-u*Math.cos(f+p),y:i.y2-u*Math.sin(f+p)}],y=[{x:i.x2,y:i.y2},{x:i.x2-u*Math.cos(f-p),y:i.y2-u*Math.sin(f-p)}];h=ut(h,i,l,s),v=ut(v,i,l,s),y=ut(y,i,l,s);let g=i.lineWidth/n,x=new Array(2).fill(g);return[{name:`"pen:${o}:${t}:User"`,properties:[{type:"float",dimensions:4,name:"color",value:r},{type:"float",name:"width",value:mt(x)},{type:"string",name:"brush",value:'"circle"'},{type:"float",dimensions:2,name:"points",value:pt(h,c)},{type:"int",name:"debug",value:0},{type:"int",name:"join",value:3},{type:"int",name:"cap",value:1},{type:"int",name:"splat",value:0}]},{name:`"pen:${o+1}:${t}:User"`,properties:[{type:"float",dimensions:4,name:"color",value:r},{type:"float",name:"width",value:mt(x)},{type:"string",name:"brush",value:'"circle"'},{type:"float",dimensions:2,name:"points",value:pt(v,c)},{type:"int",name:"debug",value:0},{type:"int",name:"join",value:3},{type:"int",name:"cap",value:1},{type:"int",name:"splat",value:0}]},{name:`"pen:${o+2}:${t}:User"`,properties:[{type:"float",dimensions:4,name:"color",value:r},{type:"float",name:"width",value:mt(x)},{type:"string",name:"brush",value:'"circle"'},{type:"float",dimensions:2,name:"points",value:pt(y,c)},{type:"int",name:"debug",value:0},{type:"int",name:"join",value:3},{type:"int",name:"cap",value:1},{type:"int",name:"splat",value:0}]}]}function co(i,o,t,e,n){var u;let a=bt(i.strokeStyle,(u=i.opacity)!=null?u:1),r=e/n,c=i.x+i.width/2,l=i.y+i.height/2,s=[{x:i.x,y:i.y},{x:i.x+i.width,y:i.y},{x:i.x+i.width,y:i.y+i.height},{x:i.x,y:i.y+i.height},{x:i.x,y:i.y}];s=ut(s,i,c,l);let h=i.lineWidth/n,m=new Array(s.length).fill(h);return{name:`"pen:${o}:${t}:User"`,properties:[{type:"float",dimensions:4,name:"color",value:ft(a)},{type:"float",name:"width",value:mt(m)},{type:"string",name:"brush",value:'"circle"'},{type:"float",dimensions:2,name:"points",value:pt(s,r)},{type:"int",name:"debug",value:0},{type:"int",name:"join",value:3},{type:"int",name:"cap",value:1},{type:"int",name:"splat",value:0}]}}function ho(i,o,t,e,n,a=32){var p;let r=bt(i.strokeStyle,(p=i.opacity)!=null?p:1),c=e/n,l=i.x,s=i.y,h=[];for(let f=0;f<=a;f++){let v=f/a*Math.PI*2;h.push({x:i.x+Math.cos(v)*i.radius,y:i.y+Math.sin(v)*i.radius})}h=ut(h,i,l,s);let m=i.lineWidth/n,u=new Array(h.length).fill(m);return{name:`"pen:${o}:${t}:User"`,properties:[{type:"float",dimensions:4,name:"color",value:ft(r)},{type:"float",name:"width",value:mt(u)},{type:"string",name:"brush",value:'"circle"'},{type:"float",dimensions:2,name:"points",value:pt(h,c)},{type:"int",name:"debug",value:0},{type:"int",name:"join",value:3},{type:"int",name:"cap",value:1},{type:"int",name:"splat",value:0}]}}function uo(i,o,t,e,n){var p,f,v,y;let a=bt(i.fillStyle,(p=i.opacity)!=null?p:1),r=e/n,c=i.x,l=i.y,s=0;if(i.rotation){let g=(f=i.rotationCenterX)!=null?f:i.x,x=(v=i.rotationCenterY)!=null?v:i.y,C=yn({x:i.x,y:i.y},g,x,i.rotation);c=C.x,l=C.y,s=i.rotation*180/Math.PI}let h=xn(c,l,r),u=(16+((y=i.lineWidth)!=null?y:1)*.5)/n;return{name:`"text:${o}:${t}:User"`,properties:[{type:"float",dimensions:2,name:"position",value:ft([h.x,h.y])},{type:"float",dimensions:4,name:"color",value:ft(a)},{type:"float",name:"spacing",value:.8},{type:"float",name:"size",value:u},{type:"float",name:"scale",value:1},{type:"float",name:"rotation",value:s},{type:"string",name:"font",value:'""'},{type:"string",name:"text",value:`"${i.text.replace(/"/g,'\\"').replace(/\n/g,"\\n")}"`},{type:"string",name:"origin",value:'""'},{type:"int",name:"debug",value:0}]}}function mo(i,o,t,e,n){switch(i.type){case"curve":return[ro(i,o,t,e,n)];case"line":return[so(i,o,t,e,n)];case"arrow":return lo(i,o,t,e,n);case"rectangle":return[co(i,o,t,e,n)];case"circle":return[ho(i,o,t,e,n)];case"text":return[uo(i,o,t,e,n)];case"eraser":case"move":case"image":case"compare":case"audio-peaks":case"selection":return[];default:return[]}}function po(i){let o=[];o.push(`    ${i.name}`),o.push("    {");for(let t of i.properties){let e=t.dimensions?`${t.type}[${t.dimensions}]`:t.type,n=typeof t.value=="string"?t.value:String(t.value);o.push(`        ${e} ${t.name} = ${n}`)}return o.push("    }"),o.join(`
`)}function we(i,o){let{mediaPath:t,width:e,height:n,sessionName:a="sm-annotate-session"}=o,r=[];r.push("GTOa (4)"),r.push(""),r.push("# Generated by sm-annotate OpenRV exporter"),r.push(`# Media: ${t}`),r.push(`# Resolution: ${e}x${n}`),r.push(""),r.push("RVSession : RVSession (4)"),r.push("{"),r.push("    session"),r.push("    {"),r.push(`        string name = "${a}"`),r.push("        int version = 4"),r.push("    }"),r.push("}"),r.push(""),r.push("sourceGroup000000_source : RVFileSource (1)"),r.push("{"),r.push("    media"),r.push("    {"),r.push(`        string movie = "${t}"`),r.push("    }"),r.push("    request"),r.push("    {"),r.push(`        int width = ${e}`),r.push(`        int height = ${n}`),r.push("    }"),r.push("}"),r.push("");let c=[],l=0;for(let s of i)for(let h of s.shapes){let m=mo(h,l,s.frame,e,n);c.push(...m),l+=m.length}if(c.length>0){let s=new Map;for(let h of c){let m=h.name.match(/:\d+:(\d+):/);if(m){let u=parseInt(m[1]);s.has(u)||s.set(u,[]);let p=h.name.startsWith('"')&&h.name.endsWith('"')?h.name.slice(1,-1):h.name;s.get(u).push(p)}}r.push("sourceGroup000000_paint : RVPaint (3)"),r.push("{"),r.push("    paint"),r.push("    {"),r.push(`        int nextId = ${l}`),r.push("        int nextAnnotationId = 0"),r.push("        int show = 1"),r.push("        string exclude = [ ]"),r.push("        string include = [ ]"),r.push("    }");for(let h of c)r.push(po(h));for(let[h,m]of s)r.push(`    "frame:${h}"`),r.push("    {"),r.push(`        string order = [ ${m.map(u=>`"${u}"`).join(" ")} ]`),r.push("    }");r.push("}")}return r.join(`
`)}function ie(i,o,t="annotations.rv"){let e=we(i,o),n=new Blob([e],{type:"text/plain"}),a=URL.createObjectURL(n),r=document.createElement("a");r.href=a,r.download=t,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(a)}function ae(i){if(i.length<3)return"#000000";let o=Math.round(i[0]*255),t=Math.round(i[1]*255),e=Math.round(i[2]*255);return`#${o.toString(16).padStart(2,"0")}${t.toString(16).padStart(2,"0")}${e.toString(16).padStart(2,"0")}`}function fo(i,o){if(i=i.trim(),i.startsWith("[")&&i.endsWith("]")){let t=i.slice(1,-1).trim();if(t==="")return o==="string"?[]:[];if(o==="string"){let n=t.match(/"([^"\\]|\\.)*"/g);return n?n.map(a=>a.slice(1,-1).replace(/\\"/g,'"').replace(/\\n/g,`
`)):[]}if(t.includes("[")){let n=[],a=t.match(/-?\d+\.?\d*(?:e[+-]?\d+)?/gi);if(a)for(let r of a)n.push(Number(r));return n}return t.split(/\s+/).filter(n=>n.length>0&&!isNaN(Number(n))).map(Number)}return i.startsWith('"')&&i.endsWith('"')?i.slice(1,-1).replace(/\\"/g,'"').replace(/\\n/g,`
`):Number(i)}function go(i){var r;let o=[],t=i.split(`
`),e=null,n=null,a=0;for(let c=0;c<t.length;c++){let l=t[c].trim();if(l===""||l.startsWith("#")||l==="GTOa (4)")continue;let s=l.match(/^(\S+)\s*:\s*(\S+)\s*\((\d+)\)\s*$/);if(s&&a===0){e={name:s[1],protocol:s[2],version:parseInt(s[3]),components:new Map},o.push(e);continue}if(l==="{"){a++;continue}if(l==="}"){a--,a===1&&(n=null),a===0&&(e=null);continue}if(e&&a>=1){if(a===1){let m=l.match(/^"([^"]+)"(\s*\{)?$/);if(m){n=m[1],e.components.has(n)||e.components.set(n,new Map),m[2]&&a++;continue}let u=l.match(/^([^\s=\[]+)(\s*\{)?$/);if(u&&!l.includes("=")){n=u[1],e.components.has(n)||e.components.set(n,new Map),u[2]&&a++;continue}}let h=l.match(/^(\w+)(?:\[([^\]]*)\])?\s+(\w+)\s*=\s*(.+)$/);if(h&&n){let[,m,,u,p]=h,f=fo(p,m);(r=e.components.get(n))==null||r.set(u,f)}}}return o}function bn(i,o,t){return{x:(i+1)/2,y:(1-o*t)/2}}function vo(i,o,t,e,n,a){let r=i.get("points"),c=i.get("color"),l=i.get("width");if(!r||r.length<4)return null;let s=o/t,h=[];for(let f=0;f<r.length;f+=2){let v=bn(r[f],r[f+1],s);v=wn(v.x,v.y,n,a),h.push(v)}let m=c?ae(c):"#000000",u=c&&c.length>=4?c[3]:1,p=2;if(typeof l=="number")p=l*e;else if(Array.isArray(l)&&l.length>0){let f=l[0];typeof f=="number"&&(p=f*e)}return n!==void 0&&n!==1&&(p*=n),p=Math.max(1,Math.min(p,50)),{type:"curve",points:h,strokeStyle:m,fillStyle:m,lineWidth:p,opacity:u}}function yo(i,o,t,e,n,a){let r=i.get("position"),c=i.get("color"),l=i.get("text"),s=i.get("size");if(!r||r.length<2||!l)return null;let h=o/t,m=bn(r[0],r[1],h);m=wn(m.x,m.y,n,a);let u=c?ae(c):"#000000",p=c&&c.length>=4?c[3]:1,v=(s!=null?s:.01)*e;n!==void 0&&n!==1&&(v*=n);let y=Math.max(1,(v-16)/.5);return{type:"text",x:m.x,y:m.y,text:l,strokeStyle:u,fillStyle:u,lineWidth:y,opacity:p}}function wn(i,o,t,e){let n=i,a=o;return t!==void 0&&t!==1&&(n=.5+(i-.5)*t,a=.5+(o-.5)*t),e&&(n-=e.x,a-=e.y),{x:n,y:a}}function Pt(i,o={}){var v,y,g,x,C,P,O,R,D;let t={frames:[]},e=go(i),n=e.find(w=>w.protocol==="RVSession");if(n){let w=n.components.get("session");if(w){let T=w.get("name");typeof T=="string"&&(t.sessionName=T)}}let a=e.find(w=>w.protocol==="RVFileSource");if(a){let w=a.components.get("media");if(w){let E=w.get("movie");typeof E=="string"&&(t.mediaPath=E)}let T=a.components.get("proxy");if(T){let E=T.get("size");E&&E.length>=2&&(t.dimensions={width:E[0],height:E[1]})}if(!t.dimensions){let E=a.components.get("request");if(E){let S=E.get("width"),$=E.get("height");typeof S=="number"&&typeof $=="number"&&(t.dimensions={width:S,height:$})}}}if(!t.dimensions){let w=e.find(T=>T.protocol==="RVStack");if(w){let T=w.components.get("output");if(T){let E=T.get("size");E&&E.length>=2&&(t.dimensions={width:E[0],height:E[1]})}}}if(!t.dimensions){let w=e.find(T=>T.protocol==="RVSequence");if(w){let T=w.components.get("output");if(T){let E=T.get("size");E&&E.length>=2&&(t.dimensions={width:E[0],height:E[1]})}}}let r=(g=(y=(v=t.dimensions)==null?void 0:v.width)!=null?y:o.width)!=null?g:1920,c=(P=(C=(x=t.dimensions)==null?void 0:x.height)!=null?C:o.height)!=null?P:1080,l=(O=o.targetHeight)!=null?O:c,s=(R=o.fps)!=null?R:25,h=o.coordinateScale,m=o.coordinateOffset,u=(D=o.debug)!=null?D:!1;t.fps=s,u&&(console.log("[OpenRV Parser] Source dimensions:",r,"x",c),console.log("[OpenRV Parser] Target height:",l),console.log("[OpenRV Parser] Coordinate scale:",h),console.log("[OpenRV Parser] Coordinate offset:",m));let p=e.filter(w=>w.protocol==="RVPaint");if(p.length===0)return u&&console.log("[OpenRV Parser] No RVPaint objects found"),t;u&&console.log("[OpenRV Parser] Found",p.length,"RVPaint objects");let f=new Map;for(let w of p)for(let[T,E]of w.components){let S=T.match(/^pen:\d+:(\d+):/i);if(S){let W=parseInt(S[1]),q=vo(E,r,c,l,h,m);q&&(f.has(W)||f.set(W,[]),f.get(W).push(q));continue}let $=T.match(/^text:\d+:(\d+):/i);if($){let W=parseInt($[1]),q=yo(E,r,c,l,h,m);q&&(f.has(W)||f.set(W,[]),f.get(W).push(q))}}for(let[w,T]of f)t.frames.push({frame:w,fps:s,version:1,shapes:T});return t.frames.sort((w,T)=>w.frame-T.frame),t}var bo="0.12.9",jr=`https://unpkg.com/@ffmpeg/core@${bo}/dist/umd/ffmpeg-core.js`,A;(function(i){i.LOAD="LOAD",i.EXEC="EXEC",i.FFPROBE="FFPROBE",i.WRITE_FILE="WRITE_FILE",i.READ_FILE="READ_FILE",i.DELETE_FILE="DELETE_FILE",i.RENAME="RENAME",i.CREATE_DIR="CREATE_DIR",i.LIST_DIR="LIST_DIR",i.DELETE_DIR="DELETE_DIR",i.ERROR="ERROR",i.DOWNLOAD="DOWNLOAD",i.PROGRESS="PROGRESS",i.LOG="LOG",i.MOUNT="MOUNT",i.UNMOUNT="UNMOUNT"})(A||(A={}));var Tn=(()=>{let i=0;return()=>i++})();var qr=new Error("unknown message type"),Sn=new Error("ffmpeg is not loaded, call `await ffmpeg.load()` first"),Cn=new Error("called FFmpeg.terminate()"),Kr=new Error("failed to import ffmpeg-core.js");var En={};var _,it,tt,gt,vt,se,U,re=class{constructor(){ot(this,_,null);ot(this,it,{});ot(this,tt,{});ot(this,gt,[]);ot(this,vt,[]);Y(this,"loaded",!1);ot(this,se,()=>{I(this,_)&&(I(this,_).onmessage=({data:{id:o,type:t,data:e}})=>{switch(t){case A.LOAD:this.loaded=!0,I(this,it)[o](e);break;case A.MOUNT:case A.UNMOUNT:case A.EXEC:case A.FFPROBE:case A.WRITE_FILE:case A.READ_FILE:case A.DELETE_FILE:case A.RENAME:case A.CREATE_DIR:case A.LIST_DIR:case A.DELETE_DIR:I(this,it)[o](e);break;case A.LOG:I(this,gt).forEach(n=>n(e));break;case A.PROGRESS:I(this,vt).forEach(n=>n(e));break;case A.ERROR:I(this,tt)[o](e);break}delete I(this,it)[o],delete I(this,tt)[o]})});ot(this,U,({type:o,data:t},e=[],n)=>I(this,_)?new Promise((a,r)=>{let c=Tn();I(this,_)&&I(this,_).postMessage({id:c,type:o,data:t},e),I(this,it)[c]=a,I(this,tt)[c]=r,n==null||n.addEventListener("abort",()=>{r(new DOMException(`Message # ${c} was aborted`,"AbortError"))},{once:!0})}):Promise.reject(Sn));Y(this,"load",(n={},{signal:e}={})=>{var a=n,{classWorkerURL:o}=a,t=Fe(a,["classWorkerURL"]);return I(this,_)||(Et(this,_,o?new Worker(new URL(o,En.url),{type:"module"}):new Worker(new URL("./worker.js",En.url),{type:"module"})),I(this,se).call(this)),I(this,U).call(this,{type:A.LOAD,data:t},void 0,e)});Y(this,"exec",(o,t=-1,{signal:e}={})=>I(this,U).call(this,{type:A.EXEC,data:{args:o,timeout:t}},void 0,e));Y(this,"ffprobe",(o,t=-1,{signal:e}={})=>I(this,U).call(this,{type:A.FFPROBE,data:{args:o,timeout:t}},void 0,e));Y(this,"terminate",()=>{let o=Object.keys(I(this,tt));for(let t of o)I(this,tt)[t](Cn),delete I(this,tt)[t],delete I(this,it)[t];I(this,_)&&(I(this,_).terminate(),Et(this,_,null),this.loaded=!1)});Y(this,"writeFile",(o,t,{signal:e}={})=>{let n=[];return t instanceof Uint8Array&&n.push(t.buffer),I(this,U).call(this,{type:A.WRITE_FILE,data:{path:o,data:t}},n,e)});Y(this,"mount",(o,t,e)=>{let n=[];return I(this,U).call(this,{type:A.MOUNT,data:{fsType:o,options:t,mountPoint:e}},n)});Y(this,"unmount",o=>{let t=[];return I(this,U).call(this,{type:A.UNMOUNT,data:{mountPoint:o}},t)});Y(this,"readFile",(o,t="binary",{signal:e}={})=>I(this,U).call(this,{type:A.READ_FILE,data:{path:o,encoding:t}},void 0,e));Y(this,"deleteFile",(o,{signal:t}={})=>I(this,U).call(this,{type:A.DELETE_FILE,data:{path:o}},void 0,t));Y(this,"rename",(o,t,{signal:e}={})=>I(this,U).call(this,{type:A.RENAME,data:{oldPath:o,newPath:t}},void 0,e));Y(this,"createDir",(o,{signal:t}={})=>I(this,U).call(this,{type:A.CREATE_DIR,data:{path:o}},void 0,t));Y(this,"listDir",(o,{signal:t}={})=>I(this,U).call(this,{type:A.LIST_DIR,data:{path:o}},void 0,t));Y(this,"deleteDir",(o,{signal:t}={})=>I(this,U).call(this,{type:A.DELETE_DIR,data:{path:o}},void 0,t))}on(o,t){o==="log"?I(this,gt).push(t):o==="progress"&&I(this,vt).push(t)}off(o,t){o==="log"?Et(this,gt,I(this,gt).filter(e=>e!==t)):o==="progress"&&Et(this,vt,I(this,vt).filter(e=>e!==t))}};_=new WeakMap,it=new WeakMap,tt=new WeakMap,gt=new WeakMap,vt=new WeakMap,se=new WeakMap,U=new WeakMap;var Fn;(function(i){i.MEMFS="MEMFS",i.NODEFS="NODEFS",i.NODERAWFS="NODERAWFS",i.IDBFS="IDBFS",i.WORKERFS="WORKERFS",i.PROXYFS="PROXYFS"})(Fn||(Fn={}));var In=new Error("failed to get response body reader"),Mn=new Error("failed to complete download");var kn="Content-Length";var wo=i=>new Promise((o,t)=>{let e=new FileReader;e.onload=()=>{let{result:n}=e;n instanceof ArrayBuffer?o(new Uint8Array(n)):o(new Uint8Array)},e.onerror=n=>{var a,r;t(Error(`File could not be read! Code=${((r=(a=n==null?void 0:n.target)==null?void 0:a.error)==null?void 0:r.code)||-1}`))},e.readAsArrayBuffer(i)}),Rt=i=>M(void 0,null,function*(){let o;if(typeof i=="string")/data:_data\/([a-zA-Z]*);base64,([^"]*)/.test(i)?o=atob(i.split(",")[1]).split("").map(t=>t.charCodeAt(0)):o=yield(yield fetch(i)).arrayBuffer();else if(i instanceof URL)o=yield(yield fetch(i)).arrayBuffer();else if(i instanceof File||i instanceof Blob)o=yield wo(i);else return new Uint8Array;return new Uint8Array(o)});var To=(i,o)=>M(void 0,null,function*(){var n;let t=yield fetch(i),e;try{let a=parseInt(t.headers.get(kn)||"-1"),r=(n=t.body)==null?void 0:n.getReader();if(!r)throw In;let c=[],l=0;for(;;){let{done:m,value:u}=yield r.read(),p=u?u.length:0;if(m){if(a!=-1&&a!==l)throw Mn;o&&o({url:i,total:a,received:l,delta:p,done:m});break}c.push(u),l+=p,o&&o({url:i,total:a,received:l,delta:p,done:m})}let s=new Uint8Array(l),h=0;for(let m of c)s.set(m,h),h+=m.length;e=s.buffer}catch(a){console.log("failed to send download progress event: ",a),e=yield t.arrayBuffer(),o&&o({url:i,total:e.byteLength,received:e.byteLength,delta:0,done:!0})}return e}),Te=(i,o,t=!1,e)=>M(void 0,null,function*(){let n=t?yield To(i,e):yield(yield fetch(i)).arrayBuffer(),a=new Blob([n],{type:o});return URL.createObjectURL(a)});var Lt=class{constructor(){this.ffmpeg=null;this.loadPromise=null;this.frames=new Map;this.videoInfo=null;this.isDestroyed=!1;this.extractionAbortController=null}load(o){return M(this,null,function*(){if(!this.ffmpeg)return this.loadPromise?this.loadPromise:(this.loadPromise=this._load(o),this.loadPromise)})}_load(o){return M(this,null,function*(){let t=typeof SharedArrayBuffer!="undefined";console.log(`SharedArrayBuffer available: ${t}`),t||console.warn(`SharedArrayBuffer not available. FFmpeg may not work correctly.
To enable, add these headers to your server:
  Cross-Origin-Embedder-Policy: require-corp
  Cross-Origin-Opener-Policy: same-origin`),this.ffmpeg=new re,this.ffmpeg.on("log",({message:m})=>{console.log("FFmpeg:",m),this.parseFFmpegLog(m)}),this.ffmpeg.on("progress",({progress:m})=>{console.log("FFmpeg progress:",m),o==null||o({loaded:m,total:1,phase:"extracting"})}),o==null||o({loaded:0,total:1,phase:"loading"});let e="https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.12.6/dist/esm",n="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.15/dist/esm",r=yield(yield fetch(`${n}/worker.js`)).text();r=r.replace(/from\s*["']\.\/([^"']+)["']/g,`from "${n}/$1"`),r=r.replace(/import\s*["']\.\/([^"']+)["']/g,`import "${n}/$1"`);let c=new Blob([r],{type:"text/javascript"}),l=URL.createObjectURL(c);o==null||o({loaded:.25,total:1,phase:"loading"});let s=yield Te(`${e}/ffmpeg-core.js`,"text/javascript");o==null||o({loaded:.5,total:1,phase:"loading"});let h=yield Te(`${e}/ffmpeg-core.wasm`,"application/wasm");o==null||o({loaded:.75,total:1,phase:"loading"}),yield this.ffmpeg.load({coreURL:s,wasmURL:h,classWorkerURL:l}),o==null||o({loaded:1,total:1,phase:"loading"})})}isLoaded(){return this.ffmpeg!==null}parseFFmpegLog(o){let t=o.match(/(\d+(?:\.\d+)?)\s*fps/);if(t&&this.videoInfo){let a=parseFloat(t[1]);a>0&&a<1e3&&(this.videoInfo.fps=a)}if(this.videoInfo&&this.videoInfo.fps===25){let a=o.match(/(\d+(?:\.\d+)?)\s*tbr/);if(a){let r=parseFloat(a[1]);r>0&&r<1e3&&(this.videoInfo.fps=r)}}let e=o.match(/Duration:\s*(\d{2}):(\d{2}):(\d{2})\.(\d+)/);if(e&&this.videoInfo){let a=parseInt(e[1],10),r=parseInt(e[2],10),c=parseInt(e[3],10),l=parseInt(e[4],10);this.videoInfo.duration=a*3600+r*60+c+l/100}let n=o.match(/(\d{2,5})x(\d{2,5})/);if(n&&this.videoInfo){let a=parseInt(n[1],10),r=parseInt(n[2],10);a>0&&r>0&&(this.videoInfo.width=a,this.videoInfo.height=r)}}probe(o){return M(this,null,function*(){if(yield this.load(),!this.ffmpeg)throw new Error("FFmpeg not loaded");this.videoInfo={fps:25,duration:0,width:0,height:0,totalFrames:0};let t="mp4";typeof o!="string"&&o.type&&(t={"video/mp4":"mp4","video/webm":"webm","video/quicktime":"mov","video/x-msvideo":"avi","video/x-matroska":"mkv","video/ogg":"ogv"}[o.type]||"mp4");let e=`input_probe.${t}`,n=typeof o=="string"?yield Rt(o):yield Rt(o);yield this.ffmpeg.writeFile(e,n);try{yield this.ffmpeg.exec(["-i",e])}catch(a){}try{yield this.ffmpeg.deleteFile(e)}catch(a){}return this.videoInfo.duration>0&&this.videoInfo.fps>0&&(this.videoInfo.totalFrames=Math.round(this.videoInfo.duration*this.videoInfo.fps)),console.log("Probed video info:",this.videoInfo),this.videoInfo})}extractFrames(e){return M(this,arguments,function*(o,t={}){var g,x,C,P,O,R,D,w,T,E;if(yield this.load(t.onProgress),!this.ffmpeg)throw new Error("FFmpeg not loaded");if(this.isDestroyed)throw new Error("Extractor has been destroyed");this.extractionAbortController=new AbortController,this.clearFrames(),this.videoInfo||(yield this.probe(o));let n=(C=(x=t.fps)!=null?x:(g=this.videoInfo)==null?void 0:g.fps)!=null?C:25,a=(P=t.format)!=null?P:"png",r=(D=(R=t.endFrame)!=null?R:(O=this.videoInfo)==null?void 0:O.totalFrames)!=null?D:0,c=(w=t.startFrame)!=null?w:1,l="mp4";typeof o!="string"&&o.type&&(l={"video/mp4":"mp4","video/webm":"webm","video/quicktime":"mov","video/x-msvideo":"avi","video/x-matroska":"mkv","video/ogg":"ogv"}[o.type]||"mp4");let s=`input.${l}`;(T=t.onProgress)==null||T.call(t,{loaded:0,total:r,phase:"extracting"});let h=typeof o=="string"?yield Rt(o):yield Rt(o),m=h.byteLength/(1024*1024);if(console.log(`Video file size: ${m.toFixed(2)} MB`),m>100)throw new Error(`Video file too large (${m.toFixed(0)}MB). FFmpeg WASM has memory limits. Please use a smaller video file (<100MB).`);yield this.ffmpeg.writeFile(s,h);try{let S=yield this.ffmpeg.readFile(s),$=S instanceof Uint8Array?S.byteLength:S.length;console.log(`Input file written: ${$} bytes`)}catch(S){console.error("Failed to verify input file:",S)}let u=(S,$=3e4)=>M(this,null,function*(){console.log("FFmpeg command:",S.join(" "));let W=new Promise((q,at)=>{setTimeout(()=>at(new Error(`FFmpeg timeout after ${$}ms`)),$)});yield Promise.race([this.ffmpeg.exec(S),W])});console.log("Testing FFmpeg with single frame extraction (this may take a while for h264)...");let p=a==="png"?"png":"jpg";try{let S=["-y","-nostdin","-i",s,"-frames:v","1"];p==="jpg"&&S.push("-q:v","8"),S.push(`test_frame.${p}`),yield u(S,6e4);let $=yield this.ffmpeg.readFile(`test_frame.${p}`),W=$ instanceof Uint8Array?$.byteLength:$.length;console.log(`Test frame extracted: ${W} bytes`),yield this.ffmpeg.deleteFile(`test_frame.${p}`)}catch(S){console.error("Single frame test failed:",S);try{yield this.ffmpeg.deleteFile(s)}catch($){}throw new Error(`FFmpeg cannot process this video (h264 decoding may be too slow in WASM). Error: ${S}`)}let f=Math.max(3e5,r*2e3);console.log(`Extracting ${r} frames as ${a.toUpperCase()} at fps=${n} (estimated timeout: ${(f/1e3).toFixed(0)}s)...`);let v=["-y","-nostdin","-i",s,"-vf",`fps=${n}`];a==="jpg"&&v.push("-q:v","8"),v.push(`frame_%06d.${a}`);try{yield u(v,f)}catch(S){console.error("Frame extraction failed:",S);try{yield this.ffmpeg.deleteFile(s)}catch($){}throw new Error(`Failed to extract frames: ${S}`)}let y=1;for(;!this.isDestroyed;){let S=`frame_${String(y).padStart(6,"0")}.${a}`;try{let $=yield this.ffmpeg.readFile(S);if($ instanceof Uint8Array){let W=new Blob([$],{type:a==="png"?"image/png":"image/jpeg"}),q=yield createImageBitmap(W);this.frames.set(y,q),yield this.ffmpeg.deleteFile(S),(E=t.onProgress)==null||E.call(t,{loaded:y,total:r||y,phase:"processing"})}y++}catch($){break}}console.log(`Extraction complete: ${this.frames.size} frames`);try{yield this.ffmpeg.deleteFile(s)}catch(S){}return this.extractionAbortController=null,this.frames})}extractFramesInChunks(a,r,c){return M(this,arguments,function*(o,t,e,n={}){var m;let l=yield this.probe(o),s=l.totalFrames,h=(m=n.fps)!=null?m:l.fps;for(let u=1;u<=s&&!this.isDestroyed;u+=t){let p=Math.min(u+t-1,s);this.clearFrames(),yield this.extractFrames(o,{fps:h,startFrame:u,endFrame:p,onProgress:n.onProgress}),e(this.frames,u,p)}})}getFrame(o){var t;return(t=this.frames.get(o))!=null?t:null}hasFrame(o){return this.frames.has(o)}getAllFrames(){return this.frames}getVideoInfo(){return this.videoInfo}get frameCount(){return this.frames.size}clearFrames(){this.frames.forEach(o=>o.close()),this.frames.clear()}abort(){var o;(o=this.extractionAbortController)==null||o.abort()}destroy(){var o;this.isDestroyed=!0,this.abort(),this.clearFrames(),(o=this.ffmpeg)==null||o.terminate(),this.ffmpeg=null,this.loadPromise=null,this.videoInfo=null}};Q.prototype.initUI=tn;Q.prototype.initCanvas=en;Q.prototype.addFrameSquareOverlay=fn;Q.prototype.addVideoOverlay=gn;Q.prototype.addProgressBarOverlay=vn;new EventSource("/esbuild").addEventListener("change",()=>location.reload());var z=null,wt=null,G=document.querySelector("video");function Pn(){return M(this,null,function*(){let i=yield fetch(G.currentSrc).then(b=>b.blob()),o=new Promise(b=>{setTimeout(()=>{b(!0)},250),G.addEventListener("loadeddata",()=>{b(!0)},{once:!0})}),t=yield fetch("./frame_29.png").then(b=>M(this,null,function*(){let F=yield b.blob(),L=new Blob([F],{type:"image/png"}),V=new Image,X=new Promise(N=>{V.addEventListener("load",()=>{N(!0)},{once:!0})});return V.src=window.URL.createObjectURL(L),yield X,V}));G.paused||G.pause();let e=new Blob([i],{type:"video/mp4"}),n=new Q(G,{toolbar:{defaultTool:null}});yield n.setVideoBlob(e,30),yield o,yield n.addReferenceVideoByURL("./mov_bbb_g.mp4"),requestAnimationFrame(()=>{n.setCanvasSize()}),n.enableVideoFrameBuffer(),console.log({tool:n}),n.addShapesToFrame(29,[{type:"image",image:t,x:0,y:0,width:1,height:1,strokeStyle:"red",lineWidth:2,fillStyle:"red"}]),G.paused||G.pause(),setInterval(()=>{n.destroy(),n.init(G)},1e8),setInterval(()=>{console.log(n.saveAllFrames())},1e5);let a=document.getElementById("file"),r=document.getElementById("download"),c=document.getElementById("sample"),l=document.getElementById("video"),s=document.getElementById("ref-video");l.addEventListener("change",b=>M(this,null,function*(){if(!l.files||l.files.length===0)return;let F=l.files[0],L=new Blob([F],{type:F.type});wt=L;let V=document.getElementById("ffmpeg-extract"),X=document.getElementById("ffmpeg-info"),N=document.getElementById("ffmpeg-fps"),le=document.getElementById("ffmpeg-frames"),et=document.getElementById("ffmpeg-status");V.innerHTML=`
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="2" y="2" width="20" height="20" rx="2"/>
        <circle cx="12" cy="12" r="3"/>
      </svg>
      Extract Frames
    `,z!=null&&z.isLoaded()&&z.clearFrames(),n.setFFmpegFrameExtractor(null);let At=0,Se=!1;if(z!=null&&z.isLoaded())try{et.className="ffmpeg-status loading",et.querySelector(".status-text").textContent="Probing video...";let J=yield z.probe(L);At=J.fps,Se=J.fps>0,X.style.display="flex",N.textContent=`FPS: ${J.fps.toFixed(2)}`,le.textContent=`Frames: ${J.totalFrames}`,et.className="ffmpeg-status ready",et.querySelector(".status-text").textContent="FFmpeg ready",console.log("Detected video info:",J)}catch(J){console.error("Failed to probe video:",J),et.className="ffmpeg-status error",et.querySelector(".status-text").textContent="Probe failed"}let Dt;if(Se)Dt=At,console.log("Using detected FPS:",Dt);else{let J=prompt("Enter FPS","30");if(!J)return;Dt=parseInt(J,10)}yield n.setVideoBlob(L,Dt),z!=null&&z.isLoaded()&&Ct()})),s.addEventListener("change",b=>M(this,null,function*(){if(!s.files||s.files.length===0)return;let F=prompt("Enter FPS","30");if(!F)return;let L=s.files[0],V=new Blob([L],{type:L.type}),X=window.URL.createObjectURL(V);yield n.addReferenceVideoByURL(X,parseInt(F,10),L.type)})),c.addEventListener("click",b=>{b.stopPropagation(),b.preventDefault(),fetch("./annotations-sample.json").then(F=>F.json()).then(F=>{n.loadAllFrames(F),n.updateActiveTimeFrame(),n.redrawFullCanvas()})}),a.addEventListener("change",b=>{if(!a.files||a.files.length===0)return;let F=a.files[0],L=new FileReader;L.onload=V=>{if(!V.target)return;let X=V.target.result,N=JSON.parse(X);confirm("Append to existing annotations?")?n.appendFrames(N):n.loadAllFrames(N),n.updateActiveTimeFrame(),n.redrawFullCanvas()},L.readAsText(F)}),r.addEventListener("click",b=>{b.stopPropagation(),b.preventDefault();let F=n.saveAllFrames(),L=document.createElement("a");L.href=URL.createObjectURL(new Blob([JSON.stringify(F)],{type:"application/json"}));let V=new Date().toISOString().replace(/:/g,"-");L.download=`annotations-${V}.json`,L.click()});let h=document.getElementById("rv-file"),m=document.getElementById("download-rv"),u=document.getElementById("rv-scale"),p=document.getElementById("rv-scale-value"),f=document.getElementById("rv-offset-x"),v=document.getElementById("rv-offset-x-value"),y=document.getElementById("rv-offset-y"),g=document.getElementById("rv-offset-y-value"),x=document.getElementById("rv-reset-transform"),C=null;function P(){if(!C)return;let b=parseFloat(u.value),F=parseFloat(f.value),L=parseFloat(y.value),V=Pt(C,{fps:n.fps,targetHeight:n.canvasHeight,coordinateScale:b,coordinateOffset:{x:-F,y:-L}});n.loadAllFrames(V.frames),n.updateActiveTimeFrame(),n.redrawFullCanvas()}u.addEventListener("input",()=>{p.textContent=u.value,P()}),f.addEventListener("input",()=>{v.textContent=f.value,P()}),y.addEventListener("input",()=>{g.textContent=y.value,P()}),x.addEventListener("click",()=>{u.value="0.85",p.textContent="0.85",f.value="0",v.textContent="0",y.value="0",g.textContent="0",P()}),h.addEventListener("change",b=>M(this,null,function*(){if(!h.files||h.files.length===0)return;let F=h.files[0];try{C=yield F.text();let L=parseFloat(u.value),V=parseFloat(f.value),X=parseFloat(y.value),N=Pt(C,{fps:n.fps,targetHeight:n.canvasHeight,coordinateScale:L,coordinateOffset:{x:-V,y:-X},debug:!0});console.log("RV file dimensions:",N.dimensions),console.log("Demo video dimensions:",G.videoWidth,"x",G.videoHeight),console.log("Canvas dimensions:",n.canvasWidth,"x",n.canvasHeight),confirm("Append to existing annotations?")?n.appendFrames(N.frames):n.loadAllFrames(N.frames),n.updateActiveTimeFrame(),n.redrawFullCanvas();let et=N.frames.map(At=>At.frame);console.log(`Loaded ${N.frames.length} annotated frames:`,et),N.frames.length>0&&console.log("First frame shapes:",N.frames[0].shapes),N.mediaPath&&console.log("OpenRV media path:",N.mediaPath)}catch(L){console.error("Failed to parse OpenRV file:",L),alert("Failed to parse OpenRV file. Check console for details.")}})),m.addEventListener("click",b=>{b.stopPropagation(),b.preventDefault();let F=n.saveAllFrames();if(F.length===0){alert("No annotations to export.");return}let L=new Date().toISOString().replace(/:/g,"-");ie(F,{mediaPath:G.currentSrc||"video.mp4",width:n.canvasWidth||1920,height:n.canvasHeight||1080,sessionName:`sm-annotate-${L}`},`annotations-${L}.rv`)});let O=document.querySelectorAll(".layout-btn"),R=document.getElementById("layout-label"),D={horizontal:"Horizontal (default)",vertical:"Vertical Sidebar",minimal:"Minimal / Floating","bottom-dock":"Bottom Dock"};O.forEach(b=>{b.addEventListener("click",F=>{let L=F.currentTarget,V=L.dataset.layout;O.forEach(X=>X.classList.remove("active")),L.classList.add("active"),R&&(R.textContent=D[V]),n.setLayout(V),requestAnimationFrame(()=>{n.setCanvasSize()})})});let w=document.getElementById("ffmpeg-load"),T=document.getElementById("ffmpeg-extract"),E=document.getElementById("ffmpeg-status"),S=document.getElementById("ffmpeg-progress"),$=document.getElementById("ffmpeg-progress-fill"),W=document.getElementById("ffmpeg-progress-text"),q=document.getElementById("ffmpeg-info"),at=document.getElementById("ffmpeg-fps"),Tt=document.getElementById("ffmpeg-frames");function K(b,F){E.className=`ffmpeg-status ${b}`,E.querySelector(".status-text").textContent=F}function rt(b){S.style.display="flex",$.style.width=`${b}%`,W.textContent=`${Math.round(b)}%`}function st(){S.style.display="none"}wt=e;function St(){return M(this,null,function*(){if(!(z!=null&&z.isLoaded())){w.disabled=!0,K("loading","Loading FFmpeg..."),rt(0);try{if(z=new Lt,yield z.load(b=>{b.phase==="loading"&&rt(b.loaded*100)}),K("ready","FFmpeg ready"),st(),T.disabled=!1,w.innerHTML=`
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
          <polyline points="7 10 12 15 17 10"/>
          <line x1="12" y1="15" x2="12" y2="3"/>
        </svg>
        FFmpeg Loaded
      `,wt){let b=yield z.probe(wt);q.style.display="flex",at.textContent=`FPS: ${b.fps.toFixed(2)}`,Tt.textContent=`Frames: ${b.totalFrames}`,console.log("Video info from FFmpeg:",b)}}catch(b){console.error("Failed to load FFmpeg:",b),K("error","Failed to load"),st(),w.disabled=!1}}})}St(),w.addEventListener("click",St);function Ct(){return M(this,null,function*(){if(!(z!=null&&z.isLoaded())||!wt){console.warn("Cannot extract frames: FFmpeg not loaded or no video.");return}T.disabled=!0,K("extracting","Extracting frames..."),rt(0);try{let b=performance.now(),F=yield z.extractFrames(wt,{format:"png",onProgress:X=>{let N=X.total>0?X.loaded/X.total*100:0;rt(N),K("extracting",`Extracting frame ${X.loaded}...`)}}),L=((performance.now()-b)/1e3).toFixed(2);console.log(`Extracted ${F.size} frames in ${L}s`),K("ready",`${F.size} frames extracted`),st(),T.disabled=!1,T.innerHTML=`
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="2" y="2" width="20" height="20" rx="2"/>
          <circle cx="12" cy="12" r="3"/>
        </svg>
        Re-extract (${F.size} frames)
      `;let V=z.getVideoInfo();V&&(at.textContent=`FPS: ${V.fps.toFixed(2)}`,Tt.textContent=`Frames: ${F.size}`),n.setFFmpegFrameExtractor(z),console.log("FFmpeg frames connected to annotation tool"),console.log("FFmpeg extracted frames:",F),console.log("Frame 1:",F.get(1))}catch(b){console.error("Failed to extract frames:",b),K("error","Extraction failed"),st(),T.disabled=!1}})}T.addEventListener("click",Ct);let yt;window.addEventListener("resize",()=>{yt&&clearTimeout(yt),yt=window.setTimeout(()=>{n.setCanvasSize()},100)})})}G.readyState===0?G.addEventListener("loadedmetadata",()=>{requestAnimationFrame(()=>{Pn()})},{once:!0}):Pn();})();
