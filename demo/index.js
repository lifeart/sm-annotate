"use strict";(()=>{var de=Object.create;var rt=Object.defineProperty,me=Object.defineProperties,ue=Object.getOwnPropertyDescriptor,pe=Object.getOwnPropertyDescriptors,ve=Object.getOwnPropertyNames,Tt=Object.getOwnPropertySymbols,fe=Object.getPrototypeOf,Ct=Object.prototype.hasOwnProperty,ge=Object.prototype.propertyIsEnumerable;var A=Math.pow,St=(o,i,t)=>i in o?rt(o,i,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[i]=t,y=(o,i)=>{for(var t in i||(i={}))Ct.call(i,t)&&St(o,t,i[t]);if(Tt)for(var t of Tt(i))ge.call(i,t)&&St(o,t,i[t]);return o},w=(o,i)=>me(o,pe(i));var ye=(o,i)=>()=>(i||o((i={exports:{}}).exports,i),i.exports);var xe=(o,i,t,e)=>{if(i&&typeof i=="object"||typeof i=="function")for(let n of ve(i))!Ct.call(o,n)&&n!==t&&rt(o,n,{get:()=>i[n],enumerable:!(e=ue(i,n))||e.enumerable});return o};var be=(o,i,t)=>(t=o!=null?de(fe(o)):{},xe(i||!o||!o.__esModule?rt(t,"default",{value:o,enumerable:!0}):t,o));var T=(o,i,t)=>new Promise((e,n)=>{var a=r=>{try{h(t.next(r))}catch(l){n(l)}},s=r=>{try{h(t.throw(r))}catch(l){n(l)}},h=r=>r.done?e(r.value):Promise.resolve(r.value).then(a,s);h((t=t.apply(o,i)).next())});var Qt=ye((yi,Zt)=>{"use strict";function Ce(o){for(var i=1/0,t=-1/0,e=0,n=o.length,a;e<n;e++)a=o[e],i>a&&(i=a),t<a&&(t=a);return{min:i,max:t}}function $t(o,i){var t=Math.pow(2,i-1),e=o<0?o*t:o*(t-1);return Math.max(-t,Math.min(t-1,e))}function Gt(o,i,t){var e,n=o.length,a=Math.ceil(n/i),s,h,r,l,c,d,m=Jt(t,a*2);for(e=0;e<a;e++)s=e*i,h=(e+1)*i>n?n:(e+1)*i,r=o.subarray(s,h),d=Ce(r),c=$t(d.min,t),l=$t(d.max,t),m[e*2]=c,m[e*2+1]=l;return m}function Jt(o,i){return new(new Function(`return Int${o}Array`)())(i)}function Ee(o,i){var t=o.length,e=1/t,n=o[0].length/2,a=0,s=0,h,r,l=Jt(i,n*2);for(s=0;s<n;s++){for(h=0,r=0,a=0;a<t;a++)h+=e*o[a][s*2],r+=e*o[a][s*2+1];l[s*2]=h,l[s*2+1]=r}return[l]}function it(o,i){return typeof o=="number"?o:i}Zt.exports=function(o,i,t,e,n,a){if(i=it(i,1e3),a=it(a,16),t==null&&(t=!0),[8,16,32].indexOf(a)<0)throw new Error("Invalid number of bits specified for peaks.");var s=o.numberOfChannels,h=[],r,l,c,d;if(e=it(e,0),n=it(n,o.length),typeof o.subarray=="undefined")for(r=0;r<s;r++)c=o.getChannelData(r),d=c.subarray(e,n),h.push(Gt(d,i,a));else h.push(Gt(o.subarray(e,n),i,a));return t&&h.length>1&&(h=Ee(h,a)),l=h[0].length/2,{length:l,data:h,bits:a}}});function Et(o,i){let t=document.createElement("button");t.type="button",t.style.margin="5px",t.style.float="right",t.title="Download current frame",t.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-image"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"></rect><circle cx="9" cy="9" r="2"></circle><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"></path></svg>',i.addEvent(t,"click",()=>{let e=i.frameToDataUrl();if(!e)return;let n=document.createElement("a");n.download=`frame_${String(i.activeTimeFrame).padStart(3,"0")}.png`,n.href=e,n.click()}),i.buttons.push(t),i.playerControlsContainer.appendChild(t)}var It='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-volume-x"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><line x1="22" x2="16" y1="9" y2="15"></line><line x1="16" x2="22" y1="9" y2="15"></line></svg>',kt='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-volume-2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path><path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path></svg>';function Ft(o,i){let t=document.createElement("button");t.type="button",t.style.margin="5px",o.muted||o.volume===0?t.innerHTML=It:t.innerHTML=kt,i.addEvent(o,"volumechange",()=>{o.muted||o.volume===0?t.innerHTML=It:t.innerHTML=kt}),i.addEvent(t,"click",()=>{if(o.muted){o.muted=!1;return}o.volume===0?o.volume=1:o.volume=0}),i.buttons.push(t),i.playerControlsContainer.appendChild(t)}var R=[{value:0,label:"off"},{value:.25,label:"25%"},{value:.5,label:"50%"},{value:.7,label:"70%"},{value:1,label:"100%"}];function Pt(o,i=!1){let t=i?'<circle cx="18" cy="6" r="4" fill="currentColor" opacity="0.7"/>':"";return`<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <style>
      .label {
        font-family: sans-serif;
        font-size: 9px;
      }
    </style>
    <rect x="3" y="3" width="18" height="18" rx="2" opacity="${o.value===0?.3:o.value}"/>
    <text x="12" y="14" text-anchor="middle" class="label" fill="currentColor">${o.label}</text>
    ${t}
  </svg>`}function lt(o){let i=R.findIndex(t=>t.value===o);return i===-1?4:i}function Mt(o){let i=document.createElement("button");i.type="button",i.title="Opacity (overlay / selected shape)";let t=lt(o.overlayOpacity),e=()=>{var h;let a=o.currentTool==="move"?o.pluginForTool("move"):null,s=a==null?void 0:a.getSelectedShape();if(s){let r=(h=s.opacity)!=null?h:1,l=lt(r);i.innerHTML=Pt(R[l],!0),i.title="Shape opacity"}else i.innerHTML=Pt(R[t],!1),i.title="Overlay opacity"};e(),i.style.margin="5px",o.addEvent(i,"click",()=>{var h;let a=o.currentTool==="move"?o.pluginForTool("move"):null,s=a==null?void 0:a.getSelectedShape();if(s&&a){let r=(h=s.opacity)!=null?h:1,l=lt(r);l=(l+1)%R.length;let c=R[l].value;a.setSelectedShapeOpacity(c)}else t=(t+1)%R.length,o.overlayOpacity=R[t].value,o.redrawFullCanvas();e()});let n=o.redrawFullCanvas.bind(o);return o.redrawFullCanvas=()=>{n(),e()},o.buttons.push(i),o.uiContainer.appendChild(i),i}var Dt='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>',we='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pause"><rect width="4" height="16" x="6" y="4"></rect><rect width="4" height="16" x="14" y="4"></rect></svg>';function Bt(o,i){let t=document.createElement("button");t.type="button",t.innerHTML=Dt,t.style.margin="5px",i.addEvent(o,"play",()=>{t.innerHTML=we}),i.addEvent(o,"pause",()=>{t.innerHTML=Dt}),i.addEvent(t,"click",()=>{i.withRefVideo(e=>{e.paused&&e.play().then(()=>{i.showButton("compare")})}),o.paused?o.play().then(()=>{i.redrawFullCanvas()}):(o.pause(),i.raf(()=>{i.redrawFullCanvas()}))}),i.buttons.push(t),i.playerControlsContainer.appendChild(t)}function At(o){return`<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-superscript">
        <style>
            .small {
                font-family: auto;
                font-size: ${o===1?"16":"24"}px;
            }
        </style>
        <text x="${o===1?3:2}" y="${o===1?17:20}" font-weight="normal" class="small">${{"0.25":"\xBC","0.5":"\xBD","0.75":"\xBE",1:"1\xD7"}[String(o)]}</text>
        
    </svg>`}function Lt(o,i){let t=[.25,.5,.75,1],e=document.createElement("button"),n=t[t.length-1];e.type="button",o.playbackRate=n,e.innerHTML=At(n),e.style.margin="5px",i.addEvent(e,"click",()=>{let a=t.indexOf(o.playbackRate),s=a+1>=t.length?0:a+1;o.playbackRate=t[s],e.innerHTML=At(t[s])}),i.buttons.push(e),i.playerControlsContainer.appendChild(e)}var Te=500;function Ht(o,i,t){let e=null,n=!1,a=()=>{n=!1,e=setTimeout(()=>{n=!0,t(),i.redrawFullCanvas()},Te)},s=()=>{e&&(clearTimeout(e),e=null)},h=()=>{e&&(clearTimeout(e),e=null)},r=l=>{n&&(l.preventDefault(),l.stopImmediatePropagation(),n=!1)};i.addEvent(o,"click",r),o.addEventListener("pointerdown",a),o.addEventListener("pointerup",s),o.addEventListener("pointerleave",h),i.destructors.push(()=>{o.removeEventListener("pointerdown",a),o.removeEventListener("pointerup",s),o.removeEventListener("pointerleave",h),e&&clearTimeout(e)})}var U=class{constructor(i,t){this.create=(i,t,e=this.uiContainer)=>{let n=document.createElement("button");if(n.type="button",n.innerHTML=i,n.style.margin="5px",e.appendChild(n),this.buttons.push(n),typeof t=="function")this.addEvent(n,"click",t);else{n.dataset.tool=t;let a=()=>{this.currentTool===t?this.currentTool=null:this.currentTool=t};try{this.tool.pluginForTool(t),this.addEvent(n,"click",a)}catch(s){console.error(s),n.disabled=!0}}return n};this.tool=i,this.uiContainer=t}get buttons(){return this.tool.buttons}get addEvent(){return this.tool.addEvent.bind(this.tool)}get currentTool(){return this.tool.currentTool}set currentTool(i){this.tool.currentTool=i}};function Rt(o,i){let t=o.videoElement.tagName==="VIDEO"?o.videoElement:null;if(i.create('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></svg>',"rectangle"),i.create('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle></svg>',"circle"),i.create('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.3 8.7 8.7 21.3c-1 1-2.5 1-3.4 0l-2.6-2.6c-1-1-1-2.5 0-3.4L15.3 2.7c1-1 2.5-1 3.4 0l2.6 2.6c1 1 1 2.5 0 3.4Z"></path><path d="m7.5 10.5 2 2"></path><path d="m10.5 7.5 2 2"></path><path d="m13.5 4.5 2 2"></path><path d="m4.5 13.5 2 2"></path></svg>',"line"),i.create('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9.06 11.9 8.07-8.06a2.85 2.85 0 1 1 4.03 4.03l-8.06 8.08"></path><path d="M7.07 14.94c-1.66 0-3 1.35-3 3.02 0 1.33-2.5 1.52-2 2.02 1.08 1.1 2.49 2.02 4 2.02 2.2 0 4-1.8 4-4.04a3.01 3.01 0 0 0-3-3.02z"></path></svg>',"curve"),i.create('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>',"arrow"),i.create('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="4 7 4 4 20 4 20 7"></polyline><line x1="9" y1="20" x2="15" y2="20"></line><line x1="12" y1="4" x2="12" y2="20"></line></svg>',"text"),i.create('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m7 21-4.3-4.3c-1-1-1-2.5 0-3.4l9.6-9.6c1-1 2.5-1 3.4 0l5.6 5.6c1 1 1 2.5 0 3.4L13 21"></path><path d="M22 21H7"></path><path d="m5 11 9 9"></path></svg>',"eraser"),i.create('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="5 9 2 12 5 15"></polyline><polyline points="9 5 12 2 15 5"></polyline><polyline points="15 19 12 22 9 19"></polyline><polyline points="19 9 22 12 19 15"></polyline><line x1="2" y1="12" x2="22" y2="12"></line><line x1="12" y1="2" x2="12" y2="22"></line></svg>',"move"),i.create('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-flip-horizontal"><path d="M8 3H5a2 2 0 0 0-2 2v14c0 1.1.9 2 2 2h3"></path><path d="M16 3h3a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-3"></path><path d="M12 20v2"></path><path d="M12 14v2"></path><path d="M12 8v2"></path><path d="M12 2v2"></path></svg>',"compare"),Mt(o),i.create('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7v6h6"></path><path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"></path></svg>',()=>{o.handleUndo()}),t){let e=i.create('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="19 20 9 12 19 4 19 20"></polygon><line x1="5" y1="19" x2="5" y2="5"></line></svg>',()=>{o.prevFrame()},o.playerControlsContainer);Ht(e,o,()=>o.prevAnnotatedFrame()),Bt(t,o);let n=i.create('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 4 15 12 5 20 5 4"></polygon><line x1="19" y1="5" x2="19" y2="19"></line></svg>',()=>{o.nextFrame()},o.playerControlsContainer);Ht(n,o,()=>o.nextAnnotatedFrame()),Ft(t,o),Lt(t,o),Et(t,o)}i.create(`<svg viewBox="0 0 24 24" width="24" height="24">
      <path fill="currentColor" d="M3 3h18v18H3V3m2 2v14h14V5H5z"/>
      <path fill="currentColor" d="M7 7h10v10H7V7m2 2v6h6V9H9z"/>
    </svg>`,"selection")}var D=(o,i)=>{let t=o.target===document.body,e=i.uiContainer.contains(o.target),n=i.playerControlsContainer.contains(o.target),a=i.videoElement.contains(o.target),s=i.canvas.contains(o.target);return e||n||a||s||t};function Y(o){return o.pointerType==="pen"?!1:o.pointerType==="touch"&&o.isPrimary===!1}function Vt(o,i){if(!D(o,i))return;let t=i.uiContainer.contains(o.target),e=i.playerControlsContainer.contains(o.target);if(t||e)return;let n=i.videoElement;n.tagName==="VIDEO"&&(n.paused||(i.currentTool=null,n.pause(),i.raf(()=>T(this,null,function*(){i.redrawFullCanvas()}))))}function Ot(o,i){var t;D(o,i)&&(o.preventDefault(),o.stopPropagation(),o.stopImmediatePropagation(),(t=o.clipboardData)==null||t.setData("application/json",JSON.stringify(i.saveCurrentFrame())))}function zt(o,i){var e;if(!D(o,i))return;o.preventDefault(),o.stopPropagation(),o.stopImmediatePropagation();let t=i.saveCurrentFrame();i.replaceFrame(i.playbackFrame,[]),i.redrawFullCanvas(),(e=o.clipboardData)==null||e.setData("application/json",JSON.stringify(t))}function Wt(o,i){if(!D(o,i))return;let t=i.videoElement;t.tagName==="VIDEO"&&(o.key==="ArrowLeft"||o.key==="ArrowRight"?(o.preventDefault(),o.stopPropagation(),o.stopImmediatePropagation(),o.key==="ArrowLeft"?i.prevFrame():o.key==="ArrowRight"&&i.nextFrame()):o.code==="Space"&&(o.preventDefault(),o.stopPropagation(),o.stopImmediatePropagation(),t.paused?t.play().then(()=>{i.redrawFullCanvas()}):(t.pause(),i.raf(()=>{i.redrawFullCanvas()}))))}function Nt(o,i){var a,s,h,r,l;if(!D(o,i))return;let t=(s=(a=o.clipboardData)==null?void 0:a.types)!=null?s:[];if(t.includes("application/json"))o.preventDefault(),o.stopPropagation(),o.stopImmediatePropagation();else if(t.includes("Files")){let c=(h=o.clipboardData)==null?void 0:h.files;if(c&&c.length>0){let d=c[0];if(d.type.startsWith("image/")){o.preventDefault(),o.stopPropagation(),o.stopImmediatePropagation();let m=new Image,p=URL.createObjectURL(d);m.addEventListener("load",()=>{URL.revokeObjectURL(p);let u=m.naturalWidth/m.naturalHeight,v=.25,f=v/u*i.aspectRatio;i.addShapesToFrame(i.playbackFrame,[{type:"image",image:m,x:0,y:0,width:v,height:f,strokeStyle:"red",fillStyle:"red",lineWidth:2}]),i.redrawFullCanvas(),i.raf(()=>{i.show()}),i.currentTool="move"},{once:!0}),m.addEventListener("error",()=>{URL.revokeObjectURL(p)},{once:!0}),m.src=p,i.redrawFullCanvas()}}}else if(t.includes("text/plain")){let c=(r=o.clipboardData)==null?void 0:r.getData("text/plain");c&&(o.preventDefault(),o.stopPropagation(),o.stopImmediatePropagation(),i.addShapesToFrame(i.playbackFrame,[{type:"text",text:c,x:.4,y:.4,strokeStyle:i.ctx.strokeStyle,fillStyle:i.ctx.fillStyle,lineWidth:i.ctx.lineWidth}]),i.show(),i.currentTool="move",i.redrawFullCanvas())}else return;let e=(l=o.clipboardData)==null?void 0:l.getData("application/json");if(!e)return;let n=JSON.parse(e);n&&n.shapes&&n.version===1&&(i.addShapesToFrame(i.playbackFrame,n.shapes),i.redrawFullCanvas())}var V={r:"#d31a3b",g:"#15d33b",b:"#0085CA",y:"#F3CE32",a:"#7fffd4",c:"#00ffff",d:"#696969",e:"#50c878",f:"#ff00ff",h:"#f0fff0",i:"#4b0082",j:"#00a86b",k:"#f0e68c",l:"#e6e6fa",m:"#98ff98",n:"#000080",o:"#ffa500",p:"#800080",q:"#e5acc8",s:"#0f52ba",t:"#008080",u:"#3f00ff",v:"#ee82ee",w:"#ffffff",x:"#738678",z:"#0014a8"};function Ut(o,i){let t=document.createElement("input");t.type="color",t.value=o,t.style.margin="5px";let e=n=>{i.ctx.strokeStyle=n.target.value,i.ctx.fillStyle=n.target.value,i.focusOnMediaNode()};return i.addEvent(t,"input",e),t}function Yt(o){let i=document.createElement("input");i.type="number",i.step="1",i.min="1",i.max="10",i.value="5",i.style.margin="5px";let t=e=>{o.ctx.lineWidth=e.target.valueAsNumber,o.focusOnMediaNode()};return o.addEvent(i,"input",t),i}function Xt(o){let i=document.createElement("button");i.textContent="\u26F6",i.title="Toggle Fullscreen",i.type="button",i.style.fontSize="20px",i.style.padding="5px 10px",i.style.backgroundColor="transparent",i.style.border="none",i.style.cursor="pointer",i.style.color="#fff";let t=()=>{if(document.fullscreenElement)document.exitFullscreen&&document.exitFullscreen();else{let n=o.videoElement.parentElement;n!=null&&n.requestFullscreen&&n.requestFullscreen()}};i.addEventListener("click",t);let e=()=>{o.setCanvasSize(),o.playbackFrame=o.playbackFrame,o.canvas.focus(),o.redrawFullCanvas(),i.blur()};return document.addEventListener("fullscreenchange",e),o.destructors.push(()=>{i.removeEventListener("click",t),document.removeEventListener("fullscreenchange",e)}),i}var Se=V.r,ht="position: relative; top: 0px; left: 0px; z-index: 2;",ct="position: absolute; top: -40px; left: 0px; z-index: 2; display: block;",jt="position: absolute;left: 0px;bottom: 5px;width: 100%;z-index: 2;",Kt="position: absolute; top: 0; left: 0px; z-index: 2; display: block;";function qt(){var s,h;let o=document.createElement("div");o.style.cssText=ct,(s=this.canvas.parentNode)==null||s.insertBefore(o,this.canvas);let i=document.createElement("div");i.style.cssText=ht,(h=this.canvas.parentNode)==null||h.insertBefore(i,this.canvas.nextSibling),this.playerControlsContainer=i;let t=this.videoElement.tagName==="VIDEO"?this.videoElement:null;this.uiContainer=o;let e=()=>{let r=document.createElement("div");return r.style.display="inline-flex",r.style.alignItems="center",r.style.margin="5px",r},n=new U(this,o);Rt(this,n),this.isMobile&&(this.hideButton("line"),this.hideButton("circle"),this.hideButton("rectangle"),this.hideButton("eraser")),this.hideButton("compare"),this.colorPicker=Ut(Se,this),o.appendChild(this.colorPicker);let a=e();if(this.strokeSizePicker=Yt(this),a.appendChild(this.strokeSizePicker),o.appendChild(a),t){this.hide(),this.addEvent(t,"pause",()=>{this.show()}),this.addEvent(t,"seek",()=>{t.paused&&this.show()}),this.addEvent(t,"timeupdate",()=>{t.currentTime<2e-4&&!t.paused&&this.startAnnotationsAsVideo()}),this.addEvent(t,"error",()=>{this.hide()}),this.addEvent(t,"stalled",()=>{this.hide()}),this.addEvent(t,"play",()=>{this.hideControls(),this.startAnnotationsAsVideo()}),this.addEvent(document,"copy",l=>{Ot(l,this)}),this.addEvent(document,"cut",l=>{zt(l,this)}),this.addEvent(document,"paste",l=>{Nt(l,this)}),this.addEvent(document,"click",l=>{Vt(l,this)}),this.addEvent(document,"keydown",l=>{Wt(l,this)}),this.addEvent(document.body.querySelector("div"),"drop",l=>{var c;(c=l.dataTransfer)!=null&&c.types});let r=Xt(this);r.style.position="absolute",r.style.right="40px",r.style.bottom="10px",i.appendChild(r)}}function _t(){var o;this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"),(o=this.videoElement.parentNode)==null||o.insertBefore(this.canvas,this.videoElement.nextSibling),this.canvas.style.position="absolute",this.canvas.style.backgroundColor="transparent",this.canvas.style.top="0",this.canvas.style.left="0",this.canvas.style.zIndex="1",this.addEvent(this.canvas,"pointerdown",this.handleMouseDown),this.addEvent(this.canvas,"pointermove",this.handleMouseMove),this.addEvent(this.canvas,"pointerup",this.handleMouseUp),this.addEvent(this.canvas,"pointercancel",this.handleMouseUp),this.addEvent(this.canvas,"pointerenter",()=>{this.isCursorOverCanvas=!0}),this.addEvent(this.canvas,"pointerleave",()=>{this.isCursorOverCanvas=!1}),this.addEvent(this.canvas,"touchmove",i=>{i.stopImmediatePropagation(),i.stopPropagation(),i.preventDefault()}),this.addEvent(window,"resize",this.setCanvasSize),this.addEvent(document,"keydown",this.onKeyDown)}var X=class{constructor(){this.destructors=[];this.isDestroyed=!1;this.activeTimeFrame=1;this.globalShapes=[];this.timeStack=new Map;this.undoTimeStack=new Map}cleanFrameStacks(){this.timeStack.clear(),this.undoTimeStack.clear()}destroy(){this.destructors.forEach(i=>i()),this.destructors=[],this.globalShapes=[],this.cleanFrameStacks()}raf(i){return requestAnimationFrame(i)}addEvent(i,t,e){let n=a=>{this.isDestroyed||e(a)};i.addEventListener(t,n),this.destructors.push(()=>{i.removeEventListener(t,n)})}addProgressBarOverlay(){throw new Error("Method not implemented.")}initUI(){throw new Error("Method not implemented.")}initCanvas(){throw new Error("Method not implemented.")}addFrameSquareOverlay(i=this.activeTimeFrame){throw new Error("Method not implemented.")}addVideoOverlay(){throw new Error("Method not implemented.")}withRefVideo(i){this.isDestroyed||this.referenceVideoElement&&i(this.referenceVideoElement)}withVideo(i){if(this.isDestroyed)return;let t=this.videoElement;!t||t.tagName!=="VIDEO"||i(t)}};var x=class{constructor(i){this.startX=0;this.startY=0;this.isDrawing=!1;this.annotationTool=i}isPointerAtShape(i,t,e){return!1}on(i,t){}get ctx(){return this.annotationTool.ctx}onDeactivate(){}onActivate(){}reset(){this.startX=0,this.startY=0,this.isDrawing=!1}save(i){this.annotationTool.addShape(i)}};var j=class extends x{constructor(){super(...arguments);this.name="rectangle"}move(t,e,n){return t.x+=e,t.y+=n,t}normalize(t,e,n){return w(y({},t),{x:t.x/e,y:t.y/n,width:t.width/e,height:t.height/n})}onPointerDown(t){let{x:e,y:n}=this.annotationTool.getRelativeCoords(t);this.startX=e,this.startY=n,this.isDrawing=!0}onPointerMove(t){if(!this.isDrawing)return;let{x:e,y:n}=this.annotationTool.getRelativeCoords(t);this.drawRectangle(this.startX,this.startY,e-this.startX,n-this.startY)}onPointerUp(t){if(!this.isDrawing)return;let{x:e,y:n}=this.annotationTool.getRelativeCoords(t);this.save({type:"rectangle",x:this.startX,y:this.startY,width:e-this.startX,height:n-this.startY,strokeStyle:this.ctx.strokeStyle,fillStyle:this.ctx.fillStyle,lineWidth:this.ctx.lineWidth}),this.drawRectangle(this.startX,this.startY,e-this.startX,n-this.startY),this.isDrawing=!1}drawRectangle(t,e,n,a){this.ctx.beginPath(),this.ctx.rect(t,e,n,a),this.ctx.stroke()}draw(t){this.drawRectangle(t.x,t.y,t.width,t.height)}isPointerAtShape(t,e,n){let s=Math.abs(e-t.x)<=5,h=Math.abs(e-(t.x+t.width))<=5,r=Math.abs(n-t.y)<=5,l=Math.abs(n-(t.y+t.height))<=5,c=n>=t.y&&n<=t.y+t.height,d=e>=t.x&&e<=t.x+t.width;return(s||h)&&c||(r||l)&&d}};var K=class extends x{constructor(){super(...arguments);this.name="circle"}move(t,e,n){return t.x+=e,t.y+=n,t}normalize(t,e,n){return w(y({},t),{x:t.x/e,y:t.y/n,radius:t.radius/e})}onPointerDown(t){let{x:e,y:n}=this.annotationTool.getRelativeCoords(t);this.startX=e,this.startY=n,this.isDrawing=!0}onPointerMove(t){if(!this.isDrawing)return;let{x:e,y:n}=this.annotationTool.getRelativeCoords(t),a=Math.sqrt(Math.pow(e-this.startX,2)+Math.pow(n-this.startY,2));this.drawCircle(this.startX,this.startY,a)}onPointerUp(t){if(!this.isDrawing)return;let{x:e,y:n}=this.annotationTool.getRelativeCoords(t),a=Math.sqrt(Math.pow(e-this.startX,2)+Math.pow(n-this.startY,2));this.save({type:"circle",x:this.startX,y:this.startY,radius:a,strokeStyle:this.ctx.strokeStyle,fillStyle:this.ctx.fillStyle,lineWidth:this.ctx.lineWidth}),this.drawCircle(this.startX,this.startY,a),this.isDrawing=!1}drawCircle(t,e,n){this.ctx.beginPath(),this.ctx.arc(t,e,n,0,2*Math.PI),this.ctx.stroke()}draw(t){this.drawCircle(t.x,t.y,t.radius)}isPointerAtShape(t,e,n){let a=e-t.x,s=n-t.y;return a*a+s*s<=t.radius*t.radius}};var q=class{constructor(i,t){this.x=i;this.y=t}distanceToLine(i,t){let e=t.x-i.x,n=t.y-i.y,a=Math.abs(n*this.x-e*this.y+t.x*i.y-t.y*i.x),s=Math.sqrt(n*n+e*e);return a/s}};function _(o,i){if(o.length<=2)return o;let t=o[0],e=o[o.length-1],n=-1,a=0;for(let s=1;s<o.length-1;s++){let h=o[s].distanceToLine(t,e);h>a&&(n=s,a=h)}if(a>i){let s=_(o.slice(0,n+1),i),h=_(o.slice(n),i);return s.slice(0,s.length-1).concat(h)}else return[t,e]}var $=class extends x{constructor(){super(...arguments);this.name="curve";this.curvePoints=[];this.zoomScale=2;this.zoomRadius=100;this.zoomCtx=null;this.zoomCanvas=null;this.onKeyPress=t=>{let e=t.key;if(e===null||e===" "||t.isComposing)return;let n=Number(e);if(isNaN(n)||!n){e in V&&(this.annotationTool.colorPicker.value=V[e],this.annotationTool.setCanvasSettings());return}this.annotationTool.strokeSizePicker.value=e,this.annotationTool.setCanvasSettings()}}move(t,e,n){return t.points=t.points.map(a=>({x:a.x+e,y:a.y+n})),t}onActivate(){this.initZoomCanvas(),document.addEventListener("keypress",this.onKeyPress)}onDeactivate(){this.zoomCtx=null,this.zoomCanvas=null,document.removeEventListener("keypress",this.onKeyPress)}normalize(t,e,n){return w(y({},t),{points:t.points.map(a=>({x:a.x/e,y:a.y/n}))})}draw(t){this.drawCurve(t)}reset(){super.reset(),this.curvePoints=[]}onPointerDown(t){if(this.isDrawing)return;let{x:e,y:n}=this.annotationTool.getRelativeCoords(t);this.curvePoints=[],this.startX=e,this.startY=n,this.isDrawing=!0,this.curvePoints.push({x:e,y:n})}onPointerMove(t){let{x:e,y:n}=this.annotationTool.getRelativeCoords(t);if(!this.isDrawing){this.drawZoomCircle(e,n,t.shiftKey);return}this.curvePoints.push({x:e,y:n}),this.drawCurve({points:this.curvePoints,lineWidth:this.ctx.lineWidth}),this.drawZoomCircle(e,n,t.shiftKey)}onPointerUp(t){let{x:e,y:n}=this.annotationTool.getRelativeCoords(t);if(this.drawZoomCircle(e,n,t.shiftKey),!this.isDrawing)return;this.curvePoints.push({x:e,y:n});let a=this.curvePoints.map(c=>new q(c.x,c.y)),l={type:"curve",points:_(a,.5).map(c=>({x:c.x,y:c.y})),strokeStyle:this.ctx.strokeStyle,fillStyle:this.ctx.fillStyle,lineWidth:this.ctx.lineWidth};this.save(l),this.curvePoints=[],this.isDrawing=!1}drawCurve(t){if(t.points.length===2&&t.points[0].x===t.points[1].x&&t.points[0].y===t.points[1].y){let e=t.lineWidth/4,n=0,a=2*Math.PI;this.ctx.beginPath(),this.ctx.arc(t.points[0].x,t.points[0].y,e,n,a),this.ctx.stroke()}else{this.ctx.beginPath(),this.ctx.moveTo(t.points[0].x,t.points[0].y);for(let e=0;e<t.points.length-1;e++){let n=t.points[e],a=t.points[e+1];this.ctx.quadraticCurveTo(n.x,n.y,a.x,a.y)}this.ctx.stroke()}}initZoomCanvas(){let t=document.createElement("canvas"),e=2;t.width=this.zoomRadius*2*e,t.height=this.zoomRadius*2*e;let n=t.getContext("2d");n&&(n.imageSmoothingQuality="high",n.imageSmoothingEnabled=!0,this.zoomCtx=n,this.zoomCanvas=t)}isPointerAtShape(t,e,n){let a=this.ctx.lineWidth/2;for(let s=0;s<t.points.length-1;s++){let h=t.points[s],r=t.points[s+1],l=e-h.x,c=n-h.y,d=r.x-h.x,m=r.y-h.y,p=l*d+c*m,u=d*d+m*m,v=-1;u!==0&&(v=p/u);let f,g;v<0?(f=h.x,g=h.y):v>1?(f=r.x,g=r.y):(f=h.x+v*d,g=h.y+v*m);let b=e-f,S=n-g;if(Math.sqrt(b*b+S*S)<a)return!0}return!1}drawZoomCircle(t,e,n=!1){if(!n)return;this.isDrawing||(this.annotationTool.clearCanvas(),this.annotationTool.addVideoOverlay(),this.annotationTool.drawShapesOverlay());let a=this.zoomCtx;if(!a)return;let s=this.annotationTool.pixelRatio,h=this.zoomRadius*2/this.zoomScale,r=t-h/2,l=e-h/2;a.clearRect(0,0,this.zoomCanvas.width,this.zoomCanvas.height),a.drawImage(this.ctx.canvas,r*s,l*s,h*s,h*s,0,0,this.zoomRadius*2,this.zoomRadius*2),this.ctx.save(),this.ctx.beginPath(),this.ctx.arc(t,e,this.zoomRadius,0,2*Math.PI),this.ctx.closePath(),this.ctx.clip(),this.ctx.drawImage(this.zoomCanvas,t-this.zoomRadius,e-this.zoomRadius),this.ctx.restore()}};var G=class extends x{constructor(){super(...arguments);this.name="line"}move(t,e,n){return t.x1+=e,t.y1+=n,t.x2+=e,t.y2+=n,t}normalize(t,e,n){return w(y({},t),{x1:t.x1/e,y1:t.y1/n,x2:t.x2/e,y2:t.y2/n})}onPointerDown(t){let{x:e,y:n}=this.annotationTool.getRelativeCoords(t);this.startX=e,this.startY=n,this.isDrawing=!0}onPointerMove(t){if(!this.isDrawing)return;let{x:e,y:n}=this.annotationTool.getRelativeCoords(t);this.drawLine(this.startX,this.startY,e,n)}onPointerUp(t){if(!this.isDrawing)return;let{x:e,y:n}=this.annotationTool.getRelativeCoords(t);this.save({type:"line",x1:this.startX,y1:this.startY,x2:e,y2:n,fillStyle:this.ctx.fillStyle,strokeStyle:this.ctx.strokeStyle,lineWidth:this.ctx.lineWidth}),this.drawLine(this.startX,this.startY,e,n),this.isDrawing=!1}drawLine(t,e,n,a){this.ctx.beginPath(),this.ctx.moveTo(t,e),this.ctx.lineTo(n,a),this.ctx.stroke()}draw(t){this.drawLine(t.x1,t.y1,t.x2,t.y2)}isPointerAtShape(t,e,n){let{x1:a,y1:s,x2:h,y2:r}=t,l=5,c=(h-a)*(s-n)-(a-e)*(r-s),d=A(h-a,2)+A(r-s,2);return Math.abs(c)/Math.sqrt(d)<=l&&e>=Math.min(a,h)-l&&e<=Math.max(a,h)+l&&n>=Math.min(s,r)-l&&n<=Math.max(s,r)+l}};var J=class extends x{constructor(){super(...arguments);this.name="arrow"}normalize(t,e,n){return w(y({},t),{x1:t.x1/e,y1:t.y1/n,x2:t.x2/e,y2:t.y2/n})}move(t,e,n){return t.x1+=e,t.y1+=n,t.x2+=e,t.y2+=n,t}draw(t){this.drawArrow(t.x1,t.y1,t.x2,t.y2)}onPointerDown(t){let{x:e,y:n}=this.annotationTool.getRelativeCoords(t);this.startX=e,this.startY=n,this.isDrawing=!0}onPointerMove(t){if(!this.isDrawing)return;let{x:e,y:n}=this.annotationTool.getRelativeCoords(t);this.drawArrow(this.startX,this.startY,e,n)}onPointerUp(t){if(!this.isDrawing)return;this.isDrawing=!1;let{x:e,y:n}=this.annotationTool.getRelativeCoords(t);this.save({type:"arrow",x1:this.startX,y1:this.startY,x2:e,y2:n,strokeStyle:this.ctx.strokeStyle,fillStyle:this.ctx.fillStyle,lineWidth:this.ctx.lineWidth})}drawArrow(t,e,n,a){let s=10+2.5*this.ctx.lineWidth,h=Math.PI/6,r=Math.atan2(a-e,n-t);this.ctx.beginPath(),this.ctx.moveTo(t,e),this.ctx.lineTo(n,a),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(n,a),this.ctx.lineTo(n-s*Math.cos(r+h),a-s*Math.sin(r+h)),this.ctx.moveTo(n,a),this.ctx.lineTo(n-s*Math.cos(r-h),a-s*Math.sin(r-h)),this.ctx.stroke()}isPointerAtShape(t,e,n){let{x1:a,y1:s,x2:h,y2:r}=t,l=5,c=(h-a)*(s-n)-(a-e)*(r-s),d=A(h-a,2)+A(r-s,2);return Math.abs(c)/Math.sqrt(d)<=l&&e>=Math.min(a,h)-l&&e<=Math.max(a,h)+l&&n>=Math.min(s,r)-l&&n<=Math.max(s,r)+l}};var Z=class extends x{constructor(){super(...arguments);this.name="text";this.activePopup=null;this.handleKeyDown=t=>{}}move(t,e,n){return t.x+=e,t.y+=n,t}onActivate(){this.annotationTool.canvas.style.cursor="text",this.isDrawing=!0}onDeactivate(){this.destroyPopup(),this.annotationTool.canvas.style.cursor="default",this.isDrawing=!1}draw(t){let e=t.text.split(`
`);for(let n=0;n<e.length;n++)this.drawText(t.x,t.y+n*20,e[n])}drawText(t,e,n){let a=16+this.ctx.lineWidth*.5;this.ctx.font=`${a}px Helvetica Neue, Arial`,this.ctx.fillText(n,t,e)}onPointerDown(t){let{x:e,y:n}=this.annotationTool.getRelativeCoords(t);this.startX=e,this.startY=n}onPointerMove(t){let{x:e,y:n}=this.annotationTool.getRelativeCoords(t);this.ctx.beginPath(),this.ctx.arc(e,n,5,0,2*Math.PI),this.ctx.fill()}normalize(t,e,n){return w(y({},t),{x:t.x/e,y:t.y/n})}destroyPopup(){var t;this.activePopup&&((t=this.annotationTool.canvas.parentElement)==null||t.removeChild(this.activePopup),this.activePopup=null,document.removeEventListener("keydown",this.handleKeyDown))}createTextInputPopup(t,e){var p;this.destroyPopup();let n=document.createElement("div");this.activePopup=n,n.style.cssText=`
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      z-index: 1000;
      min-width: 280px;
    `;let a=document.createElement("input");a.type="text",a.placeholder="Enter text to draw",a.style.cssText=`
      display: block;
      width: 100%;
      padding: 8px 12px;
      margin-bottom: 16px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      line-height: 20px;
      box-sizing: border-box;
      outline: none;
      transition: border-color 0.2s;
    `,a.addEventListener("focus",()=>{a.style.borderColor="#007bff"}),a.addEventListener("blur",()=>{a.style.borderColor="#ddd"});let s=document.createElement("div");s.style.cssText=`
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    `;let h=`
      height: 36px;
      min-width: 80px;
      padding: 0 16px;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: opacity 0.2s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    `,r=document.createElement("button");r.textContent="Cancel",r.style.cssText=`
      ${h}
      background: #f0f0f0;
      color: #333;
    `,r.addEventListener("mouseover",()=>{r.style.opacity="0.8"}),r.addEventListener("mouseout",()=>{r.style.opacity="1"});let l=document.createElement("button");l.textContent="OK",l.style.cssText=`
      ${h}
      background: #007bff;
      color: white;
    `,l.addEventListener("mouseover",()=>{l.style.opacity="0.8"}),l.addEventListener("mouseout",()=>{l.style.opacity="1"});let c=()=>{this.destroyPopup()},d=()=>{let u=a.value.trim();u&&(this.save({type:"text",x:t,y:e,text:u,strokeStyle:this.ctx.strokeStyle,fillStyle:this.ctx.fillStyle,lineWidth:this.ctx.lineWidth}),this.annotationTool.currentTool=null),c()},m=u=>{u.key==="Escape"?c():u.key==="Enter"&&d()};this.handleKeyDown=m,l.onclick=d,r.onclick=c,a.onkeyup=m,document.addEventListener("keydown",m),s.appendChild(r),s.appendChild(l),n.appendChild(a),n.appendChild(s),(p=this.annotationTool.canvas.parentElement)==null||p.appendChild(n),requestAnimationFrame(()=>{a.focus()})}onPointerUp(t){let{x:e,y:n}=this.annotationTool.getRelativeCoords(t);this.createTextInputPopup(e,n)}isPointerAtShape(t,e,n){let a=t.text.split(`
`),s=16+this.ctx.lineWidth*.5,h=a.length*s,r=Math.max(...a.map(l=>this.ctx.measureText(l).width));return e>=t.x&&e<=t.x+r&&n>=t.y-s&&n<=t.y+h-s}};var Q=class extends x{constructor(){super(...arguments);this.name="eraser"}move(t,e,n){return t.x+=e,t.y+=n,t}normalize(t,e,n){return w(y({},t),{x:t.x/e,y:t.y/n,width:t.width/e,height:t.height/n})}draw(t){this.drawEraser(t.x,t.y,t.width,t.height)}onPointerDown(t){let{x:e,y:n}=this.annotationTool.getRelativeCoords(t);this.startX=e,this.startY=n,this.isDrawing=!0}onPointerMove(t){if(!this.isDrawing)return;let{x:e,y:n}=this.annotationTool.getRelativeCoords(t);this.ctx.save(),this.ctx.strokeStyle="rgba(255, 255, 255, 0.5)",this.ctx.lineWidth=1,this.ctx.fillStyle="rgba(255, 255, 255, 0.3)",this.ctx.fillRect(this.startX,this.startY,e-this.startX,n-this.startY),this.ctx.strokeRect(this.startX,this.startY,e-this.startX,n-this.startY),this.ctx.restore()}onPointerUp(t){if(!this.isDrawing)return;this.isDrawing=!1;let{x:e,y:n}=this.annotationTool.getRelativeCoords(t);this.save({type:"eraser",x:this.startX,y:this.startY,width:e-this.startX,height:n-this.startY,strokeStyle:this.ctx.strokeStyle,fillStyle:this.ctx.fillStyle,lineWidth:this.ctx.lineWidth})}drawEraser(t,e,n,a){this.ctx.clearRect(t,e,n,a)}};var tt=class extends x{constructor(){super(...arguments);this.name="move";this.shape=null;this.shapeIndex=-1;this.lastDrawnShape=null;this.isScale=!1;this.selectedShapeIndex=-1;this.boundHandleKeyDown=null}getSelectedShape(){return this.selectedShapeIndex<0||this.selectedShapeIndex>=this.annotationTool.shapes.length?null:this.annotationTool.shapes[this.selectedShapeIndex]}setSelectedShapeOpacity(t){return this.selectedShapeIndex<0||this.selectedShapeIndex>=this.annotationTool.shapes.length?!1:(this.annotationTool.undoStack.push([...this.annotationTool.shapes]),this.annotationTool.shapes[this.selectedShapeIndex].opacity=t,this.annotationTool.redrawFullCanvas(),!0)}move(t){return t}normalize(t){return y({},t)}onActivate(){this.boundHandleKeyDown=this.handleKeyDown.bind(this),document.addEventListener("keydown",this.boundHandleKeyDown)}onDeactivate(){this.boundHandleKeyDown&&(document.removeEventListener("keydown",this.boundHandleKeyDown),this.boundHandleKeyDown=null),this.selectedShapeIndex=-1}handleKeyDown(t){(t.key==="Backspace"||t.key==="Delete")&&this.selectedShapeIndex>=0&&(t.preventDefault(),this.deleteSelectedShape())}deleteSelectedShape(){this.selectedShapeIndex<0||this.selectedShapeIndex>=this.annotationTool.shapes.length||(this.annotationTool.undoStack.push([...this.annotationTool.shapes]),this.annotationTool.shapes.splice(this.selectedShapeIndex,1),this.selectedShapeIndex=-1,this.shapeIndex=-1,this.annotationTool.redrawFullCanvas())}onPointerDown(t){let{x:e,y:n}=this.annotationTool.getRelativeCoords(t),a=this.annotationTool.shapes,s=a.slice().reverse(),h=!1;for(let r of s)if(this.isPointerAtShape(r,e,n)){this.shape=y({},r),r.fillStyle="rgba(0, 0, 0, 0)",r.strokeStyle="rgba(0, 0, 0, 0)",this.shapeIndex=a.indexOf(r),this.selectedShapeIndex=this.shapeIndex,h=!0;break}h||(this.selectedShapeIndex=-1),this.shape&&(this.lastDrawnShape=null,this.startX=e,this.startY=n,this.isDrawing=!0,this.isScale=this.shape.type==="image"?this.isPointerAtCorner(this.shape,e,n):!1,this.isScale?this.annotationTool.canvas.style.cursor="nw-resize":this.annotationTool.canvas.style.cursor="move")}isPointerAtShape(t,e,n){let a=this.annotationTool.deserialize([t])[0];return this.annotationTool.pluginForTool(a.type).isPointerAtShape(a,e,n)}isPointerAtCorner(t,e,n){if(!("type"in t))return!1;let a=this.annotationTool.deserialize([t])[0],s=15,h=Math.abs(a.y-n)<s,r=Math.abs(a.x-e)<s,l=Math.abs(a.x+a.width-e)<s,c=Math.abs(a.y+a.height-n)<s;return h&&r||h&&l||c&&r||c&&l}onPointerMove(t){if(!this.isDrawing||!this.shape)return;let{x:e,y:n}=this.annotationTool.getRelativeCoords(t),a=e-this.startX,s=n-this.startY;this.startX=e-a,this.startY=n-s;let h=this.annotationTool.deserialize([this.shape])[0],r=h.type==="image"?h:JSON.parse(JSON.stringify(h));if(r.type!=="audio-peaks")if(r.type==="image")if(this.isScale){let{width:l,height:c}=r,d=l/c,m=l+a,p=m/d;r.width=m,r.height=p,this.lastDrawnShape=r,this.annotationTool.pluginForTool(r.type).draw(r)}else{let l=this.annotationTool.pluginForTool(r.type).move(r,a,s);this.lastDrawnShape=l,this.annotationTool.pluginForTool(r.type).draw(l)}else{let l=this.annotationTool.pluginForTool(r.type).move(r,a,s);this.lastDrawnShape=l,this.annotationTool.pluginForTool(r.type).draw(l)}}onPointerUp(t){!this.isDrawing||!this.lastDrawnShape||(this.lastDrawnShape&&(this.lastDrawnShape.fillStyle=this.annotationTool.ctx.fillStyle,this.lastDrawnShape.strokeStyle=this.annotationTool.ctx.strokeStyle,this.lastDrawnShape.lineWidth=this.annotationTool.ctx.lineWidth,this.save(this.lastDrawnShape)),this.isDrawing=!1,this.isScale=!1,this.shape=null,this.lastDrawnShape=null,this.annotationTool.canvas.style.cursor="default")}draw(){throw new Error("Method not implemented.")}reset(){this.isDrawing=!1,this.shape=null,this.isScale=!1,this.lastDrawnShape=null,this.shapeIndex=-1,this.selectedShapeIndex=-1,this.annotationTool.canvas.style.cursor="default"}save(t){this.annotationTool.replaceShape(t,this.shapeIndex)}};var et=class extends x{constructor(){super(...arguments);this.name="image"}move(t,e,n){return t.x+=e,t.y+=n,t}onPointerDown(t){}onPointerMove(t){}onPointerUp(t){}normalize(t,e,n){return w(y({},t),{x:t.x/e,y:t.y/n,width:t.width/e,height:t.height/n})}draw(t){if(!(t.image instanceof HTMLImageElement)){console.error("Image is not an instance of HTMLImageElement");return}this.ctx.drawImage(t.image,t.x,t.y,t.width,t.height)}isPointerAtShape(t,e,n){return e>=t.x&&e<=t.x+t.width&&n>=t.y&&n<=t.y+t.height}};var nt=class extends x{constructor(){super(...arguments);this.name="compare";this.comparisonLine=0;this.leftOpacity=1;this.isDrawing=!1}get rightOpacity(){return this.annotationTool.overlayOpacity}move(t,e,n){return t.x+=e,t}onActivate(){this.comparisonLine=this.annotationTool.canvasWidth/2,this.leftOpacity=1,this.annotationTool.canvas.style.cursor="col-resize"}onDeactivate(){this.annotationTool.canvas.style.cursor="default",this.comparisonLine=0,this.leftOpacity=1,this.isDrawing=!1}normalize(t,e){return w(y({},t),{x:t.x/e})}onPointerDown(t){let{x:e,y:n}=this.annotationTool.getRelativeCoords(t);this.startX=e,this.startY=n,this.isDrawing=!0,this.disablePreviousCompare(),this.onPointerMove(t)}onPointerMove(t){if(!this.isDrawing){if(this.annotationTool.globalShapes.length>0){let a=this.annotationTool.globalShapes[0];if(a.type==="compare"){let s=this.annotationTool.deserialize([a])[0];this.draw(s),this.annotationTool.addFrameSquareOverlay()}}return}let{x:e}=this.annotationTool.getRelativeCoords(t);this.comparisonLine=e;let n={type:"compare",strokeStyle:this.ctx.strokeStyle,fillStyle:this.ctx.fillStyle,lineWidth:this.ctx.lineWidth,x:e};this.draw(n),this.drawDelimiter(n)}onPointerUp(){this.isDrawing&&(this.save({type:"compare",strokeStyle:this.ctx.strokeStyle,fillStyle:this.ctx.fillStyle,lineWidth:this.ctx.lineWidth,disabled:!1,x:this.comparisonLine}),this.isDrawing=!1)}removePreviousCompare(){this.annotationTool.globalShapes=this.annotationTool.globalShapes.filter(t=>t.type!=="compare")}disablePreviousCompare(){this.annotationTool.globalShapes=this.annotationTool.globalShapes.map(t=>t.type==="compare"?w(y({},t),{disabled:!0}):t)}save(t){this.removePreviousCompare();let e=this.annotationTool.serialize([t])[0];e.x<.05||e.x>.95||this.annotationTool.addGlobalShape(e)}drawDelimiter(t){this.ctx.beginPath(),this.ctx.moveTo(t.x,0),this.ctx.lineTo(t.x,this.annotationTool.canvasWidth),this.ctx.stroke()}drawShape(t){var pt,vt,ft,gt,yt,xt,bt,wt;let e=this.annotationTool.videoElement,n=this.annotationTool.referenceVideoElement;if(!e||!n)return;let a=this.ctx.globalAlpha,s=this.annotationTool.canvasWidth,h=this.annotationTool.canvasHeight,r=t.x,l=n.videoHeight-e.videoHeight,c=n.videoWidth-e.videoWidth,d=this.annotationTool.isMobile;this.ctx.globalAlpha=this.leftOpacity;let m=(vt=(pt=this.annotationTool.referenceVideoFrameBuffer)==null?void 0:pt.frameNumberFromTime(e.currentTime))!=null?vt:1,p=m;if(c>e.videoWidth&&l>e.videoHeight&&!this.annotationTool.isMobile){let M=(xt=(yt=this.annotationTool.referenceVideoFrameBuffer)==null?void 0:yt.getFrameNumberBySignature((gt=(ft=this.annotationTool.videoFrameBuffer)==null?void 0:ft.getHistogram(m))!=null?gt:null,m))!=null?xt:m,z=Math.abs(m-M);z>=1&&z<=3&&(p=M)}let v=(bt=this.annotationTool.referenceVideoFrameBuffer)==null?void 0:bt.getFrame(p),f=(wt=this.annotationTool.videoFrameBuffer)==null?void 0:wt.getFrame(m);if(d){this.ctx.imageSmoothingQuality="low";let M=r/s,z=r;this.ctx.drawImage(f!=null?f:e,0,0,M*e.videoWidth,e.videoHeight,0,0,z,h)}else{let M=f?f.width:e.videoWidth,z=f?f.height:e.videoHeight;this.ctx.drawImage(f!=null?f:e,0,0,M,z,0,0,s,h)}this.ctx.globalAlpha=this.rightOpacity;let g=0,b=0,S=e.videoWidth/e.videoHeight,L=n.videoWidth/n.videoHeight,C=Math.abs(S-L)>.1,E=10,H=Math.abs(l)>E,k=e.videoWidth,F=e.videoHeight,P=0;if(c<-E)if(C){let M=e.videoWidth/s;P=Math.abs(c/2),P=P/M,P<=E&&(P=0)}else k=n.videoWidth;else c>E&&(k=n.videoWidth);if(l===0)g=0;else if(l>0)C?(g=l/2,g<=E&&(g=0)):F=H?n.videoHeight:e.videoHeight;else if(!C)F=H?n.videoHeight:e.videoHeight;else{b=Math.abs(l/2);let M=e.videoHeight/h;b=b/M,b<=E&&(b=0)}let st=r-P,ut=s-st,ce=ut/s*k;v&&this.rightOpacity>0&&(d&&(this.ctx.imageSmoothingQuality="low"),this.ctx.drawImage(v,st/s*k,g,ce,F,st+P,b,ut,h)),this.ctx.globalAlpha=a}draw(t){if(t.disabled)return;let e=this.annotationTool.videoElement,n=this.annotationTool.referenceVideoElement;!e||!n||this.drawShape(t)}};function Ie(o){let i=o[0],t=o[0];for(let e=1;e<o.length;e++)o[e]<i&&(i=o[e]),o[e]>t&&(t=o[e]);return[i,t]}var ot=class extends x{constructor(t){super(t);this.name="audio-peaks";this.canvas=document.createElement("canvas");this.props={peaks:new Int8Array,theme:{waveOutlineColor:"rgba(255,192,203,0.7)",waveFillColor:"grey",waveProgressColor:"orange"},waveHeight:40,bits:16};this.drawCtx=this.canvas.getContext("2d")}onVideoBlobSet(t){return T(this,null,function*(){let e=yield t.arrayBuffer();this.init(e)})}on(t,e){t==="videoBlobSet"&&this.onVideoBlobSet(e)}extractPeaks(t){return T(this,null,function*(){let{default:e}=yield Promise.resolve().then(()=>be(Qt(),1)),n=this.progressBarCoordinates.width,a=Math.ceil(t.length/n);return e(t,a,!0)})}setProps(t){let[e,n]=Ie(t.data[0]),a=Math.pow(2,t.bits-1)-1,s=-Math.pow(2,t.bits-1);this.props.peaks=t.data[0].map(h=>h<0?Math.round(h/e*s):Math.round(h/n*a)),this.props.bits=t.bits}init(t){return T(this,null,function*(){try{let n=yield new AudioContext().decodeAudioData(t),a=yield this.extractPeaks(n);this.initCanvas(),this.setProps(a),this.annotationTool.removeGlobalShape("audio-peaks"),this.annotationTool.addGlobalShape({x:0,y:0,strokeStyle:"red",fillStyle:"red",lineWidth:1,type:"audio-peaks"}),this.clearLocalCanvas(),this.drawOnCanvas()}catch(e){this.initCanvas(),this.props.peaks=new Int8Array,this.annotationTool.removeGlobalShape("audio-peaks"),this.clearLocalCanvas(),console.error(e)}})}initCanvas(){this.canvas.width=this.progressBarCoordinates.width*this.pixelRatio,this.canvas.height=this.props.waveHeight*this.pixelRatio,this.drawCtx.scale(this.pixelRatio,this.pixelRatio)}move(t,e,n){return t.x+=e,t.y+=n,t}normalize(t,e,n){return w(y({},t),{x:t.x/e,y:t.y/n})}onPointerDown(t){}onPointerMove(t){}onPointerUp(t){}reset(){this.clearLocalCanvas(),this.props.peaks=new Int8Array,this.annotationTool.removeGlobalShape("audio-peaks")}draw(t){let e=this.annotationTool.videoElement;if(!e||e.tagName!=="VIDEO"||e.muted||e.volume===0)return;this.ctx.clearRect(0,0,this.annotationTool.canvasWidth,this.annotationTool.canvasHeight);let{waveHeight:a,theme:s}=this.props,h=this.ctx,r=a/2,l=this.progressBarCoordinates.y-20,{x:c,width:d}=this.progressBarCoordinates,m=this.annotationTool.playbackFrame,p=this.annotationTool.totalFrames,u=Math.ceil(m/p*d)+c;this.ctx.drawImage(this.canvas,c,l,d,a),h.fillStyle=s.waveProgressColor,h.fillRect(u,l+0,1,r*2)}get pixelRatio(){return this.annotationTool.pixelRatio}get progressBarCoordinates(){return this.annotationTool.progressBarCoordinates}clearLocalCanvas(){this.drawCtx.clearRect(0,0,this.canvas.width,this.canvas.height)}drawOnCanvas(){let{peaks:t,bits:e,waveHeight:n,theme:a}=this.props,s=this.drawCtx,h=0,r=0,l=n/2,c=A(2,e-1),d=0,m=t.length;s.fillStyle=a.waveOutlineColor;for(let p=0;p<m;p+=1){let u=t[(p+h)*2+1]/c,v=Math.abs(u*l);s.fillRect(p+r,d+0+l-v,1,v)}}};var at=class extends x{constructor(){super(...arguments);this.name="selection";this.selectedArea=null}move(t,e,n){return t.x+=e,t.y+=n,t}normalize(t,e,n){return w(y({},t),{x:t.x/e,y:t.y/n,width:t.width/e,height:t.height/n})}onPointerDown(t){let{x:e,y:n}=this.annotationTool.getRelativeCoords(t);this.startX=e,this.startY=n,this.isDrawing=!0,this.selectedArea=null}onPointerMove(t){if(!this.isDrawing)return;let{x:e,y:n}=this.annotationTool.getRelativeCoords(t);this.annotationTool.clearCanvas(),this.annotationTool.globalShapes.length>0?this.annotationTool.drawShapesOverlay():this.annotationTool.addVideoOverlay(),this.drawSelectionRect(this.startX,this.startY,e-this.startX,n-this.startY)}onPointerUp(t){if(!this.isDrawing)return;let{x:e,y:n}=this.annotationTool.getRelativeCoords(t),a=Math.min(e,this.startX),s=Math.min(n,this.startY),h=Math.abs(e-this.startX),r=Math.abs(n-this.startY);if(h<1||r<1){this.isDrawing=!1,this.annotationTool.redrawFullCanvas();return}let l=document.createElement("canvas"),c=l.getContext("2d"),d=this.annotationTool.videoElement;if(!(d instanceof HTMLVideoElement))return;let m=d.videoWidth/d.videoHeight,p=this.annotationTool.canvasWidth/this.annotationTool.canvasHeight,u=this.annotationTool.canvasWidth,v=this.annotationTool.canvasHeight,f=0,g=0;m>p?(v=this.annotationTool.canvasWidth/m,g=(this.annotationTool.canvasHeight-v)/2):(u=this.annotationTool.canvasHeight*m,f=(this.annotationTool.canvasWidth-u)/2);let b=d.videoWidth/u,S=d.videoHeight/v,L=(a-f)*b,N=(s-g)*S,C=h*b,E=r*S;l.width=Math.max(1,C),l.height=Math.max(1,E);try{c.drawImage(this.annotationTool.videoElement,L,N,C,E,0,0,C,E);let H=c.getImageData(0,0,l.width,l.height);this.selectedArea=H;let k=document.createElement("canvas");k.width=C+4,k.height=E+4,k.style.width=`${h+4}px`,k.style.height=`${r+4}px`;let F=k.getContext("2d");F.strokeStyle="black",F.lineWidth=2,F.strokeRect(1,1,C+2,E+2),F.strokeStyle="black",F.lineWidth=2,F.strokeRect(2,2,C,E),F.putImageData(H,2,2);let P=new Image;P.onload=()=>{this.annotationTool.pluginForTool("image").save({type:"image",x:a-2,y:s-2,width:h+4,height:r+4,image:P,strokeStyle:"transparent",fillStyle:"transparent",lineWidth:0}),this.isDrawing=!1,this.selectedArea=null,this.annotationTool.redrawFullCanvas()},P.src=k.toDataURL(),this.annotationTool.currentTool="move"}catch(H){console.error("Error capturing selection:",H),this.isDrawing=!1,this.annotationTool.redrawFullCanvas();return}}drawSelectionRect(t,e,n,a){var p,u,v;let s=Math.min(t,t+n),h=Math.min(e,e+a),r=Math.abs(n),l=Math.abs(a),c=this.annotationTool.pixelRatio,d=null;if(r>0&&l>0)try{d=this.ctx.getImageData(s*c,h*c,r*c,l*c)}catch(f){d=null}if(this.ctx.fillStyle="rgba(0, 0, 0, 0.5)",this.ctx.fillRect(0,0,this.annotationTool.canvasWidth,this.annotationTool.canvasHeight),d&&r>0&&l>0)this.ctx.putImageData(d,s*c,h*c);else if(r>0&&l>0){let f=this.annotationTool.videoElement;if(f instanceof HTMLVideoElement){let g=(p=this.annotationTool.videoFrameBuffer)==null?void 0:p.frameNumberFromTime(f.currentTime),b=(v=(u=this.annotationTool.videoFrameBuffer)==null?void 0:u.getFrame(g||0))!=null?v:f,S=b?b.width:f.videoWidth,L=b?b.height:f.videoHeight,N=S/this.annotationTool.canvasWidth,C=L/this.annotationTool.canvasHeight;this.ctx.drawImage(b,s*N,h*C,r*N,l*C,s,h,r,l)}}this.ctx.beginPath();let m=this.ctx.strokeStyle;this.ctx.strokeStyle="#ffffff",this.ctx.lineWidth=2,this.ctx.setLineDash([5,5]),this.ctx.strokeRect(s,h,r,l),this.ctx.setLineDash([]),this.ctx.strokeStyle=m}draw(t){this.drawSelectionRect(t.x,t.y,t.width,t.height)}reset(){super.reset(),this.selectedArea=null}};var te=[j,K,G,J,Z,Q,$,tt,et,nt,ot,at];function ee(o,i){let t,e,n,a=[],s=!0,h=!1;function r(d,m){if(h)return;let p=Math.abs(m.mediaTime-t),u=Math.abs(m.presentedFrames-e),v=p/u;v&&v<1&&s&&a.length<50&&o.playbackRate===1&&document.hasFocus()&&(a.push(v),n=Math.round(1/c()),i(n,a.length*2)),s=!0,t=m.mediaTime,e=m.presentedFrames,h||o.requestVideoFrameCallback(r)}o.requestVideoFrameCallback(r);let l=()=>{a.pop(),s=!1};o.addEventListener("seeked",l);function c(){return a.reduce((d,m)=>d+m)/a.length}return()=>{h=!0,o.removeEventListener("seeked",l)}}function ne(o,i,t){return .299*o+.587*i+.114*t}var ke=0,mt=class extends Array{constructor(){super(...arguments),this.id=ke++}};function ie(o){let i=o.width,t=o.height,e=new Array(i*t),n=new mt,a=0;for(let s=0;s<o.data.length;s+=4)e[a]=ne(o.data[s],o.data[s+1],o.data[s+2]),a++;for(let s=1;s<t-1;s++)for(let h=1;h<i-1;h++){let r=s*i+h,l=-e[r-i-1]+e[r-i+1]-2*e[r-1]+2*e[r+1]-e[r+i-1]+e[r+i+1],c=e[r-i-1]+2*e[r-i]+e[r-i+1]-e[r+i-1]-2*e[r+i]-e[r+i+1],d=Math.sqrt(l*l+c*c);n.push(d)}return n}var dt=new Map,Fe=(o,i)=>Math.max(o.id,i.id)+"-"+Math.min(o.id,i.id);function oe(o,i){let t=Fe(o,i);if(dt.has(t))return dt.get(t);let e=0;for(let a=0;a<o.length;a++)e+=(o[a]-i[a])*(o[a]-i[a]);let n=1/(1+Math.sqrt(e));return dt.set(t,n),n}var W=64,O=class{constructor(i,t,e=!0){this.isDestroyed=!1;this.autoHide=!0;this.isMobile=!1;this.seenFrames=0;this.isCanvasSizeSet=!1;this.frames=new Map;this.histograms=new Map;this.video=i,this.fps=t,this.autoHide=e,this.createCanvas(),this.createTransformCanvas()}createTransformCanvas(){this.transformCanvas=document.createElement("canvas"),this.transformCanvasCtx=this.canvas.getContext("2d",{willReadFrequently:!0,alpha:!1}),this.transformCanvas.width=W,this.transformCanvas.height=W}normalizeImage(i){return this.transformCanvasCtx.drawImage(i,0,0,i.width,i.height,0,0,W,W),this.transformCanvasCtx.getImageData(0,0,W,W)}toHistogram(i){return this.imageHistogram(this.normalizeImage(i))}imageHistogram(i){return ie(i)}start(){this.addRequestFrameCallback()}destroy(){this.isDestroyed=!0,this.frames.forEach(i=>i.close()),this.frames.clear()}tick(i,t){if(this.setCanvasSize(),t.expectedDisplayTime-performance.now()>10,this.isDestroyed)return!1;if(this.seenFrames>=this.totalFrames){if(this.autoHide)try{this.video.paused||this.video.pause(),this.video.style.display="none"}catch(h){}return!1}if(this.video.videoWidth===0||this.video.videoHeight===0)return!0;let n=this.video,a=this.frameNumberFromTime(t.mediaTime);if(!Math.max(1,t.presentedFrames>this.totalFrames?t.presentedFrames%this.totalFrames:t.presentedFrames))throw new Error("expectedFrame is 0");if(this.hasFrame(a))this.seenFrames++;else{this.ctx.drawImage(n,0,0,this.width,this.height,0,0,this.width,this.height);let h=this.ctx.getImageData(0,0,this.canvas.width,this.canvas.height);createImageBitmap(h,0,0,this.width,this.height).then(r=>T(this,null,function*(){this.setFrame(a,r),this.isMobile||this.setHistogram(a,this.toHistogram(r))}))}return!0}addRequestFrameCallback(){this.isDestroyed||this.video.requestVideoFrameCallback((i,t)=>{this.tick(i,t)&&this.addRequestFrameCallback()})}createCanvas(){this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d",{willReadFrequently:!0,alpha:!1})}setCanvasSize(){this.isCanvasSizeSet||(this.canvas.width=this.video.videoWidth,this.canvas.height=this.video.videoHeight,this.isCanvasSizeSet=!0)}get width(){return this.video.videoWidth}get height(){return this.video.videoHeight}hasFrame(i){return this.frames.has(i)}getFrame(i){return this.frames.has(i)?this.frames.get(i):null}getFrameNumberBySignature(i,t){if(!i)return t;let e=0,n=t;return[t-3,t-2,t-1,t,t+1,t+2,t+3].filter(s=>s>0&&s<=this.totalFrames).forEach(s=>{let h=this.getHistogram(s);if(h){let r=oe(i,h);r>e&&(e=r,n=s)}}),n}setFrame(i,t){this.frames.set(i,t)}setHistogram(i,t){this.histograms.set(i,t)}getHistogram(i){var t;return(t=this.histograms.get(i))!=null?t:null}get totalFrames(){return Math.round(this.video.duration*this.fps)}frameNumberFromTime(i){return Math.max(1,Math.round(i*this.fps))}};var Pe=window.devicePixelRatio||1,ae=25,B=class extends X{constructor(t){super();this.referenceVideoFrameBuffer=null;this.videoFrameBuffer=null;this.isMouseDown=!1;this.buttons=[];this.plugins=[];this.annotatedFrameCoordinates=[];this.videoBlobUrl=null;this.referenceVideoBlobUrl=null;this.frameCounterTimeoutId=null;this._enforcedTotalFrames=null;this.isCursorOverCanvas=!1;this.overlayOpacity=.7;this.fps=ae;this.plannedFn=null;this.ct=0;this.isCanvasInitialized=!1;this.enforcedCanvasSize=null;this.lastNavigatedFrame=0;this.isProgressBarNavigation=!1;this.isAnnotationsAsVideoActive=!1;this.plugins=te.map(e=>new e(this)),this.init(t)}prevFrame(){let e=this.playbackFrame-1;e<1?this.playbackFrame=this.totalFrames:this.playbackFrame=e}nextFrame(){let e=this.playbackFrame+1;e>this.totalFrames?this.playbackFrame=1:this.playbackFrame=e}getAnnotatedFrames(){let t=[];return this.timeStack.forEach((e,n)=>{e&&e.length>0&&t.push(n)}),t.sort((e,n)=>e-n)}prevAnnotatedFrame(){let t=this.getAnnotatedFrames();if(t.length===0)return;let e=this.playbackFrame;for(let n=t.length-1;n>=0;n--)if(t[n]<e){this.playbackFrame=t[n];return}this.playbackFrame=t[t.length-1]}nextAnnotatedFrame(){let t=this.getAnnotatedFrames();if(t.length===0)return;let e=this.playbackFrame;for(let n of t)if(n>e){this.playbackFrame=n;return}this.playbackFrame=t[0]}removeGlobalShape(t){this.globalShapes=this.globalShapes.filter(e=>e.type!==t)}addGlobalShape(t){this.globalShapes.push(t)}get selectedColor(){return this.colorPicker.value}get selectedStrokeSize(){return this.strokeSizePicker.valueAsNumber}get currentTool(){return this._currentTool}set currentTool(t){let e=this._currentTool;e&&(this.getButtonForTool(e).classList.remove("active"),this.pluginForTool(e).onDeactivate()),this._currentTool=t,this.canvas.style.cursor=t?"pointer":"default",t&&(this.getButtonForTool(t).classList.add("active"),this.pluginForTool(t).onActivate())}enableFrameRateDetection(){if(this.destructors.find(n=>n.name==="frameRateDetector"))return;let t=this.videoElement;if(t.tagName==="IMG")return;let e=ee(t,n=>{this.fps=n});Object.defineProperty(e,"name",{value:"frameRateDetector"}),this.destructors.push(e)}timeToFrame(t){return Math.max(1,Math.round(t*this.fps))}get playbackFrame(){return this.videoElement instanceof HTMLImageElement?1:this.timeToFrame(this.videoElement.currentTime)}set playbackFrame(t){if(this.videoElement instanceof HTMLImageElement)return;let e=t/this.fps;this.videoElement.currentTime=e,this.rvf(()=>{this.show()})}rvf(t){this.plannedFn=t}get canvasWidth(){var t,e;return(e=(t=this.enforcedCanvasSize)==null?void 0:t.width)!=null?e:0}get canvasHeight(){var t,e;return(e=(t=this.enforcedCanvasSize)==null?void 0:t.height)!=null?e:0}get aspectRatio(){return this.canvasHeight===0?0:this.canvasWidth/this.canvasHeight}get isMobile(){return window.innerWidth<960}get progressBarCoordinates(){let t=this.isMobile?30:10,e=5,a=this.canvasWidth-e-55,s=e,h=this.canvasHeight-t;return{x:s,y:h,width:a,height:t}}get shapes(){return this.timeStack.has(this.activeTimeFrame)||this.timeStack.set(this.activeTimeFrame,[]),this.timeStack.get(this.activeTimeFrame)}set shapes(t){this.timeStack.set(this.activeTimeFrame,t)}get undoStack(){return this.undoTimeStack.has(this.activeTimeFrame)||this.undoTimeStack.set(this.activeTimeFrame,[]),this.undoTimeStack.get(this.activeTimeFrame)}set undoStack(t){this.undoTimeStack.set(this.activeTimeFrame,t)}get pixelRatio(){return Pe}setVideoBlob(n){return T(this,arguments,function*(t,e=this.fps){this.videoBlobUrl&&URL.revokeObjectURL(this.videoBlobUrl);let a=URL.createObjectURL(t);this.videoBlobUrl=a,yield this.setVideoUrl(a,e),this.plugins.forEach(s=>{s.on("videoBlobSet",t)})})}setVideoUrl(n){return T(this,arguments,function*(t,e=this.fps){if(this.videoElement instanceof HTMLImageElement)return;let a=this.videoElement;a.src=t.toString(),yield this.videoElement.load(),this.setFrameRate(e),this.videoFrameBuffer&&(this.videoFrameBuffer.destroy(),this.videoFrameBuffer=new O(a,e,!1),this.videoFrameBuffer.isMobile=this.isMobile),this.setCanvasSize()})}enableVideoFrameBuffer(){this.videoElement instanceof HTMLImageElement||(this.videoFrameBuffer=new O(this.videoElement,this.fps,!1),this.videoFrameBuffer.isMobile=this.isMobile)}hide(){this.stopAnnotationsAsVideo(),this.hideControls(),this.hideCanvas()}showControls(){this.uiContainer.style.display="block"}hideControls(){this.uiContainer.style.display="none"}showCanvas(){this.canvas.style.display="block"}hideCanvas(){this.canvas.style.display="none"}updateActiveTimeFrame(t=void 0){this.activeTimeFrame=t?this.timeToFrame(t):this.playbackFrame}show(){this.stopAnnotationsAsVideo(),this.updateActiveTimeFrame(),this.showCanvas(),this.showControls(),this.redrawFullCanvas()}setCanvasSettings(){this.ctx.strokeStyle=this.selectedColor,this.ctx.fillStyle=this.selectedColor,this.ctx.lineWidth=this.selectedStrokeSize}pluginForTool(t){if(this.isDestroyed)throw new Error("AnnotationTool is destroyed");let e=this.plugins.find(n=>n.name===t);if(!e)throw new Error(`No plugin found for tool ${t}`);return e}getButtonForTool(t){return this.buttons.find(e=>e.dataset.tool===t)}bindContext(){this.handleMouseDown=this.handleMouseDown.bind(this),this.handleMouseMove=this.handleMouseMove.bind(this),this.handleMouseUp=this.handleMouseUp.bind(this),this.setCanvasSize=this.setCanvasSize.bind(this),this.onKeyDown=this.onKeyDown.bind(this)}initProperties(){this.isDestroyed=!1,this.isProgressBarNavigation=!1,this.shapes=[],this.globalShapes=[],this.currentTool=this.isMobile?null:"curve"}setVideoStyles(){this.videoElement.style.objectFit="cover",this.videoElement.style.objectPosition="left top"}get frameCallbackSupported(){return"requestVideoFrameCallback"in HTMLVideoElement.prototype}initFrameCounter(){if(!this.frameCallbackSupported){this.frameCounterTimeoutId=setTimeout(()=>{var t;this.isDestroyed||((t=this.plannedFn)==null||t.call(this),this.plannedFn=null,this.initFrameCounter(),this.updateActiveTimeFrame(),this.playAnnotationsAsVideo())},1e3/this.fps);return}this.withVideo(t=>{t.requestVideoFrameCallback((e,n)=>{var a,s;this.isCanvasInitialized||this._setCanvasSize(),(a=this.videoFrameBuffer)==null||a.tick(e,n),(s=this.plannedFn)==null||s.call(this),this.plannedFn=null,this.raf(()=>{this.initFrameCounter(),this.updateActiveTimeFrame(n.mediaTime),this.playAnnotationsAsVideo()})})})}init(t){this.videoElement=t,this.setVideoStyles(),this.initFrameCounter(),this.bindContext(),this.initCanvas(),this.initUI(),this.initProperties(),this.setCanvasSize()}onKeyDown(t){(t.ctrlKey||t.metaKey)&&t.key.toLowerCase()==="z"&&this.handleUndo()}handleUndo(){this.undoStack.length>0&&(this.shapes=this.undoStack.pop(),this.redrawFullCanvas())}destroy(){var a,s,h,r,l,c,d,m;if(this.isDestroyed)return;super.destroy(),this.stopAnnotationsAsVideo(),this.frameCounterTimeoutId&&(clearTimeout(this.frameCounterTimeoutId),this.frameCounterTimeoutId=null),this.videoBlobUrl&&(URL.revokeObjectURL(this.videoBlobUrl),this.videoBlobUrl=null),this.referenceVideoBlobUrl&&(URL.revokeObjectURL(this.referenceVideoBlobUrl),this.referenceVideoBlobUrl=null),this.currentTool=null,this.plugins.forEach(p=>p.reset()),this.annotatedFrameCoordinates=[],this.setFrameRate(ae);let t=this.strokeSizePicker.parentElement;if((a=t==null?void 0:t.parentNode)==null||a.removeChild(t),this.referenceVideoElement){let p=this.referenceVideoElement.parentElement;(s=p==null?void 0:p.parentNode)==null||s.removeChild(p),this.referenceVideoElement=null}let e=this.colorPicker.parentElement;(h=e==null?void 0:e.parentNode)==null||h.removeChild(e),this.buttons.forEach(p=>{var u;(u=p.parentNode)==null||u.removeChild(p)}),this.buttons=[],(r=this.uiContainer.parentNode)==null||r.removeChild(this.uiContainer),(l=this.canvas.parentNode)==null||l.removeChild(this.canvas),(c=this.playerControlsContainer.parentElement)==null||c.removeChild(this.playerControlsContainer),["strokeSizePicker","colorPicker","uiContainer","playerControlsContainer","canvas","ctx","videoElement"].forEach(p=>{delete this[p]}),this.activeTimeFrame=0,this.isDestroyed=!0,(d=this.referenceVideoFrameBuffer)==null||d.destroy(),this.referenceVideoFrameBuffer=null,(m=this.videoFrameBuffer)==null||m.destroy(),this.videoFrameBuffer=null}_setCanvasSize(){let t=getComputedStyle(this.videoElement),e=parseInt(t.width,10),n=this.videoElement,a=n.videoWidth/n.videoHeight;if(isNaN(e)||!n.videoWidth||!n.videoHeight)return this.isCanvasInitialized=!1,this.setCanvasSettings(),!1;let s=n.parentElement,h=!!document.fullscreenElement,r=Math.min(e,n.videoWidth),l=Math.floor(r/a);if(h&&s){let m=window.innerWidth,p=window.innerHeight-90;m/p>a?(l=p,r=l*a):(r=m,l=r/a),n.style.width=`${r}px`,n.style.height=`${l}px`,n.style.marginTop="40px",n.style.marginBottom="50px"}else n.style.width=`${r}px`,n.style.height=`${l}px`,n.style.marginTop="",n.style.marginBottom="";return h?(this.playerControlsContainer.style.cssText=jt,this.uiContainer.style.cssText=Kt):(this.playerControlsContainer.style.cssText=ht,this.uiContainer.style.cssText=ct),this.isCanvasInitialized=n.videoWidth>0&&n.videoHeight>0,this.canvas.width=r*this.pixelRatio,this.canvas.height=l*this.pixelRatio,this.canvas.style.width=`${r}px`,this.canvas.style.height=`${l}px`,this.canvas.style.position="absolute",this.canvas.style.top=n.style.marginTop||"0",this.canvas.style.left="0",this.enforcedCanvasSize={width:r,height:l},this.ctx.scale(this.pixelRatio,this.pixelRatio),this.setCanvasSettings(),!0}setCanvasSize(){this._setCanvasSize()&&(this.syncVideoSizes(),this.redrawFullCanvas())}replaceShape(t,e){let n=this.serialize([t])[0];this.undoStack.push([...this.shapes]),this.shapes[e]=n}addShape(t){let e=this.serialize([t])[0];this.undoStack.push([...this.shapes]),this.shapes.push(e)}get msPerFrame(){return 1e3/this.fps}syncVideoSizes(){this.withRefVideo(t=>{let n=this.videoElement.getBoundingClientRect();t.style.position="fixed",t.style.top=`${n.top}px`,t.style.left=`${n.left}px`})}addReferenceVideoByURL(a){return T(this,arguments,function*(t,e=this.fps,n="video/mp4"){var l;let s=yield fetch(t).then(c=>c.blob()),h=new Blob([s],{type:n});this.referenceVideoBlobUrl&&URL.revokeObjectURL(this.referenceVideoBlobUrl);let r=window.URL.createObjectURL(h);this.referenceVideoBlobUrl=r,this.referenceVideoElement?((l=this.referenceVideoFrameBuffer)==null||l.destroy(),this.referenceVideoFrameBuffer=new O(this.referenceVideoElement,e),this.referenceVideoFrameBuffer.isMobile=this.isMobile,this.referenceVideoFrameBuffer.start()):(this.referenceVideoElement=document.createElement("video"),this.withRefVideo(c=>{this.isMobile?(c.style.zIndex="2",c.style.display="block",c.style.top="0",c.style.left="0",c.style.opacity="0.25",c.style.width="20px",c.style.height="15px"):(c.style.zIndex="-1",c.style.display="none",c.style.width="100px",c.style.height="70px"),c.style.objectFit="cover",c.style.objectPosition="left top",c.muted=!0,c.volume=0,c.playsInline=!0,c.autoplay=!1,c.controls=!1,c.loop=!0,this.videoElement.after(c),this.referenceVideoFrameBuffer=new O(c,e),this.referenceVideoFrameBuffer.isMobile=this.isMobile,this.referenceVideoFrameBuffer.start()}),this.syncVideoSizes()),this.referenceVideoElement.src=r,this.referenceVideoElement.play().then(()=>{this.showButton("compare")}).catch(()=>{this.hideButton("compare")})})}hideButton(t){let e=this.getButtonForTool(t);e.style.display="none"}showButton(t){let e=this.getButtonForTool(t);e.style.display=""}addSingletonShape(t){let e=this.serialize([t])[0],n=this.shapes.filter(a=>a.type!==t.type);this.replaceFrame(this.playbackFrame,[...n,e])}serialize(t=this.shapes){let e=this.canvasWidth,n=this.canvasHeight;return t.map(a=>this.pluginForTool(a.type).normalize(a,e,n))}deserialize(t){let e=1/this.canvasWidth,n=1/this.canvasHeight;return t.map(a=>this.pluginForTool(a.type).normalize(a,e,n))}getRelativeCoords(t){let e=this.canvas.getBoundingClientRect();return{x:this.getEventX(t)-e.left,y:this.getEventY(t)-e.top}}handleMouseDown(t){if(t.preventDefault(),this.isMouseDown=!0,Y(t))return;let e=this.frameFromProgressBar(t,!0);if(e){this.isProgressBarNavigation=!0;let n=this.getAnnotationFrame(t);this.isVideoPaused&&(n!==null?this.playbackFrame=n:this.playbackFrame=e);return}this.currentTool&&this.pluginForTool(this.currentTool).onPointerDown(t)}get isDrawing(){return this.currentTool?this.pluginForTool(this.currentTool).isDrawing:!1}get isVideoPaused(){return this.videoElement.tagName==="VIDEO"?this.videoElement.paused:!0}get hasGlobalOverlays(){return this.globalShapes.length>0}handleMouseMove(t){if(t.preventDefault(),!Y(t)){if(this.isMouseDown){let e=this.isProgressBarNavigation?this.frameFromProgressBar(t,!1):null;if(e!==null&&!this.isDrawing){if(e===this.lastNavigatedFrame)return;this.lastNavigatedFrame=e,this.isVideoPaused&&(this.playbackFrame=e);return}else this.hideControls(),this.clearCanvas(),this.hasGlobalOverlays||this.addVideoOverlay(),this.drawShapesOverlay()}else this.redrawFullCanvas();this.currentTool&&this.pluginForTool(this.currentTool).onPointerMove(t)}}getEventX(t){return t.clientX}getEventY(t){return t.clientY}handleMouseUp(t){this.isMouseDown=!1,this.isProgressBarNavigation=!1,this.showControls(),!Y(t)&&(this.currentTool&&this.pluginForTool(this.currentTool).onPointerUp(t),this.redrawFullCanvas())}focusOnMediaNode(){this.videoElement.focus()}drawShapesOverlay(){var e,n;let t={strokeStyle:this.ctx.strokeStyle,fillStyle:this.ctx.fillStyle,lineWidth:this.ctx.lineWidth,globalAlpha:this.ctx.globalAlpha};for(let a of this.deserialize(this.globalShapes)){this.ctx.strokeStyle=a.strokeStyle,this.ctx.fillStyle=a.fillStyle,this.ctx.lineWidth=a.lineWidth,this.ctx.globalAlpha=(e=a.opacity)!=null?e:1;try{this.pluginForTool(a.type).draw(a)}catch(s){console.error(s)}}for(let a of this.deserialize(this.shapes)){this.ctx.strokeStyle=a.strokeStyle,this.ctx.fillStyle=a.fillStyle,this.ctx.lineWidth=a.lineWidth,this.ctx.globalAlpha=(n=a.opacity)!=null?n:1;try{this.pluginForTool(a.type).draw(a)}catch(s){console.error(s)}}this.ctx.strokeStyle=t.strokeStyle,this.ctx.fillStyle=t.fillStyle,this.ctx.lineWidth=t.lineWidth,this.ctx.globalAlpha=t.globalAlpha}clearCanvas(){this.ctx.clearRect(0,0,this.canvasWidth,this.canvasHeight)}frameToDataUrl(){try{this.clearCanvas(),this.addVideoOverlay(),this.addFrameSquareOverlay(),this.drawShapesOverlay();let t=this.canvas.toDataURL("image/png");return this.redrawFullCanvas(),t}catch(t){return console.error(t),null}}redrawFullCanvas(){this.hasGlobalOverlays||(this.clearCanvas(),this.addVideoOverlay()),this.drawShapesOverlay(),this.addFrameSquareOverlay(),this.addProgressBarOverlay()}replaceFrame(t,e){this.timeStack.set(t,this.parseShapes(this.stringifyShapes(e)))}addShapesToFrame(t,e){let n=this.timeStack.get(t)||[];this.timeStack.set(t,[...n,...this.parseShapes(this.stringifyShapes(e))])}setFrameRate(t){var e;(e=this.destructors.find(n=>n.name==="frameRateDetector"))==null||e(),this.fps=t}stringifyShapes(t){return JSON.stringify(t,(e,n)=>e==="image"?n.src:n)}parseShapes(t){return JSON.parse(t,(e,n)=>{if(e==="image"){let a=new Image;return a.src=n,a}return n})}filterNonSerializableShapes(t){return t.filter(e=>e.type!=="image")}saveCurrentFrame(){return{frame:this.playbackFrame,version:1,fps:this.fps,shapes:this.parseShapes(this.stringifyShapes(this.filterNonSerializableShapes(this.shapes)))}}loadAllFrames(t){this.cleanFrameStacks(),t.forEach(e=>{this.timeStack.set(e.frame,e.shapes)})}appendFrames(t){t.forEach(e=>{this.addShapesToFrame(e.frame,e.shapes)})}saveAllFrames(){return Array.from(this.timeStack.keys()).filter(a=>{var s;return(s=this.timeStack.get(a))==null?void 0:s.length}).map(a=>{var s;return{frame:a,fps:this.fps,version:1,shapes:this.filterNonSerializableShapes((s=this.timeStack.get(a))!=null?s:[])}})}getAnnotationFrame(t){var h,r;let e=t.offsetX,n=t.offsetY,a=this.isMobile?10:5;return(r=(h=this.annotatedFrameCoordinates.find(l=>e>=l.x-a&&e<=l.x+a&&n>=l.y-a&&n<=l.y+a))==null?void 0:h.frame)!=null?r:null}get totalFrames(){if(this._enforcedTotalFrames!==null)return this._enforcedTotalFrames;let t=this.videoElement;return t.tagName!=="VIDEO"?1:Math.round(t.duration*this.fps)}setTotalFrames(t){this._enforcedTotalFrames=t!==null?Math.max(1,Math.round(t)):null}getEnforcedTotalFrames(){return this._enforcedTotalFrames}frameFromProgressBar(t,e=!0){if(this.videoElement.tagName!=="VIDEO")return null;let{x:a,width:s,height:h,y:r}=this.progressBarCoordinates,l=t.offsetX,c=t.offsetY,d=()=>{let m=Math.round((l-a)/s*this.totalFrames);return Math.max(1,Math.min(m,this.totalFrames))};return e?l>=a&&l<=a+s&&c>=r&&c<=r+h?d():null:l>=a&&l<=a+s?d():null}hasAnnotationsForFrame(t){if(this.globalShapes.length>0)return!0;if(this.timeStack.has(t)){let e=this.timeStack.get(t);return e&&e.length>0}return!1}stopAnnotationsAsVideo(){this.isAnnotationsAsVideoActive=!1}startAnnotationsAsVideo(){this.isAnnotationsAsVideoActive=!0,this.playAnnotationsAsVideo()}playAnnotationsAsVideo(){this.isAnnotationsAsVideoActive&&(this.hasGlobalOverlays||this.clearCanvas(),this.isMobile?this.hasGlobalOverlays||this.addVideoOverlay():this.addVideoOverlay(),this.drawShapesOverlay(),(this.isCursorOverCanvas||this.isMobile)&&(this.addFrameSquareOverlay(),this.addProgressBarOverlay()))}};function se(o=this.activeTimeFrame){this.ctx.save(),this.ctx.fillStyle="rgba(0, 0, 0, 0.5)";let i=50,t=30,e=20;this.ctx.fillRect(this.canvasWidth-i,this.canvasHeight-t,i,t),this.ctx.fillStyle="white",this.ctx.font=`${e}px sans-serif`,this.ctx.fillText(`${o}`.padStart(3,"0"),this.canvasWidth-40,this.canvasHeight-7),this.ctx.restore()}function re(){var l,c,d;let o=this.videoElement;if(o.tagName!=="VIDEO")return;let i=o.getBoundingClientRect(),t=this.canvas.getBoundingClientRect(),e=i.left-t.left,n=i.top-t.top,a=(l=this.videoFrameBuffer)==null?void 0:l.frameNumberFromTime(o.currentTime),s=(d=(c=this.videoFrameBuffer)==null?void 0:c.getFrame(a||0))!=null?d:o,h=s?s.width:o.videoWidth,r=s?s.height:o.videoHeight;this.ctx.drawImage(s,0,0,h,r,e,n,this.canvasWidth,this.canvasHeight)}function le(){if(this.videoElement.tagName!=="VIDEO")return;this.annotatedFrameCoordinates=[];let t=Array.from(this.timeStack.keys()).filter(u=>{var v;return(v=this.timeStack.get(u))==null?void 0:v.length}),e=this.totalFrames,{x:n,width:a,height:s,y:h}=this.progressBarCoordinates,r=t.map(u=>Math.round(u/e*a));this.ctx.save(),this.ctx.fillStyle="rgba(0, 0, 0, 0.5)",this.ctx.fillRect(n,h,a,s),this.ctx.fillStyle=V.y;let l=this.isMobile?16:8;r.forEach((u,v)=>{this.ctx.beginPath();let f=n+u,g=this.canvasHeight-s/2;this.ctx.fillRect(f-l/2,g-l/2,l,l),this.annotatedFrameCoordinates.push({x:f,y:g,frame:t[v]})});let c=this.playbackFrame,d=Math.round(c/e*a)+n;this.ctx.fillStyle="white",this.ctx.beginPath();let m=d,p=this.canvasHeight-s/2;this.ctx.beginPath(),this.ctx.fillRect(m-l/2,p-l/2,l,l),this.ctx.fill(),this.ctx.restore()}B.prototype.initUI=qt;B.prototype.initCanvas=_t;B.prototype.addFrameSquareOverlay=se;B.prototype.addVideoOverlay=re;B.prototype.addProgressBarOverlay=le;new EventSource("/esbuild").addEventListener("change",()=>location.reload());var I=document.querySelector("video");function he(){return T(this,null,function*(){let o=window.getComputedStyle(I),i=parseFloat(o.width),t=parseFloat(o.height),e=window.innerHeight-80;if(t>e){let u=i/t,v=e,f=v*u;I.style.width=`${f}px`,I.style.height=`${v}px`}let n=yield fetch(I.currentSrc).then(u=>u.blob()),a=new Promise(u=>{setTimeout(()=>{u(!0)},250),I.addEventListener("loadeddata",()=>{u(!0)},{once:!0})}),s=yield fetch("./frame_29.png").then(u=>T(this,null,function*(){let v=yield u.blob(),f=new Blob([v],{type:"image/png"}),g=new Image,b=new Promise(S=>{g.addEventListener("load",()=>{S(!0)},{once:!0})});return g.src=window.URL.createObjectURL(f),yield b,g}));I.paused||I.pause();let h=new Blob([n],{type:"video/mp4"}),r=new B(I);yield r.setVideoBlob(h,30),yield a,yield r.addReferenceVideoByURL("./mov_bbb_g.mp4"),requestAnimationFrame(()=>{r.setCanvasSize()}),r.enableVideoFrameBuffer(),console.log({tool:r}),r.addShapesToFrame(29,[{type:"image",image:s,x:0,y:0,width:1,height:1,strokeStyle:"red",lineWidth:2,fillStyle:"red"}]),I.paused||I.pause(),setInterval(()=>{r.destroy(),r.init(I)},1e8),setInterval(()=>{console.log(r.saveAllFrames())},1e5);let l=document.getElementById("file"),c=document.getElementById("download"),d=document.getElementById("sample"),m=document.getElementById("video"),p=document.getElementById("ref-video");m.addEventListener("change",u=>T(this,null,function*(){if(!m.files||m.files.length===0)return;let v=prompt("Enter FPS","30");if(!v)return;let f=m.files[0],g=new Blob([f],{type:f.type});yield r.setVideoBlob(g,parseInt(v,10))})),p.addEventListener("change",u=>T(this,null,function*(){if(!p.files||p.files.length===0)return;let v=prompt("Enter FPS","30");if(!v)return;let f=p.files[0],g=new Blob([f],{type:f.type}),b=window.URL.createObjectURL(g);yield r.addReferenceVideoByURL(b,parseInt(v,10),f.type)})),d.addEventListener("click",u=>{u.stopPropagation(),u.preventDefault(),fetch("./annotations-sample.json").then(v=>v.json()).then(v=>{r.loadAllFrames(v),r.redrawFullCanvas()})}),l.addEventListener("change",u=>{if(!l.files||l.files.length===0)return;let v=l.files[0],f=new FileReader;f.onload=g=>{if(!g.target)return;let b=g.target.result,S=JSON.parse(b);confirm("Append to existing annotations?")?r.appendFrames(S):r.loadAllFrames(S),r.redrawFullCanvas()},f.readAsText(v)}),c.addEventListener("click",u=>{u.stopPropagation(),u.preventDefault();let v=r.saveAllFrames(),f=document.createElement("a");f.href=URL.createObjectURL(new Blob([JSON.stringify(v)],{type:"application/json"}));let g=new Date().toISOString().replace(/:/g,"-");f.download=`annotations-${g}.json`,f.click()})})}I.readyState===0?I.addEventListener("loadedmetadata",()=>{requestAnimationFrame(()=>{he()})},{once:!0}):he();})();
