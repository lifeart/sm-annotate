"use strict";(()=>{var dt=Object.defineProperty,mt=Object.defineProperties;var ut=Object.getOwnPropertyDescriptors;var Y=Object.getOwnPropertySymbols;var pt=Object.prototype.hasOwnProperty,vt=Object.prototype.propertyIsEnumerable;var j=(s,i,t)=>i in s?dt(s,i,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[i]=t,f=(s,i)=>{for(var t in i||(i={}))pt.call(i,t)&&j(s,t,i[t]);if(Y)for(var t of Y(i))vt.call(i,t)&&j(s,t,i[t]);return s},x=(s,i)=>mt(s,ut(i));var I=(s,i,t)=>new Promise((e,n)=>{var o=a=>{try{h(t.next(a))}catch(c){n(c)}},l=a=>{try{h(t.throw(a))}catch(c){n(c)}},h=a=>a.done?e(a.value):Promise.resolve(a.value).then(o,l);h((t=t.apply(s,i)).next())});function q(s,i){let t=document.createElement("button");t.type="button",t.style.margin="5px",t.style.float="right",t.title="Download current frame",t.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-image"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"></rect><circle cx="9" cy="9" r="2"></circle><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"></path></svg>',i.addEvent(t,"click",()=>{let e=i.frameToDataUrl();if(!e)return;let n=document.createElement("a");n.download=`frame_${String(i.activeTimeFrame).padStart(3,"0")}.png`,n.href=e,n.click()}),i.buttons.push(t),i.playerControlsContainer.appendChild(t)}var $='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-volume-x"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><line x1="22" x2="16" y1="9" y2="15"></line><line x1="16" x2="22" y1="9" y2="15"></line></svg>',K='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-volume-2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path><path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path></svg>';function _(s,i){let t=document.createElement("button");t.type="button",t.style.margin="5px",s.muted||s.volume===0?t.innerHTML=K:t.innerHTML=$,i.addEvent(s,"volumechange",()=>{s.muted||s.volume===0?t.innerHTML=$:t.innerHTML=K}),i.addEvent(t,"click",()=>{s.muted&&(s.muted=!1),s.volume===0?s.volume=1:s.volume=0}),i.buttons.push(t),i.playerControlsContainer.appendChild(t)}var J='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>',gt='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pause"><rect width="4" height="16" x="6" y="4"></rect><rect width="4" height="16" x="14" y="4"></rect></svg>';function G(s,i){let t=document.createElement("button");t.type="button",t.innerHTML=J,t.style.margin="5px";let e=function(n){i.referenceVideoElement&&n(i.referenceVideoElement)};i.addEvent(s,"play",()=>{t.innerHTML=gt}),i.addEvent(s,"pause",()=>{t.innerHTML=J,i.syncTime()}),i.addEvent(t,"click",()=>{s.paused?(e(n=>{n.paused&&(n.play(),i.syncTime())}),s.play()):(e(n=>{n.paused||n.pause()}),s.pause(),requestAnimationFrame(()=>{i.syncTime(),i.redrawFullCanvas()}))}),i.buttons.push(t),i.playerControlsContainer.appendChild(t)}function Z(s){return`<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-superscript">
        <style>
            .small {
                font-family: auto;
                font-size: ${s===1?"16":"24"}px;
            }
        </style>
        <text x="${s===1?3:2}" y="${s===1?17:20}" font-weight="normal" class="small">${{"0.25":"\xBC","0.5":"\xBD","0.75":"\xBE",1:"1\xD7"}[String(s)]}</text>
        
    </svg>`}function Q(s,i){let t=[.25,.5,.75,1],e=document.createElement("button"),n=t[t.length-1],o=function(l){i.referenceVideoElement&&l(i.referenceVideoElement)};e.type="button",s.playbackRate=n,o(l=>{l.playbackRate=n}),e.innerHTML=Z(n),e.style.margin="5px",i.addEvent(e,"click",()=>{let l=t.indexOf(s.playbackRate),h=l+1>=t.length?0:l+1;s.playbackRate=t[h],o(a=>{a.playbackRate=t[h]}),e.innerHTML=Z(t[h])}),i.buttons.push(e),i.playerControlsContainer.appendChild(e)}var yt="#F3CE32";function tt(){var m,g;let s=document.createElement("div");s.style.position="absolute",s.style.top="-40px",s.style.left="0",s.style.zIndex="2",(m=this.canvas.parentNode)==null||m.insertBefore(s,this.canvas);let i=document.createElement("div");i.style.position="relative",i.style.top="0",i.style.left="0",i.style.zIndex="2",(g=this.canvas.parentNode)==null||g.insertBefore(i,this.canvas.nextSibling),this.playerControlsContainer=i;let t=this.videoElement.tagName==="VIDEO"?this.videoElement:null;this.uiContainer=s;let e=(p,r,d=s)=>{let u=document.createElement("button");if(u.type="button",u.innerHTML=p,u.style.margin="5px",d.appendChild(u),this.buttons.push(u),typeof r=="function")this.addEvent(u,"click",r);else{u.dataset.tool=r;let v=()=>{this.currentTool===r?this.currentTool=null:this.currentTool=r};this.addEvent(u,"click",v)}return u},n=()=>{let p=document.createElement("div");return p.style.display="inline-flex",p.style.alignItems="center",p.style.margin="5px",s.appendChild(p),p};e('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></svg>',"rectangle"),e('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle></svg>',"circle"),e('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.3 8.7 8.7 21.3c-1 1-2.5 1-3.4 0l-2.6-2.6c-1-1-1-2.5 0-3.4L15.3 2.7c1-1 2.5-1 3.4 0l2.6 2.6c1 1 1 2.5 0 3.4Z"></path><path d="m7.5 10.5 2 2"></path><path d="m10.5 7.5 2 2"></path><path d="m13.5 4.5 2 2"></path><path d="m4.5 13.5 2 2"></path></svg>',"line"),e('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9.06 11.9 8.07-8.06a2.85 2.85 0 1 1 4.03 4.03l-8.06 8.08"></path><path d="M7.07 14.94c-1.66 0-3 1.35-3 3.02 0 1.33-2.5 1.52-2 2.02 1.08 1.1 2.49 2.02 4 2.02 2.2 0 4-1.8 4-4.04a3.01 3.01 0 0 0-3-3.02z"></path></svg>',"curve"),e('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>',"arrow"),e('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="4 7 4 4 20 4 20 7"></polyline><line x1="9" y1="20" x2="15" y2="20"></line><line x1="12" y1="4" x2="12" y2="20"></line></svg>',"text"),e('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m7 21-4.3-4.3c-1-1-1-2.5 0-3.4l9.6-9.6c1-1 2.5-1 3.4 0l5.6 5.6c1 1 1 2.5 0 3.4L13 21"></path><path d="M22 21H7"></path><path d="m5 11 9 9"></path></svg>',"eraser"),e('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="5 9 2 12 5 15"></polyline><polyline points="9 5 12 2 15 5"></polyline><polyline points="15 19 12 22 9 19"></polyline><polyline points="19 9 22 12 19 15"></polyline><line x1="2" y1="12" x2="22" y2="12"></line><line x1="12" y1="2" x2="12" y2="22"></line></svg>',"move"),e('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-flip-horizontal"><path d="M8 3H5a2 2 0 0 0-2 2v14c0 1.1.9 2 2 2h3"></path><path d="M16 3h3a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-3"></path><path d="M12 20v2"></path><path d="M12 14v2"></path><path d="M12 8v2"></path><path d="M12 2v2"></path></svg>',"compare"),e('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7v6h6"></path><path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"></path></svg>',()=>{this.handleUndo()}),t&&(e('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="19 20 9 12 19 4 19 20"></polygon><line x1="5" y1="19" x2="5" y2="5"></line></svg>',()=>{this.prevFrame()},this.playerControlsContainer),G(t,this),e('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 4 15 12 5 20 5 4"></polygon><line x1="19" y1="5" x2="19" y2="19"></line></svg>',()=>{this.nextFrame()},this.playerControlsContainer),_(t,this),Q(t,this),q(t,this));let o=document.createElement("input");o.type="color",o.value=yt,o.style.margin="5px",this.colorPicker=o,s.appendChild(o);let l=n(),h=document.createElement("input");h.type="number",h.step="1",h.min="1",h.max="10",h.value="5",h.style.margin="5px",l.appendChild(h);let a=p=>{this.ctx.lineWidth=p.target.valueAsNumber,this.focusOnMediaNode()};this.addEvent(h,"input",a);let c=p=>{this.ctx.strokeStyle=p.target.value,this.ctx.fillStyle=p.target.value,this.focusOnMediaNode()};if(this.addEvent(o,"input",c),this.colorPicker=o,this.strokeSizePicker=h,this.getButtonForTool("compare").style.display="none",t){this.hide(),this.addEvent(t,"pause",()=>{this.show()}),this.addEvent(t,"seek",()=>{t.paused&&this.show(),this.syncTime()}),this.addEvent(t,"timeupdate",()=>{t.currentTime<2e-4&&!t.paused&&this.playAnnotationsAsVideo(),this.syncTime()}),this.addEvent(t,"seeking",()=>{this.syncTime()}),this.addEvent(t,"error",()=>{this.hide()}),this.addEvent(t,"stalled",()=>{this.hide()}),this.addEvent(t,"waiting",()=>{this.hide()}),this.addEvent(t,"ended",()=>{this.hide()}),this.addEvent(t,"play",()=>{this.hideControls(),this.playAnnotationsAsVideo()});let p=r=>{let d=r.target===document.body,u=this.uiContainer.contains(r.target),v=this.playerControlsContainer.contains(r.target),T=this.videoElement.contains(r.target),E=this.canvas.contains(r.target);return u||v||T||E||d};this.addEvent(document,"copy",r=>{var d;p(r)&&(r.preventDefault(),r.stopPropagation(),r.stopImmediatePropagation(),(d=r.clipboardData)==null||d.setData("application/json",JSON.stringify(this.saveCurrentFrame())))}),this.addEvent(document,"cut",r=>{var u;if(!p(r))return;r.preventDefault(),r.stopPropagation(),r.stopImmediatePropagation();let d=this.saveCurrentFrame();this.replaceFrame(this.playbackFrame,[]),this.redrawFullCanvas(),(u=r.clipboardData)==null||u.setData("application/json",JSON.stringify(d))}),this.addEvent(document,"paste",r=>{var T,E,W,z,O;if(!p(r))return;let d=(E=(T=r.clipboardData)==null?void 0:T.types)!=null?E:[];if(console.log("dataTypes",JSON.stringify(d)),d.includes("application/json"))r.preventDefault(),r.stopPropagation(),r.stopImmediatePropagation();else if(d.includes("Files")){let S=(W=r.clipboardData)==null?void 0:W.files;if(S&&S.length>0){let U=S[0];if(U.type.startsWith("image/")){r.preventDefault(),r.stopPropagation(),r.stopImmediatePropagation();let C=new Image;C.addEventListener("load",()=>{let ht=C.naturalWidth/C.naturalHeight,X=.25,ct=X/ht*this.aspectRatio;this.addShapesToFrame(this.playbackFrame,[{type:"image",image:C,x:0,y:0,width:X,height:ct,strokeStyle:"red",fillStyle:"red",lineWidth:2}]),this.redrawFullCanvas(),requestAnimationFrame(()=>{this.show()}),this.currentTool="move"},{once:!0}),C.src=URL.createObjectURL(U),this.redrawFullCanvas()}}}else if(d.includes("text/plain")){let S=(z=r.clipboardData)==null?void 0:z.getData("text/plain");S&&(console.log("text",S),r.preventDefault(),r.stopPropagation(),r.stopImmediatePropagation(),this.addShapesToFrame(this.playbackFrame,[{type:"text",text:S,x:.4,y:.4,strokeStyle:this.ctx.strokeStyle,fillStyle:this.ctx.fillStyle,lineWidth:this.ctx.lineWidth}]),this.show(),this.currentTool="move",this.redrawFullCanvas())}else return;let u=(O=r.clipboardData)==null?void 0:O.getData("application/json");if(!u)return;let v=JSON.parse(u);v&&v.shapes&&v.version===1&&(this.addShapesToFrame(this.playbackFrame,v.shapes),this.redrawFullCanvas())}),this.addEvent(document,"click",r=>{if(!p(r))return;let d=this.uiContainer.contains(r.target),u=this.playerControlsContainer.contains(r.target);d||u||t.paused||(this.currentTool=null,t.pause(),requestAnimationFrame(()=>{this.syncTime(),this.redrawFullCanvas()}))}),this.addEvent(document,"keydown",r=>{p(r)&&(r.key==="ArrowLeft"||r.key==="ArrowRight"?(r.preventDefault(),r.stopPropagation(),r.stopImmediatePropagation(),r.key==="ArrowLeft"?this.prevFrame():r.key==="ArrowRight"&&this.nextFrame()):r.code==="Space"&&(r.preventDefault(),r.stopPropagation(),r.stopImmediatePropagation(),t.paused?t.play():(t.pause(),requestAnimationFrame(()=>{this.syncTime(),this.redrawFullCanvas()}))))})}}function et(){var s;this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"),(s=this.videoElement.parentNode)==null||s.insertBefore(this.canvas,this.videoElement.nextSibling),this.canvas.style.position="absolute",this.canvas.style.top="0",this.canvas.style.left="0",this.canvas.style.zIndex="1",this.addEvent(this.canvas,"pointerdown",this.handleMouseDown),this.addEvent(this.canvas,"pointermove",this.handleMouseMove),this.addEvent(this.canvas,"pointerup",this.handleMouseUp),this.addEvent(this.canvas,"pointercancel",this.handleMouseUp),this.addEvent(window,"resize",this.setCanvasSize),this.addEvent(document,"keydown",this.onKeyDown)}var y=class{constructor(i){this.startX=0;this.startY=0;this.isDrawing=!1;this.annotationTool=i}get ctx(){return this.annotationTool.ctx}onDeactivate(){}onActivate(){}reset(){this.startX=0,this.startY=0,this.isDrawing=!1}save(i){this.annotationTool.addShape(i)}};var P=class extends y{constructor(){super(...arguments);this.name="rectangle"}move(t,e,n){return t.x+=e,t.y+=n,t}normalize(t,e,n){return x(f({},t),{x:t.x/e,y:t.y/n,width:t.width/e,height:t.height/n})}onPointerDown(t){let{x:e,y:n}=this.annotationTool.getRelativeCoords(t);this.startX=e,this.startY=n,this.isDrawing=!0}onPointerMove(t){if(!this.isDrawing)return;let{x:e,y:n}=this.annotationTool.getRelativeCoords(t);this.drawRectangle(this.startX,this.startY,e-this.startX,n-this.startY)}onPointerUp(t){if(!this.isDrawing)return;let{x:e,y:n}=this.annotationTool.getRelativeCoords(t);this.save({type:"rectangle",x:this.startX,y:this.startY,width:e-this.startX,height:n-this.startY,strokeStyle:this.ctx.strokeStyle,fillStyle:this.ctx.fillStyle,lineWidth:this.ctx.lineWidth}),this.drawRectangle(this.startX,this.startY,e-this.startX,n-this.startY),this.isDrawing=!1}drawRectangle(t,e,n,o){this.ctx.beginPath(),this.ctx.rect(t,e,n,o),this.ctx.stroke()}draw(t){this.drawRectangle(t.x,t.y,t.width,t.height)}};var k=class extends y{constructor(){super(...arguments);this.name="circle"}move(t,e,n){return t.x+=e,t.y+=n,t}normalize(t,e,n){return x(f({},t),{x:t.x/e,y:t.y/n,radius:t.radius/e})}onPointerDown(t){let{x:e,y:n}=this.annotationTool.getRelativeCoords(t);this.startX=e,this.startY=n,this.isDrawing=!0}onPointerMove(t){if(!this.isDrawing)return;let{x:e,y:n}=this.annotationTool.getRelativeCoords(t),o=Math.sqrt(Math.pow(e-this.startX,2)+Math.pow(n-this.startY,2));this.drawCircle(this.startX,this.startY,o)}onPointerUp(t){if(!this.isDrawing)return;let{x:e,y:n}=this.annotationTool.getRelativeCoords(t),o=Math.sqrt(Math.pow(e-this.startX,2)+Math.pow(n-this.startY,2));this.save({type:"circle",x:this.startX,y:this.startY,radius:o,strokeStyle:this.ctx.strokeStyle,fillStyle:this.ctx.fillStyle,lineWidth:this.ctx.lineWidth}),this.drawCircle(this.startX,this.startY,o),this.isDrawing=!1}drawCircle(t,e,n){this.ctx.beginPath(),this.ctx.arc(t,e,n,0,2*Math.PI),this.ctx.stroke()}draw(t){this.drawCircle(t.x,t.y,t.radius)}};var F=class{constructor(i,t){this.x=i;this.y=t}distanceToLine(i,t){let e=t.x-i.x,n=t.y-i.y,o=Math.abs(n*this.x-e*this.y+t.x*i.y-t.y*i.x),l=Math.sqrt(n*n+e*e);return o/l}};function M(s,i){if(s.length<=2)return s;let t=s[0],e=s[s.length-1],n=-1,o=0;for(let l=1;l<s.length-1;l++){let h=s[l].distanceToLine(t,e);h>o&&(n=l,o=h)}if(o>i){let l=M(s.slice(0,n+1),i),h=M(s.slice(n),i);return l.slice(0,l.length-1).concat(h)}else return[t,e]}var D=class extends y{constructor(){super(...arguments);this.name="curve";this.curvePoints=[]}move(t,e,n){return t.points=t.points.map(o=>({x:o.x+e,y:o.y+n})),t}normalize(t,e,n){return x(f({},t),{points:t.points.map(o=>({x:o.x/e,y:o.y/n}))})}draw(t){this.drawCurve(t)}reset(){super.reset(),this.curvePoints=[]}onPointerDown(t){if(this.isDrawing)return;let{x:e,y:n}=this.annotationTool.getRelativeCoords(t);this.curvePoints=[],this.startX=e,this.startY=n,this.isDrawing=!0,this.curvePoints.push({x:e,y:n})}onPointerMove(t){if(!this.isDrawing)return;let{x:e,y:n}=this.annotationTool.getRelativeCoords(t);this.curvePoints.push({x:e,y:n}),this.drawCurve({points:this.curvePoints,lineWidth:this.ctx.lineWidth})}onPointerUp(t){if(!this.isDrawing)return;let{x:e,y:n}=this.annotationTool.getRelativeCoords(t);this.curvePoints.push({x:e,y:n});let o=this.curvePoints.map(m=>new F(m.x,m.y)),c={type:"curve",points:M(o,2).map(m=>({x:m.x,y:m.y})),strokeStyle:this.ctx.strokeStyle,fillStyle:this.ctx.fillStyle,lineWidth:this.ctx.lineWidth};this.save(c),this.curvePoints=[],this.isDrawing=!1}drawCurve(t){if(t.points.length===2&&t.points[0].x===t.points[1].x&&t.points[0].y===t.points[1].y){let e=t.lineWidth/4,n=0,o=2*Math.PI;this.ctx.beginPath(),this.ctx.arc(t.points[0].x,t.points[0].y,e,n,o),this.ctx.stroke()}else{this.ctx.beginPath(),this.ctx.moveTo(t.points[0].x,t.points[0].y);for(let e=1;e<t.points.length-1;e++){let n=t.points[e],o=t.points[e+1];this.ctx.quadraticCurveTo(n.x,n.y,o.x,o.y)}this.ctx.stroke()}}};var L=class extends y{constructor(){super(...arguments);this.name="line"}move(t,e,n){return t.x1+=e,t.y1+=n,t.x2+=e,t.y2+=n,t}normalize(t,e,n){return x(f({},t),{x1:t.x1/e,y1:t.y1/n,x2:t.x2/e,y2:t.y2/n})}onPointerDown(t){let{x:e,y:n}=this.annotationTool.getRelativeCoords(t);this.startX=e,this.startY=n,this.isDrawing=!0}onPointerMove(t){if(!this.isDrawing)return;let{x:e,y:n}=this.annotationTool.getRelativeCoords(t);this.drawLine(this.startX,this.startY,e,n)}onPointerUp(t){if(!this.isDrawing)return;let{x:e,y:n}=this.annotationTool.getRelativeCoords(t);this.save({type:"line",x1:this.startX,y1:this.startY,x2:e,y2:n,fillStyle:this.ctx.fillStyle,strokeStyle:this.ctx.strokeStyle,lineWidth:this.ctx.lineWidth}),this.drawLine(this.startX,this.startY,e,n),this.isDrawing=!1}drawLine(t,e,n,o){this.ctx.beginPath(),this.ctx.moveTo(t,e),this.ctx.lineTo(n,o),this.ctx.stroke()}draw(t){this.drawLine(t.x1,t.y1,t.x2,t.y2)}};var B=class extends y{constructor(){super(...arguments);this.name="arrow"}normalize(t,e,n){return x(f({},t),{x1:t.x1/e,y1:t.y1/n,x2:t.x2/e,y2:t.y2/n})}move(t,e,n){return t.x1+=e,t.y1+=n,t.x2+=e,t.y2+=n,t}draw(t){this.drawArrow(t.x1,t.y1,t.x2,t.y2)}onPointerDown(t){let{x:e,y:n}=this.annotationTool.getRelativeCoords(t);this.startX=e,this.startY=n,this.isDrawing=!0}onPointerMove(t){if(!this.isDrawing)return;let{x:e,y:n}=this.annotationTool.getRelativeCoords(t);this.drawArrow(this.startX,this.startY,e,n)}onPointerUp(t){if(!this.isDrawing)return;this.isDrawing=!1;let{x:e,y:n}=this.annotationTool.getRelativeCoords(t);this.save({type:"arrow",x1:this.startX,y1:this.startY,x2:e,y2:n,strokeStyle:this.ctx.strokeStyle,fillStyle:this.ctx.fillStyle,lineWidth:this.ctx.lineWidth})}drawArrow(t,e,n,o){let l=10+2.5*this.ctx.lineWidth,h=Math.PI/6,a=Math.atan2(o-e,n-t);this.ctx.beginPath(),this.ctx.moveTo(t,e),this.ctx.lineTo(n,o),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(n,o),this.ctx.lineTo(n-l*Math.cos(a+h),o-l*Math.sin(a+h)),this.ctx.moveTo(n,o),this.ctx.lineTo(n-l*Math.cos(a-h),o-l*Math.sin(a-h)),this.ctx.stroke()}};var R=class extends y{constructor(){super(...arguments);this.name="text"}move(t,e,n){return t.x+=e,t.y+=n,t}onActivate(){this.annotationTool.canvas.style.cursor="text",this.isDrawing=!0}onDeactivate(){this.annotationTool.canvas.style.cursor="default",this.isDrawing=!1}draw(t){let e=t.text.split(`
`);for(let n=0;n<e.length;n++)this.drawText(t.x,t.y+n*20,e[n])}drawText(t,e,n){let o=16+this.ctx.lineWidth*.5;this.ctx.font=`${o}px Helvetica Neue, Arial`,this.ctx.fillText(n,t,e)}onPointerDown(t){let{x:e,y:n}=this.annotationTool.getRelativeCoords(t);this.startX=e,this.startY=n}onPointerMove(t){let{x:e,y:n}=this.annotationTool.getRelativeCoords(t);this.ctx.beginPath(),this.ctx.arc(e,n,5,0,2*Math.PI),this.ctx.fill()}normalize(t,e,n){return x(f({},t),{x:t.x/e,y:t.y/n})}onPointerUp(t){let{x:e,y:n}=this.annotationTool.getRelativeCoords(t),o=prompt("Enter the text to be drawn:");o!==null&&this.save({type:"text",x:e,y:n,text:o,strokeStyle:this.ctx.strokeStyle,fillStyle:this.ctx.fillStyle,lineWidth:this.ctx.lineWidth})}};var A=class extends y{constructor(){super(...arguments);this.name="eraser"}move(t,e,n){return t.x+=e,t.y+=n,t}normalize(t,e,n){return x(f({},t),{x:t.x/e,y:t.y/n,width:t.width/e,height:t.height/n})}draw(t){this.drawEraser(t.x,t.y,t.width,t.height)}onPointerDown(t){let{x:e,y:n}=this.annotationTool.getRelativeCoords(t);this.startX=e,this.startY=n,this.isDrawing=!0}onPointerMove(t){if(!this.isDrawing)return;let{x:e,y:n}=this.annotationTool.getRelativeCoords(t);this.ctx.save(),this.ctx.strokeStyle="rgba(255, 255, 255, 0.5)",this.ctx.lineWidth=1,this.ctx.fillStyle="rgba(255, 255, 255, 0.3)",this.ctx.fillRect(this.startX,this.startY,e-this.startX,n-this.startY),this.ctx.strokeRect(this.startX,this.startY,e-this.startX,n-this.startY),this.ctx.restore()}onPointerUp(t){if(!this.isDrawing)return;this.isDrawing=!1;let{x:e,y:n}=this.annotationTool.getRelativeCoords(t);this.save({type:"eraser",x:this.startX,y:this.startY,width:e-this.startX,height:n-this.startY,strokeStyle:this.ctx.strokeStyle,fillStyle:this.ctx.fillStyle,lineWidth:this.ctx.lineWidth})}drawEraser(t,e,n,o){this.ctx.clearRect(t,e,n,o)}};var V=class extends y{constructor(){super(...arguments);this.name="move";this.shape=null;this.lastDrawnShape=null;this.shapeRemoved=!1;this.isScale=!1}move(t){return t}normalize(t){return f({},t)}onPointerDown(t){let{x:e,y:n}=this.annotationTool.getRelativeCoords(t),o=this.annotationTool.shapes.slice(0).pop();o&&(this.shape=o,this.shapeRemoved=!1,this.lastDrawnShape=null,this.startX=e,this.startY=n,this.isDrawing=!0,this.isScale=o.type==="image"?this.isPointerAtCorner(o,e,n):!1)}isPointerAtCorner(t,e,n){let o=this.annotationTool.deserialize([t])[0],l=15,h=Math.abs(o.y-n)<l,a=Math.abs(o.x-e)<l,c=Math.abs(o.x+o.width-e)<l,m=Math.abs(o.y+o.height-n)<l;return h&&a||h&&c||m&&a||m&&c}onPointerMove(t){if(!this.isDrawing||!this.shape)return;this.shapeRemoved||(this.annotationTool.removeLastShape(),this.shapeRemoved=!0);let{x:e,y:n}=this.annotationTool.getRelativeCoords(t),o=e-this.startX,l=n-this.startY;this.startX=e-o,this.startY=n-l;let h=this.annotationTool.deserialize([this.shape])[0],a=h.type==="image"?h:JSON.parse(JSON.stringify(h));if(a.type==="image")if(this.isScale){let{width:c,height:m}=a,g=c/m,p=c+o,r=p/g;a.width=p,a.height=r,this.lastDrawnShape=a,this.annotationTool.pluginForTool(a.type).draw(a)}else{let c=this.annotationTool.pluginForTool(a.type).move(a,o,l);this.lastDrawnShape=c,this.annotationTool.pluginForTool(a.type).draw(c)}else{let c=this.annotationTool.pluginForTool(a.type).move(a,o,l);this.lastDrawnShape=c,this.annotationTool.pluginForTool(a.type).draw(c)}}onPointerUp(t){!this.isDrawing||!this.lastDrawnShape||(this.lastDrawnShape&&(this.lastDrawnShape.fillStyle=this.annotationTool.ctx.fillStyle,this.lastDrawnShape.strokeStyle=this.annotationTool.ctx.strokeStyle,this.lastDrawnShape.lineWidth=this.annotationTool.ctx.lineWidth,this.save(this.lastDrawnShape)),this.isDrawing=!1,this.isScale=!1,this.shape=null,this.shapeRemoved=!1,this.lastDrawnShape=null)}draw(){throw new Error("Method not implemented.")}reset(){this.isDrawing=!1,this.shape=null,this.isScale=!1,this.lastDrawnShape=null,this.shapeRemoved=!1}};var H=class extends y{constructor(){super(...arguments);this.name="image"}move(t,e,n){return t.x+=e,t.y+=n,t}onPointerDown(t){}onPointerMove(t){}onPointerUp(t){}normalize(t,e,n){return x(f({},t),{x:t.x/e,y:t.y/n,width:t.width/e,height:t.height/n})}draw(t){if(!(t.image instanceof HTMLImageElement)){console.error("Image is not an instance of HTMLImageElement");return}this.ctx.drawImage(t.image,t.x,t.y,t.width,t.height)}};var N=class extends y{constructor(){super(...arguments);this.name="compare";this.comparisonLine=0;this.leftOpacity=1;this.rightOpacity=1;this.isDrawing=!1}move(t,e,n){return t.x+=e,t}onActivate(){this.comparisonLine=this.annotationTool.canvasWidth/2,this.leftOpacity=.7,this.rightOpacity=.7,this.annotationTool.canvas.style.cursor="col-resize",this.annotationTool.syncTime(!0)}onDeactivate(){this.annotationTool.canvas.style.cursor="default",this.comparisonLine=0,this.leftOpacity=1,this.rightOpacity=1,this.isDrawing=!1}normalize(t,e){return x(f({},t),{x:t.x/e})}onPointerDown(t){let{x:e,y:n}=this.annotationTool.getRelativeCoords(t);this.startX=e,this.startY=n,this.isDrawing=!0,this.annotationTool.syncTime(!0),this.onPointerMove(t)}onPointerMove(t){if(!this.isDrawing){if(this.annotationTool.globalShapes.length>0){let o=this.annotationTool.globalShapes[0];if(o.type==="compare"){let l=this.annotationTool.deserialize([o])[0];this.draw(l),this.annotationTool.addFrameSquareOverlay()}}return}let{x:e}=this.annotationTool.getRelativeCoords(t);this.comparisonLine=e;let n={type:"compare",strokeStyle:this.ctx.strokeStyle,fillStyle:this.ctx.fillStyle,lineWidth:this.ctx.lineWidth,x:e};this.draw(n),this.drawDelimiter(n)}onPointerUp(){this.isDrawing&&(this.save({type:"compare",strokeStyle:this.ctx.strokeStyle,fillStyle:this.ctx.fillStyle,lineWidth:this.ctx.lineWidth,x:this.comparisonLine}),this.isDrawing=!1)}save(t){this.annotationTool.globalShapes=this.annotationTool.globalShapes.filter(n=>n.type!=="compare");let e=this.annotationTool.serialize([t])[0];e.x<.05||e.x>.95||this.annotationTool.addGlobalShape(e)}drawDelimiter(t){this.ctx.beginPath(),this.ctx.moveTo(t.x,0),this.ctx.lineTo(t.x,this.annotationTool.canvasWidth),this.ctx.stroke()}draw(t){let e=this.annotationTool.videoElement,n=this.annotationTool.referenceVideoElement;if(!e||!n)return;this.annotationTool.syncTime();let o=this.ctx.globalAlpha,l=this.annotationTool.canvasWidth,h=this.annotationTool.canvasHeight,a=t.x;this.ctx.globalAlpha=this.leftOpacity;let c=a/l,m=a;this.ctx.drawImage(e,0,0,c*e.videoWidth,e.videoHeight,0,0,m,h);let g=a,p=l-g,r=p/l*e.videoWidth;this.ctx.globalAlpha=this.rightOpacity,this.ctx.drawImage(n,g/l*e.videoWidth,0,r,e.videoHeight,g,0,p,h),this.ctx.globalAlpha=o}};var it=[P,k,L,B,R,A,D,V,H,N];function nt(s,i){let t,e,n,o=[],l=!0;function h(m,g){let p=Math.abs(g.mediaTime-t),r=Math.abs(g.presentedFrames-e),d=p/r;d&&d<1&&l&&o.length<50&&s.playbackRate===1&&document.hasFocus()&&(o.push(d),n=Math.round(1/c()),i(n,o.length*2)),l=!0,t=g.mediaTime,e=g.presentedFrames,s.requestVideoFrameCallback(h)}s.requestVideoFrameCallback(h);let a=()=>{o.pop(),l=!1};s.addEventListener("seeked",a);function c(){return o.reduce((m,g)=>m+g)/o.length}return()=>{s.removeEventListener("seeked",a)}}var ot=25,b=class{constructor(i){this.isMouseDown=!1;this.activeTimeFrame=1;this.buttons=[];this.destructors=[];this.plugins=[];this.isDestroyed=!1;this.globalShapes=[];this.timeStack=new Map;this.undoTimeStack=new Map;this.annotatedFrameCoordinates=[];this.fps=ot;this.lastNavigatedFrame=0;this.isProgressBarNavigation=!1;this.plugins=it.map(t=>new t(this)),this.init(i)}prevFrame(){let i=this.activeTimeFrame,t=Math.max(1,i-1);this.playbackFrame=t}nextFrame(){let i=this.activeTimeFrame,t=Math.min(this.videoElement.duration*this.fps,i+1);this.playbackFrame=t}addGlobalShape(i){this.globalShapes.push(i)}get selectedColor(){return this.colorPicker.value}get selectedStrokeSize(){return this.strokeSizePicker.valueAsNumber}get currentTool(){return this._currentTool}set currentTool(i){let t=this._currentTool;t&&(this.getButtonForTool(t).classList.remove("active"),this.pluginForTool(t).onDeactivate()),this._currentTool=i,this.canvas.style.cursor=i?"pointer":"default",i&&(this.getButtonForTool(i).classList.add("active"),this.pluginForTool(i).onActivate())}enableFrameRateDetection(){if(this.destructors.find(e=>e.name==="frameRateDetector"))return;let i=this.videoElement;if(i.tagName==="IMG")return;let t=nt(i,e=>{this.fps=e});Object.defineProperty(t,"name",{value:"frameRateDetector"}),this.destructors.push(t)}get playbackFrame(){if(this.videoElement instanceof HTMLImageElement)return 1;let i=Math.round(this.videoElement.currentTime*this.fps);return Math.max(1,i)}set playbackFrame(i){if(this.videoElement instanceof HTMLImageElement)return;let t=i/this.fps;this.videoElement.currentTime=t,this.syncTime(),this.show()}get canvasWidth(){return this.canvas.width/this.pixelRatio}get canvasHeight(){return this.canvas.height/this.pixelRatio}get aspectRatio(){return this.canvasWidth/this.canvasHeight}get isMobile(){return window.innerWidth<960}get progressBarCoordinates(){let i=this.isMobile?30:10,t=5,e=55,n=this.canvasWidth-t-e,o=t,l=this.canvasHeight-i;return{x:o,y:l,width:n,height:i}}get videoClientRect(){return this.videoElement.getBoundingClientRect()}get shapes(){return this.timeStack.has(this.activeTimeFrame)||this.timeStack.set(this.activeTimeFrame,[]),this.timeStack.get(this.activeTimeFrame)}set shapes(i){this.timeStack.set(this.activeTimeFrame,i)}get undoStack(){return this.undoTimeStack.has(this.activeTimeFrame)||this.undoTimeStack.set(this.activeTimeFrame,[]),this.undoTimeStack.get(this.activeTimeFrame)}set undoStack(i){this.undoTimeStack.set(this.activeTimeFrame,i)}get pixelRatio(){return window.devicePixelRatio||1}hide(){this.stopAnnotationsAsVideo(),this.hideControls(),this.hideCanvas()}showControls(){this.uiContainer.style.display="block"}hideControls(){this.uiContainer.style.display="none"}showCanvas(){this.canvas.style.display="block"}hideCanvas(){this.canvas.style.display="none"}show(){this.stopAnnotationsAsVideo(),this.activeTimeFrame=this.playbackFrame,this.showCanvas(),this.showControls(),this.redrawFullCanvas()}setCanvasSettings(){this.ctx.strokeStyle=this.selectedColor,this.ctx.fillStyle=this.selectedColor,this.ctx.lineWidth=this.selectedStrokeSize}pluginForTool(i){if(this.isDestroyed)throw new Error("AnnotationTool is destroyed");let t=this.plugins.find(e=>e.name===i);if(!t)throw new Error(`No plugin found for tool ${i}`);return t}getButtonForTool(i){return this.buttons.find(t=>t.dataset.tool===i)}bindContext(){this.handleMouseDown=this.handleMouseDown.bind(this),this.handleMouseMove=this.handleMouseMove.bind(this),this.handleMouseUp=this.handleMouseUp.bind(this),this.setCanvasSize=this.setCanvasSize.bind(this),this.onKeyDown=this.onKeyDown.bind(this)}initProperties(){this.isDestroyed=!1,this.isProgressBarNavigation=!1,this.currentTool=null,this.shapes=[],this.globalShapes=[]}init(i){this.videoElement=i,this.videoElement.style.objectFit="cover",this.videoElement.style.objectPosition="left top",this.bindContext(),this.initCanvas(),this.initUI(),this.initProperties(),this.setCanvasSize(),this.fillCanvas(),this.setCanvasSettings(),this.currentTool=this.isMobile?null:"curve"}addEvent(i,t,e){let n=o=>{this.isDestroyed||e(o)};i.addEventListener(t,n),this.destructors.push(()=>{i.removeEventListener(t,n)})}initCanvas(){throw new Error("Method not implemented.")}onKeyDown(i){(i.ctrlKey||i.metaKey)&&i.key.toLowerCase()==="z"&&this.handleUndo()}removeLastShape(){this.shapes.pop(),this.redrawFullCanvas()}handleUndo(){this.undoStack.length>0&&(this.shapes=this.undoStack.pop(),this.redrawFullCanvas())}destroy(){var n,o,l,h,a,c;if(this.isDestroyed)return;this.destructors.forEach(m=>m()),this.stopAnnotationsAsVideo(),this.destructors=[],this.globalShapes=[],this._currentTool=null,this.plugins.forEach(m=>m.reset()),this.annotatedFrameCoordinates=[],this.setFrameRate(ot),this.cleanFrameStacks();let i=this.strokeSizePicker.parentElement;if((n=i==null?void 0:i.parentNode)==null||n.removeChild(i),this.referenceVideoElement){let m=this.referenceVideoElement.parentElement;(o=m==null?void 0:m.parentNode)==null||o.removeChild(m),this.referenceVideoElement=null}let t=this.colorPicker.parentElement;(l=t==null?void 0:t.parentNode)==null||l.removeChild(t),this.buttons.forEach(m=>{var g;(g=m.parentNode)==null||g.removeChild(m)}),this.buttons=[],(h=this.uiContainer.parentNode)==null||h.removeChild(this.uiContainer),(a=this.canvas.parentNode)==null||a.removeChild(this.canvas),(c=this.playerControlsContainer.parentElement)==null||c.removeChild(this.playerControlsContainer),["strokeSizePicker","colorPicker","uiContainer","playerControlsContainer","canvas","ctx","videoElement"].forEach(m=>{delete this[m]}),this.activeTimeFrame=0,this.isDestroyed=!0}setCanvasSize(){let i=this.videoClientRect;this.canvas.width=i.width*this.pixelRatio,this.canvas.height=i.height*this.pixelRatio,this.canvas.style.width=`${i.width}px`,this.canvas.style.height=`${i.height}px`,this.ctx.scale(this.pixelRatio,this.pixelRatio),this.redrawFullCanvas(),this.setCanvasSettings(),this.syncVideoSizes()}isMultiTouch(i){return i.pointerType==="touch"&&i.isPrimary===!1}addShape(i){let t=this.serialize([i])[0];this.undoStack.push([...this.shapes]),this.shapes.push(t)}syncTime(i=!1){let t=this.videoElement;if(!t||t.tagName!=="VIDEO"||!this.referenceVideoElement||this.referenceVideoElement.readyState<4||!i&&!this.globalShapes.length)return;Math.abs(this.referenceVideoElement.currentTime-t.currentTime)>=this.msPerFrame/3&&(this.referenceVideoElement.currentTime=t.currentTime)}get msPerFrame(){return this.fps/1e3}syncVideoSizes(){if(!this.referenceVideoElement)return;let t=this.videoElement.getBoundingClientRect();this.referenceVideoElement.style.position="fixed",this.referenceVideoElement.style.top=`${t.top}px`,this.referenceVideoElement.style.left=`${t.left}px`}addReferenceVideoByURL(i){return I(this,null,function*(){let t=yield fetch(i).then(o=>o.blob()),e=new Blob([t],{type:"video/mp4"}),n=window.URL.createObjectURL(e);this.referenceVideoElement||(this.referenceVideoElement=document.createElement("video"),this.referenceVideoElement.style.zIndex="-1",this.referenceVideoElement.style.display="none",this.referenceVideoElement.style.objectFit="cover",this.referenceVideoElement.style.objectPosition="left top",this.referenceVideoElement.muted=!0,this.referenceVideoElement.playsInline=!0,this.referenceVideoElement.autoplay=!1,this.referenceVideoElement.controls=!1,this.referenceVideoElement.loop=!0,this.videoElement.after(this.referenceVideoElement),this.syncVideoSizes()),this.referenceVideoElement.src=n,this.getButtonForTool("compare").style.display=""})}addSingletonShape(i){let t=this.serialize([i])[0],e=this.shapes.filter(n=>n.type!==i.type);this.replaceFrame(this.playbackFrame,[...e,t])}serialize(i=this.shapes){let t=this.canvasWidth,e=this.canvasHeight;return i.map(n=>this.pluginForTool(n.type).normalize(n,t,e))}deserialize(i){let t=1/this.canvasWidth,e=1/this.canvasHeight;return i.map(n=>this.pluginForTool(n.type).normalize(n,t,e))}getRelativeCoords(i){let t=this.canvas.getBoundingClientRect();return{x:this.getEventX(i)-t.left,y:this.getEventY(i)-t.top}}handleMouseDown(i){if(i.preventDefault(),this.isMouseDown=!0,this.isMultiTouch(i))return;let t=this.frameFromProgressBar(i,!0);if(t){this.isProgressBarNavigation=!0;let e=this.getAnnotationFrame(i);this.isVideoPaused&&(e!==null?this.playbackFrame=e:this.playbackFrame=t);return}this.currentTool&&this.pluginForTool(this.currentTool).onPointerDown(i)}get isDrawing(){return this.currentTool?this.pluginForTool(this.currentTool).isDrawing:!1}get isVideoPaused(){return this.videoElement.tagName==="VIDEO"?this.videoElement.paused:!0}handleMouseMove(i){if(i.preventDefault(),!this.isMultiTouch(i)){if(this.isMouseDown){let t=this.isProgressBarNavigation?this.frameFromProgressBar(i,!1):null;if(t!==null&&!this.isDrawing){if(t===this.lastNavigatedFrame)return;this.lastNavigatedFrame=t,this.isVideoPaused&&(this.playbackFrame=t);return}else this.hideControls(),this.clearCanvas(),this.addVideoOverlay(),this.drawShapesOverlay()}else this.redrawFullCanvas();this.currentTool&&this.pluginForTool(this.currentTool).onPointerMove(i)}}getEventX(i){return i.clientX}getEventY(i){return i.clientY}handleMouseUp(i){this.isMouseDown=!1,this.isProgressBarNavigation=!1,this.showControls(),!this.isMultiTouch(i)&&(this.currentTool&&this.pluginForTool(this.currentTool).onPointerUp(i),this.redrawFullCanvas())}focusOnMediaNode(){this.videoElement.focus()}drawShapesOverlay(){let i={strokeStyle:this.ctx.strokeStyle,fillStyle:this.ctx.fillStyle,lineWidth:this.ctx.lineWidth};this.deserialize(this.globalShapes).forEach(t=>{this.ctx.strokeStyle=t.strokeStyle,this.ctx.fillStyle=t.fillStyle,this.ctx.lineWidth=t.lineWidth;try{this.pluginForTool(t.type).draw(t)}catch(e){console.error(e)}}),this.deserialize(this.shapes).forEach(t=>{this.ctx.strokeStyle=t.strokeStyle,this.ctx.fillStyle=t.fillStyle,this.ctx.lineWidth=t.lineWidth;try{this.pluginForTool(t.type).draw(t)}catch(e){console.error(e)}}),this.ctx.strokeStyle=i.strokeStyle,this.ctx.fillStyle=i.fillStyle,this.ctx.lineWidth=i.lineWidth}clearCanvas(){this.ctx.clearRect(0,0,this.canvasWidth,this.canvasHeight)}frameToDataUrl(){try{this.clearCanvas(),this.addVideoOverlay(),this.addFrameSquareOverlay(),this.drawShapesOverlay();let i=this.canvas.toDataURL("image/png");return this.redrawFullCanvas(),i}catch(i){return console.error(i),null}}redrawFullCanvas(){this.clearCanvas(),this.addVideoOverlay(),this.drawShapesOverlay(),this.addFrameSquareOverlay(),this.addProgressBarOverlay()}replaceFrame(i,t){this.timeStack.set(i,this.parseShapes(this.stringifyShapes(t)))}addShapesToFrame(i,t){let e=this.timeStack.get(i)||[];this.timeStack.set(i,[...e,...this.parseShapes(this.stringifyShapes(t))])}setFrameRate(i){var t;(t=this.destructors.find(e=>e.name==="frameRateDetector"))==null||t(),this.fps=i}stringifyShapes(i){return JSON.stringify(i,(t,e)=>t==="image"?e.src:e)}parseShapes(i){return JSON.parse(i,(t,e)=>{if(t==="image"){let n=new Image;return n.src=e,n}return e})}filterNonSerializableShapes(i){return i.filter(t=>t.type!=="image")}saveCurrentFrame(){return{frame:this.playbackFrame,version:1,fps:this.fps,shapes:this.parseShapes(this.stringifyShapes(this.filterNonSerializableShapes(this.shapes)))}}addFrameSquareOverlay(i=this.activeTimeFrame){throw new Error("Method not implemented.")}addVideoOverlay(){throw new Error("Method not implemented.")}cleanFrameStacks(){this.timeStack.clear(),this.undoTimeStack.clear()}loadAllFrames(i){this.cleanFrameStacks(),i.forEach(t=>{this.timeStack.set(t.frame,t.shapes)})}appendFrames(i){i.forEach(t=>{this.addShapesToFrame(t.frame,t.shapes)})}saveAllFrames(){return Array.from(this.timeStack.keys()).filter(n=>{var o;return(o=this.timeStack.get(n))==null?void 0:o.length}).map(n=>{var o;return{frame:n,fps:this.fps,version:1,shapes:this.filterNonSerializableShapes((o=this.timeStack.get(n))!=null?o:[])}})}getAnnotationFrame(i){var l,h;let t=i.offsetX,e=i.offsetY,n=this.isMobile?10:5;return(h=(l=this.annotatedFrameCoordinates.find(a=>t>=a.x-n&&t<=a.x+n&&e>=a.y-n&&e<=a.y+n))==null?void 0:l.frame)!=null?h:null}frameFromProgressBar(i,t=!0){let e=this.videoElement;if(e.tagName!=="VIDEO")return null;let{x:n,width:o,height:l,y:h}=this.progressBarCoordinates,a=i.offsetX,c=i.offsetY;return t?a>=n&&a<=n+o&&c>=h&&c<=h+l?Math.ceil((a-n)/o*(e.duration*this.fps)):null:a>=n&&a<=n+o?Math.ceil((a-n)/o*(e.duration*this.fps)):null}addProgressBarOverlay(){throw new Error("Method not implemented.")}initUI(){throw new Error("Method not implemented.")}stopAnnotationsAsVideo(){clearTimeout(this.playTimeout)}hasAnnotationsForFrame(i){if(this.globalShapes.length>0)return!0;if(this.timeStack.has(i)){let t=this.timeStack.get(i);return t&&t.length>0}return!1}playAnnotationsAsVideo(){this.stopAnnotationsAsVideo();let i=this.playbackFrame;this.hasAnnotationsForFrame(i)?(this.showCanvas(),this.activeTimeFrame=i,this.syncTime(),this.clearCanvas(),this.drawShapesOverlay()):this.hideCanvas();let t=1e3/this.fps;requestAnimationFrame(()=>{this.syncTime()}),this.playTimeout=window.setTimeout(()=>{this.playAnnotationsAsVideo()},t)}fillCanvas(){}};function st(s=this.activeTimeFrame){this.ctx.save(),this.ctx.fillStyle="rgba(0, 0, 0, 0.5)";let i=50,t=30,e=20;this.ctx.fillRect(this.canvasWidth-i,this.canvasHeight-t,i,t),this.ctx.fillStyle="white",this.ctx.font=`${e}px sans-serif`,this.ctx.fillText(`${s}`.padStart(3,"0"),this.canvasWidth-40,this.canvasHeight-7),this.ctx.restore()}function rt(){let s=this.videoElement;s.tagName==="VIDEO"&&this.ctx.drawImage(s,0,0,s.videoWidth,s.videoHeight,0,0,this.canvasWidth,this.canvasHeight)}function at(){let s=this.videoElement;if(s.tagName!=="VIDEO")return;this.annotatedFrameCoordinates=[];let t=Array.from(this.timeStack.keys()).filter(d=>{var u;return(u=this.timeStack.get(d))==null?void 0:u.length}),e=s.duration*this.fps,{x:n,width:o,height:l,y:h}=this.progressBarCoordinates,a=t.map(d=>Math.ceil(d/e*o));this.ctx.save(),this.ctx.fillStyle="rgba(0, 0, 0, 0.5)",this.ctx.fillRect(n,h,o,l),this.ctx.fillStyle="#F3CE32";let c=this.isMobile?16:8;a.forEach((d,u)=>{this.ctx.beginPath();let v=n+d,T=this.canvasHeight-l/2;this.ctx.fillRect(v-c/2,T-c/2,c,c),this.annotatedFrameCoordinates.push({x:v,y:T,frame:t[u]})});let m=this.playbackFrame,g=Math.ceil(m/e*o)+n;this.ctx.fillStyle="white",this.ctx.beginPath();let p=g,r=this.canvasHeight-l/2;this.ctx.beginPath(),this.ctx.fillRect(p-c/2,r-c/2,c,c),this.ctx.fill(),this.ctx.restore()}b.prototype.initUI=tt;b.prototype.initCanvas=et;b.prototype.addFrameSquareOverlay=st;b.prototype.addVideoOverlay=rt;b.prototype.addProgressBarOverlay=at;new EventSource("/esbuild").addEventListener("change",()=>location.reload());var w=document.querySelector("video");function lt(){return I(this,null,function*(){let s=window.getComputedStyle(w),i=parseFloat(s.width),t=parseFloat(s.height),e=window.innerHeight-80;if(t>e){let r=i/t,d=e,u=d*r;w.style.width=`${u}px`,w.style.height=`${d}px`}let n=yield fetch(w.currentSrc).then(r=>r.blob()),o=new Promise(r=>{setTimeout(()=>{r(!0)},250),w.addEventListener("loadeddata",()=>{r(!0)},{once:!0})}),l=yield fetch("./frame_29.png").then(r=>I(this,null,function*(){let d=yield r.blob(),u=new Blob([d],{type:"image/png"}),v=new Image,T=new Promise(E=>{v.addEventListener("load",()=>{E(!0)},{once:!0})});return v.src=window.URL.createObjectURL(u),yield T,v}));w.paused||w.pause();let h=new Blob([n],{type:"video/mp4"});w.src=window.URL.createObjectURL(h),yield o;let a=new b(w);yield a.addReferenceVideoByURL("./mov_bbb_g.mp4"),a.setFrameRate(30),requestAnimationFrame(()=>{a.setCanvasSize()}),console.log({tool:a}),a.addShapesToFrame(29,[{type:"image",image:l,x:0,y:0,width:1,height:1,strokeStyle:"red",lineWidth:2,fillStyle:"red"}]),w.paused||w.pause(),setInterval(()=>{a.destroy(),a.init(w)},1e8),setInterval(()=>{console.log(a.saveAllFrames())},1e5);let c=document.getElementById("file"),m=document.getElementById("download"),g=document.getElementById("sample");document.getElementById("save-image").addEventListener("click",r=>{r.stopPropagation(),r.preventDefault();let d=a.frameToDataUrl();if(!d)return;let u=a.activeTimeFrame,v=document.createElement("a");v.href=d,v.download=`frame_${String(u).padStart(3,"0")}.png`,v.click()}),g.addEventListener("click",r=>{r.stopPropagation(),r.preventDefault(),fetch("./annotations-sample.json").then(d=>d.json()).then(d=>{a.loadAllFrames(d),a.redrawFullCanvas()})}),c.addEventListener("change",r=>{if(!c.files||c.files.length===0)return;let d=c.files[0],u=new FileReader;u.onload=v=>{if(!v.target)return;let T=v.target.result,E=JSON.parse(T);confirm("Append to existing annotations?")?a.appendFrames(E):a.loadAllFrames(E),a.redrawFullCanvas()},u.readAsText(d)}),m.addEventListener("click",r=>{r.stopPropagation(),r.preventDefault();let d=a.saveAllFrames(),u=document.createElement("a");u.href=URL.createObjectURL(new Blob([JSON.stringify(d)],{type:"application/json"}));let v=new Date().toISOString().replace(/:/g,"-");u.download=`annotations-${v}.json`,u.click()})})}w.readyState===0?w.addEventListener("loadedmetadata",()=>{requestAnimationFrame(()=>{lt()})},{once:!0}):lt();})();
