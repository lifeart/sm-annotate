var Zt=Object.create;var ot=Object.defineProperty,Qt=Object.defineProperties,te=Object.getOwnPropertyDescriptor,ee=Object.getOwnPropertyDescriptors,ie=Object.getOwnPropertyNames,vt=Object.getOwnPropertySymbols,oe=Object.getPrototypeOf,gt=Object.prototype.hasOwnProperty,ne=Object.prototype.propertyIsEnumerable;var yt=Math.pow,ft=(n,o,t)=>o in n?ot(n,o,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[o]=t,v=(n,o)=>{for(var t in o||(o={}))gt.call(o,t)&&ft(n,t,o[t]);if(vt)for(var t of vt(o))ne.call(o,t)&&ft(n,t,o[t]);return n},g=(n,o)=>Qt(n,ee(o));var se=(n,o)=>()=>(o||n((o={exports:{}}).exports,o),o.exports);var ae=(n,o,t,e)=>{if(o&&typeof o=="object"||typeof o=="function")for(let i of ie(o))!gt.call(n,i)&&i!==t&&ot(n,i,{get:()=>o[i],enumerable:!(e=te(o,i))||e.enumerable});return n};var re=(n,o,t)=>(t=n!=null?Zt(oe(n)):{},ae(o||!n||!n.__esModule?ot(t,"default",{value:n,enumerable:!0}):t,n));var T=(n,o,t)=>new Promise((e,i)=>{var s=r=>{try{l(t.next(r))}catch(h){i(h)}},a=r=>{try{l(t.throw(r))}catch(h){i(h)}},l=r=>r.done?e(r.value):Promise.resolve(r.value).then(s,a);l((t=t.apply(n,o)).next())});var Ot=se((Zi,Nt)=>{"use strict";function me(n){for(var o=1/0,t=-1/0,e=0,i=n.length,s;e<i;e++)s=n[e],o>s&&(o=s),t<s&&(t=s);return{min:o,max:t}}function Vt(n,o){var t=Math.pow(2,o-1),e=n<0?n*t:n*(t-1);return Math.max(-t,Math.min(t-1,e))}function zt(n,o,t){var e,i=n.length,s=Math.ceil(i/o),a,l,r,h,c,d,m=Wt(t,s*2);for(e=0;e<s;e++)a=e*o,l=(e+1)*o>i?i:(e+1)*o,r=n.subarray(a,l),d=me(r),c=Vt(d.min,t),h=Vt(d.max,t),m[e*2]=c,m[e*2+1]=h;return m}function Wt(n,o){return new(new Function(`return Int${n}Array`)())(o)}function ue(n,o){var t=n.length,e=1/t,i=n[0].length/2,s=0,a=0,l,r,h=Wt(o,i*2);for(a=0;a<i;a++){for(l=0,r=0,s=0;s<t;s++)l+=e*n[s][a*2],r+=e*n[s][a*2+1];h[a*2]=l,h[a*2+1]=r}return[h]}function J(n,o){return typeof n=="number"?n:o}Nt.exports=function(n,o,t,e,i,s){if(o=J(o,1e3),s=J(s,16),t==null&&(t=!0),[8,16,32].indexOf(s)<0)throw new Error("Invalid number of bits specified for peaks.");var a=n.numberOfChannels,l=[],r,h,c,d;if(e=J(e,0),i=J(i,n.length),typeof n.subarray=="undefined")for(r=0;r<a;r++)c=n.getChannelData(r),d=c.subarray(e,i),l.push(zt(d,o,s));else l.push(zt(n.subarray(e,i),o,s));return t&&l.length>1&&(l=ue(l,s)),h=l[0].length/2,{length:h,data:l,bits:s}}});function xt(n,o){let t=document.createElement("button");t.type="button",t.style.margin="5px",t.style.float="right",t.title="Download current frame",t.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-image"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"></rect><circle cx="9" cy="9" r="2"></circle><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"></path></svg>',o.addEvent(t,"click",()=>{let e=o.frameToDataUrl();if(!e)return;let i=document.createElement("a");i.download=`frame_${String(o.activeTimeFrame).padStart(3,"0")}.png`,i.href=e,i.click()}),o.buttons.push(t),o.playerControlsContainer.appendChild(t)}var wt='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-volume-x"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><line x1="22" x2="16" y1="9" y2="15"></line><line x1="16" x2="22" y1="9" y2="15"></line></svg>',Tt='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-volume-2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path><path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path></svg>';function bt(n,o){let t=document.createElement("button");t.type="button",t.style.margin="5px",n.muted||n.volume===0?t.innerHTML=wt:t.innerHTML=Tt,o.addEvent(n,"volumechange",()=>{n.muted||n.volume===0?t.innerHTML=wt:t.innerHTML=Tt}),o.addEvent(t,"click",()=>{if(n.muted){n.muted=!1;return}n.volume===0?n.volume=1:n.volume=0}),o.buttons.push(t),o.playerControlsContainer.appendChild(t)}var Ct='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>',le='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pause"><rect width="4" height="16" x="6" y="4"></rect><rect width="4" height="16" x="14" y="4"></rect></svg>';function St(n,o){let t=document.createElement("button");t.type="button",t.innerHTML=Ct,t.style.margin="5px",o.addEvent(n,"play",()=>{t.innerHTML=le}),o.addEvent(n,"pause",()=>{t.innerHTML=Ct}),o.addEvent(t,"click",()=>{o.withRefVideo(e=>{e.paused&&e.play().then(()=>{o.showButton("compare")})}),n.paused?n.play().then(()=>{o.redrawFullCanvas()}):(n.pause(),o.raf(()=>{o.redrawFullCanvas()}))}),o.buttons.push(t),o.playerControlsContainer.appendChild(t)}function Et(n){return`<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-superscript">
        <style>
            .small {
                font-family: auto;
                font-size: ${n===1?"16":"24"}px;
            }
        </style>
        <text x="${n===1?3:2}" y="${n===1?17:20}" font-weight="normal" class="small">${{"0.25":"\xBC","0.5":"\xBD","0.75":"\xBE",1:"1\xD7"}[String(n)]}</text>
        
    </svg>`}function kt(n,o){let t=[.25,.5,.75,1],e=document.createElement("button"),i=t[t.length-1];e.type="button",n.playbackRate=i,e.innerHTML=Et(i),e.style.margin="5px",o.addEvent(e,"click",()=>{let s=t.indexOf(n.playbackRate),a=s+1>=t.length?0:s+1;n.playbackRate=t[a],e.innerHTML=Et(t[a])}),o.buttons.push(e),o.playerControlsContainer.appendChild(e)}var L=class{constructor(o,t){this.create=(o,t,e=this.uiContainer)=>{let i=document.createElement("button");if(i.type="button",i.innerHTML=o,i.style.margin="5px",e.appendChild(i),this.buttons.push(i),typeof t=="function")this.addEvent(i,"click",t);else{i.dataset.tool=t;let s=()=>{this.currentTool===t?this.currentTool=null:this.currentTool=t};try{this.tool.pluginForTool(t),this.addEvent(i,"click",s)}catch(a){console.error(a),i.disabled=!0}}return i};this.tool=o,this.uiContainer=t}get buttons(){return this.tool.buttons}get addEvent(){return this.tool.addEvent.bind(this.tool)}get currentTool(){return this.tool.currentTool}set currentTool(o){this.tool.currentTool=o}};function It(n,o){let t=n.videoElement.tagName==="VIDEO"?n.videoElement:null;o.create('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></svg>',"rectangle"),o.create('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle></svg>',"circle"),o.create('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.3 8.7 8.7 21.3c-1 1-2.5 1-3.4 0l-2.6-2.6c-1-1-1-2.5 0-3.4L15.3 2.7c1-1 2.5-1 3.4 0l2.6 2.6c1 1 1 2.5 0 3.4Z"></path><path d="m7.5 10.5 2 2"></path><path d="m10.5 7.5 2 2"></path><path d="m13.5 4.5 2 2"></path><path d="m4.5 13.5 2 2"></path></svg>',"line"),o.create('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9.06 11.9 8.07-8.06a2.85 2.85 0 1 1 4.03 4.03l-8.06 8.08"></path><path d="M7.07 14.94c-1.66 0-3 1.35-3 3.02 0 1.33-2.5 1.52-2 2.02 1.08 1.1 2.49 2.02 4 2.02 2.2 0 4-1.8 4-4.04a3.01 3.01 0 0 0-3-3.02z"></path></svg>',"curve"),o.create('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>',"arrow"),o.create('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="4 7 4 4 20 4 20 7"></polyline><line x1="9" y1="20" x2="15" y2="20"></line><line x1="12" y1="4" x2="12" y2="20"></line></svg>',"text"),o.create('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m7 21-4.3-4.3c-1-1-1-2.5 0-3.4l9.6-9.6c1-1 2.5-1 3.4 0l5.6 5.6c1 1 1 2.5 0 3.4L13 21"></path><path d="M22 21H7"></path><path d="m5 11 9 9"></path></svg>',"eraser"),o.create('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="5 9 2 12 5 15"></polyline><polyline points="9 5 12 2 15 5"></polyline><polyline points="15 19 12 22 9 19"></polyline><polyline points="19 9 22 12 19 15"></polyline><line x1="2" y1="12" x2="22" y2="12"></line><line x1="12" y1="2" x2="12" y2="22"></line></svg>',"move"),o.create('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-flip-horizontal"><path d="M8 3H5a2 2 0 0 0-2 2v14c0 1.1.9 2 2 2h3"></path><path d="M16 3h3a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-3"></path><path d="M12 20v2"></path><path d="M12 14v2"></path><path d="M12 8v2"></path><path d="M12 2v2"></path></svg>',"compare"),o.create('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7v6h6"></path><path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"></path></svg>',()=>{n.handleUndo()}),t&&(o.create('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="19 20 9 12 19 4 19 20"></polygon><line x1="5" y1="19" x2="5" y2="5"></line></svg>',()=>{n.prevFrame()},n.playerControlsContainer),St(t,n),o.create('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 4 15 12 5 20 5 4"></polygon><line x1="19" y1="5" x2="19" y2="19"></line></svg>',()=>{n.nextFrame()},n.playerControlsContainer),bt(t,n),kt(t,n),xt(t,n)),o.create(`<svg viewBox="0 0 24 24" width="24" height="24">
      <path fill="currentColor" d="M3 3h18v18H3V3m2 2v14h14V5H5z"/>
      <path fill="currentColor" d="M7 7h10v10H7V7m2 2v6h6V9H9z"/>
    </svg>`,"selection")}var E=(n,o)=>{let t=n.target===document.body,e=o.uiContainer.contains(n.target),i=o.playerControlsContainer.contains(n.target),s=o.videoElement.contains(n.target),a=o.canvas.contains(n.target);return e||i||s||a||t};function V(n){return n.pointerType==="pen"?!1:n.pointerType==="touch"&&n.isPrimary===!1}function Pt(n,o){if(!E(n,o))return;let t=o.uiContainer.contains(n.target),e=o.playerControlsContainer.contains(n.target);if(t||e)return;let i=o.videoElement;i.tagName==="VIDEO"&&(i.paused||(o.currentTool=null,i.pause(),o.raf(()=>T(this,null,function*(){o.redrawFullCanvas()}))))}function Mt(n,o){var t;E(n,o)&&(n.preventDefault(),n.stopPropagation(),n.stopImmediatePropagation(),(t=n.clipboardData)==null||t.setData("application/json",JSON.stringify(o.saveCurrentFrame())))}function Ft(n,o){var e;if(!E(n,o))return;n.preventDefault(),n.stopPropagation(),n.stopImmediatePropagation();let t=o.saveCurrentFrame();o.replaceFrame(o.playbackFrame,[]),o.redrawFullCanvas(),(e=n.clipboardData)==null||e.setData("application/json",JSON.stringify(t))}function Dt(n,o){if(!E(n,o))return;let t=o.videoElement;t.tagName==="VIDEO"&&(n.key==="ArrowLeft"||n.key==="ArrowRight"?(n.preventDefault(),n.stopPropagation(),n.stopImmediatePropagation(),n.key==="ArrowLeft"?o.prevFrame():n.key==="ArrowRight"&&o.nextFrame()):n.code==="Space"&&(n.preventDefault(),n.stopPropagation(),n.stopImmediatePropagation(),t.paused?t.play().then(()=>{o.redrawFullCanvas()}):(t.pause(),o.raf(()=>{o.redrawFullCanvas()}))))}function At(n,o){var s,a,l,r,h;if(!E(n,o))return;let t=(a=(s=n.clipboardData)==null?void 0:s.types)!=null?a:[];if(t.includes("application/json"))n.preventDefault(),n.stopPropagation(),n.stopImmediatePropagation();else if(t.includes("Files")){let c=(l=n.clipboardData)==null?void 0:l.files;if(c&&c.length>0){let d=c[0];if(d.type.startsWith("image/")){n.preventDefault(),n.stopPropagation(),n.stopImmediatePropagation();let m=new Image;m.addEventListener("load",()=>{let u=m.naturalWidth/m.naturalHeight,f=.25,x=f/u*o.aspectRatio;o.addShapesToFrame(o.playbackFrame,[{type:"image",image:m,x:0,y:0,width:f,height:x,strokeStyle:"red",fillStyle:"red",lineWidth:2}]),o.redrawFullCanvas(),o.raf(()=>{o.show()}),o.currentTool="move"},{once:!0}),m.src=URL.createObjectURL(d),o.redrawFullCanvas()}}}else if(t.includes("text/plain")){let c=(r=n.clipboardData)==null?void 0:r.getData("text/plain");c&&(n.preventDefault(),n.stopPropagation(),n.stopImmediatePropagation(),o.addShapesToFrame(o.playbackFrame,[{type:"text",text:c,x:.4,y:.4,strokeStyle:o.ctx.strokeStyle,fillStyle:o.ctx.fillStyle,lineWidth:o.ctx.lineWidth}]),o.show(),o.currentTool="move",o.redrawFullCanvas())}else return;let e=(h=n.clipboardData)==null?void 0:h.getData("application/json");if(!e)return;let i=JSON.parse(e);i&&i.shapes&&i.version===1&&(o.addShapesToFrame(o.playbackFrame,i.shapes),o.redrawFullCanvas())}function Bt(n,o){let t=document.createElement("input");t.type="color",t.value=n,t.style.margin="5px";let e=i=>{o.ctx.strokeStyle=i.target.value,o.ctx.fillStyle=i.target.value,o.focusOnMediaNode()};return o.addEvent(t,"input",e),t}function Ht(n){let o=document.createElement("input");o.type="number",o.step="1",o.min="1",o.max="10",o.value="5",o.style.margin="5px";let t=e=>{n.ctx.lineWidth=e.target.valueAsNumber,n.focusOnMediaNode()};return n.addEvent(o,"input",t),o}var he=(n,o)=>{Object.keys(o).forEach(t=>{let e=t,i=o[e];typeof i=="string"&&(n.style[e]=i)})},ce="#F3CE32";function Rt(){var a,l;let n=document.createElement("div");he(n,{position:"absolute",top:"-40px",left:"0",zIndex:"2"}),n.style.position="absolute",n.style.top="-40px",n.style.left="0",n.style.zIndex="2",(a=this.canvas.parentNode)==null||a.insertBefore(n,this.canvas);let o=document.createElement("div");o.style.position="relative",o.style.top="0",o.style.left="0",o.style.zIndex="2",(l=this.canvas.parentNode)==null||l.insertBefore(o,this.canvas.nextSibling),this.playerControlsContainer=o;let t=this.videoElement.tagName==="VIDEO"?this.videoElement:null;this.uiContainer=n;let e=()=>{let r=document.createElement("div");return r.style.display="inline-flex",r.style.alignItems="center",r.style.margin="5px",r},i=new L(this,n);It(this,i),this.isMobile&&(this.hideButton("line"),this.hideButton("circle"),this.hideButton("rectangle"),this.hideButton("eraser")),this.hideButton("compare"),this.colorPicker=Bt(ce,this),n.appendChild(this.colorPicker);let s=e();this.strokeSizePicker=Ht(this),s.appendChild(this.strokeSizePicker),n.appendChild(s),t&&(this.hide(),this.addEvent(t,"pause",()=>{this.show()}),this.addEvent(t,"seek",()=>{t.paused&&this.show()}),this.addEvent(t,"timeupdate",()=>{t.currentTime<2e-4&&!t.paused&&this.startAnnotationsAsVideo()}),this.addEvent(t,"error",()=>{this.hide()}),this.addEvent(t,"stalled",()=>{this.hide()}),this.addEvent(t,"play",()=>{this.hideControls(),this.startAnnotationsAsVideo()}),this.addEvent(document,"copy",r=>{Mt(r,this)}),this.addEvent(document,"cut",r=>{Ft(r,this)}),this.addEvent(document,"paste",r=>{At(r,this)}),this.addEvent(document,"click",r=>{Pt(r,this)}),this.addEvent(document,"keydown",r=>{Dt(r,this)}),this.addEvent(document.body.querySelector("div"),"drop",r=>{var h;(h=r.dataTransfer)!=null&&h.types}))}function Lt(){var n;this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"),(n=this.videoElement.parentNode)==null||n.insertBefore(this.canvas,this.videoElement.nextSibling),this.canvas.style.position="absolute",this.canvas.style.backgroundColor="transparent",this.canvas.style.top="0",this.canvas.style.left="0",this.canvas.style.zIndex="1",this.addEvent(this.canvas,"pointerdown",this.handleMouseDown),this.addEvent(this.canvas,"pointermove",this.handleMouseMove),this.addEvent(this.canvas,"pointerup",this.handleMouseUp),this.addEvent(this.canvas,"pointercancel",this.handleMouseUp),this.canvas.addEventListener("touchmove",o=>{o.stopImmediatePropagation(),o.stopPropagation(),o.preventDefault()}),this.addEvent(window,"resize",this.setCanvasSize),this.addEvent(document,"keydown",this.onKeyDown)}var z=class{constructor(){this.destructors=[];this.isDestroyed=!1;this.activeTimeFrame=1;this.globalShapes=[];this.timeStack=new Map;this.undoTimeStack=new Map}cleanFrameStacks(){this.timeStack.clear(),this.undoTimeStack.clear()}destroy(){this.destructors.forEach(o=>o()),this.destructors=[],this.globalShapes=[],this.cleanFrameStacks()}raf(o){return requestAnimationFrame(o)}addEvent(o,t,e){let i=s=>{this.isDestroyed||e(s)};o.addEventListener(t,i),this.destructors.push(()=>{o.removeEventListener(t,i)})}addProgressBarOverlay(){throw new Error("Method not implemented.")}initUI(){throw new Error("Method not implemented.")}initCanvas(){throw new Error("Method not implemented.")}addFrameSquareOverlay(o=this.activeTimeFrame){throw new Error("Method not implemented.")}addVideoOverlay(){throw new Error("Method not implemented.")}withRefVideo(o){this.isDestroyed||this.referenceVideoElement&&o(this.referenceVideoElement)}withVideo(o){if(this.isDestroyed)return;let t=this.videoElement;!t||t.tagName!=="VIDEO"||o(t)}};var p=class{constructor(o){this.startX=0;this.startY=0;this.isDrawing=!1;this.annotationTool=o}on(o,t){}get ctx(){return this.annotationTool.ctx}onDeactivate(){}onActivate(){}reset(){this.startX=0,this.startY=0,this.isDrawing=!1}save(o){this.annotationTool.addShape(o)}};var W=class extends p{constructor(){super(...arguments);this.name="rectangle"}move(t,e,i){return t.x+=e,t.y+=i,t}normalize(t,e,i){return g(v({},t),{x:t.x/e,y:t.y/i,width:t.width/e,height:t.height/i})}onPointerDown(t){let{x:e,y:i}=this.annotationTool.getRelativeCoords(t);this.startX=e,this.startY=i,this.isDrawing=!0}onPointerMove(t){if(!this.isDrawing)return;let{x:e,y:i}=this.annotationTool.getRelativeCoords(t);this.drawRectangle(this.startX,this.startY,e-this.startX,i-this.startY)}onPointerUp(t){if(!this.isDrawing)return;let{x:e,y:i}=this.annotationTool.getRelativeCoords(t);this.save({type:"rectangle",x:this.startX,y:this.startY,width:e-this.startX,height:i-this.startY,strokeStyle:this.ctx.strokeStyle,fillStyle:this.ctx.fillStyle,lineWidth:this.ctx.lineWidth}),this.drawRectangle(this.startX,this.startY,e-this.startX,i-this.startY),this.isDrawing=!1}drawRectangle(t,e,i,s){this.ctx.beginPath(),this.ctx.rect(t,e,i,s),this.ctx.stroke()}draw(t){this.drawRectangle(t.x,t.y,t.width,t.height)}};var N=class extends p{constructor(){super(...arguments);this.name="circle"}move(t,e,i){return t.x+=e,t.y+=i,t}normalize(t,e,i){return g(v({},t),{x:t.x/e,y:t.y/i,radius:t.radius/e})}onPointerDown(t){let{x:e,y:i}=this.annotationTool.getRelativeCoords(t);this.startX=e,this.startY=i,this.isDrawing=!0}onPointerMove(t){if(!this.isDrawing)return;let{x:e,y:i}=this.annotationTool.getRelativeCoords(t),s=Math.sqrt(Math.pow(e-this.startX,2)+Math.pow(i-this.startY,2));this.drawCircle(this.startX,this.startY,s)}onPointerUp(t){if(!this.isDrawing)return;let{x:e,y:i}=this.annotationTool.getRelativeCoords(t),s=Math.sqrt(Math.pow(e-this.startX,2)+Math.pow(i-this.startY,2));this.save({type:"circle",x:this.startX,y:this.startY,radius:s,strokeStyle:this.ctx.strokeStyle,fillStyle:this.ctx.fillStyle,lineWidth:this.ctx.lineWidth}),this.drawCircle(this.startX,this.startY,s),this.isDrawing=!1}drawCircle(t,e,i){this.ctx.beginPath(),this.ctx.arc(t,e,i,0,2*Math.PI),this.ctx.stroke()}draw(t){this.drawCircle(t.x,t.y,t.radius)}};var O=class{constructor(o,t){this.x=o;this.y=t}distanceToLine(o,t){let e=t.x-o.x,i=t.y-o.y,s=Math.abs(i*this.x-e*this.y+t.x*o.y-t.y*o.x),a=Math.sqrt(i*i+e*e);return s/a}};function Y(n,o){if(n.length<=2)return n;let t=n[0],e=n[n.length-1],i=-1,s=0;for(let a=1;a<n.length-1;a++){let l=n[a].distanceToLine(t,e);l>s&&(i=a,s=l)}if(s>o){let a=Y(n.slice(0,i+1),o),l=Y(n.slice(i),o);return a.slice(0,a.length-1).concat(l)}else return[t,e]}var X=class extends p{constructor(){super(...arguments);this.name="curve";this.curvePoints=[];this.zoomScale=2;this.zoomRadius=100;this.zoomCtx=null;this.zoomCanvas=null;this.colorMap={r:"#d31a3b",g:"#15d33b",b:"#0085CA",y:"#F3CE32"};this.onKeyPress=t=>{let e=t.key;if(e===null||e===" "||t.isComposing)return;let i=Number(e);if(isNaN(i)||!i){e in this.colorMap&&(this.annotationTool.colorPicker.value=this.colorMap[e],this.annotationTool.setCanvasSettings());return}this.annotationTool.strokeSizePicker.value=e,this.annotationTool.setCanvasSettings()}}move(t,e,i){return t.points=t.points.map(s=>({x:s.x+e,y:s.y+i})),t}onActivate(){this.initZoomCanvas(),document.addEventListener("keypress",this.onKeyPress)}onDeactivate(){this.zoomCtx=null,this.zoomCanvas=null,document.removeEventListener("keypress",this.onKeyPress)}normalize(t,e,i){return g(v({},t),{points:t.points.map(s=>({x:s.x/e,y:s.y/i}))})}draw(t){this.drawCurve(t)}reset(){super.reset(),this.curvePoints=[]}onPointerDown(t){if(this.isDrawing)return;let{x:e,y:i}=this.annotationTool.getRelativeCoords(t);this.curvePoints=[],this.startX=e,this.startY=i,this.isDrawing=!0,this.curvePoints.push({x:e,y:i})}onPointerMove(t){let{x:e,y:i}=this.annotationTool.getRelativeCoords(t);if(!this.isDrawing){this.drawZoomCircle(e,i,t.shiftKey);return}this.curvePoints.push({x:e,y:i}),this.drawCurve({points:this.curvePoints,lineWidth:this.ctx.lineWidth}),this.drawZoomCircle(e,i,t.shiftKey)}onPointerUp(t){let{x:e,y:i}=this.annotationTool.getRelativeCoords(t);if(this.drawZoomCircle(e,i,t.shiftKey),!this.isDrawing)return;this.curvePoints.push({x:e,y:i});let s=this.curvePoints.map(c=>new O(c.x,c.y)),h={type:"curve",points:Y(s,.5).map(c=>({x:c.x,y:c.y})),strokeStyle:this.ctx.strokeStyle,fillStyle:this.ctx.fillStyle,lineWidth:this.ctx.lineWidth};this.save(h),this.curvePoints=[],this.isDrawing=!1}drawCurve(t){if(t.points.length===2&&t.points[0].x===t.points[1].x&&t.points[0].y===t.points[1].y){let e=t.lineWidth/4,i=0,s=2*Math.PI;this.ctx.beginPath(),this.ctx.arc(t.points[0].x,t.points[0].y,e,i,s),this.ctx.stroke()}else{this.ctx.beginPath(),this.ctx.moveTo(t.points[0].x,t.points[0].y);for(let e=0;e<t.points.length-1;e++){let i=t.points[e],s=t.points[e+1];this.ctx.quadraticCurveTo(i.x,i.y,s.x,s.y)}this.ctx.stroke()}}initZoomCanvas(){let t=document.createElement("canvas"),e=2;t.width=this.zoomRadius*2*e,t.height=this.zoomRadius*2*e;let i=t.getContext("2d");i&&(i.imageSmoothingQuality="high",i.imageSmoothingEnabled=!0,this.zoomCtx=i,this.zoomCanvas=t)}drawZoomCircle(t,e,i=!1){if(!i)return;this.isDrawing||(this.annotationTool.clearCanvas(),this.annotationTool.addVideoOverlay(),this.annotationTool.drawShapesOverlay());let s=this.zoomCtx;if(!s)return;let a=this.annotationTool.pixelRatio,l=this.zoomRadius*2/this.zoomScale,r=t-l/2,h=e-l/2;s.clearRect(0,0,this.zoomCanvas.width,this.zoomCanvas.height),s.drawImage(this.ctx.canvas,r*a,h*a,l*a,l*a,0,0,this.zoomRadius*2,this.zoomRadius*2),this.ctx.save(),this.ctx.beginPath(),this.ctx.arc(t,e,this.zoomRadius,0,2*Math.PI),this.ctx.closePath(),this.ctx.clip(),this.ctx.drawImage(this.zoomCanvas,t-this.zoomRadius,e-this.zoomRadius),this.ctx.restore()}};var U=class extends p{constructor(){super(...arguments);this.name="line"}move(t,e,i){return t.x1+=e,t.y1+=i,t.x2+=e,t.y2+=i,t}normalize(t,e,i){return g(v({},t),{x1:t.x1/e,y1:t.y1/i,x2:t.x2/e,y2:t.y2/i})}onPointerDown(t){let{x:e,y:i}=this.annotationTool.getRelativeCoords(t);this.startX=e,this.startY=i,this.isDrawing=!0}onPointerMove(t){if(!this.isDrawing)return;let{x:e,y:i}=this.annotationTool.getRelativeCoords(t);this.drawLine(this.startX,this.startY,e,i)}onPointerUp(t){if(!this.isDrawing)return;let{x:e,y:i}=this.annotationTool.getRelativeCoords(t);this.save({type:"line",x1:this.startX,y1:this.startY,x2:e,y2:i,fillStyle:this.ctx.fillStyle,strokeStyle:this.ctx.strokeStyle,lineWidth:this.ctx.lineWidth}),this.drawLine(this.startX,this.startY,e,i),this.isDrawing=!1}drawLine(t,e,i,s){this.ctx.beginPath(),this.ctx.moveTo(t,e),this.ctx.lineTo(i,s),this.ctx.stroke()}draw(t){this.drawLine(t.x1,t.y1,t.x2,t.y2)}};var j=class extends p{constructor(){super(...arguments);this.name="arrow"}normalize(t,e,i){return g(v({},t),{x1:t.x1/e,y1:t.y1/i,x2:t.x2/e,y2:t.y2/i})}move(t,e,i){return t.x1+=e,t.y1+=i,t.x2+=e,t.y2+=i,t}draw(t){this.drawArrow(t.x1,t.y1,t.x2,t.y2)}onPointerDown(t){let{x:e,y:i}=this.annotationTool.getRelativeCoords(t);this.startX=e,this.startY=i,this.isDrawing=!0}onPointerMove(t){if(!this.isDrawing)return;let{x:e,y:i}=this.annotationTool.getRelativeCoords(t);this.drawArrow(this.startX,this.startY,e,i)}onPointerUp(t){if(!this.isDrawing)return;this.isDrawing=!1;let{x:e,y:i}=this.annotationTool.getRelativeCoords(t);this.save({type:"arrow",x1:this.startX,y1:this.startY,x2:e,y2:i,strokeStyle:this.ctx.strokeStyle,fillStyle:this.ctx.fillStyle,lineWidth:this.ctx.lineWidth})}drawArrow(t,e,i,s){let a=10+2.5*this.ctx.lineWidth,l=Math.PI/6,r=Math.atan2(s-e,i-t);this.ctx.beginPath(),this.ctx.moveTo(t,e),this.ctx.lineTo(i,s),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(i,s),this.ctx.lineTo(i-a*Math.cos(r+l),s-a*Math.sin(r+l)),this.ctx.moveTo(i,s),this.ctx.lineTo(i-a*Math.cos(r-l),s-a*Math.sin(r-l)),this.ctx.stroke()}};var K=class extends p{constructor(){super(...arguments);this.name="text"}move(t,e,i){return t.x+=e,t.y+=i,t}onActivate(){this.annotationTool.canvas.style.cursor="text",this.isDrawing=!0}onDeactivate(){this.annotationTool.canvas.style.cursor="default",this.isDrawing=!1}draw(t){let e=t.text.split(`
`);for(let i=0;i<e.length;i++)this.drawText(t.x,t.y+i*20,e[i])}drawText(t,e,i){let s=16+this.ctx.lineWidth*.5;this.ctx.font=`${s}px Helvetica Neue, Arial`,this.ctx.fillText(i,t,e)}onPointerDown(t){let{x:e,y:i}=this.annotationTool.getRelativeCoords(t);this.startX=e,this.startY=i}onPointerMove(t){let{x:e,y:i}=this.annotationTool.getRelativeCoords(t);this.ctx.beginPath(),this.ctx.arc(e,i,5,0,2*Math.PI),this.ctx.fill()}normalize(t,e,i){return g(v({},t),{x:t.x/e,y:t.y/i})}onPointerUp(t){let{x:e,y:i}=this.annotationTool.getRelativeCoords(t),s=prompt("Enter the text to be drawn:");s!==null&&this.save({type:"text",x:e,y:i,text:s,strokeStyle:this.ctx.strokeStyle,fillStyle:this.ctx.fillStyle,lineWidth:this.ctx.lineWidth})}};var q=class extends p{constructor(){super(...arguments);this.name="eraser"}move(t,e,i){return t.x+=e,t.y+=i,t}normalize(t,e,i){return g(v({},t),{x:t.x/e,y:t.y/i,width:t.width/e,height:t.height/i})}draw(t){this.drawEraser(t.x,t.y,t.width,t.height)}onPointerDown(t){let{x:e,y:i}=this.annotationTool.getRelativeCoords(t);this.startX=e,this.startY=i,this.isDrawing=!0}onPointerMove(t){if(!this.isDrawing)return;let{x:e,y:i}=this.annotationTool.getRelativeCoords(t);this.ctx.save(),this.ctx.strokeStyle="rgba(255, 255, 255, 0.5)",this.ctx.lineWidth=1,this.ctx.fillStyle="rgba(255, 255, 255, 0.3)",this.ctx.fillRect(this.startX,this.startY,e-this.startX,i-this.startY),this.ctx.strokeRect(this.startX,this.startY,e-this.startX,i-this.startY),this.ctx.restore()}onPointerUp(t){if(!this.isDrawing)return;this.isDrawing=!1;let{x:e,y:i}=this.annotationTool.getRelativeCoords(t);this.save({type:"eraser",x:this.startX,y:this.startY,width:e-this.startX,height:i-this.startY,strokeStyle:this.ctx.strokeStyle,fillStyle:this.ctx.fillStyle,lineWidth:this.ctx.lineWidth})}drawEraser(t,e,i,s){this.ctx.clearRect(t,e,i,s)}};var G=class extends p{constructor(){super(...arguments);this.name="move";this.shape=null;this.lastDrawnShape=null;this.shapeRemoved=!1;this.isScale=!1}move(t){return t}normalize(t){return v({},t)}onPointerDown(t){let{x:e,y:i}=this.annotationTool.getRelativeCoords(t),s=this.annotationTool.shapes.slice(0).pop();s&&(this.shape=s,this.shapeRemoved=!1,this.lastDrawnShape=null,this.startX=e,this.startY=i,this.isDrawing=!0,this.isScale=s.type==="image"?this.isPointerAtCorner(s,e,i):!1,this.isScale?this.annotationTool.canvas.style.cursor="nw-resize":this.annotationTool.canvas.style.cursor="move")}isPointerAtCorner(t,e,i){if(!("type"in t))return!1;let s=this.annotationTool.deserialize([t])[0],a=15,l=Math.abs(s.y-i)<a,r=Math.abs(s.x-e)<a,h=Math.abs(s.x+s.width-e)<a,c=Math.abs(s.y+s.height-i)<a;return l&&r||l&&h||c&&r||c&&h}onPointerMove(t){if(!this.isDrawing||!this.shape)return;this.shapeRemoved||(this.annotationTool.removeLastShape(),this.shapeRemoved=!0);let{x:e,y:i}=this.annotationTool.getRelativeCoords(t),s=e-this.startX,a=i-this.startY;this.startX=e-s,this.startY=i-a;let l=this.annotationTool.deserialize([this.shape])[0],r=l.type==="image"?l:JSON.parse(JSON.stringify(l));if(r.type!=="audio-peaks")if(r.type==="image")if(this.isScale){let{width:h,height:c}=r,d=h/c,m=h+s,u=m/d;r.width=m,r.height=u,this.lastDrawnShape=r,this.annotationTool.pluginForTool(r.type).draw(r)}else{let h=this.annotationTool.pluginForTool(r.type).move(r,s,a);this.lastDrawnShape=h,this.annotationTool.pluginForTool(r.type).draw(h)}else{let h=this.annotationTool.pluginForTool(r.type).move(r,s,a);this.lastDrawnShape=h,this.annotationTool.pluginForTool(r.type).draw(h)}}onPointerUp(t){!this.isDrawing||!this.lastDrawnShape||(this.lastDrawnShape&&(this.lastDrawnShape.fillStyle=this.annotationTool.ctx.fillStyle,this.lastDrawnShape.strokeStyle=this.annotationTool.ctx.strokeStyle,this.lastDrawnShape.lineWidth=this.annotationTool.ctx.lineWidth,this.save(this.lastDrawnShape)),this.isDrawing=!1,this.isScale=!1,this.shape=null,this.shapeRemoved=!1,this.lastDrawnShape=null,this.annotationTool.canvas.style.cursor="default")}draw(){throw new Error("Method not implemented.")}reset(){this.isDrawing=!1,this.shape=null,this.isScale=!1,this.lastDrawnShape=null,this.shapeRemoved=!1,this.annotationTool.canvas.style.cursor="default"}};var $=class extends p{constructor(){super(...arguments);this.name="image"}move(t,e,i){return t.x+=e,t.y+=i,t}onPointerDown(t){}onPointerMove(t){}onPointerUp(t){}normalize(t,e,i){return g(v({},t),{x:t.x/e,y:t.y/i,width:t.width/e,height:t.height/i})}draw(t){if(!(t.image instanceof HTMLImageElement)){console.error("Image is not an instance of HTMLImageElement");return}this.ctx.drawImage(t.image,t.x,t.y,t.width,t.height)}};var de=.7,_=class extends p{constructor(){super(...arguments);this.name="compare";this.comparisonLine=0;this.leftOpacity=1;this.rightOpacity=1;this.isDrawing=!1}move(t,e,i){return t.x+=e,t}onActivate(){this.comparisonLine=this.annotationTool.canvasWidth/2,this.leftOpacity=1,this.rightOpacity=this.annotationTool.isMobile?1:de,this.annotationTool.canvas.style.cursor="col-resize"}onDeactivate(){this.annotationTool.canvas.style.cursor="default",this.comparisonLine=0,this.leftOpacity=1,this.rightOpacity=1,this.isDrawing=!1}normalize(t,e){return g(v({},t),{x:t.x/e})}onPointerDown(t){let{x:e,y:i}=this.annotationTool.getRelativeCoords(t);this.startX=e,this.startY=i,this.isDrawing=!0,this.disablePreviousCompare(),this.onPointerMove(t)}onPointerMove(t){if(!this.isDrawing){if(this.annotationTool.globalShapes.length>0){let s=this.annotationTool.globalShapes[0];if(s.type==="compare"){let a=this.annotationTool.deserialize([s])[0];this.draw(a),this.annotationTool.addFrameSquareOverlay()}}return}let{x:e}=this.annotationTool.getRelativeCoords(t);this.comparisonLine=e;let i={type:"compare",strokeStyle:this.ctx.strokeStyle,fillStyle:this.ctx.fillStyle,lineWidth:this.ctx.lineWidth,x:e};this.draw(i),this.drawDelimiter(i)}onPointerUp(){this.isDrawing&&(this.save({type:"compare",strokeStyle:this.ctx.strokeStyle,fillStyle:this.ctx.fillStyle,lineWidth:this.ctx.lineWidth,disabled:!1,x:this.comparisonLine}),this.isDrawing=!1)}removePreviousCompare(){this.annotationTool.globalShapes=this.annotationTool.globalShapes.filter(t=>t.type!=="compare")}disablePreviousCompare(){this.annotationTool.globalShapes=this.annotationTool.globalShapes.map(t=>t.type==="compare"?g(v({},t),{disabled:!0}):t)}save(t){this.removePreviousCompare();let e=this.annotationTool.serialize([t])[0];e.x<.05||e.x>.95||this.annotationTool.addGlobalShape(e)}drawDelimiter(t){this.ctx.beginPath(),this.ctx.moveTo(t.x,0),this.ctx.lineTo(t.x,this.annotationTool.canvasWidth),this.ctx.stroke()}drawShape(t){var rt,lt,ht,ct,dt,mt,ut,pt;let e=this.annotationTool.videoElement,i=this.annotationTool.referenceVideoElement;if(!e||!i)return;let s=this.ctx.globalAlpha,a=this.annotationTool.canvasWidth,l=this.annotationTool.canvasHeight,r=t.x,h=i.videoHeight-e.videoHeight,c=i.videoWidth-e.videoWidth,d=this.annotationTool.isMobile;this.ctx.globalAlpha=this.leftOpacity;let m=(lt=(rt=this.annotationTool.referenceVideoFrameBuffer)==null?void 0:rt.frameNumberFromTime(e.currentTime))!=null?lt:1,u=m;if(c>e.videoWidth&&h>e.videoHeight&&!this.annotationTool.isMobile){let S=(mt=(dt=this.annotationTool.referenceVideoFrameBuffer)==null?void 0:dt.getFrameNumberBySignature((ct=(ht=this.annotationTool.videoFrameBuffer)==null?void 0:ht.getHistogram(m))!=null?ct:null,m))!=null?mt:m,H=Math.abs(m-S);H>=1&&H<=3&&(u=S)}let x=(ut=this.annotationTool.referenceVideoFrameBuffer)==null?void 0:ut.getFrame(u),y=(pt=this.annotationTool.videoFrameBuffer)==null?void 0:pt.getFrame(m);if(d){this.ctx.imageSmoothingQuality="low";let S=r/a,H=r;this.ctx.drawImage(y!=null?y:e,0,0,S*e.videoWidth,e.videoHeight,0,0,H,l)}else{let S=y?y.width:e.videoWidth,H=y?y.height:e.videoHeight;this.ctx.drawImage(y!=null?y:e,0,0,S,H,0,0,a,l)}this.ctx.globalAlpha=this.rightOpacity;let b=0,k=0,tt=e.videoWidth/e.videoHeight,I=i.videoWidth/i.videoHeight,P=Math.abs(tt-I)>.1,w=10,C=Math.abs(h)>w,M=e.videoWidth,et=e.videoHeight,A=0;if(c<-w)if(P){let S=e.videoWidth/a;A=Math.abs(c/2),A=A/S,A<=w&&(A=0)}else M=i.videoWidth;else c>w&&(M=i.videoWidth);if(h===0)b=0;else if(h>0)P?(b=h/2,b<=w&&(b=0)):et=C?i.videoHeight:e.videoHeight;else if(!P)et=C?i.videoHeight:e.videoHeight;else{k=Math.abs(h/2);let S=e.videoHeight/l;k=k/S,k<=w&&(k=0)}let it=r-A,at=a-it,Jt=at/a*M;x?(d&&(this.ctx.imageSmoothingQuality="low"),this.ctx.drawImage(x,it/a*M,b,Jt,et,it+A,k,at,l)):console.log("no video data",m),this.ctx.globalAlpha=s}draw(t){if(t.disabled)return;let e=this.annotationTool.videoElement,i=this.annotationTool.referenceVideoElement;!e||!i||this.drawShape(t)}};function pe(n){let o=n[0],t=n[0];for(let e=1;e<n.length;e++)n[e]<o&&(o=n[e]),n[e]>t&&(t=n[e]);return[o,t]}var Z=class extends p{constructor(t){super(t);this.name="audio-peaks";this.canvas=document.createElement("canvas");this.props={peaks:new Int8Array,theme:{waveOutlineColor:"rgba(255,192,203,0.7)",waveFillColor:"grey",waveProgressColor:"orange"},waveHeight:40,bits:16};this.drawCtx=this.canvas.getContext("2d")}onVideoBlobSet(t){return T(this,null,function*(){let e=yield t.arrayBuffer();this.init(e)})}on(t,e){t==="videoBlobSet"&&this.onVideoBlobSet(e)}extractPeaks(t){return T(this,null,function*(){let{default:e}=yield Promise.resolve().then(()=>re(Ot(),1)),i=this.progressBarCoordinates.width,s=Math.ceil(t.length/i);return e(t,s,!0)})}setProps(t){let[e,i]=pe(t.data[0]),s=Math.pow(2,t.bits-1)-1,a=-Math.pow(2,t.bits-1);this.props.peaks=t.data[0].map(l=>l<0?Math.round(l/e*a):Math.round(l/i*s)),this.props.bits=t.bits}init(t){return T(this,null,function*(){try{let i=yield new AudioContext().decodeAudioData(t),s=yield this.extractPeaks(i);this.initCanvas(),this.setProps(s),this.annotationTool.removeGlobalShape("audio-peaks"),this.annotationTool.addGlobalShape({x:0,y:0,strokeStyle:"red",fillStyle:"red",lineWidth:1,type:"audio-peaks"}),this.clearLocalCanvas(),this.drawOnCanvas()}catch(e){this.initCanvas(),this.props.peaks=new Int8Array,this.annotationTool.removeGlobalShape("audio-peaks"),this.clearLocalCanvas(),console.error(e)}})}initCanvas(){this.canvas.width=this.progressBarCoordinates.width*this.pixelRatio,this.canvas.height=this.props.waveHeight*this.pixelRatio,this.drawCtx.scale(this.pixelRatio,this.pixelRatio)}move(t,e,i){return t.x+=e,t.y+=i,t}normalize(t,e,i){return g(v({},t),{x:t.x/e,y:t.y/i})}onPointerDown(t){}onPointerMove(t){}onPointerUp(t){}reset(){this.clearLocalCanvas(),this.props.peaks=new Int8Array,this.annotationTool.removeGlobalShape("audio-peaks")}draw(t){let e=this.annotationTool.videoElement;if(!e||e.tagName!=="VIDEO"||e.muted||e.volume===0)return;this.ctx.clearRect(0,0,this.annotationTool.canvasWidth,this.annotationTool.canvasHeight);let{waveHeight:s,theme:a}=this.props,l=this.ctx,r=s/2,h=this.progressBarCoordinates.y-20,{x:c,width:d}=this.progressBarCoordinates,m=this.annotationTool.playbackFrame,u=e.duration*this.annotationTool.fps,f=Math.ceil(m/u*d)+c;this.ctx.drawImage(this.canvas,c,h,d,s),l.fillStyle=a.waveProgressColor,l.fillRect(f,h+0,1,r*2)}get pixelRatio(){return this.annotationTool.pixelRatio}get progressBarCoordinates(){return this.annotationTool.progressBarCoordinates}clearLocalCanvas(){this.drawCtx.clearRect(0,0,this.canvas.width,this.canvas.height)}drawOnCanvas(){let{peaks:t,bits:e,waveHeight:i,theme:s}=this.props,a=this.drawCtx,l=0,r=0,h=i/2,c=yt(2,e-1),d=0,m=t.length;a.fillStyle=s.waveOutlineColor;for(let u=0;u<m;u+=1){let f=t[(u+l)*2+1]/c,x=Math.abs(f*h);a.fillRect(u+r,d+0+h-x,1,x)}}};var Q=class extends p{constructor(){super(...arguments);this.name="selection";this.selectedArea=null}move(t,e,i){return t.x+=e,t.y+=i,t}normalize(t,e,i){return g(v({},t),{x:t.x/e,y:t.y/i,width:t.width/e,height:t.height/i})}onPointerDown(t){let{x:e,y:i}=this.annotationTool.getRelativeCoords(t);this.startX=e,this.startY=i,this.isDrawing=!0,this.selectedArea=null}onPointerMove(t){if(!this.isDrawing)return;let{x:e,y:i}=this.annotationTool.getRelativeCoords(t);this.annotationTool.clearCanvas(),this.annotationTool.addVideoOverlay(),this.drawSelectionRect(this.startX,this.startY,e-this.startX,i-this.startY)}onPointerUp(t){if(!this.isDrawing)return;let{x:e,y:i}=this.annotationTool.getRelativeCoords(t),s=Math.min(e,this.startX),a=Math.min(i,this.startY),l=Math.abs(e-this.startX),r=Math.abs(i-this.startY);if(l<1||r<1){this.isDrawing=!1,this.annotationTool.redrawFullCanvas();return}let h=document.createElement("canvas"),c=h.getContext("2d"),d=this.annotationTool.videoElement;if(!(d instanceof HTMLVideoElement))return;let m=d.videoWidth,u=d.videoHeight,f=d.offsetWidth,x=d.offsetHeight,y=m/f,b=u/x,k=s*y,tt=a*b,I=l*y,D=r*b;h.width=Math.max(1,I),h.height=Math.max(1,D);try{c.drawImage(this.annotationTool.videoElement,k,tt,I,D,0,0,I,D);let P=c.getImageData(0,0,h.width,h.height);this.selectedArea=P;let w=document.createElement("canvas");w.width=I+4,w.height=D+4,w.style.width=`${l+4}px`,w.style.height=`${r+4}px`;let C=w.getContext("2d");C.strokeStyle="black",C.lineWidth=2,C.strokeRect(1,1,I+2,D+2),C.strokeStyle="black",C.lineWidth=2,C.strokeRect(2,2,I,D),C.putImageData(P,2,2);let M=new Image;M.onload=()=>{this.annotationTool.pluginForTool("image").save({type:"image",x:s-2,y:a-2,width:l+4,height:r+4,image:M,strokeStyle:"transparent",fillStyle:"transparent",lineWidth:0}),this.isDrawing=!1,this.selectedArea=null,this.annotationTool.redrawFullCanvas()},M.src=w.toDataURL(),this.annotationTool.currentTool="move"}catch(P){console.error("Error capturing selection:",P),this.isDrawing=!1,this.annotationTool.redrawFullCanvas();return}}drawSelectionRect(t,e,i,s){let a=Math.min(t,t+i),l=Math.min(e,e+s),r=Math.abs(i),h=Math.abs(s);this.ctx.fillStyle="rgba(0, 0, 0, 0.5)",this.ctx.fillRect(0,0,this.annotationTool.canvasWidth,this.annotationTool.canvasHeight),this.ctx.clearRect(a,l,r,h),this.ctx.beginPath();let c=this.ctx.strokeStyle;this.ctx.strokeStyle="#ffffff",this.ctx.lineWidth=2,this.ctx.setLineDash([5,5]),this.ctx.strokeRect(a,l,r,h),this.ctx.setLineDash([]),this.ctx.strokeStyle=c}draw(t){this.drawSelectionRect(t.x,t.y,t.width,t.height)}reset(){super.reset(),this.selectedArea=null}};var Yt=[W,N,U,j,K,q,X,G,$,_,Z,Q];function Xt(n,o){let t,e,i,s=[],a=!0;function l(c,d){let m=Math.abs(d.mediaTime-t),u=Math.abs(d.presentedFrames-e),f=m/u;f&&f<1&&a&&s.length<50&&n.playbackRate===1&&document.hasFocus()&&(s.push(f),i=Math.round(1/h()),o(i,s.length*2)),a=!0,t=d.mediaTime,e=d.presentedFrames,n.requestVideoFrameCallback(l)}n.requestVideoFrameCallback(l);let r=()=>{s.pop(),a=!1};n.addEventListener("seeked",r);function h(){return s.reduce((c,d)=>c+d)/s.length}return()=>{n.removeEventListener("seeked",r)}}function Ut(n,o,t){return .299*n+.587*o+.114*t}var ve=0,st=class extends Array{constructor(){super(...arguments),this.id=ve++}};function jt(n){let o=n.width,t=n.height,e=new Array(o*t),i=new st,s=0;for(let a=0;a<n.data.length;a+=4)e[s]=Ut(n.data[a],n.data[a+1],n.data[a+2]),s++;for(let a=1;a<t-1;a++)for(let l=1;l<o-1;l++){let r=a*o+l,h=-e[r-o-1]+e[r-o+1]-2*e[r-1]+2*e[r+1]-e[r+o-1]+e[r+o+1],c=e[r-o-1]+2*e[r-o]+e[r-o+1]-e[r+o-1]-2*e[r+o]-e[r+o+1],d=Math.sqrt(h*h+c*c);i.push(d)}return i}var nt=new Map,fe=(n,o)=>Math.max(n.id,o.id)+"-"+Math.min(n.id,o.id);function Kt(n,o){let t=fe(n,o);if(nt.has(t))return nt.get(t);let e=0;for(let s=0;s<n.length;s++)e+=(n[s]-o[s])*(n[s]-o[s]);let i=1/(1+Math.sqrt(e));return nt.set(t,i),i}var R=64,B=class{constructor(o,t,e=!0){this.isDestroyed=!1;this.autoHide=!0;this.isMobile=!1;this.seenFrames=0;this.isCanvasSizeSet=!1;this.frames=new Map;this.histograms=new Map;this.video=o,this.fps=t,this.autoHide=e,this.createCanvas(),this.createTransformCanvas()}createTransformCanvas(){this.transformCanvas=document.createElement("canvas"),this.transformCanvasCtx=this.canvas.getContext("2d",{willReadFrequently:!0,alpha:!1}),this.transformCanvas.width=R,this.transformCanvas.height=R}normalizeImage(o){return this.transformCanvasCtx.drawImage(o,0,0,o.width,o.height,0,0,R,R),this.transformCanvasCtx.getImageData(0,0,R,R)}toHistogram(o){return this.imageHistogram(this.normalizeImage(o))}imageHistogram(o){return jt(o)}start(){this.addRequestFrameCallback()}destroy(){this.isDestroyed=!0,this.frames.forEach(o=>o.close()),this.frames.clear()}tick(o,t){if(this.setCanvasSize(),t.expectedDisplayTime-performance.now()>10&&console.log("looks like frame is not yet rendered"),this.isDestroyed)return!1;if(this.seenFrames>=this.totalFrames){if(this.autoHide)try{this.video.paused||this.video.pause(),this.video.style.display="none"}catch(l){}return!1}if(this.video.videoWidth===0||this.video.videoHeight===0)return!0;let i=this.video,s=this.frameNumberFromTime(t.mediaTime);if(!Math.max(1,t.presentedFrames>this.totalFrames?t.presentedFrames%this.totalFrames:t.presentedFrames))throw new Error("expectedFrame is 0");if(this.hasFrame(s))this.seenFrames++;else{this.ctx.drawImage(i,0,0,this.width,this.height,0,0,this.width,this.height);let l=this.ctx.getImageData(0,0,this.canvas.width,this.canvas.height);createImageBitmap(l,0,0,this.width,this.height).then(r=>T(this,null,function*(){this.setFrame(s,r),this.isMobile||this.setHistogram(s,this.toHistogram(r))}))}return!0}addRequestFrameCallback(){this.isDestroyed||this.video.requestVideoFrameCallback((o,t)=>{this.tick(o,t)&&this.addRequestFrameCallback()})}createCanvas(){this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d",{willReadFrequently:!0,alpha:!1})}setCanvasSize(){this.isCanvasSizeSet||(this.canvas.width=this.video.videoWidth,this.canvas.height=this.video.videoHeight,this.isCanvasSizeSet=!0)}get width(){return this.video.videoWidth}get height(){return this.video.videoHeight}hasFrame(o){return this.frames.has(o)}getFrame(o){return this.frames.has(o)?this.frames.get(o):null}getFrameNumberBySignature(o,t){if(!o)return t;let e=0,i=t;return[t-3,t-2,t-1,t,t+1,t+2,t+3].filter(a=>a>0&&a<=this.totalFrames).forEach(a=>{let l=this.getHistogram(a);if(l){let r=Kt(o,l);r>e&&(e=r,i=a)}}),i}setFrame(o,t){this.frames.set(o,t)}setHistogram(o,t){this.histograms.set(o,t)}getHistogram(o){var t;return(t=this.histograms.get(o))!=null?t:null}get totalFrames(){return Math.round(this.video.duration*this.fps)}frameNumberFromTime(o){return Math.max(1,Math.round(o*this.fps))}};var ge=window.devicePixelRatio||1,qt=25,F=class extends z{constructor(t){super();this.referenceVideoFrameBuffer=null;this.videoFrameBuffer=null;this.isMouseDown=!1;this.buttons=[];this.plugins=[];this.annotatedFrameCoordinates=[];this.fps=qt;this.plannedFn=null;this.ct=0;this.isCanvasInitialized=!1;this.enforcedCanvasSize=null;this.lastNavigatedFrame=0;this.isProgressBarNavigation=!1;this.isAnnotationsAsVideoActive=!1;this.plugins=Yt.map(e=>new e(this)),this.init(t)}prevFrame(){let t=this.playbackFrame,e=Math.max(1,t-1);e===this.playbackFrame?this.playbackFrame=this.totalFrames-1:this.playbackFrame=e}nextFrame(){let t=this.playbackFrame,e=Math.min(this.totalFrames,t+1);e===this.totalFrames?this.playbackFrame=1:this.playbackFrame=e}removeGlobalShape(t){this.globalShapes=this.globalShapes.filter(e=>e.type!==t)}addGlobalShape(t){this.globalShapes.push(t)}get selectedColor(){return this.colorPicker.value}get selectedStrokeSize(){return this.strokeSizePicker.valueAsNumber}get currentTool(){return this._currentTool}set currentTool(t){let e=this._currentTool;e&&(this.getButtonForTool(e).classList.remove("active"),this.pluginForTool(e).onDeactivate()),this._currentTool=t,this.canvas.style.cursor=t?"pointer":"default",t&&(this.getButtonForTool(t).classList.add("active"),this.pluginForTool(t).onActivate())}enableFrameRateDetection(){if(this.destructors.find(i=>i.name==="frameRateDetector"))return;let t=this.videoElement;if(t.tagName==="IMG")return;let e=Xt(t,i=>{this.fps=i});Object.defineProperty(e,"name",{value:"frameRateDetector"}),this.destructors.push(e)}timeToFrame(t){return Math.max(1,Math.round(t*this.fps))}get playbackFrame(){return this.videoElement instanceof HTMLImageElement?1:this.timeToFrame(this.videoElement.currentTime)}set playbackFrame(t){if(this.videoElement instanceof HTMLImageElement)return;let e=t/this.fps;this.videoElement.currentTime=e,this.rvf(()=>{this.show()})}rvf(t){this.plannedFn=t}get canvasWidth(){var t,e;return(e=(t=this.enforcedCanvasSize)==null?void 0:t.width)!=null?e:0}get canvasHeight(){var t,e;return(e=(t=this.enforcedCanvasSize)==null?void 0:t.height)!=null?e:0}get aspectRatio(){return this.canvasWidth/this.canvasHeight}get isMobile(){return window.innerWidth<960}get progressBarCoordinates(){let t=this.isMobile?30:10,e=5,s=this.canvasWidth-e-55,a=e,l=this.canvasHeight-t;return{x:a,y:l,width:s,height:t}}get shapes(){return this.timeStack.has(this.activeTimeFrame)||this.timeStack.set(this.activeTimeFrame,[]),this.timeStack.get(this.activeTimeFrame)}set shapes(t){this.timeStack.set(this.activeTimeFrame,t)}get undoStack(){return this.undoTimeStack.has(this.activeTimeFrame)||this.undoTimeStack.set(this.activeTimeFrame,[]),this.undoTimeStack.get(this.activeTimeFrame)}set undoStack(t){this.undoTimeStack.set(this.activeTimeFrame,t)}get pixelRatio(){return ge}setVideoBlob(i){return T(this,arguments,function*(t,e=this.fps){let s=URL.createObjectURL(t);yield this.setVideoUrl(s,e),this.plugins.forEach(a=>{a.on("videoBlobSet",t)})})}setVideoUrl(i){return T(this,arguments,function*(t,e=this.fps){if(this.videoElement instanceof HTMLImageElement)return;let s=this.videoElement;s.src=t.toString(),yield this.videoElement.load(),this.setFrameRate(e),this.videoFrameBuffer&&(this.videoFrameBuffer.destroy(),this.videoFrameBuffer=new B(s,e,!1),this.videoFrameBuffer.isMobile=this.isMobile),this.setCanvasSize()})}enableVideoFrameBuffer(){this.videoElement instanceof HTMLImageElement||(this.videoFrameBuffer=new B(this.videoElement,this.fps,!1),this.videoFrameBuffer.isMobile=this.isMobile)}hide(){this.stopAnnotationsAsVideo(),this.hideControls(),this.hideCanvas()}showControls(){this.uiContainer.style.display="block"}hideControls(){this.uiContainer.style.display="none"}showCanvas(){this.canvas.style.display="block"}hideCanvas(){this.canvas.style.display="none"}updateActiveTimeFrame(t=void 0){this.activeTimeFrame=t?this.timeToFrame(t):this.playbackFrame}show(){this.stopAnnotationsAsVideo(),this.updateActiveTimeFrame(),this.showCanvas(),this.showControls(),this.redrawFullCanvas()}setCanvasSettings(){this.ctx.strokeStyle=this.selectedColor,this.ctx.fillStyle=this.selectedColor,this.ctx.lineWidth=this.selectedStrokeSize}pluginForTool(t){if(this.isDestroyed)throw new Error("AnnotationTool is destroyed");let e=this.plugins.find(i=>i.name===t);if(!e)throw new Error(`No plugin found for tool ${t}`);return e}getButtonForTool(t){return this.buttons.find(e=>e.dataset.tool===t)}bindContext(){this.handleMouseDown=this.handleMouseDown.bind(this),this.handleMouseMove=this.handleMouseMove.bind(this),this.handleMouseUp=this.handleMouseUp.bind(this),this.setCanvasSize=this.setCanvasSize.bind(this),this.onKeyDown=this.onKeyDown.bind(this)}initProperties(){this.isDestroyed=!1,this.isProgressBarNavigation=!1,this.shapes=[],this.globalShapes=[],this.currentTool=this.isMobile?null:"curve"}setVideoStyles(){this.videoElement.style.objectFit="cover",this.videoElement.style.objectPosition="left top"}get frameCallbackSupported(){return"requestVideoFrameCallback"in HTMLVideoElement.prototype}initFrameCounter(){if(!this.frameCallbackSupported){setTimeout(()=>{var t;(t=this.plannedFn)==null||t.call(this),this.plannedFn=null,this.initFrameCounter(),this.updateActiveTimeFrame(),this.playAnnotationsAsVideo()},1e3/this.fps);return}this.withVideo(t=>{t.requestVideoFrameCallback((e,i)=>{var s,a;this.isCanvasInitialized||this._setCanvasSize(),(s=this.videoFrameBuffer)==null||s.tick(e,i),(a=this.plannedFn)==null||a.call(this),this.plannedFn=null,this.raf(()=>{this.initFrameCounter(),this.updateActiveTimeFrame(i.mediaTime),this.playAnnotationsAsVideo()})})})}init(t){this.videoElement=t,this.setVideoStyles(),this.initFrameCounter(),this.bindContext(),this.initCanvas(),this.initUI(),this.initProperties(),this.setCanvasSize()}onKeyDown(t){(t.ctrlKey||t.metaKey)&&t.key.toLowerCase()==="z"&&this.handleUndo()}removeLastShape(){this.shapes.pop(),this.redrawFullCanvas()}handleUndo(){this.undoStack.length>0&&(this.shapes=this.undoStack.pop(),this.redrawFullCanvas())}destroy(){var s,a,l,r,h,c,d,m;if(this.isDestroyed)return;super.destroy(),this.stopAnnotationsAsVideo(),this.currentTool=null,this.plugins.forEach(u=>u.reset()),this.annotatedFrameCoordinates=[],this.setFrameRate(qt);let t=this.strokeSizePicker.parentElement;if((s=t==null?void 0:t.parentNode)==null||s.removeChild(t),this.referenceVideoElement){let u=this.referenceVideoElement.parentElement;(a=u==null?void 0:u.parentNode)==null||a.removeChild(u),this.referenceVideoElement=null}let e=this.colorPicker.parentElement;(l=e==null?void 0:e.parentNode)==null||l.removeChild(e),this.buttons.forEach(u=>{var f;(f=u.parentNode)==null||f.removeChild(u)}),this.buttons=[],(r=this.uiContainer.parentNode)==null||r.removeChild(this.uiContainer),(h=this.canvas.parentNode)==null||h.removeChild(this.canvas),(c=this.playerControlsContainer.parentElement)==null||c.removeChild(this.playerControlsContainer),["strokeSizePicker","colorPicker","uiContainer","playerControlsContainer","canvas","ctx","videoElement"].forEach(u=>{delete this[u]}),this.activeTimeFrame=0,this.isDestroyed=!0,(d=this.referenceVideoFrameBuffer)==null||d.destroy(),this.referenceVideoFrameBuffer=null,(m=this.videoFrameBuffer)==null||m.destroy(),this.videoFrameBuffer=null}_setCanvasSize(){let t=getComputedStyle(this.videoElement),e=parseInt(t.width,10),i=this.videoElement,s=i.videoWidth/i.videoHeight;if(isNaN(e)||!i.videoWidth||!i.videoHeight)return this.isCanvasInitialized=!1,this.setCanvasSettings(),!1;let a=Math.min(e,i.videoWidth),l=Math.floor(a/s);return i.style.width=`${a}px`,i.style.height=`${l}px`,this.isCanvasInitialized=i.videoWidth>0&&i.videoHeight>0,this.canvas.width=a*this.pixelRatio,this.canvas.height=l*this.pixelRatio,this.canvas.style.width=`${a}px`,this.canvas.style.height=`${l}px`,this.enforcedCanvasSize={width:a,height:l},this.ctx.scale(this.pixelRatio,this.pixelRatio),this.setCanvasSettings(),!0}setCanvasSize(){this._setCanvasSize()&&(this.syncVideoSizes(),this.redrawFullCanvas())}addShape(t){let e=this.serialize([t])[0];this.undoStack.push([...this.shapes]),this.shapes.push(e)}get msPerFrame(){return this.fps/1e3}syncVideoSizes(){this.withRefVideo(t=>{let i=this.videoElement.getBoundingClientRect();t.style.position="fixed",t.style.top=`${i.top}px`,t.style.left=`${i.left}px`})}addReferenceVideoByURL(s){return T(this,arguments,function*(t,e=this.fps,i="video/mp4"){var h;let a=yield fetch(t).then(c=>c.blob()),l=new Blob([a],{type:i}),r=window.URL.createObjectURL(l);this.referenceVideoElement?((h=this.referenceVideoFrameBuffer)==null||h.destroy(),this.referenceVideoFrameBuffer=new B(this.referenceVideoElement,e),this.referenceVideoFrameBuffer.isMobile=this.isMobile,this.referenceVideoFrameBuffer.start()):(this.referenceVideoElement=document.createElement("video"),this.withRefVideo(c=>{this.isMobile?(c.style.zIndex="2",c.style.display="block",c.style.top="0",c.style.left="0",c.style.opacity="0.25",c.style.width="20px",c.style.height="15px"):(c.style.zIndex="-1",c.style.display="none",c.style.width="100px",c.style.height="70px"),c.style.objectFit="cover",c.style.objectPosition="left top",c.muted=!0,c.volume=0,c.playsInline=!0,c.autoplay=!1,c.controls=!1,c.loop=!0,this.videoElement.after(c),this.referenceVideoFrameBuffer=new B(c,e),this.referenceVideoFrameBuffer.isMobile=this.isMobile,this.referenceVideoFrameBuffer.start()}),this.syncVideoSizes()),this.referenceVideoElement.src=r,this.referenceVideoElement.play().then(()=>{this.showButton("compare")}).catch(()=>{this.hideButton("compare")})})}hideButton(t){let e=this.getButtonForTool(t);e.style.display="none"}showButton(t){let e=this.getButtonForTool(t);e.style.display=""}addSingletonShape(t){let e=this.serialize([t])[0],i=this.shapes.filter(s=>s.type!==t.type);this.replaceFrame(this.playbackFrame,[...i,e])}serialize(t=this.shapes){let e=this.canvasWidth,i=this.canvasHeight;return t.map(s=>this.pluginForTool(s.type).normalize(s,e,i))}deserialize(t){let e=1/this.canvasWidth,i=1/this.canvasHeight;return t.map(s=>this.pluginForTool(s.type).normalize(s,e,i))}getRelativeCoords(t){let e=this.canvas.getBoundingClientRect();return{x:this.getEventX(t)-e.left,y:this.getEventY(t)-e.top}}handleMouseDown(t){if(t.preventDefault(),this.isMouseDown=!0,V(t))return;let e=this.frameFromProgressBar(t,!0);if(e){this.isProgressBarNavigation=!0;let i=this.getAnnotationFrame(t);this.isVideoPaused&&(i!==null?this.playbackFrame=i:this.playbackFrame=e);return}this.currentTool&&this.pluginForTool(this.currentTool).onPointerDown(t)}get isDrawing(){return this.currentTool?this.pluginForTool(this.currentTool).isDrawing:!1}get isVideoPaused(){return this.videoElement.tagName==="VIDEO"?this.videoElement.paused:!0}get hasGlobalOverlays(){return this.globalShapes.length>0}handleMouseMove(t){if(t.preventDefault(),!V(t)){if(this.isMouseDown){let e=this.isProgressBarNavigation?this.frameFromProgressBar(t,!1):null;if(e!==null&&!this.isDrawing){if(e===this.lastNavigatedFrame)return;this.lastNavigatedFrame=e,this.isVideoPaused&&(this.playbackFrame=e);return}else this.hideControls(),this.clearCanvas(),this.hasGlobalOverlays||this.addVideoOverlay(),this.drawShapesOverlay()}else this.redrawFullCanvas();this.currentTool&&this.pluginForTool(this.currentTool).onPointerMove(t)}}getEventX(t){return t.clientX}getEventY(t){return t.clientY}handleMouseUp(t){this.isMouseDown=!1,this.isProgressBarNavigation=!1,this.showControls(),!V(t)&&(this.currentTool&&this.pluginForTool(this.currentTool).onPointerUp(t),this.redrawFullCanvas())}focusOnMediaNode(){this.videoElement.focus()}drawShapesOverlay(){let t={strokeStyle:this.ctx.strokeStyle,fillStyle:this.ctx.fillStyle,lineWidth:this.ctx.lineWidth};for(let e of this.deserialize(this.globalShapes)){this.ctx.strokeStyle=e.strokeStyle,this.ctx.fillStyle=e.fillStyle,this.ctx.lineWidth=e.lineWidth;try{this.pluginForTool(e.type).draw(e)}catch(i){console.error(i)}}for(let e of this.deserialize(this.shapes)){this.ctx.strokeStyle=e.strokeStyle,this.ctx.fillStyle=e.fillStyle,this.ctx.lineWidth=e.lineWidth;try{this.pluginForTool(e.type).draw(e)}catch(i){console.error(i)}}this.ctx.strokeStyle=t.strokeStyle,this.ctx.fillStyle=t.fillStyle,this.ctx.lineWidth=t.lineWidth}clearCanvas(){this.ctx.clearRect(0,0,this.canvasWidth,this.canvasHeight)}frameToDataUrl(){try{this.clearCanvas(),this.addVideoOverlay(),this.addFrameSquareOverlay(),this.drawShapesOverlay();let t=this.canvas.toDataURL("image/png");return this.redrawFullCanvas(),t}catch(t){return console.error(t),null}}redrawFullCanvas(){this.hasGlobalOverlays||(this.clearCanvas(),this.addVideoOverlay()),this.drawShapesOverlay(),this.addFrameSquareOverlay(),this.addProgressBarOverlay()}replaceFrame(t,e){this.timeStack.set(t,this.parseShapes(this.stringifyShapes(e)))}addShapesToFrame(t,e){let i=this.timeStack.get(t)||[];this.timeStack.set(t,[...i,...this.parseShapes(this.stringifyShapes(e))])}setFrameRate(t){var e;(e=this.destructors.find(i=>i.name==="frameRateDetector"))==null||e(),this.fps=t}stringifyShapes(t){return JSON.stringify(t,(e,i)=>e==="image"?i.src:i)}parseShapes(t){return JSON.parse(t,(e,i)=>{if(e==="image"){let s=new Image;return s.src=i,s}return i})}filterNonSerializableShapes(t){return t.filter(e=>e.type!=="image")}saveCurrentFrame(){return{frame:this.playbackFrame,version:1,fps:this.fps,shapes:this.parseShapes(this.stringifyShapes(this.filterNonSerializableShapes(this.shapes)))}}loadAllFrames(t){this.cleanFrameStacks(),t.forEach(e=>{this.timeStack.set(e.frame,e.shapes)})}appendFrames(t){t.forEach(e=>{this.addShapesToFrame(e.frame,e.shapes)})}saveAllFrames(){return Array.from(this.timeStack.keys()).filter(s=>{var a;return(a=this.timeStack.get(s))==null?void 0:a.length}).map(s=>{var a;return{frame:s,fps:this.fps,version:1,shapes:this.filterNonSerializableShapes((a=this.timeStack.get(s))!=null?a:[])}})}getAnnotationFrame(t){var l,r;let e=t.offsetX,i=t.offsetY,s=this.isMobile?10:5;return(r=(l=this.annotatedFrameCoordinates.find(h=>e>=h.x-s&&e<=h.x+s&&i>=h.y-s&&i<=h.y+s))==null?void 0:l.frame)!=null?r:null}get totalFrames(){let t=this.videoElement;return t.tagName!=="VIDEO"?1:Math.ceil(t.duration*this.fps)}frameFromProgressBar(t,e=!0){let i=this.videoElement;if(i.tagName!=="VIDEO")return null;let{x:s,width:a,height:l,y:r}=this.progressBarCoordinates,h=t.offsetX,c=t.offsetY;return e?h>=s&&h<=s+a&&c>=r&&c<=r+l?Math.ceil((h-s)/a*(i.duration*this.fps)):null:h>=s&&h<=s+a?Math.ceil((h-s)/a*(i.duration*this.fps)):null}hasAnnotationsForFrame(t){if(this.globalShapes.length>0)return!0;if(this.timeStack.has(t)){let e=this.timeStack.get(t);return e&&e.length>0}return!1}stopAnnotationsAsVideo(){this.isAnnotationsAsVideoActive=!1}startAnnotationsAsVideo(){this.isAnnotationsAsVideoActive=!0,this.playAnnotationsAsVideo()}playAnnotationsAsVideo(){this.isAnnotationsAsVideoActive&&(this.hasGlobalOverlays||this.clearCanvas(),this.isMobile?this.hasGlobalOverlays||this.addVideoOverlay():this.addVideoOverlay(),this.drawShapesOverlay(),this.addFrameSquareOverlay(),this.addProgressBarOverlay())}};function Gt(n=this.activeTimeFrame){this.ctx.save(),this.ctx.fillStyle="rgba(0, 0, 0, 0.5)";let o=50,t=30,e=20;this.ctx.fillRect(this.canvasWidth-o,this.canvasHeight-t,o,t),this.ctx.fillStyle="white",this.ctx.font=`${e}px sans-serif`,this.ctx.fillText(`${n}`.padStart(3,"0"),this.canvasWidth-40,this.canvasHeight-7),this.ctx.restore()}function $t(){var s,a,l;let n=this.videoElement;if(n.tagName!=="VIDEO")return;let o=(s=this.videoFrameBuffer)==null?void 0:s.frameNumberFromTime(n.currentTime),t=(l=(a=this.videoFrameBuffer)==null?void 0:a.getFrame(o||0))!=null?l:n,e=t?t.width:n.videoWidth,i=t?t.height:n.videoHeight;this.ctx.drawImage(t,0,0,e,i,0,0,this.canvasWidth,this.canvasHeight)}function _t(){let n=this.videoElement;if(n.tagName!=="VIDEO")return;this.annotatedFrameCoordinates=[];let t=Array.from(this.timeStack.keys()).filter(f=>{var x;return(x=this.timeStack.get(f))==null?void 0:x.length}),e=n.duration*this.fps,{x:i,width:s,height:a,y:l}=this.progressBarCoordinates,r=t.map(f=>Math.ceil(f/e*s));this.ctx.save(),this.ctx.fillStyle="rgba(0, 0, 0, 0.5)",this.ctx.fillRect(i,l,s,a),this.ctx.fillStyle="#F3CE32";let h=this.isMobile?16:8;r.forEach((f,x)=>{this.ctx.beginPath();let y=i+f,b=this.canvasHeight-a/2;this.ctx.fillRect(y-h/2,b-h/2,h,h),this.annotatedFrameCoordinates.push({x:y,y:b,frame:t[x]})});let c=this.playbackFrame,d=Math.ceil(c/e*s)+i;this.ctx.fillStyle="white",this.ctx.beginPath();let m=d,u=this.canvasHeight-a/2;this.ctx.beginPath(),this.ctx.fillRect(m-h/2,u-h/2,h,h),this.ctx.fill(),this.ctx.restore()}F.prototype.initUI=Rt;F.prototype.initCanvas=Lt;F.prototype.addFrameSquareOverlay=Gt;F.prototype.addVideoOverlay=$t;F.prototype.addProgressBarOverlay=_t;export{F as SmAnnotate};
