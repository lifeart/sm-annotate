var L="#F3CE32";function b(){let r=document.createElement("div");r.style.position="absolute",r.style.top="0",r.style.left="0",r.style.zIndex="2",this.canvas.parentNode?.insertBefore(r,this.canvas);let i=this.videoElement.tagName==="VIDEO"?this.videoElement:null;this.uiContainer=r;let t=(a,c)=>{let u=document.createElement("button");if(u.type="button",u.innerHTML=a,u.style.margin="5px",r.appendChild(u),this.buttons.push(u),typeof c=="function")this.addEvent(u,"click",c);else{u.dataset.tool=c;let k=()=>{this.currentTool=c};this.addEvent(u,"click",k)}return u},n=()=>{let a=document.createElement("div");return a.style.display="inline-flex",a.style.alignItems="center",a.style.margin="5px",r.appendChild(a),a};t('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></svg>',"rectangle"),t('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle></svg>',"circle"),t('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.3 8.7 8.7 21.3c-1 1-2.5 1-3.4 0l-2.6-2.6c-1-1-1-2.5 0-3.4L15.3 2.7c1-1 2.5-1 3.4 0l2.6 2.6c1 1 1 2.5 0 3.4Z"></path><path d="m7.5 10.5 2 2"></path><path d="m10.5 7.5 2 2"></path><path d="m13.5 4.5 2 2"></path><path d="m4.5 13.5 2 2"></path></svg>',"line"),t('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9.06 11.9 8.07-8.06a2.85 2.85 0 1 1 4.03 4.03l-8.06 8.08"></path><path d="M7.07 14.94c-1.66 0-3 1.35-3 3.02 0 1.33-2.5 1.52-2 2.02 1.08 1.1 2.49 2.02 4 2.02 2.2 0 4-1.8 4-4.04a3.01 3.01 0 0 0-3-3.02z"></path></svg>',"curve"),t('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>',"arrow"),t('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="4 7 4 4 20 4 20 7"></polyline><line x1="9" y1="20" x2="15" y2="20"></line><line x1="12" y1="4" x2="12" y2="20"></line></svg>',"text"),t('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m7 21-4.3-4.3c-1-1-1-2.5 0-3.4l9.6-9.6c1-1 2.5-1 3.4 0l5.6 5.6c1 1 1 2.5 0 3.4L13 21"></path><path d="M22 21H7"></path><path d="m5 11 9 9"></path></svg>',"eraser"),t('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7v6h6"></path><path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"></path></svg>',()=>{this.handleUndo()}),i&&(t('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="19 20 9 12 19 4 19 20"></polygon><line x1="5" y1="19" x2="5" y2="5"></line></svg>',()=>{this.playbackFrame=Math.max(1,this.activeTimeFrame-1)}),t('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 4 15 12 5 20 5 4"></polygon><line x1="19" y1="5" x2="19" y2="19"></line></svg>',()=>{this.playbackFrame=Math.min(i.duration*this.fps,this.activeTimeFrame+1)}),t('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>',()=>{i.play()}));let e=document.createElement("input");e.type="color",e.value=L,e.style.margin="5px",this.colorPicker=e,r.appendChild(e);let s=n(),o=document.createElement("input");o.type="number",o.step="1",o.min="1",o.max="10",o.value="5",o.style.margin="5px",s.appendChild(o);let h=a=>{this.ctx.lineWidth=a.target.valueAsNumber,this.focusOnMediaNode()};this.addEvent(o,"input",h);let d=a=>{this.ctx.strokeStyle=a.target.value,this.ctx.fillStyle=a.target.value,this.focusOnMediaNode()};this.addEvent(e,"input",d),this.addEvent(this.canvas,"pointerover",()=>{this.focusOnMediaNode()}),this.colorPicker=e,this.strokeSizePicker=o,i&&(this.hide(),this.addEvent(i,"pause",()=>{this.show()}),this.addEvent(i,"seek",()=>{i.paused&&this.show()}),this.addEvent(i,"timeupdate",()=>{i.paused&&this.show()}),this.addEvent(i,"error",()=>{this.hide()}),this.addEvent(i,"stalled",()=>{this.hide()}),this.addEvent(i,"waiting",()=>{this.hide()}),this.addEvent(i,"ended",()=>{this.hide()}),this.addEvent(i,"play",()=>{this.hideControls(),this.playAnnotationsAsVideo()}),this.addEvent(i,"keydown",a=>{if(a.key==="ArrowLeft"||a.key==="ArrowRight"){let c=i;a.preventDefault(),a.stopPropagation(),a.stopImmediatePropagation(),a.key==="ArrowLeft"?this.playbackFrame=Math.max(1,this.activeTimeFrame-1):a.key==="ArrowRight"&&(this.playbackFrame=Math.min(c.duration*this.fps,this.activeTimeFrame+1))}}))}function I(){this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"),this.videoElement.parentNode?.insertBefore(this.canvas,this.videoElement.nextSibling),this.canvas.style.position="absolute",this.canvas.style.top="0",this.canvas.style.left="0",this.canvas.style.zIndex="1",this.addEvent(this.canvas,"pointerdown",this.handleMouseDown),this.addEvent(this.canvas,"pointermove",this.handleMouseMove),this.addEvent(this.canvas,"pointerup",this.handleMouseUp),this.addEvent(this.canvas,"pointercancel",this.handleMouseUp),this.addEvent(window,"resize",this.setCanvasSize),this.addEvent(document,"keydown",this.onKeyDown)}var l=class{constructor(i){this.startX=0;this.startY=0;this.isDrawing=!1;this.annotationTool=i}get ctx(){return this.annotationTool.ctx}onDeactivate(){}onActivate(){}reset(){this.startX=0,this.startY=0,this.isDrawing=!1}save(i){this.annotationTool.addShape(i)}};var p=class extends l{constructor(){super(...arguments);this.name="rectangle"}normalize(t,n,e){return{...t,x:t.x/n,y:t.y/e,width:t.width/n,height:t.height/e}}onPointerDown(t){let{x:n,y:e}=this.annotationTool.getRelativeCoords(t);this.startX=n,this.startY=e,this.isDrawing=!0}onPointerMove(t){if(!this.isDrawing)return;let{x:n,y:e}=this.annotationTool.getRelativeCoords(t);this.drawRectangle(this.startX,this.startY,n-this.startX,e-this.startY)}onPointerUp(t){if(!this.isDrawing)return;let{x:n,y:e}=this.annotationTool.getRelativeCoords(t);this.save({type:"rectangle",x:this.startX,y:this.startY,width:n-this.startX,height:e-this.startY,strokeStyle:this.ctx.strokeStyle,fillStyle:this.ctx.fillStyle,lineWidth:this.ctx.lineWidth}),this.drawRectangle(this.startX,this.startY,n-this.startX,e-this.startY),this.isDrawing=!1}drawRectangle(t,n,e,s){this.ctx.beginPath(),this.ctx.rect(t,n,e,s),this.ctx.stroke()}draw(t){this.drawRectangle(t.x,t.y,t.width,t.height)}};var g=class extends l{constructor(){super(...arguments);this.name="circle"}normalize(t,n,e){return{...t,x:t.x/n,y:t.y/e,radius:t.radius/n}}onPointerDown(t){let{x:n,y:e}=this.annotationTool.getRelativeCoords(t);this.startX=n,this.startY=e,this.isDrawing=!0}onPointerMove(t){if(!this.isDrawing)return;let{x:n,y:e}=this.annotationTool.getRelativeCoords(t),s=Math.sqrt(Math.pow(n-this.startX,2)+Math.pow(e-this.startY,2));this.drawCircle(this.startX,this.startY,s)}onPointerUp(t){if(!this.isDrawing)return;let{x:n,y:e}=this.annotationTool.getRelativeCoords(t),s=Math.sqrt(Math.pow(n-this.startX,2)+Math.pow(e-this.startY,2));this.save({type:"circle",x:this.startX,y:this.startY,radius:s,strokeStyle:this.ctx.strokeStyle,fillStyle:this.ctx.fillStyle,lineWidth:this.ctx.lineWidth}),this.drawCircle(this.startX,this.startY,s),this.isDrawing=!1}drawCircle(t,n,e){this.ctx.beginPath(),this.ctx.arc(t,n,e,0,2*Math.PI),this.ctx.stroke()}draw(t){this.drawCircle(t.x,t.y,t.radius)}};var x=class{constructor(i,t){this.x=i;this.y=t}distanceToLine(i,t){let n=t.x-i.x,e=t.y-i.y,s=Math.abs(e*this.x-n*this.y+t.x*i.y-t.y*i.x),o=Math.sqrt(e*e+n*n);return s/o}};function y(r,i){if(r.length<=2)return r;let t=r[0],n=r[r.length-1],e=-1,s=0;for(let o=1;o<r.length-1;o++){let h=r[o].distanceToLine(t,n);h>s&&(e=o,s=h)}if(s>i){let o=y(r.slice(0,e+1),i),h=y(r.slice(e),i);return o.slice(0,o.length-1).concat(h)}else return[t,n]}var w=class extends l{constructor(){super(...arguments);this.name="curve";this.curvePoints=[]}normalize(t,n,e){return{...t,points:t.points.map(s=>({x:s.x/n,y:s.y/e}))}}draw(t){this.drawCurve(t)}reset(){super.reset(),this.curvePoints=[]}onPointerDown(t){if(this.isDrawing)return;let{x:n,y:e}=this.annotationTool.getRelativeCoords(t);this.curvePoints=[],this.startX=n,this.startY=e,this.isDrawing=!0,this.curvePoints.push({x:n,y:e})}onPointerMove(t){if(!this.isDrawing)return;let{x:n,y:e}=this.annotationTool.getRelativeCoords(t);this.curvePoints.push({x:n,y:e}),this.drawCurve({points:this.curvePoints})}onPointerUp(t){if(!this.isDrawing)return;let{x:n,y:e}=this.annotationTool.getRelativeCoords(t);this.curvePoints.push({x:n,y:e});let s=this.curvePoints.map(c=>new x(c.x,c.y)),a={type:"curve",points:y(s,2).map(c=>({x:c.x,y:c.y})),strokeStyle:this.ctx.strokeStyle,fillStyle:this.ctx.fillStyle,lineWidth:this.ctx.lineWidth};this.save(a),this.curvePoints=[],this.isDrawing=!1}drawCurve(t){this.ctx.beginPath(),this.ctx.moveTo(t.points[0].x,t.points[0].y);for(let n=1;n<t.points.length-1;n++){let e=t.points[n],s=t.points[n+1];this.ctx.quadraticCurveTo(e.x,e.y,s.x,s.y)}this.ctx.stroke()}};var f=class extends l{constructor(){super(...arguments);this.name="line"}normalize(t,n,e){return{...t,x1:t.x1/n,y1:t.y1/e,x2:t.x2/n,y2:t.y2/e}}onPointerDown(t){let{x:n,y:e}=this.annotationTool.getRelativeCoords(t);this.startX=n,this.startY=e,this.isDrawing=!0}onPointerMove(t){if(!this.isDrawing)return;let{x:n,y:e}=this.annotationTool.getRelativeCoords(t);this.drawLine(this.startX,this.startY,n,e)}onPointerUp(t){if(!this.isDrawing)return;let{x:n,y:e}=this.annotationTool.getRelativeCoords(t);this.save({type:"line",x1:this.startX,y1:this.startY,x2:n,y2:e,fillStyle:this.ctx.fillStyle,strokeStyle:this.ctx.strokeStyle,lineWidth:this.ctx.lineWidth}),this.drawLine(this.startX,this.startY,n,e),this.isDrawing=!1}drawLine(t,n,e,s){this.ctx.beginPath(),this.ctx.moveTo(t,n),this.ctx.lineTo(e,s),this.ctx.stroke()}draw(t){this.drawLine(t.x1,t.y1,t.x2,t.y2)}};var T=class extends l{constructor(){super(...arguments);this.name="arrow"}normalize(t,n,e){return{...t,x1:t.x1/n,y1:t.y1/e,x2:t.x2/n,y2:t.y2/e}}draw(t){this.drawArrow(t.x1,t.y1,t.x2,t.y2)}onPointerDown(t){let{x:n,y:e}=this.annotationTool.getRelativeCoords(t);this.startX=n,this.startY=e,this.isDrawing=!0}onPointerMove(t){if(!this.isDrawing)return;let{x:n,y:e}=this.annotationTool.getRelativeCoords(t);this.drawArrow(this.startX,this.startY,n,e)}onPointerUp(t){if(!this.isDrawing)return;this.isDrawing=!1;let{x:n,y:e}=this.annotationTool.getRelativeCoords(t);this.save({type:"arrow",x1:this.startX,y1:this.startY,x2:n,y2:e,strokeStyle:this.ctx.strokeStyle,fillStyle:this.ctx.fillStyle,lineWidth:this.ctx.lineWidth})}drawArrow(t,n,e,s){let o=10+2.5*this.ctx.lineWidth,h=Math.PI/6,d=Math.atan2(s-n,e-t);this.ctx.beginPath(),this.ctx.moveTo(t,n),this.ctx.lineTo(e,s),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(e,s),this.ctx.lineTo(e-o*Math.cos(d+h),s-o*Math.sin(d+h)),this.ctx.moveTo(e,s),this.ctx.lineTo(e-o*Math.cos(d-h),s-o*Math.sin(d-h)),this.ctx.stroke()}};var E=class extends l{constructor(){super(...arguments);this.name="text"}onActivate(){this.annotationTool.canvas.style.cursor="text",this.isDrawing=!0}onDeactivate(){this.annotationTool.canvas.style.cursor="default",this.isDrawing=!1}draw(t){this.drawText(t.x,t.y,t.text)}drawText(t,n,e){let s=16+this.ctx.lineWidth*.5;this.ctx.font=`${s}px Helvetica Neue, Arial`,this.ctx.fillText(e,t,n)}onPointerDown(t){let{x:n,y:e}=this.annotationTool.getRelativeCoords(t);this.startX=n,this.startY=e}onPointerMove(t){let{x:n,y:e}=this.annotationTool.getRelativeCoords(t);this.ctx.beginPath(),this.ctx.arc(n,e,5,0,2*Math.PI),this.ctx.fill()}normalize(t,n,e){return{...t,x:t.x/n,y:t.y/e}}onPointerUp(t){let{x:n,y:e}=this.annotationTool.getRelativeCoords(t),s=prompt("Enter the text to be drawn:");s!==null&&this.save({type:"text",x:n,y:e,text:s,strokeStyle:this.ctx.strokeStyle,fillStyle:this.ctx.fillStyle,lineWidth:this.ctx.lineWidth})}};var P=class extends l{constructor(){super(...arguments);this.name="eraser"}normalize(t,n,e){return{...t,x:t.x/n,y:t.y/e,width:t.width/n,height:t.height/e}}draw(t){this.drawEraser(t.x,t.y,t.width,t.height)}onPointerDown(t){let{x:n,y:e}=this.annotationTool.getRelativeCoords(t);this.startX=n,this.startY=e,this.isDrawing=!0}onPointerMove(t){if(!this.isDrawing)return;let{x:n,y:e}=this.annotationTool.getRelativeCoords(t);this.ctx.save(),this.ctx.strokeStyle="rgba(255, 255, 255, 0.5)",this.ctx.lineWidth=1,this.ctx.fillStyle="rgba(255, 255, 255, 0.3)",this.ctx.fillRect(this.startX,this.startY,n-this.startX,e-this.startY),this.ctx.strokeRect(this.startX,this.startY,n-this.startX,e-this.startY),this.ctx.restore()}onPointerUp(t){if(!this.isDrawing)return;this.isDrawing=!1;let{x:n,y:e}=this.annotationTool.getRelativeCoords(t);this.save({type:"eraser",x:this.startX,y:this.startY,width:n-this.startX,height:e-this.startY,strokeStyle:this.ctx.strokeStyle,fillStyle:this.ctx.fillStyle,lineWidth:this.ctx.lineWidth})}drawEraser(t,n,e,s){this.ctx.clearRect(t,n,e,s)}};var M=[p,g,f,T,E,P,w];var m=class{constructor(i){this.isMouseDown=!1;this.activeTimeFrame=1;this.buttons=[];this.destructors=[];this.plugins=[];this.isDestroyed=!1;this.timeStack=new Map;this.undoTimeStack=new Map;this.annotatedFrameCoordinates=[];this.plugins=M.map(t=>new t(this)),this.init(i)}get selectedColor(){return this.colorPicker.value}get selectedStrokeSize(){return this.strokeSizePicker.valueAsNumber}get currentTool(){return this._currentTool}set currentTool(i){let t=this._currentTool;t&&(this.getButtonForTool(t).classList.remove("active"),this.pluginForTool(t).onDeactivate()),this._currentTool=i,this.canvas.style.cursor=i?"pointer":"default",i&&(this.getButtonForTool(i).classList.add("active"),this.pluginForTool(i).onActivate())}get fps(){return 25}get playbackFrame(){if(this.videoElement instanceof HTMLImageElement)return 1;let i=Math.round(this.videoElement.currentTime*this.fps);return Math.max(1,i)}set playbackFrame(i){this.videoElement instanceof HTMLImageElement||(this.videoElement.currentTime=i/this.fps)}get canvasWidth(){return this.canvas.width/this.pixelRatio}get canvasHeight(){return this.canvas.height/this.pixelRatio}get progressBarCoordinates(){let n=this.canvasWidth-5-55,e=5,s=this.canvasHeight-10;return{x:e,y:s,width:n,height:10}}get videoClientRect(){return this.videoElement.getBoundingClientRect()}get shapes(){return this.timeStack.has(this.activeTimeFrame)||this.timeStack.set(this.activeTimeFrame,[]),this.timeStack.get(this.activeTimeFrame)}set shapes(i){this.timeStack.set(this.activeTimeFrame,i)}get undoStack(){return this.undoTimeStack.has(this.activeTimeFrame)||this.undoTimeStack.set(this.activeTimeFrame,[]),this.undoTimeStack.get(this.activeTimeFrame)}set undoStack(i){this.undoTimeStack.set(this.activeTimeFrame,i)}get pixelRatio(){return window.devicePixelRatio||1}hide(){this.stopAnnotationsAsVideo(),this.hideControls(),this.hideCanvas()}showControls(){this.uiContainer.style.display="block"}hideControls(){this.uiContainer.style.display="none"}showCanvas(){this.canvas.style.display="block"}hideCanvas(){this.canvas.style.display="none"}show(){this.stopAnnotationsAsVideo(),this.activeTimeFrame=this.playbackFrame,this.showCanvas(),this.showControls(),this.redrawFullCanvas()}setCanvasSettings(){this.ctx.strokeStyle=this.selectedColor,this.ctx.fillStyle=this.selectedColor,this.ctx.lineWidth=this.selectedStrokeSize}pluginForTool(i){if(this.isDestroyed)throw new Error("AnnotationTool is destroyed");let t=this.plugins.find(n=>n.name===i);if(!t)throw new Error(`No plugin found for tool ${i}`);return t}getButtonForTool(i){return this.buttons.find(t=>t.dataset.tool===i)}bindContext(){this.handleMouseDown=this.handleMouseDown.bind(this),this.handleMouseMove=this.handleMouseMove.bind(this),this.handleMouseUp=this.handleMouseUp.bind(this),this.setCanvasSize=this.setCanvasSize.bind(this),this.onKeyDown=this.onKeyDown.bind(this)}initProperties(){this.isDestroyed=!1,this.currentTool=null,this.shapes=[]}init(i){this.videoElement=i,this.bindContext(),this.initCanvas(),this.initUI(),this.initProperties(),this.setCanvasSize(),this.fillCanvas(),this.setCanvasSettings(),this.currentTool="curve"}addEvent(i,t,n){let e=s=>{this.isDestroyed||n(s)};i.addEventListener(t,e),this.destructors.push(()=>{i.removeEventListener(t,e)})}initCanvas(){throw new Error("Method not implemented.")}onKeyDown(i){(i.ctrlKey||i.metaKey)&&i.key.toLowerCase()==="z"&&this.handleUndo()}handleUndo(){this.undoStack.length>0&&(this.shapes=this.undoStack.pop(),this.redrawFullCanvas())}destroy(){if(this.isDestroyed)return;this.destructors.forEach(e=>e()),this.stopAnnotationsAsVideo(),this.destructors=[],this.plugins.forEach(e=>e.reset()),this.annotatedFrameCoordinates=[],this._currentTool=null,this.timeStack.clear(),this.undoTimeStack.clear();let i=this.strokeSizePicker.parentElement;i?.parentNode?.removeChild(i);let t=this.colorPicker.parentElement;t?.parentNode?.removeChild(t),this.buttons.forEach(e=>{e.parentNode?.removeChild(e)}),this.buttons=[],this.uiContainer.parentNode?.removeChild(this.uiContainer),this.canvas.parentNode?.removeChild(this.canvas),["strokeSizePicker","colorPicker","uiContainer","canvas","ctx","videoElement"].forEach(e=>{delete this[e]}),this.activeTimeFrame=0}setCanvasSize(){let i=this.videoClientRect;this.canvas.width=i.width*this.pixelRatio,this.canvas.height=i.height*this.pixelRatio,this.canvas.style.width=`${i.width}px`,this.canvas.style.height=`${i.height}px`,this.ctx.scale(this.pixelRatio,this.pixelRatio),this.redrawFullCanvas(),this.setCanvasSettings()}isMultiTouch(i){return i.pointerType==="touch"&&i.isPrimary===!1}addShape(i){let t=this.serialize([i])[0];console.log("serializedShape",t),this.undoStack.push([...this.shapes]),this.shapes.push(t)}serialize(i=this.shapes){let t=this.canvas.width,n=this.canvas.height;return i.map(e=>this.pluginForTool(e.type).normalize(e,t,n))}deserialize(i){let t=1/this.canvas.width,n=1/this.canvas.height;return i.map(e=>this.pluginForTool(e.type).normalize(e,t,n))}getRelativeCoords(i){let t=this.canvas.getBoundingClientRect();return{x:this.getEventX(i)-t.left,y:this.getEventY(i)-t.top}}handleMouseDown(i){if(i.preventDefault(),this.isMouseDown=!0,this.isMultiTouch(i))return;let t=this.frameFromProgressBar(i);if(t){let n=this.getAnnotationFrame(i);n!==null?this.playbackFrame=n:this.playbackFrame=t;return}this.currentTool&&this.pluginForTool(this.currentTool).onPointerDown(i)}get isDrawing(){return this.currentTool?this.pluginForTool(this.currentTool).isDrawing:!1}handleMouseMove(i){if(i.preventDefault(),!this.isMultiTouch(i)){if(this.isMouseDown){let t=this.frameFromProgressBar(i);if(t!==null&&!this.isDrawing){this.playbackFrame=t;return}else this.hideControls(),this.clearCanvas(),this.addVideoOverlay(),this.drawShapesOverlay()}else this.redrawFullCanvas();this.currentTool&&this.pluginForTool(this.currentTool).onPointerMove(i)}}getEventX(i){return i.clientX}getEventY(i){return i.clientY}handleMouseUp(i){this.isMouseDown=!1,this.showControls(),!this.isMultiTouch(i)&&(this.currentTool&&this.pluginForTool(this.currentTool).onPointerUp(i),this.redrawFullCanvas())}focusOnMediaNode(){this.videoElement.focus()}drawShapesOverlay(){let i={strokeStyle:this.ctx.strokeStyle,fillStyle:this.ctx.fillStyle,lineWidth:this.ctx.lineWidth};this.deserialize(this.shapes).forEach(t=>{this.ctx.strokeStyle=t.strokeStyle,this.ctx.fillStyle=t.fillStyle,this.ctx.lineWidth=t.lineWidth,this.pluginForTool(t.type).draw(t)}),this.ctx.strokeStyle=i.strokeStyle,this.ctx.fillStyle=i.fillStyle,this.ctx.lineWidth=i.lineWidth}clearCanvas(){this.ctx.clearRect(0,0,this.canvasWidth,this.canvasHeight)}imageForCapture(){try{this.clearCanvas(),this.addVideoOverlay(),this.addFrameSquareOverlay(),this.drawShapesOverlay();let i=new Image;return i.src=this.canvas.toDataURL("image/png"),i}catch(i){return console.error(i),null}}redrawFullCanvas(){this.clearCanvas(),this.addVideoOverlay(),this.addFrameSquareOverlay(),this.addProgressBarOverlay(),this.drawShapesOverlay()}saveCurrentFrame(){return{frame:this.playbackFrame,version:1,fps:this.fps,shapes:this.shapes}}addFrameSquareOverlay(i=this.activeTimeFrame){throw new Error("Method not implemented.")}addVideoOverlay(){throw new Error("Method not implemented.")}saveAllFrames(){return Array.from(this.timeStack.keys()).filter(e=>this.timeStack.get(e)?.length).map(e=>({frame:e,fps:this.fps,version:1,shapes:this.timeStack.get(e)}))}getAnnotationFrame(i){let t=i.offsetX,n=i.offsetY,e=5;return this.annotatedFrameCoordinates.find(o=>t>=o.x-e&&t<=o.x+e&&n>=o.y-e&&n<=o.y+e)?.frame??null}frameFromProgressBar(i){let t=this.videoElement;if(t.tagName!=="VIDEO")return null;let{x:n,width:e,height:s,y:o}=this.progressBarCoordinates,h=i.offsetX,d=i.offsetY;return h>=n&&h<=n+e&&d>=o&&d<=o+s?Math.ceil((h-n)/e*(t.duration*this.fps)):null}addProgressBarOverlay(){throw new Error("Method not implemented.")}initUI(){throw new Error("Method not implemented.")}stopAnnotationsAsVideo(){clearTimeout(this.playTimeout)}hasAnnotationsForFrame(i){if(this.timeStack.has(i)){let t=this.timeStack.get(i);return t&&t.length>0}return!1}playAnnotationsAsVideo(){this.stopAnnotationsAsVideo();let i=this.playbackFrame;this.hasAnnotationsForFrame(i)?(this.showCanvas(),this.activeTimeFrame=i,this.clearCanvas(),this.drawShapesOverlay()):this.hideCanvas();let t=1e3/this.fps;this.playTimeout=window.setTimeout(()=>{this.playAnnotationsAsVideo()},t)}fillCanvas(){this.ctx.save(),this.ctx.fillStyle="rgba(0, 0, 0, 0.5)",this.ctx.fillRect(0,0,this.canvasWidth,this.canvasHeight),this.ctx.restore()}};function F(r=this.activeTimeFrame){this.ctx.save(),this.ctx.fillStyle="rgba(0, 0, 0, 0.5)";let i=50,t=30,n=20;this.ctx.fillRect(this.canvasWidth-i,this.canvasHeight-t,i,t),this.ctx.fillStyle="white",this.ctx.font=`${n}px sans-serif`,this.ctx.fillText(`${r}`.padStart(3,"0"),this.canvasWidth-40,this.canvasHeight-7),this.ctx.restore()}function D(){this.ctx.drawImage(this.videoElement,0,0,this.canvas.width/this.pixelRatio,this.canvas.height/this.pixelRatio)}function B(){let r=this.videoElement;if(r.tagName!=="VIDEO")return;this.annotatedFrameCoordinates=[];let t=Array.from(this.timeStack.keys()).filter(v=>this.timeStack.get(v)?.length),n=r.duration*this.fps,{x:e,width:s,height:o,y:h}=this.progressBarCoordinates,d=t.map(v=>Math.ceil(v/n*s));this.ctx.save(),this.ctx.fillStyle="rgba(0, 0, 0, 0.5)",this.ctx.fillRect(e,h,s,o),this.ctx.fillStyle="#F3CE32";let a=8;d.forEach((v,R)=>{this.ctx.beginPath();let C=e+v,S=this.canvasHeight-5;this.ctx.fillRect(C-a/2,S-a/2,a,a),this.annotatedFrameCoordinates.push({x:C,y:S,frame:t[R]})});let c=this.playbackFrame,u=Math.ceil(c/n*s)+e;this.ctx.fillStyle="white",this.ctx.beginPath();let k=u,A=this.canvasHeight-5;this.ctx.beginPath(),this.ctx.fillRect(k-a/2,A-a/2,a,a),this.ctx.fill(),this.ctx.restore()}m.prototype.initUI=b;m.prototype.initCanvas=I;m.prototype.addFrameSquareOverlay=F;m.prototype.addVideoOverlay=D;m.prototype.addProgressBarOverlay=B;var Kt=m;export{Kt as SmAnnotate};
